var N=Object.defineProperty;var S=l=>{throw TypeError(l)};var $=(l,i,s)=>i in l?N(l,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[i]=s;var o=(l,i,s)=>$(l,typeof i!="symbol"?i+"":i,s),B=(l,i,s)=>i.has(l)||S("Cannot "+s);var A=(l,i,s)=>i.has(l)?S("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(l):i.set(l,s);var u=(l,i,s)=>(B(l,i,"access private method"),s);import{F as U}from"./FacadeVFS-DDp67IRV.js";import{r as I,f as H,j as k,k as b,S as p,l as M,m as x,n as z,o as Y,p as G,q as K,t as W,u as X,v as J,w as V,e as Z,B as ee,D as se,d as te}from"./WASQLiteDB.worker-BO2zAGn8.js";const re=10,ae=1e3,w=["","-journal","-wal"],ne=new FinalizationRegistry(l=>l());class L{constructor(i,s){o(this,"path");o(this,"flags");o(this,"accessHandle");o(this,"persistentFile");this.path=i,this.flags=s}}class O{constructor(i){o(this,"fileHandle");o(this,"accessHandle",null);o(this,"isLockBusy",!1);o(this,"isFileLocked",!1);o(this,"isRequestInProgress",!1);o(this,"handleLockReleaser",null);o(this,"handleRequestChannel");o(this,"isHandleRequested",!1);this.fileHandle=i}}var h,v,C,R,f,Q;const T=class T extends U{constructor(s,t){super(s,t);A(this,h);o(this,"mapIdToFile",new Map);o(this,"lastError",null);o(this,"log",null);o(this,"persistentFiles",new Map);o(this,"boundAccessHandles",new Map);o(this,"unboundAccessHandles",new Set);o(this,"accessiblePaths",new Set);o(this,"releaser",null)}static async create(s,t){var r;const e=new T(s,t);return await Promise.all([e.isReady(),u(r=e,h,v).call(r,re)]),e}jOpen(s,t,e,r){var a;try{const n=new URL(s||Math.random().toString(36).slice(2),"file://").pathname;if(e&I){const F=this.persistentFiles.get(n);if(F!=null&&F.isRequestInProgress)return H;if(F)if(F.fileHandle){if(!F.accessHandle)return this._module.retryOps.push((async()=>{const E=new L(n,e);E.persistentFile=this.persistentFiles.get(n),await u(this,h,R).call(this,E)})()),H}else return this.persistentFiles.delete(n),b;else{(a=this.log)==null||a.call(this,`creating persistent file for ${n}`);const E=!!(e&k);return this._module.retryOps.push((async()=>{try{let g=await navigator.storage.getDirectory();const m=n.split("/").filter(y=>y),j=m.pop();for(const y of m)g=await g.getDirectoryHandle(y,{create:E});for(const y of w){const D=await g.getFileHandle(j+y,{create:E});await u(this,h,C).call(this,D)}const _=new L(n,e);_.persistentFile=this.persistentFiles.get(n),await u(this,h,R).call(this,_)}catch(g){const m=new O(null);this.persistentFiles.set(n,m),console.error(g)}})()),H}}if(!this.accessiblePaths.has(n)&&!(e&k))throw new Error(`File ${n} not found`);const d=new L(n,e);return this.mapIdToFile.set(t,d),this.persistentFiles.has(n)?d.persistentFile=this.persistentFiles.get(n):this.boundAccessHandles.has(n)?d.accessHandle=this.boundAccessHandles.get(n):this.unboundAccessHandles.size&&(d.accessHandle=this.unboundAccessHandles.values().next().value,d.accessHandle.truncate(0),this.unboundAccessHandles.delete(d.accessHandle),this.boundAccessHandles.set(n,d.accessHandle)),this.accessiblePaths.add(n),r.setInt32(0,e,!0),p}catch(c){return this.lastError=c,b}}jDelete(s,t){var e;try{const a=new URL(s,"file://").pathname;return this.persistentFiles.has(a)?this.persistentFiles.get(a).accessHandle.truncate(0):(e=this.boundAccessHandles.get(a))==null||e.truncate(0),this.accessiblePaths.delete(a),p}catch(r){return this.lastError=r,M}}jAccess(s,t,e){try{const a=new URL(s,"file://").pathname;return e.setInt32(0,this.accessiblePaths.has(a)?1:0,!0),p}catch(r){return this.lastError=r,x}}jClose(s){var t;try{const e=this.mapIdToFile.get(s);return this.mapIdToFile.delete(s),(e==null?void 0:e.flags)&I?(t=e.persistentFile)!=null&&t.handleLockReleaser&&u(this,h,f).call(this,e):(e==null?void 0:e.flags)&z&&(e.accessHandle.truncate(0),this.accessiblePaths.delete(e.path),this.persistentFiles.has(e.path)||(this.boundAccessHandles.delete(e.path),this.unboundAccessHandles.add(e.accessHandle))),p}catch(e){return this.lastError=e,Y}}jRead(s,t,e){try{const r=this.mapIdToFile.get(s),c=(r.accessHandle||r.persistentFile.accessHandle).read(t.subarray(),{at:e});return r.flags&I&&!r.persistentFile.isFileLocked&&u(this,h,f).call(this,r),c<t.byteLength?(t.fill(0,c),G):p}catch(r){return this.lastError=r,K}}jWrite(s,t,e){try{const r=this.mapIdToFile.get(s);if((r.accessHandle||r.persistentFile.accessHandle).write(t.subarray(),{at:e})!==t.byteLength)throw new Error("short write");return p}catch(r){return this.lastError=r,W}}jTruncate(s,t){try{const e=this.mapIdToFile.get(s);return(e.accessHandle||e.persistentFile.accessHandle).truncate(t),p}catch(e){return this.lastError=e,X}}jSync(s,t){try{const e=this.mapIdToFile.get(s);return(e.accessHandle||e.persistentFile.accessHandle).flush(),p}catch(e){return this.lastError=e,J}}jFileSize(s,t){try{const e=this.mapIdToFile.get(s),a=(e.accessHandle||e.persistentFile.accessHandle).getSize();return t.setBigInt64(0,BigInt(a),!0),p}catch(e){return this.lastError=e,V}}jLock(s,t){var r;const e=this.mapIdToFile.get(s);return e.persistentFile.isRequestInProgress?(e.persistentFile.isLockBusy=!0,H):(e.persistentFile.isFileLocked=!0,e.persistentFile.handleLockReleaser?(e.persistentFile.isLockBusy=!1,p):(e.persistentFile.handleRequestChannel.onmessage=()=>{var a;(a=this.log)==null||a.call(this,`received notification for ${e.path}`),e.persistentFile.isFileLocked?e.persistentFile.isHandleRequested=!0:u(this,h,f).call(this,e),e.persistentFile.handleRequestChannel.onmessage=null},u(this,h,R).call(this,e),(r=this.log)==null||r.call(this,"returning SQLITE_BUSY"),e.persistentFile.isLockBusy=!0,H))}jUnlock(s,t){const e=this.mapIdToFile.get(s);return t===Z&&(e.persistentFile.isLockBusy||(e.persistentFile.isHandleRequested&&(u(this,h,f).call(this,e),e.persistentFile.isHandleRequested=!1),e.persistentFile.isFileLocked=!1)),p}jFileControl(s,t,e){var r;try{const a=this.mapIdToFile.get(s);switch(t){case ee:const c=q(e,4),n=q(e,8);switch((r=this.log)==null||r.call(this,"xFileControl",a.path,"PRAGMA",c,n),c.toLowerCase()){case"journal_mode":if(n&&!["off","memory","delete","wal"].includes(n.toLowerCase()))throw new Error('journal_mode must be "off", "memory", "delete", or "wal"');break}break}}catch(a){return this.lastError=a,se}return te}jGetLastError(s){if(this.lastError){console.error(this.lastError);const t=s.subarray(0,s.byteLength-1),{written:e}=new TextEncoder().encodeInto(this.lastError.message,t);s[e]=0}return p}};h=new WeakSet,v=async function(s){const t=await navigator.storage.getDirectory();for await(const a of t.values())a.kind==="directory"&&a.name.startsWith(".ahp-")&&await navigator.locks.request(a.name,{ifAvailable:!0},async c=>{var n,d;c?((n=this.log)==null||n.call(this,`Deleting temporary directory ${a.name}`),await t.removeEntry(a.name,{recursive:!0})):(d=this.log)==null||d.call(this,`Temporary directory ${a.name} is in use`)});const e=`.ahp-${Math.random().toString(36).slice(2)}`;this.releaser=await new Promise(a=>{navigator.locks.request(e,()=>new Promise(c=>{a(c)}))}),ne.register(this,this.releaser);const r=await t.getDirectoryHandle(e,{create:!0});for(let a=0;a<s;a++){const n=await(await r.getFileHandle(`${a}.tmp`,{create:!0})).createSyncAccessHandle();this.unboundAccessHandles.add(n)}},C=async function(s){const t=new O(s),a=`/${(await(await navigator.storage.getDirectory()).resolve(s)).join("/")}`;return t.handleRequestChannel=new BroadcastChannel(`ahp:${a}`),this.persistentFiles.set(a,t),(await s.getFile()).size&&this.accessiblePaths.add(a),t},R=function(s){return console.assert(!s.persistentFile.handleLockReleaser),s.persistentFile.isRequestInProgress?Promise.resolve():(s.persistentFile.isRequestInProgress=!0,this._module.retryOps.push((async()=>{var t,e;s.persistentFile.handleLockReleaser=await u(this,h,Q).call(this,s.persistentFile);try{(t=this.log)==null||t.call(this,`creating access handles for ${s.path}`),await Promise.all(w.map(async r=>{const a=this.persistentFiles.get(s.path+r);a&&(a.accessHandle=await a.fileHandle.createSyncAccessHandle())}))}catch(r){throw(e=this.log)==null||e.call(this,`failed to create access handles for ${s.path}`,r),u(this,h,f).call(this,s),r}finally{s.persistentFile.isRequestInProgress=!1}})()),this._module.retryOps.at(-1))},f=async function(s){var t,e,r,a;w.forEach(async c=>{var d;const n=this.persistentFiles.get(s.path+c);n&&((d=n.accessHandle)==null||d.close(),n.accessHandle=null)}),(t=this.log)==null||t.call(this,`access handles closed for ${s.path}`),(r=(e=s.persistentFile).handleLockReleaser)==null||r.call(e),s.persistentFile.handleLockReleaser=null,(a=this.log)==null||a.call(this,`lock released for ${s.path}`)},Q=function(s){return new Promise(t=>{var c;const e=s.handleRequestChannel.name,r=()=>{var n;(n=this.log)==null||n.call(this,`notifying for ${e}`),s.handleRequestChannel.postMessage(null)},a=setInterval(r,ae);setTimeout(r),(c=this.log)==null||c.call(this,`lock requested: ${e}`),navigator.locks.request(e,n=>{var d;return(d=this.log)==null||d.call(this,`lock acquired: ${e}`,n),clearInterval(a),new Promise(t)})})};let P=T;function q(l,i){const s=l.getUint32(i,!0);if(s){const t=new Uint8Array(l.buffer,s);return new TextDecoder().decode(t.subarray(0,t.indexOf(0)))}return null}export{P as OPFSCoopSyncVFS};
