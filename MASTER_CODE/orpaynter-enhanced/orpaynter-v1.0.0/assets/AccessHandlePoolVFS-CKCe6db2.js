var z=Object.defineProperty;var C=r=>{throw TypeError(r)};var B=(r,c,t)=>c in r?z(r,c,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[c]=t;var N=(r,c,t)=>B(r,typeof c!="symbol"?c+"":c,t),m=(r,c,t)=>c.has(r)||C("Cannot "+t);var i=(r,c,t)=>(m(r,c,"read from private field"),t?t.call(r):c.get(r)),S=(r,c,t)=>c.has(r)?C("Cannot add the same private member more than once"):c instanceof WeakSet?c.add(r):c.set(r,t),R=(r,c,t,e)=>(m(r,c,"write to private field"),e?e.call(r,t):c.set(r,t),t),h=(r,c,t)=>(m(r,c,"access private method"),t);import{F as V}from"./FacadeVFS-DDp67IRV.js";import{j as G,S as u,k as Z,n as F,p as k,D as W,F as J,r as Y,G as q,H as K,I as X}from"./WASQLiteDB.worker-BO2zAGn8.js";const U=4096,H=512,$=4,tt=8,D=H+$,M=H,b=D,_=U,et=Y|q|K|X,st=6;var I,g,d,l,E,f,n,Q,v,x,A,L,T,O;const P=class P extends V{constructor(t,e){super(t,e);S(this,n);N(this,"log",null);S(this,I);S(this,g);S(this,d,new Map);S(this,l,new Map);S(this,E,new Set);S(this,f,new Map);R(this,I,t)}static async create(t,e){const s=new P(t,e);return await s.isReady(),s}jOpen(t,e,s,a){try{const o=t?h(this,n,T).call(this,t):Math.random().toString(36);let w=i(this,l).get(o);if(!w&&s&G)if(this.getSize()<this.getCapacity())[w]=i(this,E).keys(),h(this,n,A).call(this,w,o,s);else throw new Error("cannot create file");if(!w)throw new Error("file not found");const y={path:o,flags:s,accessHandle:w};return i(this,f).set(e,y),a.setInt32(0,s,!0),u}catch(o){return console.error(o.message),Z}}jClose(t){const e=i(this,f).get(t);return e&&(e.accessHandle.flush(),i(this,f).delete(t),e.flags&F&&h(this,n,O).call(this,e.path)),u}jRead(t,e,s){const o=i(this,f).get(t).accessHandle.read(e.subarray(),{at:_+s});return o<e.byteLength?(e.fill(0,o,e.byteLength),k):u}jWrite(t,e,s){return i(this,f).get(t).accessHandle.write(e.subarray(),{at:_+s})===e.byteLength?u:W}jTruncate(t,e){return i(this,f).get(t).accessHandle.truncate(_+e),u}jSync(t,e){return i(this,f).get(t).accessHandle.flush(),u}jFileSize(t,e){const a=i(this,f).get(t).accessHandle.getSize()-_;return e.setBigInt64(0,BigInt(a),!0),u}jSectorSize(t){return U}jDeviceCharacteristics(t){return J}jAccess(t,e,s){const a=h(this,n,T).call(this,t);return s.setInt32(0,i(this,l).has(a)?1:0,!0),u}jDelete(t,e){const s=h(this,n,T).call(this,t);return h(this,n,O).call(this,s),u}async close(){await h(this,n,v).call(this)}async isReady(){if(!i(this,g)){let t=await navigator.storage.getDirectory();for(const e of i(this,I).split("/"))e&&(t=await t.getDirectoryHandle(e,{create:!0}));R(this,g,t),await h(this,n,Q).call(this),this.getCapacity()===0&&await this.addCapacity(st)}return!0}getSize(){return i(this,l).size}getCapacity(){return i(this,d).size}async addCapacity(t){for(let e=0;e<t;++e){const s=Math.random().toString(36).replace("0.",""),o=await(await i(this,g).getFileHandle(s,{create:!0})).createSyncAccessHandle();i(this,d).set(o,s),h(this,n,A).call(this,o,"",0)}return t}async removeCapacity(t){let e=0;for(const s of Array.from(i(this,E))){if(e==t||this.getSize()===this.getCapacity())return e;const a=i(this,d).get(s);await s.close(),await i(this,g).removeEntry(a),i(this,d).delete(s),i(this,E).delete(s),++e}return e}};I=new WeakMap,g=new WeakMap,d=new WeakMap,l=new WeakMap,E=new WeakMap,f=new WeakMap,n=new WeakSet,Q=async function(){const t=[];for await(const[e,s]of i(this,g))s.kind==="file"&&t.push([e,s]);await Promise.all(t.map(async([e,s])=>{const a=await s.createSyncAccessHandle();i(this,d).set(a,e);const o=h(this,n,x).call(this,a);o?i(this,l).set(o,a):i(this,E).add(a)}))},v=function(){for(const t of i(this,d).keys())t.close();i(this,d).clear(),i(this,l).clear(),i(this,E).clear()},x=function(t){const e=new Uint8Array(D);t.read(e,{at:0});const a=new DataView(e.buffer,e.byteOffset).getUint32(M);if(e[0]&&(a&F||(a&et)===0))return console.warn(`Remove file with unexpected flags ${a.toString(16)}`),h(this,n,A).call(this,t,"",0),"";const o=new Uint32Array(tt/4);t.read(o,{at:b});const w=h(this,n,L).call(this,e);if(o.every((y,p)=>y===w[p])){const y=e.findIndex(p=>p===0);return y===0&&t.truncate(_),new TextDecoder().decode(e.subarray(0,y))}else return console.warn("Disassociating file with bad digest."),h(this,n,A).call(this,t,"",0),""},A=function(t,e,s){const a=new Uint8Array(D);if(new TextEncoder().encodeInto(e,a).written>=H)throw new Error("path too long");new DataView(a.buffer,a.byteOffset).setUint32(M,s);const y=h(this,n,L).call(this,a);t.write(a,{at:0}),t.write(y,{at:b}),t.flush(),e?(i(this,l).set(e,t),i(this,E).delete(t)):(t.truncate(_),i(this,E).add(t))},L=function(t){if(!t[0])return new Uint32Array([4274806656,2899230775]);let e=3735928559,s=1103547991;for(const a of t)e=Math.imul(e^a,2654435761),s=Math.imul(s^a,1597334677);return e=Math.imul(e^e>>>16,2246822507)^Math.imul(s^s>>>13,3266489909),s=Math.imul(s^s>>>16,2246822507)^Math.imul(e^e>>>13,3266489909),new Uint32Array([e>>>0,s>>>0])},T=function(t){return(typeof t=="string"?new URL(t,"file://localhost/"):t).pathname},O=function(t){const e=i(this,l).get(t);e&&(i(this,l).delete(t),h(this,n,A).call(this,e,"",0))};let j=P;export{j as AccessHandlePoolVFS};
