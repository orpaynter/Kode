var Nn=Object.defineProperty;var xn=(r,u,i)=>u in r?Nn(r,u,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[u]=i;var G=(r,u,i)=>xn(r,typeof u!="symbol"?u+"":u,i);const Nr=0,xr=1,Cr=5,Dr=10,Pr=12,Ur=14;const qr=3338,Br=3594,Mr=4106,kr=2570,Qr=1802,Hr=1034,zr=3850,jr=266,Wr=522,Gr=1546,Vr=2058,Xr=778;const Kr=4,Yr=8,Jr=64,Zr=256,$r=512,ei=2048,ti=16384,ni=524288,ri=0,ii=1,si=2,ai=4,oi=2048,ui=16384,ci=14,li=21,hi=31,fi=32,di=33;typeof BigInt.prototype.toJSON>"u"&&(BigInt.prototype.toJSON=function(){return this.toString()});const Lt=0x7fffffffffffffffn,Ot=-0x8000000000000000n,Et=Object.getPrototypeOf(async function(){}).constructor;class Me extends Error{constructor(u,i){super(u),this.code=i}}const ke=!0;function Cn(r){const u={};r.retryOps=[];const i=r._getSqliteFree(),_=r._malloc(8),g=[_,_+4],R=new TextEncoder;function f(a){if(typeof a!="string")return 0;const o=R.encode(a),p=r._sqlite3_malloc(o.byteLength+1);return r.HEAPU8.set(o,p),r.HEAPU8[p+o.byteLength]=0,p}function E(a,o){return BigInt(o)<<32n|BigInt(a)&0xffffffffn}const I=(function(){const a=BigInt(Number.MAX_SAFE_INTEGER)>>32n,o=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(p,T){return T>a||T<o?E(p,T):T*4294967296+(p&2147483647)-(p&2147483648)}})(),w=new Set;function c(a){if(!w.has(a))throw new Me("not a database",21)}const t=new Map;function l(a){if(!t.has(a))throw new Me("not a statement",21)}u.bind_collection=function(a,o){l(a);const p=Array.isArray(o),T=u.bind_parameter_count(a);for(let b=1;b<=T;++b){const L=p?b-1:u.bind_parameter_name(a,b),N=o[L];N!==void 0&&u.bind(a,b,N)}return 0},u.bind=function(a,o,p){switch(l(a),typeof p){case"number":return p===(p|0)?u.bind_int(a,o,p):u.bind_double(a,o,p);case"string":return u.bind_text(a,o,p);case"boolean":return u.bind_int(a,o,p?1:0);default:return p instanceof Uint8Array||Array.isArray(p)?u.bind_blob(a,o,p):p===null?u.bind_null(a,o):typeof p=="bigint"?u.bind_int64(a,o,p):p===void 0?27:(console.warn("unknown binding converted to null",p),u.bind_null(a,o))}},u.bind_blob=(function(){const a="sqlite3_bind_blob",o=r.cwrap(a,...P("nnnnn:n"));return function(p,T,b){l(p);const L=b.byteLength??b.length,N=r._sqlite3_malloc(L);r.HEAPU8.subarray(N).set(b);const D=o(p,T,N,L,i);return s(a,D,t.get(p))}})(),u.bind_parameter_count=(function(){const o=r.cwrap("sqlite3_bind_parameter_count",...P("n:n"));return function(p){return l(p),o(p)}})(),u.bind_double=(function(){const a="sqlite3_bind_double",o=r.cwrap(a,...P("nnn:n"));return function(p,T,b){l(p);const L=o(p,T,b);return s(a,L,t.get(p))}})(),u.bind_int=(function(){const a="sqlite3_bind_int",o=r.cwrap(a,...P("nnn:n"));return function(p,T,b){if(l(p),b>2147483647||b<-2147483648)return 25;const L=o(p,T,b);return s(a,L,t.get(p))}})(),u.bind_int64=(function(){const a="sqlite3_bind_int64",o=r.cwrap(a,...P("nnnn:n"));return function(p,T,b){if(l(p),b>Lt||b<Ot)return 25;const L=b&0xffffffffn,N=b>>32n,D=o(p,T,Number(L),Number(N));return s(a,D,t.get(p))}})(),u.bind_null=(function(){const a="sqlite3_bind_null",o=r.cwrap(a,...P("nn:n"));return function(p,T){l(p);const b=o(p,T);return s(a,b,t.get(p))}})(),u.bind_parameter_name=(function(){const o=r.cwrap("sqlite3_bind_parameter_name",...P("n:s"));return function(p,T){return l(p),o(p,T)}})(),u.bind_text=(function(){const a="sqlite3_bind_text",o=r.cwrap(a,...P("nnnnn:n"));return function(p,T,b){l(p);const L=f(b),N=o(p,T,L,-1,i);return s(a,N,t.get(p))}})(),u.changes=(function(){const o=r.cwrap("sqlite3_changes",...P("n:n"));return function(p){return c(p),o(p)}})(),u.clear_bindings=(function(){const a="sqlite3_clear_bindings",o=r.cwrap(a,...P("n:n"));return function(p){l(p);const T=o(p);return s(a,T,t.get(p))}})(),u.last_insert_id=(function(){const o=r.cwrap("sqlite3_last_insert_rowid",...P("n:n"));return function(p){return c(p),o(p)}})(),u.close=(function(){const a="sqlite3_close",o=r.cwrap(a,...P("n:n"),{async:ke});return async function(p){c(p);const T=await o(p);return w.delete(p),s(a,T,p)}})(),u.column=function(a,o){l(a);const p=u.column_type(a,o);switch(p){case 4:return u.column_blob(a,o);case 2:return u.column_double(a,o);case 1:const T=u.column_int(a,o),b=r.getTempRet0();return I(T,b);case 5:return null;case 3:return u.column_text(a,o);default:throw new Me("unknown type",p)}},u.column_blob=(function(){const o=r.cwrap("sqlite3_column_blob",...P("nn:n"));return function(p,T){l(p);const b=u.column_bytes(p,T),L=o(p,T);return r.HEAPU8.subarray(L,L+b)}})(),u.column_bytes=(function(){const o=r.cwrap("sqlite3_column_bytes",...P("nn:n"));return function(p,T){return l(p),o(p,T)}})(),u.column_count=(function(){const o=r.cwrap("sqlite3_column_count",...P("n:n"));return function(p){return l(p),o(p)}})(),u.column_double=(function(){const o=r.cwrap("sqlite3_column_double",...P("nn:n"));return function(p,T){return l(p),o(p,T)}})(),u.column_int=(function(){const o=r.cwrap("sqlite3_column_int64",...P("nn:n"));return function(p,T){return l(p),o(p,T)}})(),u.column_int64=(function(){const o=r.cwrap("sqlite3_column_int64",...P("nn:n"));return function(p,T){l(p);const b=o(p,T),L=r.getTempRet0();return E(b,L)}})(),u.column_name=(function(){const o=r.cwrap("sqlite3_column_name",...P("nn:s"));return function(p,T){return l(p),o(p,T)}})(),u.column_names=function(a){const o=[],p=u.column_count(a);for(let T=0;T<p;++T)o.push(u.column_name(a,T));return o},u.column_text=(function(){const o=r.cwrap("sqlite3_column_text",...P("nn:s"));return function(p,T){return l(p),o(p,T)}})(),u.column_type=(function(){const o=r.cwrap("sqlite3_column_type",...P("nn:n"));return function(p,T){return l(p),o(p,T)}})(),u.create_function=function(a,o,p,T,b,L,N,D){c(a);function U(k){return k instanceof Et?(async(M,z,q)=>k(M,r.HEAP32.subarray(q/4,q/4+z))):((M,z,q)=>k(M,r.HEAP32.subarray(q/4,q/4+z)))}const H=r.create_function(a,o,p,T,b,L&&U(L),N&&U(N),D);return s("sqlite3_create_function",H,a)},u.data_count=(function(){const o=r.cwrap("sqlite3_data_count",...P("n:n"));return function(p){return l(p),o(p)}})(),u.exec=async function(a,o,p){for await(const T of u.statements(a,o)){let b;for(;await u.step(T)===100;)if(p){b=b??u.column_names(T);const L=u.row(T);await p(L,b)}}return 0},u.finalize=(function(){const o=r.cwrap("sqlite3_finalize",...P("n:n"),{async:ke});return async function(p){const T=await o(p);return t.delete(p),T}})(),u.get_autocommit=(function(){const o=r.cwrap("sqlite3_get_autocommit",...P("n:n"));return function(p){return o(p)}})(),u.libversion=(function(){const o=r.cwrap("sqlite3_libversion",...P(":s"));return function(){return o()}})(),u.libversion_number=(function(){const o=r.cwrap("sqlite3_libversion_number",...P(":n"));return function(){return o()}})(),u.limit=(function(){const o=r.cwrap("sqlite3_limit",...P("nnn:n"));return function(p,T,b){return o(p,T,b)}})(),u.open_v2=(function(){const a="sqlite3_open_v2",o=r.cwrap(a,...P("snnn:n"),{async:ke});return async function(p,T,b){T=T||6,b=f(b);try{const L=await m(()=>o(p,g[0],T,b)),N=r.getValue(g[0],"*");return w.add(N),r.ccall("RegisterExtensionFunctions","number",["number"],[N]),s(a,L),N}finally{r._sqlite3_free(b)}}})(),u.progress_handler=function(a,o,p,T){c(a),r.progress_handler(a,o,p,T)},u.reset=(function(){const a="sqlite3_reset",o=r.cwrap(a,...P("n:n"),{async:ke});return async function(p){l(p);const T=await o(p);return s(a,T,t.get(p))}})(),u.result=function(a,o){switch(typeof o){case"number":o===(o|0)?u.result_int(a,o):u.result_double(a,o);break;case"string":u.result_text(a,o);break;default:if(o instanceof Uint8Array||Array.isArray(o))u.result_blob(a,o);else if(o===null)u.result_null(a);else{if(typeof o=="bigint")return u.result_int64(a,o);console.warn("unknown result converted to null",o),u.result_null(a)}break}},u.result_blob=(function(){const o=r.cwrap("sqlite3_result_blob",...P("nnnn:n"));return function(p,T){const b=T.byteLength??T.length,L=r._sqlite3_malloc(b);r.HEAPU8.subarray(L).set(T),o(p,L,b,i)}})(),u.result_double=(function(){const o=r.cwrap("sqlite3_result_double",...P("nn:n"));return function(p,T){o(p,T)}})(),u.result_int=(function(){const o=r.cwrap("sqlite3_result_int",...P("nn:n"));return function(p,T){o(p,T)}})(),u.result_int64=(function(){const o=r.cwrap("sqlite3_result_int64",...P("nnn:n"));return function(p,T){if(T>Lt||T<Ot)return 25;const b=T&0xffffffffn,L=T>>32n;o(p,Number(b),Number(L))}})(),u.result_null=(function(){const o=r.cwrap("sqlite3_result_null",...P("n:n"));return function(p){o(p)}})(),u.result_text=(function(){const o=r.cwrap("sqlite3_result_text",...P("nnnn:n"));return function(p,T){const b=f(T);o(p,b,-1,i)}})(),u.row=function(a){const o=[],p=u.data_count(a);for(let T=0;T<p;++T){const b=u.column(a,T);o.push((b==null?void 0:b.buffer)===r.HEAPU8.buffer?b.slice():b)}return o},u.set_authorizer=function(a,o,p){c(a);function T(N,D,U,H,k,M){return[N,D,r.UTF8ToString(U),r.UTF8ToString(H),r.UTF8ToString(k),r.UTF8ToString(M)]}function b(N){return N instanceof Et?(async(D,U,H,k,M,z)=>N(...T(D,U,H,k,M,z))):((D,U,H,k,M,z)=>N(...T(D,U,H,k,M,z)))}const L=r.set_authorizer(a,b(o),p);return s("sqlite3_set_authorizer",L,a)},u.sql=(function(){const o=r.cwrap("sqlite3_sql",...P("n:s"));return function(p){return l(p),o(p)}})(),u.statements=function(a,o,p={}){const T=r.cwrap("sqlite3_prepare_v3","number",["number","number","number","number","number","number"],{async:!0});return(async function*(){const b=[];try{let z=function(){M&&!p.unscoped&&u.finalize(M),M=0};const L=R.encode(o),N=L.byteLength-L.byteLength%4+12,D=r._sqlite3_malloc(N),U=D+L.byteLength+1;b.push(()=>r._sqlite3_free(D)),r.HEAPU8.set(L,D),r.HEAPU8[U-1]=0;const H=D+N-8,k=D+N-4;let M;b.push(z),r.setValue(k,D,"*");do{z();const q=r.getValue(k,"*"),V=await m(()=>T(a,q,U-k,p.flags||0,H,k));V!==0&&s("sqlite3_prepare_v3",V,a),M=r.getValue(H,"*"),M&&(t.set(M,a),yield M)}while(M)}finally{for(;b.length;)b.pop()()}})()},u.step=(function(){const a="sqlite3_step",o=r.cwrap(a,...P("n:n"),{async:ke});return async function(p){l(p);const T=await m(()=>o(p));return s(a,T,t.get(p),[100,101])}})(),u.commit_hook=function(a,o){c(a),r.commit_hook(a,o)},u.update_hook=function(a,o){c(a);function p(b,L,N,D,U){return[b,r.UTF8ToString(L),r.UTF8ToString(N),E(D,U)]}function T(b){return b instanceof Et?(async(L,N,D,U,H)=>b(...p(L,N,D,U,H))):((L,N,D,U,H)=>b(...p(L,N,D,U,H)))}r.update_hook(a,T(o))},u.value=function(a){const o=u.value_type(a);switch(o){case 4:return u.value_blob(a);case 2:return u.value_double(a);case 1:const p=u.value_int(a),T=r.getTempRet0();return I(p,T);case 5:return null;case 3:return u.value_text(a);default:throw new Me("unknown type",o)}},u.value_blob=(function(){const o=r.cwrap("sqlite3_value_blob",...P("n:n"));return function(p){const T=u.value_bytes(p),b=o(p);return r.HEAPU8.subarray(b,b+T)}})(),u.value_bytes=(function(){const o=r.cwrap("sqlite3_value_bytes",...P("n:n"));return function(p){return o(p)}})(),u.value_double=(function(){const o=r.cwrap("sqlite3_value_double",...P("n:n"));return function(p){return o(p)}})(),u.value_int=(function(){const o=r.cwrap("sqlite3_value_int64",...P("n:n"));return function(p){return o(p)}})(),u.value_int64=(function(){const o=r.cwrap("sqlite3_value_int64",...P("n:n"));return function(p){const T=o(p),b=r.getTempRet0();return E(T,b)}})(),u.value_text=(function(){const o=r.cwrap("sqlite3_value_text",...P("n:s"));return function(p){return o(p)}})(),u.value_type=(function(){const o=r.cwrap("sqlite3_value_type",...P("n:n"));return function(p){return o(p)}})(),u.vfs_register=function(a,o){const p=r.vfs_register(a,o);return s("sqlite3_vfs_register",p)};function s(a,o,p=null,T=[0]){if(T.includes(o))return o;const b=p?r.ccall("sqlite3_errmsg","string",["number"],[p]):a;throw new Me(b,o)}async function m(a){let o;do{if(r.retryOps.length)try{await Promise.all(r.retryOps)}finally{r.retryOps=[]}o=await a()}while(o&&r.retryOps.length);return o}return u}function P(r){const u=[],i=r.match(/([ns@]*):([nsv@])/);switch(i[2]){case"n":u.push("number");break;case"s":u.push("string");break;case"v":u.push(null);break}const _=[];for(let g of i[1])switch(g){case"n":_.push("number");break;case"s":_.push("string");break}return u.push(_),u}const Dn=new Error("request for lock canceled");var Pn=function(r,u,i,_){function g(R){return R instanceof i?R:new i(function(f){f(R)})}return new(i||(i=Promise))(function(R,f){function E(c){try{w(_.next(c))}catch(t){f(t)}}function I(c){try{w(_.throw(c))}catch(t){f(t)}}function w(c){c.done?R(c.value):g(c.value).then(E,I)}w((_=_.apply(r,u||[])).next())})};class Un{constructor(u,i=Dn){this._value=u,this._cancelError=i,this._queue=[],this._weightedWaiters=[]}acquire(u=1,i=0){if(u<=0)throw new Error(`invalid weight ${u}: must be positive`);return new Promise((_,g)=>{const R={resolve:_,reject:g,weight:u,priority:i},f=yn(this._queue,E=>i<=E.priority);f===-1&&u<=this._value?this._dispatchItem(R):this._queue.splice(f+1,0,R)})}runExclusive(u){return Pn(this,arguments,void 0,function*(i,_=1,g=0){const[R,f]=yield this.acquire(_,g);try{return yield i(R)}finally{f()}})}waitForUnlock(u=1,i=0){if(u<=0)throw new Error(`invalid weight ${u}: must be positive`);return this._couldLockImmediately(u,i)?Promise.resolve():new Promise(_=>{this._weightedWaiters[u-1]||(this._weightedWaiters[u-1]=[]),qn(this._weightedWaiters[u-1],{resolve:_,priority:i})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(u){this._value=u,this._dispatchQueue()}release(u=1){if(u<=0)throw new Error(`invalid weight ${u}: must be positive`);this._value+=u,this._dispatchQueue()}cancel(){this._queue.forEach(u=>u.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(u){const i=this._value;this._value-=u.weight,u.resolve([i,this._newReleaser(u.weight)])}_newReleaser(u){let i=!1;return()=>{i||(i=!0,this.release(u))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let u=this._value;u>0;u--){const i=this._weightedWaiters[u-1];i&&(i.forEach(_=>_.resolve()),this._weightedWaiters[u-1]=[])}else{const u=this._queue[0].priority;for(let i=this._value;i>0;i--){const _=this._weightedWaiters[i-1];if(!_)continue;const g=_.findIndex(R=>R.priority<=u);(g===-1?_:_.splice(0,g)).forEach((R=>R.resolve()))}}}_couldLockImmediately(u,i){return(this._queue.length===0||this._queue[0].priority<i)&&u<=this._value}}function qn(r,u){const i=yn(r,_=>u.priority<=_.priority);r.splice(i+1,0,u)}function yn(r,u){for(let i=r.length-1;i>=0;i--)if(u(r[i]))return i;return-1}var Bn=function(r,u,i,_){function g(R){return R instanceof i?R:new i(function(f){f(R)})}return new(i||(i=Promise))(function(R,f){function E(c){try{w(_.next(c))}catch(t){f(t)}}function I(c){try{w(_.throw(c))}catch(t){f(t)}}function w(c){c.done?R(c.value):g(c.value).then(E,I)}w((_=_.apply(r,u||[])).next())})};class Mn{constructor(u){this._semaphore=new Un(1,u)}acquire(){return Bn(this,arguments,void 0,function*(u=0){const[,i]=yield this._semaphore.acquire(1,u);return i})}runExclusive(u,i=0){return this._semaphore.runExclusive(()=>u(),1,i)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(u=0){return this._semaphore.waitForUnlock(1,u)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}function kn(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Ue={},Qe={},Nt;function Qn(){if(Nt)return Qe;Nt=1,Object.defineProperty(Qe,"__esModule",{value:!0});class r{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(_){if(this.isStopped)return;const g={value:_,done:!1};if(this.pullQueue.length){const R=this.pullQueue.shift();R&&R.resolve(g)}else this.pushQueue.push(Promise.resolve(g)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const _ of this.pullQueue)_.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(_){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const g of this.pullQueue)g.reject(_);this.pullQueue.length=0}else{const g=Promise.reject(_);g.catch(()=>{}),this.pushQueue.push(g)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:_=>{const g=this.pushQueue.shift();return g?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),g):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((R,f)=>{this.pullQueue.push({resolve:R,reject:f})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class u{constructor(_,{highWaterMark:g=100,lowWaterMark:R=1}={}){const f=new r;f.highWaterMark=g,f.lowWaterMark=R,f.removeCallback=_({push:E=>f.push(E),stop:()=>f.stop(),fail:E=>f.fail(E),on:(E,I)=>{f.eventHandlers[E]=I}})||(()=>{}),this[Symbol.asyncIterator]=()=>f[Symbol.asyncIterator](),Object.freeze(this)}}return Qe.EventIterator=u,Qe.default=u,Qe}var xt;function Hn(){if(xt)return Ue;xt=1,Object.defineProperty(Ue,"__esModule",{value:!0});const r=Qn();Ue.EventIterator=r.EventIterator;function u(i,_,g){return new r.EventIterator(({push:R})=>(this.addEventListener(i,R,_),()=>this.removeEventListener(i,R,_)),g)}return Ue.subscribe=u,Ue.default=r.EventIterator,Ue}Hn();var Ze={exports:{}};/*!
 * js-logger - http://github.com/jonnyreeves/js-logger
 * Jonny Reeves, http://jonnyreeves.co.uk/
 * js-logger may be freely distributed under the MIT license.
 */var zn=Ze.exports,Ct;function jn(){return Ct||(Ct=1,(function(r){(function(u){var i={};i.VERSION="1.6.1";var _,g={},R=function(c,t){return function(){return t.apply(c,arguments)}},f=function(){var c=arguments,t=c[0],l,s;for(s=1;s<c.length;s++)for(l in c[s])!(l in t)&&c[s].hasOwnProperty(l)&&(t[l]=c[s][l]);return t},E=function(c,t){return{value:c,name:t}};i.TRACE=E(1,"TRACE"),i.DEBUG=E(2,"DEBUG"),i.INFO=E(3,"INFO"),i.TIME=E(4,"TIME"),i.WARN=E(5,"WARN"),i.ERROR=E(8,"ERROR"),i.OFF=E(99,"OFF");var I=function(c){this.context=c,this.setLevel(c.filterLevel),this.log=this.info};I.prototype={setLevel:function(c){c&&"value"in c&&(this.context.filterLevel=c)},getLevel:function(){return this.context.filterLevel},enabledFor:function(c){var t=this.context.filterLevel;return c.value>=t.value},trace:function(){this.invoke(i.TRACE,arguments)},debug:function(){this.invoke(i.DEBUG,arguments)},info:function(){this.invoke(i.INFO,arguments)},warn:function(){this.invoke(i.WARN,arguments)},error:function(){this.invoke(i.ERROR,arguments)},time:function(c){typeof c=="string"&&c.length>0&&this.invoke(i.TIME,[c,"start"])},timeEnd:function(c){typeof c=="string"&&c.length>0&&this.invoke(i.TIME,[c,"end"])},invoke:function(c,t){_&&this.enabledFor(c)&&_(t,f({level:c},this.context))}};var w=new I({filterLevel:i.OFF});(function(){var c=i;c.enabledFor=R(w,w.enabledFor),c.trace=R(w,w.trace),c.debug=R(w,w.debug),c.time=R(w,w.time),c.timeEnd=R(w,w.timeEnd),c.info=R(w,w.info),c.warn=R(w,w.warn),c.error=R(w,w.error),c.log=c.info})(),i.setHandler=function(c){_=c},i.setLevel=function(c){w.setLevel(c);for(var t in g)g.hasOwnProperty(t)&&g[t].setLevel(c)},i.getLevel=function(){return w.getLevel()},i.get=function(c){return g[c]||(g[c]=new I(f({name:c},w.context)))},i.createDefaultHandler=function(c){c=c||{},c.formatter=c.formatter||function(m,a){a.name&&m.unshift("["+a.name+"]")};var t={},l=function(s,m){Function.prototype.apply.call(s,console,m)};return typeof console>"u"?function(){}:function(s,m){s=Array.prototype.slice.call(s);var a=console.log,o;m.level===i.TIME?(o=(m.name?"["+m.name+"] ":"")+s[0],s[1]==="start"?console.time?console.time(o):t[o]=new Date().getTime():console.timeEnd?console.timeEnd(o):l(a,[o+": "+(new Date().getTime()-t[o])+"ms"])):(m.level===i.WARN&&console.warn?a=console.warn:m.level===i.ERROR&&console.error?a=console.error:m.level===i.INFO&&console.info?a=console.info:m.level===i.DEBUG&&console.debug?a=console.debug:m.level===i.TRACE&&console.trace&&(a=console.trace),c.formatter(s,m),l(a,s))}},i.useDefaults=function(c){i.setLevel(c&&c.defaultLevel||i.DEBUG),i.setHandler(i.createDefaultHandler(c))},i.setDefaults=i.useDefaults,r.exports?r.exports=i:(i._prevLogger=u.Logger,i.noConflict=function(){return u.Logger=i._prevLogger,i},u.Logger=i)})(zn)})(Ze)),Ze.exports}var Wn=jn(),st=kn(Wn),Dt;(function(r){r[r.SQLITE_INSERT=18]="SQLITE_INSERT",r[r.SQLITE_DELETE=9]="SQLITE_DELETE",r[r.SQLITE_UPDATE=23]="SQLITE_UPDATE"})(Dt||(Dt={}));class Gn{constructor(){G(this,"listeners",new Set)}dispose(){this.listeners.clear()}registerListener(u){return this.listeners.add(u),()=>{this.listeners.delete(u)}}iterateListeners(u){for(const i of this.listeners)u(i)}async iterateAsyncListeners(u){for(let i of Array.from(this.listeners.values()))await u(i)}}"FinalizationRegistry"in globalThis&&new FinalizationRegistry(r=>{r.logger.warn(`A subscription to ${r.name} with params ${JSON.stringify(r.parameters)} leaked! Please ensure calling unsubscribe() when you don't need a subscription anymore. For global subscriptions, consider storing them in global fields to avoid this warning.`)});var Pt;(function(r){r.ON_DATA="onData",r.ON_ERROR="onError",r.ON_STATE_CHANGE="onStateChange",r.SETTINGS_WILL_UPDATE="settingsWillUpdate",r.CLOSED="closed"})(Pt||(Pt={}));var Ut;(function(r){r.DATA="ps_data",r.CRUD="ps_crud",r.BUCKETS="ps_buckets",r.OPLOG="ps_oplog",r.UNTYPED="ps_untyped"})(Ut||(Ut={}));var qt;(function(r){r.PROCESS_TEXT_LINE="line_text",r.PROCESS_BSON_LINE="line_binary",r.STOP="stop",r.START="start",r.NOTIFY_TOKEN_REFRESHED="refreshed_token",r.NOTIFY_CRUD_UPLOAD_COMPLETED="completed_upload",r.UPDATE_SUBSCRIPTIONS="update_subscriptions"})(qt||(qt={}));var Bt;(function(r){r.PUT="PUT",r.PATCH="PATCH",r.DELETE="DELETE"})(Bt||(Bt={}));var Mt;(function(r){r[r.CLEAR=1]="CLEAR",r[r.MOVE=2]="MOVE",r[r.PUT=3]="PUT",r[r.REMOVE=4]="REMOVE"})(Mt||(Mt={}));var mt={},He={},kt;function Vn(){if(kt)return He;kt=1,He.byteLength=E,He.toByteArray=w,He.fromByteArray=l;for(var r=[],u=[],i=typeof Uint8Array<"u"?Uint8Array:Array,_="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",g=0,R=_.length;g<R;++g)r[g]=_[g],u[_.charCodeAt(g)]=g;u[45]=62,u[95]=63;function f(s){var m=s.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var a=s.indexOf("=");a===-1&&(a=m);var o=a===m?0:4-a%4;return[a,o]}function E(s){var m=f(s),a=m[0],o=m[1];return(a+o)*3/4-o}function I(s,m,a){return(m+a)*3/4-a}function w(s){var m,a=f(s),o=a[0],p=a[1],T=new i(I(s,o,p)),b=0,L=p>0?o-4:o,N;for(N=0;N<L;N+=4)m=u[s.charCodeAt(N)]<<18|u[s.charCodeAt(N+1)]<<12|u[s.charCodeAt(N+2)]<<6|u[s.charCodeAt(N+3)],T[b++]=m>>16&255,T[b++]=m>>8&255,T[b++]=m&255;return p===2&&(m=u[s.charCodeAt(N)]<<2|u[s.charCodeAt(N+1)]>>4,T[b++]=m&255),p===1&&(m=u[s.charCodeAt(N)]<<10|u[s.charCodeAt(N+1)]<<4|u[s.charCodeAt(N+2)]>>2,T[b++]=m>>8&255,T[b++]=m&255),T}function c(s){return r[s>>18&63]+r[s>>12&63]+r[s>>6&63]+r[s&63]}function t(s,m,a){for(var o,p=[],T=m;T<a;T+=3)o=(s[T]<<16&16711680)+(s[T+1]<<8&65280)+(s[T+2]&255),p.push(c(o));return p.join("")}function l(s){for(var m,a=s.length,o=a%3,p=[],T=16383,b=0,L=a-o;b<L;b+=T)p.push(t(s,b,b+T>L?L:b+T));return o===1?(m=s[a-1],p.push(r[m>>2]+r[m<<4&63]+"==")):o===2&&(m=(s[a-2]<<8)+s[a-1],p.push(r[m>>10]+r[m>>4&63]+r[m<<2&63]+"=")),p.join("")}return He}var Ye={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */var Qt;function Xn(){return Qt||(Qt=1,Ye.read=function(r,u,i,_,g){var R,f,E=g*8-_-1,I=(1<<E)-1,w=I>>1,c=-7,t=i?g-1:0,l=i?-1:1,s=r[u+t];for(t+=l,R=s&(1<<-c)-1,s>>=-c,c+=E;c>0;R=R*256+r[u+t],t+=l,c-=8);for(f=R&(1<<-c)-1,R>>=-c,c+=_;c>0;f=f*256+r[u+t],t+=l,c-=8);if(R===0)R=1-w;else{if(R===I)return f?NaN:(s?-1:1)*(1/0);f=f+Math.pow(2,_),R=R-w}return(s?-1:1)*f*Math.pow(2,R-_)},Ye.write=function(r,u,i,_,g,R){var f,E,I,w=R*8-g-1,c=(1<<w)-1,t=c>>1,l=g===23?Math.pow(2,-24)-Math.pow(2,-77):0,s=_?0:R-1,m=_?1:-1,a=u<0||u===0&&1/u<0?1:0;for(u=Math.abs(u),isNaN(u)||u===1/0?(E=isNaN(u)?1:0,f=c):(f=Math.floor(Math.log(u)/Math.LN2),u*(I=Math.pow(2,-f))<1&&(f--,I*=2),f+t>=1?u+=l/I:u+=l*Math.pow(2,1-t),u*I>=2&&(f++,I/=2),f+t>=c?(E=0,f=c):f+t>=1?(E=(u*I-1)*Math.pow(2,g),f=f+t):(E=u*Math.pow(2,t-1)*Math.pow(2,g),f=0));g>=8;r[i+s]=E&255,s+=m,E/=256,g-=8);for(f=f<<g|E,w+=g;w>0;r[i+s]=f&255,s+=m,f/=256,w-=8);r[i+s-m]|=a*128}),Ye}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var Ht;function Kn(){return Ht||(Ht=1,(function(r){const u=Vn(),i=Xn(),_=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=E,r.SlowBuffer=T,r.INSPECT_MAX_BYTES=50;const g=2147483647;r.kMaxLength=g,E.TYPED_ARRAY_SUPPORT=R(),!E.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function R(){try{const d=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(d,e),d.foo()===42}catch{return!1}}Object.defineProperty(E.prototype,"parent",{enumerable:!0,get:function(){if(E.isBuffer(this))return this.buffer}}),Object.defineProperty(E.prototype,"offset",{enumerable:!0,get:function(){if(E.isBuffer(this))return this.byteOffset}});function f(d){if(d>g)throw new RangeError('The value "'+d+'" is invalid for option "size"');const e=new Uint8Array(d);return Object.setPrototypeOf(e,E.prototype),e}function E(d,e,n){if(typeof d=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return t(d)}return I(d,e,n)}E.poolSize=8192;function I(d,e,n){if(typeof d=="string")return l(d,e);if(ArrayBuffer.isView(d))return m(d);if(d==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof d);if(te(d,ArrayBuffer)||d&&te(d.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(te(d,SharedArrayBuffer)||d&&te(d.buffer,SharedArrayBuffer)))return a(d,e,n);if(typeof d=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const y=d.valueOf&&d.valueOf();if(y!=null&&y!==d)return E.from(y,e,n);const F=o(d);if(F)return F;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof d[Symbol.toPrimitive]=="function")return E.from(d[Symbol.toPrimitive]("string"),e,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof d)}E.from=function(d,e,n){return I(d,e,n)},Object.setPrototypeOf(E.prototype,Uint8Array.prototype),Object.setPrototypeOf(E,Uint8Array);function w(d){if(typeof d!="number")throw new TypeError('"size" argument must be of type number');if(d<0)throw new RangeError('The value "'+d+'" is invalid for option "size"')}function c(d,e,n){return w(d),d<=0?f(d):e!==void 0?typeof n=="string"?f(d).fill(e,n):f(d).fill(e):f(d)}E.alloc=function(d,e,n){return c(d,e,n)};function t(d){return w(d),f(d<0?0:p(d)|0)}E.allocUnsafe=function(d){return t(d)},E.allocUnsafeSlow=function(d){return t(d)};function l(d,e){if((typeof e!="string"||e==="")&&(e="utf8"),!E.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const n=b(d,e)|0;let y=f(n);const F=y.write(d,e);return F!==n&&(y=y.slice(0,F)),y}function s(d){const e=d.length<0?0:p(d.length)|0,n=f(e);for(let y=0;y<e;y+=1)n[y]=d[y]&255;return n}function m(d){if(te(d,Uint8Array)){const e=new Uint8Array(d);return a(e.buffer,e.byteOffset,e.byteLength)}return s(d)}function a(d,e,n){if(e<0||d.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(d.byteLength<e+(n||0))throw new RangeError('"length" is outside of buffer bounds');let y;return e===void 0&&n===void 0?y=new Uint8Array(d):n===void 0?y=new Uint8Array(d,e):y=new Uint8Array(d,e,n),Object.setPrototypeOf(y,E.prototype),y}function o(d){if(E.isBuffer(d)){const e=p(d.length)|0,n=f(e);return n.length===0||d.copy(n,0,0,e),n}if(d.length!==void 0)return typeof d.length!="number"||Ce(d.length)?f(0):s(d);if(d.type==="Buffer"&&Array.isArray(d.data))return s(d.data)}function p(d){if(d>=g)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+g.toString(16)+" bytes");return d|0}function T(d){return+d!=d&&(d=0),E.alloc(+d)}E.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==E.prototype},E.compare=function(e,n){if(te(e,Uint8Array)&&(e=E.from(e,e.offset,e.byteLength)),te(n,Uint8Array)&&(n=E.from(n,n.offset,n.byteLength)),!E.isBuffer(e)||!E.isBuffer(n))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===n)return 0;let y=e.length,F=n.length;for(let h=0,v=Math.min(y,F);h<v;++h)if(e[h]!==n[h]){y=e[h],F=n[h];break}return y<F?-1:F<y?1:0},E.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},E.concat=function(e,n){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return E.alloc(0);let y;if(n===void 0)for(n=0,y=0;y<e.length;++y)n+=e[y].length;const F=E.allocUnsafe(n);let h=0;for(y=0;y<e.length;++y){let v=e[y];if(te(v,Uint8Array))h+v.length>F.length?(E.isBuffer(v)||(v=E.from(v)),v.copy(F,h)):Uint8Array.prototype.set.call(F,v,h);else if(E.isBuffer(v))v.copy(F,h);else throw new TypeError('"list" argument must be an Array of Buffers');h+=v.length}return F};function b(d,e){if(E.isBuffer(d))return d.length;if(ArrayBuffer.isView(d)||te(d,ArrayBuffer))return d.byteLength;if(typeof d!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof d);const n=d.length,y=arguments.length>2&&arguments[2]===!0;if(!y&&n===0)return 0;let F=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return Be(d).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return n*2;case"hex":return n>>>1;case"base64":return Ke(d).length;default:if(F)return y?-1:Be(d).length;e=(""+e).toLowerCase(),F=!0}}E.byteLength=b;function L(d,e,n){let y=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((n===void 0||n>this.length)&&(n=this.length),n<=0)||(n>>>=0,e>>>=0,n<=e))return"";for(d||(d="utf8");;)switch(d){case"hex":return ve(this,e,n);case"utf8":case"utf-8":return X(this,e,n);case"ascii":return ge(this,e,n);case"latin1":case"binary":return _e(this,e,n);case"base64":return V(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ne(this,e,n);default:if(y)throw new TypeError("Unknown encoding: "+d);d=(d+"").toLowerCase(),y=!0}}E.prototype._isBuffer=!0;function N(d,e,n){const y=d[e];d[e]=d[n],d[n]=y}E.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<e;n+=2)N(this,n,n+1);return this},E.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<e;n+=4)N(this,n,n+3),N(this,n+1,n+2);return this},E.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<e;n+=8)N(this,n,n+7),N(this,n+1,n+6),N(this,n+2,n+5),N(this,n+3,n+4);return this},E.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?X(this,0,e):L.apply(this,arguments)},E.prototype.toLocaleString=E.prototype.toString,E.prototype.equals=function(e){if(!E.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:E.compare(this,e)===0},E.prototype.inspect=function(){let e="";const n=r.INSPECT_MAX_BYTES;return e=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(e+=" ... "),"<Buffer "+e+">"},_&&(E.prototype[_]=E.prototype.inspect),E.prototype.compare=function(e,n,y,F,h){if(te(e,Uint8Array)&&(e=E.from(e,e.offset,e.byteLength)),!E.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(n===void 0&&(n=0),y===void 0&&(y=e?e.length:0),F===void 0&&(F=0),h===void 0&&(h=this.length),n<0||y>e.length||F<0||h>this.length)throw new RangeError("out of range index");if(F>=h&&n>=y)return 0;if(F>=h)return-1;if(n>=y)return 1;if(n>>>=0,y>>>=0,F>>>=0,h>>>=0,this===e)return 0;let v=h-F,S=y-n;const A=Math.min(v,S),C=this.slice(F,h),O=e.slice(n,y);for(let x=0;x<A;++x)if(C[x]!==O[x]){v=C[x],S=O[x];break}return v<S?-1:S<v?1:0};function D(d,e,n,y,F){if(d.length===0)return-1;if(typeof n=="string"?(y=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,Ce(n)&&(n=F?0:d.length-1),n<0&&(n=d.length+n),n>=d.length){if(F)return-1;n=d.length-1}else if(n<0)if(F)n=0;else return-1;if(typeof e=="string"&&(e=E.from(e,y)),E.isBuffer(e))return e.length===0?-1:U(d,e,n,y,F);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?F?Uint8Array.prototype.indexOf.call(d,e,n):Uint8Array.prototype.lastIndexOf.call(d,e,n):U(d,[e],n,y,F);throw new TypeError("val must be string, number or Buffer")}function U(d,e,n,y,F){let h=1,v=d.length,S=e.length;if(y!==void 0&&(y=String(y).toLowerCase(),y==="ucs2"||y==="ucs-2"||y==="utf16le"||y==="utf-16le")){if(d.length<2||e.length<2)return-1;h=2,v/=2,S/=2,n/=2}function A(O,x){return h===1?O[x]:O.readUInt16BE(x*h)}let C;if(F){let O=-1;for(C=n;C<v;C++)if(A(d,C)===A(e,O===-1?0:C-O)){if(O===-1&&(O=C),C-O+1===S)return O*h}else O!==-1&&(C-=C-O),O=-1}else for(n+S>v&&(n=v-S),C=n;C>=0;C--){let O=!0;for(let x=0;x<S;x++)if(A(d,C+x)!==A(e,x)){O=!1;break}if(O)return C}return-1}E.prototype.includes=function(e,n,y){return this.indexOf(e,n,y)!==-1},E.prototype.indexOf=function(e,n,y){return D(this,e,n,y,!0)},E.prototype.lastIndexOf=function(e,n,y){return D(this,e,n,y,!1)};function H(d,e,n,y){n=Number(n)||0;const F=d.length-n;y?(y=Number(y),y>F&&(y=F)):y=F;const h=e.length;y>h/2&&(y=h/2);let v;for(v=0;v<y;++v){const S=parseInt(e.substr(v*2,2),16);if(Ce(S))return v;d[n+v]=S}return v}function k(d,e,n,y){return xe(Be(e,d.length-n),d,n,y)}function M(d,e,n,y){return xe(ft(e),d,n,y)}function z(d,e,n,y){return xe(Ke(e),d,n,y)}function q(d,e,n,y){return xe(Xe(e,d.length-n),d,n,y)}E.prototype.write=function(e,n,y,F){if(n===void 0)F="utf8",y=this.length,n=0;else if(y===void 0&&typeof n=="string")F=n,y=this.length,n=0;else if(isFinite(n))n=n>>>0,isFinite(y)?(y=y>>>0,F===void 0&&(F="utf8")):(F=y,y=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const h=this.length-n;if((y===void 0||y>h)&&(y=h),e.length>0&&(y<0||n<0)||n>this.length)throw new RangeError("Attempt to write outside buffer bounds");F||(F="utf8");let v=!1;for(;;)switch(F){case"hex":return H(this,e,n,y);case"utf8":case"utf-8":return k(this,e,n,y);case"ascii":case"latin1":case"binary":return M(this,e,n,y);case"base64":return z(this,e,n,y);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return q(this,e,n,y);default:if(v)throw new TypeError("Unknown encoding: "+F);F=(""+F).toLowerCase(),v=!0}},E.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function V(d,e,n){return e===0&&n===d.length?u.fromByteArray(d):u.fromByteArray(d.slice(e,n))}function X(d,e,n){n=Math.min(d.length,n);const y=[];let F=e;for(;F<n;){const h=d[F];let v=null,S=h>239?4:h>223?3:h>191?2:1;if(F+S<=n){let A,C,O,x;switch(S){case 1:h<128&&(v=h);break;case 2:A=d[F+1],(A&192)===128&&(x=(h&31)<<6|A&63,x>127&&(v=x));break;case 3:A=d[F+1],C=d[F+2],(A&192)===128&&(C&192)===128&&(x=(h&15)<<12|(A&63)<<6|C&63,x>2047&&(x<55296||x>57343)&&(v=x));break;case 4:A=d[F+1],C=d[F+2],O=d[F+3],(A&192)===128&&(C&192)===128&&(O&192)===128&&(x=(h&15)<<18|(A&63)<<12|(C&63)<<6|O&63,x>65535&&x<1114112&&(v=x))}}v===null?(v=65533,S=1):v>65535&&(v-=65536,y.push(v>>>10&1023|55296),v=56320|v&1023),y.push(v),F+=S}return de(y)}const oe=4096;function de(d){const e=d.length;if(e<=oe)return String.fromCharCode.apply(String,d);let n="",y=0;for(;y<e;)n+=String.fromCharCode.apply(String,d.slice(y,y+=oe));return n}function ge(d,e,n){let y="";n=Math.min(d.length,n);for(let F=e;F<n;++F)y+=String.fromCharCode(d[F]&127);return y}function _e(d,e,n){let y="";n=Math.min(d.length,n);for(let F=e;F<n;++F)y+=String.fromCharCode(d[F]);return y}function ve(d,e,n){const y=d.length;(!e||e<0)&&(e=0),(!n||n<0||n>y)&&(n=y);let F="";for(let h=e;h<n;++h)F+=dt[d[h]];return F}function Ne(d,e,n){const y=d.slice(e,n);let F="";for(let h=0;h<y.length-1;h+=2)F+=String.fromCharCode(y[h]+y[h+1]*256);return F}E.prototype.slice=function(e,n){const y=this.length;e=~~e,n=n===void 0?y:~~n,e<0?(e+=y,e<0&&(e=0)):e>y&&(e=y),n<0?(n+=y,n<0&&(n=0)):n>y&&(n=y),n<e&&(n=e);const F=this.subarray(e,n);return Object.setPrototypeOf(F,E.prototype),F};function j(d,e,n){if(d%1!==0||d<0)throw new RangeError("offset is not uint");if(d+e>n)throw new RangeError("Trying to access beyond buffer length")}E.prototype.readUintLE=E.prototype.readUIntLE=function(e,n,y){e=e>>>0,n=n>>>0,y||j(e,n,this.length);let F=this[e],h=1,v=0;for(;++v<n&&(h*=256);)F+=this[e+v]*h;return F},E.prototype.readUintBE=E.prototype.readUIntBE=function(e,n,y){e=e>>>0,n=n>>>0,y||j(e,n,this.length);let F=this[e+--n],h=1;for(;n>0&&(h*=256);)F+=this[e+--n]*h;return F},E.prototype.readUint8=E.prototype.readUInt8=function(e,n){return e=e>>>0,n||j(e,1,this.length),this[e]},E.prototype.readUint16LE=E.prototype.readUInt16LE=function(e,n){return e=e>>>0,n||j(e,2,this.length),this[e]|this[e+1]<<8},E.prototype.readUint16BE=E.prototype.readUInt16BE=function(e,n){return e=e>>>0,n||j(e,2,this.length),this[e]<<8|this[e+1]},E.prototype.readUint32LE=E.prototype.readUInt32LE=function(e,n){return e=e>>>0,n||j(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},E.prototype.readUint32BE=E.prototype.readUInt32BE=function(e,n){return e=e>>>0,n||j(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},E.prototype.readBigUInt64LE=ae(function(e){e=e>>>0,me(e,"offset");const n=this[e],y=this[e+7];(n===void 0||y===void 0)&&Fe(e,this.length-8);const F=n+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,h=this[++e]+this[++e]*2**8+this[++e]*2**16+y*2**24;return BigInt(F)+(BigInt(h)<<BigInt(32))}),E.prototype.readBigUInt64BE=ae(function(e){e=e>>>0,me(e,"offset");const n=this[e],y=this[e+7];(n===void 0||y===void 0)&&Fe(e,this.length-8);const F=n*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],h=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+y;return(BigInt(F)<<BigInt(32))+BigInt(h)}),E.prototype.readIntLE=function(e,n,y){e=e>>>0,n=n>>>0,y||j(e,n,this.length);let F=this[e],h=1,v=0;for(;++v<n&&(h*=256);)F+=this[e+v]*h;return h*=128,F>=h&&(F-=Math.pow(2,8*n)),F},E.prototype.readIntBE=function(e,n,y){e=e>>>0,n=n>>>0,y||j(e,n,this.length);let F=n,h=1,v=this[e+--F];for(;F>0&&(h*=256);)v+=this[e+--F]*h;return h*=128,v>=h&&(v-=Math.pow(2,8*n)),v},E.prototype.readInt8=function(e,n){return e=e>>>0,n||j(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},E.prototype.readInt16LE=function(e,n){e=e>>>0,n||j(e,2,this.length);const y=this[e]|this[e+1]<<8;return y&32768?y|4294901760:y},E.prototype.readInt16BE=function(e,n){e=e>>>0,n||j(e,2,this.length);const y=this[e+1]|this[e]<<8;return y&32768?y|4294901760:y},E.prototype.readInt32LE=function(e,n){return e=e>>>0,n||j(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},E.prototype.readInt32BE=function(e,n){return e=e>>>0,n||j(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},E.prototype.readBigInt64LE=ae(function(e){e=e>>>0,me(e,"offset");const n=this[e],y=this[e+7];(n===void 0||y===void 0)&&Fe(e,this.length-8);const F=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(y<<24);return(BigInt(F)<<BigInt(32))+BigInt(n+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),E.prototype.readBigInt64BE=ae(function(e){e=e>>>0,me(e,"offset");const n=this[e],y=this[e+7];(n===void 0||y===void 0)&&Fe(e,this.length-8);const F=(n<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(F)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+y)}),E.prototype.readFloatLE=function(e,n){return e=e>>>0,n||j(e,4,this.length),i.read(this,e,!0,23,4)},E.prototype.readFloatBE=function(e,n){return e=e>>>0,n||j(e,4,this.length),i.read(this,e,!1,23,4)},E.prototype.readDoubleLE=function(e,n){return e=e>>>0,n||j(e,8,this.length),i.read(this,e,!0,52,8)},E.prototype.readDoubleBE=function(e,n){return e=e>>>0,n||j(e,8,this.length),i.read(this,e,!1,52,8)};function W(d,e,n,y,F,h){if(!E.isBuffer(d))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>F||e<h)throw new RangeError('"value" argument is out of bounds');if(n+y>d.length)throw new RangeError("Index out of range")}E.prototype.writeUintLE=E.prototype.writeUIntLE=function(e,n,y,F){if(e=+e,n=n>>>0,y=y>>>0,!F){const S=Math.pow(2,8*y)-1;W(this,e,n,y,S,0)}let h=1,v=0;for(this[n]=e&255;++v<y&&(h*=256);)this[n+v]=e/h&255;return n+y},E.prototype.writeUintBE=E.prototype.writeUIntBE=function(e,n,y,F){if(e=+e,n=n>>>0,y=y>>>0,!F){const S=Math.pow(2,8*y)-1;W(this,e,n,y,S,0)}let h=y-1,v=1;for(this[n+h]=e&255;--h>=0&&(v*=256);)this[n+h]=e/v&255;return n+y},E.prototype.writeUint8=E.prototype.writeUInt8=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,1,255,0),this[n]=e&255,n+1},E.prototype.writeUint16LE=E.prototype.writeUInt16LE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,2,65535,0),this[n]=e&255,this[n+1]=e>>>8,n+2},E.prototype.writeUint16BE=E.prototype.writeUInt16BE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,2,65535,0),this[n]=e>>>8,this[n+1]=e&255,n+2},E.prototype.writeUint32LE=E.prototype.writeUInt32LE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,4,4294967295,0),this[n+3]=e>>>24,this[n+2]=e>>>16,this[n+1]=e>>>8,this[n]=e&255,n+4},E.prototype.writeUint32BE=E.prototype.writeUInt32BE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,4,4294967295,0),this[n]=e>>>24,this[n+1]=e>>>16,this[n+2]=e>>>8,this[n+3]=e&255,n+4};function ne(d,e,n,y,F){Ve(e,y,F,d,n,7);let h=Number(e&BigInt(4294967295));d[n++]=h,h=h>>8,d[n++]=h,h=h>>8,d[n++]=h,h=h>>8,d[n++]=h;let v=Number(e>>BigInt(32)&BigInt(4294967295));return d[n++]=v,v=v>>8,d[n++]=v,v=v>>8,d[n++]=v,v=v>>8,d[n++]=v,n}function Re(d,e,n,y,F){Ve(e,y,F,d,n,7);let h=Number(e&BigInt(4294967295));d[n+7]=h,h=h>>8,d[n+6]=h,h=h>>8,d[n+5]=h,h=h>>8,d[n+4]=h;let v=Number(e>>BigInt(32)&BigInt(4294967295));return d[n+3]=v,v=v>>8,d[n+2]=v,v=v>>8,d[n+1]=v,v=v>>8,d[n]=v,n+8}E.prototype.writeBigUInt64LE=ae(function(e,n=0){return ne(this,e,n,BigInt(0),BigInt("0xffffffffffffffff"))}),E.prototype.writeBigUInt64BE=ae(function(e,n=0){return Re(this,e,n,BigInt(0),BigInt("0xffffffffffffffff"))}),E.prototype.writeIntLE=function(e,n,y,F){if(e=+e,n=n>>>0,!F){const A=Math.pow(2,8*y-1);W(this,e,n,y,A-1,-A)}let h=0,v=1,S=0;for(this[n]=e&255;++h<y&&(v*=256);)e<0&&S===0&&this[n+h-1]!==0&&(S=1),this[n+h]=(e/v>>0)-S&255;return n+y},E.prototype.writeIntBE=function(e,n,y,F){if(e=+e,n=n>>>0,!F){const A=Math.pow(2,8*y-1);W(this,e,n,y,A-1,-A)}let h=y-1,v=1,S=0;for(this[n+h]=e&255;--h>=0&&(v*=256);)e<0&&S===0&&this[n+h+1]!==0&&(S=1),this[n+h]=(e/v>>0)-S&255;return n+y},E.prototype.writeInt8=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,1,127,-128),e<0&&(e=255+e+1),this[n]=e&255,n+1},E.prototype.writeInt16LE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,2,32767,-32768),this[n]=e&255,this[n+1]=e>>>8,n+2},E.prototype.writeInt16BE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,2,32767,-32768),this[n]=e>>>8,this[n+1]=e&255,n+2},E.prototype.writeInt32LE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,4,2147483647,-2147483648),this[n]=e&255,this[n+1]=e>>>8,this[n+2]=e>>>16,this[n+3]=e>>>24,n+4},E.prototype.writeInt32BE=function(e,n,y){return e=+e,n=n>>>0,y||W(this,e,n,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[n]=e>>>24,this[n+1]=e>>>16,this[n+2]=e>>>8,this[n+3]=e&255,n+4},E.prototype.writeBigInt64LE=ae(function(e,n=0){return ne(this,e,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),E.prototype.writeBigInt64BE=ae(function(e,n=0){return Re(this,e,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Te(d,e,n,y,F,h){if(n+y>d.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Se(d,e,n,y,F){return e=+e,n=n>>>0,F||Te(d,e,n,4),i.write(d,e,n,y,23,4),n+4}E.prototype.writeFloatLE=function(e,n,y){return Se(this,e,n,!0,y)},E.prototype.writeFloatBE=function(e,n,y){return Se(this,e,n,!1,y)};function pe(d,e,n,y,F){return e=+e,n=n>>>0,F||Te(d,e,n,8),i.write(d,e,n,y,52,8),n+8}E.prototype.writeDoubleLE=function(e,n,y){return pe(this,e,n,!0,y)},E.prototype.writeDoubleBE=function(e,n,y){return pe(this,e,n,!1,y)},E.prototype.copy=function(e,n,y,F){if(!E.isBuffer(e))throw new TypeError("argument should be a Buffer");if(y||(y=0),!F&&F!==0&&(F=this.length),n>=e.length&&(n=e.length),n||(n=0),F>0&&F<y&&(F=y),F===y||e.length===0||this.length===0)return 0;if(n<0)throw new RangeError("targetStart out of bounds");if(y<0||y>=this.length)throw new RangeError("Index out of range");if(F<0)throw new RangeError("sourceEnd out of bounds");F>this.length&&(F=this.length),e.length-n<F-y&&(F=e.length-n+y);const h=F-y;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(n,y,F):Uint8Array.prototype.set.call(e,this.subarray(y,F),n),h},E.prototype.fill=function(e,n,y,F){if(typeof e=="string"){if(typeof n=="string"?(F=n,n=0,y=this.length):typeof y=="string"&&(F=y,y=this.length),F!==void 0&&typeof F!="string")throw new TypeError("encoding must be a string");if(typeof F=="string"&&!E.isEncoding(F))throw new TypeError("Unknown encoding: "+F);if(e.length===1){const v=e.charCodeAt(0);(F==="utf8"&&v<128||F==="latin1")&&(e=v)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(n<0||this.length<n||this.length<y)throw new RangeError("Out of range index");if(y<=n)return this;n=n>>>0,y=y===void 0?this.length:y>>>0,e||(e=0);let h;if(typeof e=="number")for(h=n;h<y;++h)this[h]=e;else{const v=E.isBuffer(e)?e:E.from(e,F),S=v.length;if(S===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(h=0;h<y-n;++h)this[h+n]=v[h%S]}return this};const ee={};function ue(d,e,n){ee[d]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${d}]`,this.stack,delete this.name}get code(){return d}set code(F){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:F,writable:!0})}toString(){return`${this.name} [${d}]: ${this.message}`}}}ue("ERR_BUFFER_OUT_OF_BOUNDS",function(d){return d?`${d} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ue("ERR_INVALID_ARG_TYPE",function(d,e){return`The "${d}" argument must be of type number. Received type ${typeof e}`},TypeError),ue("ERR_OUT_OF_RANGE",function(d,e,n){let y=`The value of "${d}" is out of range.`,F=n;return Number.isInteger(n)&&Math.abs(n)>2**32?F=Ee(String(n)):typeof n=="bigint"&&(F=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(F=Ee(F)),F+="n"),y+=` It must be ${e}. Received ${F}`,y},RangeError);function Ee(d){let e="",n=d.length;const y=d[0]==="-"?1:0;for(;n>=y+4;n-=3)e=`_${d.slice(n-3,n)}${e}`;return`${d.slice(0,n)}${e}`}function ct(d,e,n){me(e,"offset"),(d[e]===void 0||d[e+n]===void 0)&&Fe(e,d.length-(n+1))}function Ve(d,e,n,y,F,h){if(d>n||d<e){const v=typeof e=="bigint"?"n":"";let S;throw e===0||e===BigInt(0)?S=`>= 0${v} and < 2${v} ** ${(h+1)*8}${v}`:S=`>= -(2${v} ** ${(h+1)*8-1}${v}) and < 2 ** ${(h+1)*8-1}${v}`,new ee.ERR_OUT_OF_RANGE("value",S,d)}ct(y,F,h)}function me(d,e){if(typeof d!="number")throw new ee.ERR_INVALID_ARG_TYPE(e,"number",d)}function Fe(d,e,n){throw Math.floor(d)!==d?(me(d,n),new ee.ERR_OUT_OF_RANGE("offset","an integer",d)):e<0?new ee.ERR_BUFFER_OUT_OF_BOUNDS:new ee.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,d)}const lt=/[^+/0-9A-Za-z-_]/g;function ht(d){if(d=d.split("=")[0],d=d.trim().replace(lt,""),d.length<2)return"";for(;d.length%4!==0;)d=d+"=";return d}function Be(d,e){e=e||1/0;let n;const y=d.length;let F=null;const h=[];for(let v=0;v<y;++v){if(n=d.charCodeAt(v),n>55295&&n<57344){if(!F){if(n>56319){(e-=3)>-1&&h.push(239,191,189);continue}else if(v+1===y){(e-=3)>-1&&h.push(239,191,189);continue}F=n;continue}if(n<56320){(e-=3)>-1&&h.push(239,191,189),F=n;continue}n=(F-55296<<10|n-56320)+65536}else F&&(e-=3)>-1&&h.push(239,191,189);if(F=null,n<128){if((e-=1)<0)break;h.push(n)}else if(n<2048){if((e-=2)<0)break;h.push(n>>6|192,n&63|128)}else if(n<65536){if((e-=3)<0)break;h.push(n>>12|224,n>>6&63|128,n&63|128)}else if(n<1114112){if((e-=4)<0)break;h.push(n>>18|240,n>>12&63|128,n>>6&63|128,n&63|128)}else throw new Error("Invalid code point")}return h}function ft(d){const e=[];for(let n=0;n<d.length;++n)e.push(d.charCodeAt(n)&255);return e}function Xe(d,e){let n,y,F;const h=[];for(let v=0;v<d.length&&!((e-=2)<0);++v)n=d.charCodeAt(v),y=n>>8,F=n%256,h.push(F),h.push(y);return h}function Ke(d){return u.toByteArray(ht(d))}function xe(d,e,n,y){let F;for(F=0;F<y&&!(F+n>=e.length||F>=d.length);++F)e[F+n]=d[F];return F}function te(d,e){return d instanceof e||d!=null&&d.constructor!=null&&d.constructor.name!=null&&d.constructor.name===e.name}function Ce(d){return d!==d}const dt=(function(){const d="0123456789abcdef",e=new Array(256);for(let n=0;n<16;++n){const y=n*16;for(let F=0;F<16;++F)e[y+F]=d[n]+d[F]}return e})();function ae(d){return typeof BigInt>"u"?pt:d}function pt(){throw new Error("BigInt not supported")}})(mt)),mt}var Q=Kn(),we={},ze={},yt={},zt;function se(){return zt||(zt=1,(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.Frame=r.Lengths=r.Flags=r.FrameTypes=void 0;var u;(function(i){i[i.RESERVED=0]="RESERVED",i[i.SETUP=1]="SETUP",i[i.LEASE=2]="LEASE",i[i.KEEPALIVE=3]="KEEPALIVE",i[i.REQUEST_RESPONSE=4]="REQUEST_RESPONSE",i[i.REQUEST_FNF=5]="REQUEST_FNF",i[i.REQUEST_STREAM=6]="REQUEST_STREAM",i[i.REQUEST_CHANNEL=7]="REQUEST_CHANNEL",i[i.REQUEST_N=8]="REQUEST_N",i[i.CANCEL=9]="CANCEL",i[i.PAYLOAD=10]="PAYLOAD",i[i.ERROR=11]="ERROR",i[i.METADATA_PUSH=12]="METADATA_PUSH",i[i.RESUME=13]="RESUME",i[i.RESUME_OK=14]="RESUME_OK",i[i.EXT=63]="EXT"})(u=r.FrameTypes||(r.FrameTypes={})),(function(i){i[i.NONE=0]="NONE",i[i.COMPLETE=64]="COMPLETE",i[i.FOLLOWS=128]="FOLLOWS",i[i.IGNORE=512]="IGNORE",i[i.LEASE=64]="LEASE",i[i.METADATA=256]="METADATA",i[i.NEXT=32]="NEXT",i[i.RESPOND=128]="RESPOND",i[i.RESUME_ENABLE=128]="RESUME_ENABLE"})(r.Flags||(r.Flags={})),(function(i){function _(t){return(t&i.METADATA)===i.METADATA}i.hasMetadata=_;function g(t){return(t&i.COMPLETE)===i.COMPLETE}i.hasComplete=g;function R(t){return(t&i.NEXT)===i.NEXT}i.hasNext=R;function f(t){return(t&i.FOLLOWS)===i.FOLLOWS}i.hasFollows=f;function E(t){return(t&i.IGNORE)===i.IGNORE}i.hasIgnore=E;function I(t){return(t&i.RESPOND)===i.RESPOND}i.hasRespond=I;function w(t){return(t&i.LEASE)===i.LEASE}i.hasLease=w;function c(t){return(t&i.RESUME_ENABLE)===i.RESUME_ENABLE}i.hasResume=c})(r.Flags||(r.Flags={})),(function(i){i[i.FRAME=3]="FRAME",i[i.HEADER=6]="HEADER",i[i.METADATA=3]="METADATA",i[i.REQUEST=3]="REQUEST"})(r.Lengths||(r.Lengths={})),(function(i){function _(R){return R.streamId===0}i.isConnection=_;function g(R){return u.REQUEST_RESPONSE<=R.type&&R.type<=u.REQUEST_CHANNEL}i.isRequest=g})(r.Frame||(r.Frame={}))})(yt)),yt}var jt;function gn(){return jt||(jt=1,(function(r){var u=ze&&ze.__generator||function(h,v){var S={label:0,sent:function(){if(O[0]&1)throw O[1];return O[1]},trys:[],ops:[]},A,C,O,x;return x={next:re(0),throw:re(1),return:re(2)},typeof Symbol=="function"&&(x[Symbol.iterator]=function(){return this}),x;function re(B){return function(Pe){return De([B,Pe])}}function De(B){if(A)throw new TypeError("Generator is already executing.");for(;S;)try{if(A=1,C&&(O=B[0]&2?C.return:B[0]?C.throw||((O=C.return)&&O.call(C),0):C.next)&&!(O=O.call(C,B[1])).done)return O;switch(C=0,O&&(B=[B[0]&2,O.value]),B[0]){case 0:case 1:O=B;break;case 4:return S.label++,{value:B[1],done:!1};case 5:S.label++,C=B[1],B=[0];continue;case 7:B=S.ops.pop(),S.trys.pop();continue;default:if(O=S.trys,!(O=O.length>0&&O[O.length-1])&&(B[0]===6||B[0]===2)){S=0;continue}if(B[0]===3&&(!O||B[1]>O[0]&&B[1]<O[3])){S.label=B[1];break}if(B[0]===6&&S.label<O[1]){S.label=O[1],O=B;break}if(O&&S.label<O[2]){S.label=O[2],S.ops.push(B);break}O[2]&&S.ops.pop(),S.trys.pop();continue}B=v.call(h,S)}catch(Pe){B=[6,Pe],C=0}finally{A=O=0}if(B[0]&5)throw B[1];return{value:B[0]?B[1]:void 0,done:!0}}};Object.defineProperty(r,"__esModule",{value:!0}),r.Deserializer=r.sizeOfFrame=r.serializeFrame=r.deserializeFrame=r.serializeFrameWithLength=r.deserializeFrames=r.deserializeFrameWithLength=r.writeUInt64BE=r.readUInt64BE=r.writeUInt24BE=r.readUInt24BE=r.MAX_VERSION=r.MAX_TTL=r.MAX_STREAM_ID=r.MAX_RESUME_LENGTH=r.MAX_REQUEST_N=r.MAX_REQUEST_COUNT=r.MAX_MIME_LENGTH=r.MAX_METADATA_LENGTH=r.MAX_LIFETIME=r.MAX_KEEPALIVE=r.MAX_CODE=r.FRAME_TYPE_OFFFSET=r.FLAGS_MASK=void 0;var i=se();r.FLAGS_MASK=1023,r.FRAME_TYPE_OFFFSET=10,r.MAX_CODE=2147483647,r.MAX_KEEPALIVE=2147483647,r.MAX_LIFETIME=2147483647,r.MAX_METADATA_LENGTH=16777215,r.MAX_MIME_LENGTH=255,r.MAX_REQUEST_COUNT=2147483647,r.MAX_REQUEST_N=2147483647,r.MAX_RESUME_LENGTH=65535,r.MAX_STREAM_ID=2147483647,r.MAX_TTL=2147483647,r.MAX_VERSION=65535;var _=4294967296;function g(h,v){var S=h.readUInt8(v)<<16,A=h.readUInt8(v+1)<<8,C=h.readUInt8(v+2);return S|A|C}r.readUInt24BE=g;function R(h,v,S){return S=h.writeUInt8(v>>>16,S),S=h.writeUInt8(v>>>8&255,S),h.writeUInt8(v&255,S)}r.writeUInt24BE=R;function f(h,v){var S=h.readUInt32BE(v),A=h.readUInt32BE(v+4);return S*_+A}r.readUInt64BE=f;function E(h,v,S){var A=v/_|0,C=v%_;return S=h.writeUInt32BE(A,S),h.writeUInt32BE(C,S)}r.writeUInt64BE=E;var I=6,w=3;function c(h){var v=g(h,0);return s(h.slice(w,w+v))}r.deserializeFrameWithLength=c;function t(h){var v,S,A,C,O,x;return u(this,function(re){switch(re.label){case 0:v=0,re.label=1;case 1:return v+w<h.length?(S=g(h,v),A=v+w,C=A+S,C>h.length?[3,3]:(O=h.slice(A,C),x=s(O),v=C,[4,[x,v]])):[3,3];case 2:return re.sent(),[3,1];case 3:return[2]}})}r.deserializeFrames=t;function l(h){var v=m(h),S=Q.Buffer.allocUnsafe(v.length+w);return R(S,v.length,0),v.copy(S,w),S}r.serializeFrameWithLength=l;function s(h){var v=0,S=h.readInt32BE(v);v+=4;var A=h.readUInt16BE(v);v+=2;var C=A>>>r.FRAME_TYPE_OFFFSET,O=A&r.FLAGS_MASK;switch(C){case i.FrameTypes.SETUP:return L(h,S,O);case i.FrameTypes.PAYLOAD:return ft(h,S,O);case i.FrameTypes.ERROR:return H(h,S,O);case i.FrameTypes.KEEPALIVE:return q(h,S,O);case i.FrameTypes.REQUEST_FNF:return j(h,S,O);case i.FrameTypes.REQUEST_RESPONSE:return W(h,S,O);case i.FrameTypes.REQUEST_STREAM:return pe(h,S,O);case i.FrameTypes.REQUEST_CHANNEL:return ee(h,S,O);case i.FrameTypes.METADATA_PUSH:return ne(h,S,O);case i.FrameTypes.REQUEST_N:return Ve(h,S,O);case i.FrameTypes.RESUME:return te(h,S,O);case i.FrameTypes.RESUME_OK:return pt(h,S,O);case i.FrameTypes.CANCEL:return lt(h,S,O);case i.FrameTypes.LEASE:return de(h,S,O)}}r.deserializeFrame=s;function m(h){switch(h.type){case i.FrameTypes.SETUP:return T(h);case i.FrameTypes.PAYLOAD:return ht(h);case i.FrameTypes.ERROR:return D(h);case i.FrameTypes.KEEPALIVE:return M(h);case i.FrameTypes.REQUEST_FNF:case i.FrameTypes.REQUEST_RESPONSE:return ge(h);case i.FrameTypes.REQUEST_STREAM:case i.FrameTypes.REQUEST_CHANNEL:return Te(h);case i.FrameTypes.METADATA_PUSH:return ve(h);case i.FrameTypes.REQUEST_N:return Ee(h);case i.FrameTypes.RESUME:return Ke(h);case i.FrameTypes.RESUME_OK:return dt(h);case i.FrameTypes.CANCEL:return me(h);case i.FrameTypes.LEASE:return X(h)}}r.serializeFrame=m;function a(h){switch(h.type){case i.FrameTypes.SETUP:return b(h);case i.FrameTypes.PAYLOAD:return Be(h);case i.FrameTypes.ERROR:return U(h);case i.FrameTypes.KEEPALIVE:return z(h);case i.FrameTypes.REQUEST_FNF:case i.FrameTypes.REQUEST_RESPONSE:return _e(h);case i.FrameTypes.REQUEST_STREAM:case i.FrameTypes.REQUEST_CHANNEL:return Se(h);case i.FrameTypes.METADATA_PUSH:return Ne(h);case i.FrameTypes.REQUEST_N:return ct();case i.FrameTypes.RESUME:return xe(h);case i.FrameTypes.RESUME_OK:return ae();case i.FrameTypes.CANCEL:return Fe();case i.FrameTypes.LEASE:return oe(h)}}r.sizeOfFrame=a;var o=14,p=2;function T(h){var v=h.resumeToken!=null?h.resumeToken.byteLength:0,S=h.metadataMimeType!=null?Q.Buffer.byteLength(h.metadataMimeType,"ascii"):0,A=h.dataMimeType!=null?Q.Buffer.byteLength(h.dataMimeType,"ascii"):0,C=e(h),O=Q.Buffer.allocUnsafe(I+o+(v?p+v:0)+S+A+C),x=d(h,O);return x=O.writeUInt16BE(h.majorVersion,x),x=O.writeUInt16BE(h.minorVersion,x),x=O.writeUInt32BE(h.keepAlive,x),x=O.writeUInt32BE(h.lifetime,x),h.flags&i.Flags.RESUME_ENABLE&&(x=O.writeUInt16BE(v,x),h.resumeToken!=null&&(x+=h.resumeToken.copy(O,x))),x=O.writeUInt8(S,x),h.metadataMimeType!=null&&(x+=O.write(h.metadataMimeType,x,x+S,"ascii")),x=O.writeUInt8(A,x),h.dataMimeType!=null&&(x+=O.write(h.dataMimeType,x,x+A,"ascii")),n(h,O,x),O}function b(h){var v=h.resumeToken!=null?h.resumeToken.byteLength:0,S=h.metadataMimeType!=null?Q.Buffer.byteLength(h.metadataMimeType,"ascii"):0,A=h.dataMimeType!=null?Q.Buffer.byteLength(h.dataMimeType,"ascii"):0,C=e(h);return I+o+(v?p+v:0)+S+A+C}function L(h,v,S){h.length;var A=I,C=h.readUInt16BE(A);A+=2;var O=h.readUInt16BE(A);A+=2;var x=h.readInt32BE(A);A+=4;var re=h.readInt32BE(A);A+=4;var De=null;if(S&i.Flags.RESUME_ENABLE){var B=h.readInt16BE(A);A+=2,De=h.slice(A,A+B),A+=B}var Pe=h.readUInt8(A);A+=1;var Ln=h.toString("ascii",A,A+Pe);A+=Pe;var At=h.readUInt8(A);A+=1;var On=h.toString("ascii",A,A+At);A+=At;var bt={data:null,dataMimeType:On,flags:S,keepAlive:x,lifetime:re,majorVersion:C,metadata:null,metadataMimeType:Ln,minorVersion:O,resumeToken:De,streamId:0,type:i.FrameTypes.SETUP};return y(h,bt,A),bt}var N=4;function D(h){var v=h.message!=null?Q.Buffer.byteLength(h.message,"utf8"):0,S=Q.Buffer.allocUnsafe(I+N+v),A=d(h,S);return A=S.writeUInt32BE(h.code,A),h.message!=null&&S.write(h.message,A,A+v,"utf8"),S}function U(h){var v=h.message!=null?Q.Buffer.byteLength(h.message,"utf8"):0;return I+N+v}function H(h,v,S){h.length;var A=I,C=h.readInt32BE(A);A+=4;var O=h.length-A,x="";return O>0&&(x=h.toString("utf8",A,A+O),A+=O),{code:C,flags:S,message:x,streamId:v,type:i.FrameTypes.ERROR}}var k=8;function M(h){var v=h.data!=null?h.data.byteLength:0,S=Q.Buffer.allocUnsafe(I+k+v),A=d(h,S);return A=E(S,h.lastReceivedPosition,A),h.data!=null&&h.data.copy(S,A),S}function z(h){var v=h.data!=null?h.data.byteLength:0;return I+k+v}function q(h,v,S){h.length;var A=I,C=f(h,A);A+=8;var O=null;return A<h.length&&(O=h.slice(A,h.length)),{data:O,flags:S,lastReceivedPosition:C,streamId:0,type:i.FrameTypes.KEEPALIVE}}var V=8;function X(h){var v=h.metadata!=null?h.metadata.byteLength:0,S=Q.Buffer.allocUnsafe(I+V+v),A=d(h,S);return A=S.writeUInt32BE(h.ttl,A),A=S.writeUInt32BE(h.requestCount,A),h.metadata!=null&&h.metadata.copy(S,A),S}function oe(h){var v=h.metadata!=null?h.metadata.byteLength:0;return I+V+v}function de(h,v,S){var A=I,C=h.readUInt32BE(A);A+=4;var O=h.readUInt32BE(A);A+=4;var x=null;return A<h.length&&(x=h.slice(A,h.length)),{flags:S,metadata:x,requestCount:O,streamId:0,ttl:C,type:i.FrameTypes.LEASE}}function ge(h){var v=e(h),S=Q.Buffer.allocUnsafe(I+v),A=d(h,S);return n(h,S,A),S}function _e(h){var v=e(h);return I+v}function ve(h){var v=h.metadata;if(v!=null){var S=Q.Buffer.allocUnsafe(I+v.byteLength),A=d(h,S);return v.copy(S,A),S}else{var S=Q.Buffer.allocUnsafe(I);return d(h,S),S}}function Ne(h){return I+(h.metadata!=null?h.metadata.byteLength:0)}function j(h,v,S){h.length;var A={data:null,flags:S,metadata:null,streamId:v,type:i.FrameTypes.REQUEST_FNF};return y(h,A,I),A}function W(h,v,S){var A={data:null,flags:S,metadata:null,streamId:v,type:i.FrameTypes.REQUEST_RESPONSE};return y(h,A,I),A}function ne(h,v,S){return{flags:S,metadata:length===I?null:h.slice(I,length),streamId:0,type:i.FrameTypes.METADATA_PUSH}}var Re=4;function Te(h){var v=e(h),S=Q.Buffer.allocUnsafe(I+Re+v),A=d(h,S);return A=S.writeUInt32BE(h.requestN,A),n(h,S,A),S}function Se(h){var v=e(h);return I+Re+v}function pe(h,v,S){h.length;var A=I,C=h.readInt32BE(A);A+=4;var O={data:null,flags:S,metadata:null,requestN:C,streamId:v,type:i.FrameTypes.REQUEST_STREAM};return y(h,O,A),O}function ee(h,v,S){h.length;var A=I,C=h.readInt32BE(A);A+=4;var O={data:null,flags:S,metadata:null,requestN:C,streamId:v,type:i.FrameTypes.REQUEST_CHANNEL};return y(h,O,A),O}var ue=4;function Ee(h){var v=Q.Buffer.allocUnsafe(I+ue),S=d(h,v);return v.writeUInt32BE(h.requestN,S),v}function ct(h){return I+ue}function Ve(h,v,S){h.length;var A=h.readInt32BE(I);return{flags:S,requestN:A,streamId:v,type:i.FrameTypes.REQUEST_N}}function me(h){var v=Q.Buffer.allocUnsafe(I);return d(h,v),v}function Fe(h){return I}function lt(h,v,S){return h.length,{flags:S,streamId:v,type:i.FrameTypes.CANCEL}}function ht(h){var v=e(h),S=Q.Buffer.allocUnsafe(I+v),A=d(h,S);return n(h,S,A),S}function Be(h){var v=e(h);return I+v}function ft(h,v,S){h.length;var A={data:null,flags:S,metadata:null,streamId:v,type:i.FrameTypes.PAYLOAD};return y(h,A,I),A}var Xe=22;function Ke(h){var v=h.resumeToken.byteLength,S=Q.Buffer.allocUnsafe(I+Xe+v),A=d(h,S);return A=S.writeUInt16BE(h.majorVersion,A),A=S.writeUInt16BE(h.minorVersion,A),A=S.writeUInt16BE(v,A),A+=h.resumeToken.copy(S,A),A=E(S,h.serverPosition,A),E(S,h.clientPosition,A),S}function xe(h){var v=h.resumeToken.byteLength;return I+Xe+v}function te(h,v,S){h.length;var A=I,C=h.readUInt16BE(A);A+=2;var O=h.readUInt16BE(A);A+=2;var x=h.readInt16BE(A);A+=2;var re=h.slice(A,A+x);A+=x;var De=f(h,A);A+=8;var B=f(h,A);return A+=8,{clientPosition:B,flags:S,majorVersion:C,minorVersion:O,resumeToken:re,serverPosition:De,streamId:0,type:i.FrameTypes.RESUME}}var Ce=8;function dt(h){var v=Q.Buffer.allocUnsafe(I+Ce),S=d(h,v);return E(v,h.clientPosition,S),v}function ae(h){return I+Ce}function pt(h,v,S){h.length;var A=f(h,I);return{clientPosition:A,flags:S,streamId:0,type:i.FrameTypes.RESUME_OK}}function d(h,v){var S=v.writeInt32BE(h.streamId,0);return v.writeUInt16BE(h.type<<r.FRAME_TYPE_OFFFSET|h.flags&r.FLAGS_MASK,S)}function e(h){var v=0;return h.data!=null&&(v+=h.data.byteLength),i.Flags.hasMetadata(h.flags)&&(v+=w,h.metadata!=null&&(v+=h.metadata.byteLength)),v}function n(h,v,S){if(i.Flags.hasMetadata(h.flags))if(h.metadata!=null){var A=h.metadata.byteLength;S=R(v,A,S),S+=h.metadata.copy(v,S)}else S=R(v,0,S);h.data!=null&&h.data.copy(v,S)}function y(h,v,S){if(i.Flags.hasMetadata(v.flags)){var A=g(h,S);S+=w,A>0&&(v.metadata=h.slice(S,S+A),S+=A)}S<h.length&&(v.data=h.slice(S,h.length))}var F=(function(){function h(){}return h.prototype.deserializeFrame=function(v){return s(v)},h.prototype.deserializeFrameWithLength=function(v){return c(v)},h.prototype.deserializeFrames=function(v){return t(v)},h})();r.Deserializer=F})(ze)),ze}var gt={},Wt;function Yn(){return Wt||(Wt=1,Object.defineProperty(gt,"__esModule",{value:!0})),gt}var Ie={},Gt;function _n(){if(Gt)return Ie;Gt=1;var r=Ie&&Ie.__values||function(i){var _=typeof Symbol=="function"&&Symbol.iterator,g=_&&i[_],R=0;if(g)return g.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&R>=i.length&&(i=void 0),{value:i&&i[R++],done:!i}}};throw new TypeError(_?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.Deferred=void 0;var u=(function(){function i(){this._done=!1,this.onCloseCallbacks=[]}return Object.defineProperty(i.prototype,"done",{get:function(){return this._done},enumerable:!1,configurable:!0}),i.prototype.close=function(_){var g,R,f,E;if(this.done){console.warn("Trying to close for the second time. ".concat(_?"Dropping error [".concat(_,"]."):""));return}if(this._done=!0,this._error=_,_){try{for(var I=r(this.onCloseCallbacks),w=I.next();!w.done;w=I.next()){var c=w.value;c(_)}}catch(s){g={error:s}}finally{try{w&&!w.done&&(R=I.return)&&R.call(I)}finally{if(g)throw g.error}}return}try{for(var t=r(this.onCloseCallbacks),l=t.next();!l.done;l=t.next()){var c=l.value;c()}}catch(s){f={error:s}}finally{try{l&&!l.done&&(E=t.return)&&E.call(t)}finally{if(f)throw f.error}}},i.prototype.onClose=function(_){if(this._done){_(this._error);return}this.onCloseCallbacks.push(_)},i})();return Ie.Deferred=u,Ie}var je={},Vt;function ye(){return Vt||(Vt=1,(function(r){var u=je&&je.__extends||(function(){var _=function(g,R){return _=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(f,E){f.__proto__=E}||function(f,E){for(var I in E)Object.prototype.hasOwnProperty.call(E,I)&&(f[I]=E[I])},_(g,R)};return function(g,R){if(typeof R!="function"&&R!==null)throw new TypeError("Class extends value "+String(R)+" is not a constructor or null");_(g,R);function f(){this.constructor=g}g.prototype=R===null?Object.create(R):(f.prototype=R.prototype,new f)}})();Object.defineProperty(r,"__esModule",{value:!0}),r.ErrorCodes=r.RSocketError=void 0;var i=(function(_){u(g,_);function g(R,f){var E=_.call(this,f)||this;return E.code=R,E}return g})(Error);r.RSocketError=i,(function(_){_[_.RESERVED=0]="RESERVED",_[_.INVALID_SETUP=1]="INVALID_SETUP",_[_.UNSUPPORTED_SETUP=2]="UNSUPPORTED_SETUP",_[_.REJECTED_SETUP=3]="REJECTED_SETUP",_[_.REJECTED_RESUME=4]="REJECTED_RESUME",_[_.CONNECTION_CLOSE=258]="CONNECTION_CLOSE",_[_.CONNECTION_ERROR=257]="CONNECTION_ERROR",_[_.APPLICATION_ERROR=513]="APPLICATION_ERROR",_[_.REJECTED=514]="REJECTED",_[_.CANCELED=515]="CANCELED",_[_.INVALID=516]="INVALID",_[_.RESERVED_EXTENSION=4294967295]="RESERVED_EXTENSION"})(r.ErrorCodes||(r.ErrorCodes={}))})(je)),je}var _t={},Xt;function Jn(){return Xt||(Xt=1,Object.defineProperty(_t,"__esModule",{value:!0})),_t}var ce={},le={},Kt;function vn(){return Kt||(Kt=1,(function(r){var u=le&&le.__extends||(function(){var t=function(l,s){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,a){m.__proto__=a}||function(m,a){for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(m[o]=a[o])},t(l,s)};return function(l,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");t(l,s);function m(){this.constructor=l}l.prototype=s===null?Object.create(s):(m.prototype=s.prototype,new m)}})(),i=le&&le.__awaiter||function(t,l,s,m){function a(o){return o instanceof s?o:new s(function(p){p(o)})}return new(s||(s=Promise))(function(o,p){function T(N){try{L(m.next(N))}catch(D){p(D)}}function b(N){try{L(m.throw(N))}catch(D){p(D)}}function L(N){N.done?o(N.value):a(N.value).then(T,b)}L((m=m.apply(t,l||[])).next())})},_=le&&le.__generator||function(t,l){var s={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},m,a,o,p;return p={next:T(0),throw:T(1),return:T(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function T(L){return function(N){return b([L,N])}}function b(L){if(m)throw new TypeError("Generator is already executing.");for(;s;)try{if(m=1,a&&(o=L[0]&2?a.return:L[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,L[1])).done)return o;switch(a=0,o&&(L=[L[0]&2,o.value]),L[0]){case 0:case 1:o=L;break;case 4:return s.label++,{value:L[1],done:!1};case 5:s.label++,a=L[1],L=[0];continue;case 7:L=s.ops.pop(),s.trys.pop();continue;default:if(o=s.trys,!(o=o.length>0&&o[o.length-1])&&(L[0]===6||L[0]===2)){s=0;continue}if(L[0]===3&&(!o||L[1]>o[0]&&L[1]<o[3])){s.label=L[1];break}if(L[0]===6&&s.label<o[1]){s.label=o[1],o=L;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(L);break}o[2]&&s.ops.pop(),s.trys.pop();continue}L=l.call(t,s)}catch(N){L=[6,N],a=0}finally{m=o=0}if(L[0]&5)throw L[1];return{value:L[0]?L[1]:void 0,done:!0}}};Object.defineProperty(r,"__esModule",{value:!0}),r.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=r.ResumableClientServerInputMultiplexerDemultiplexer=r.ClientServerInputMultiplexerDemultiplexer=r.StreamIdGenerator=void 0;var g=ut(),R=_n(),f=ye(),E=se();(function(t){function l(m){return new s(m)}t.create=l;var s=(function(){function m(a){this.currentId=a}return m.prototype.next=function(a){var o=this.currentId+2;a(o)&&(this.currentId=o)},m})()})(r.StreamIdGenerator||(r.StreamIdGenerator={}));var I=(function(t){u(l,t);function l(s,m,a){var o=t.call(this)||this;return o.streamIdSupplier=s,o.outbound=m,o.closeable=a,o.registry={},a.onClose(o.close.bind(o)),o}return l.prototype.handle=function(s){if(E.Frame.isConnection(s)){if(s.type===g.FrameTypes.RESERVED)return;this.connectionFramesHandler.handle(s)}else if(E.Frame.isRequest(s)){if(this.registry[s.streamId])return;this.requestFramesHandler.handle(s,this)}else{var m=this.registry[s.streamId];if(!m)return;m.handle(s)}},l.prototype.connectionInbound=function(s){if(this.connectionFramesHandler)throw new Error("Connection frame handler has already been installed");this.connectionFramesHandler=s},l.prototype.handleRequestStream=function(s){if(this.requestFramesHandler)throw new Error("Stream handler has already been installed");this.requestFramesHandler=s},l.prototype.send=function(s){this.outbound.send(s)},Object.defineProperty(l.prototype,"connectionOutbound",{get:function(){return this},enumerable:!1,configurable:!0}),l.prototype.createRequestStream=function(s){var m=this;if(this.done){s.handleReject(new Error("Already closed"));return}var a=this.registry;this.streamIdSupplier.next(function(o){return s.handleReady(o,m)},Object.keys(a))},l.prototype.connect=function(s){this.registry[s.streamId]=s},l.prototype.disconnect=function(s){delete this.registry[s.streamId]},l.prototype.close=function(s){if(this.done){t.prototype.close.call(this,s);return}for(var m in this.registry){var a=this.registry[m];a.close(new Error("Closed. ".concat(s?"Original cause [".concat(s,"]."):"")))}t.prototype.close.call(this,s)},l})(R.Deferred);r.ClientServerInputMultiplexerDemultiplexer=I;var w=(function(t){u(l,t);function l(s,m,a,o,p,T,b){var L=t.call(this,s,m,new R.Deferred)||this;return L.frameStore=o,L.token=p,L.sessionTimeout=b,T instanceof Function?L.reconnector=T:L.sessionStore=T,a.onClose(L.handleConnectionClose.bind(L)),L}return l.prototype.send=function(s){if(E.Frame.isConnection(s)){if(s.type===g.FrameTypes.KEEPALIVE)s.lastReceivedPosition=this.frameStore.lastReceivedFramePosition;else if(s.type===g.FrameTypes.ERROR){this.outbound.send(s),this.sessionStore&&delete this.sessionStore[this.token],t.prototype.close.call(this,new f.RSocketError(s.code,s.message));return}}else this.frameStore.store(s);this.outbound.send(s)},l.prototype.handle=function(s){if(E.Frame.isConnection(s)){if(s.type===g.FrameTypes.KEEPALIVE)try{this.frameStore.dropTo(s.lastReceivedPosition)}catch(m){this.outbound.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:m.code,message:m.message}),this.close(m)}else if(s.type===g.FrameTypes.ERROR){t.prototype.handle.call(this,s),this.sessionStore&&delete this.sessionStore[this.token],t.prototype.close.call(this,new f.RSocketError(s.code,s.message));return}}else this.frameStore.record(s);t.prototype.handle.call(this,s)},l.prototype.resume=function(s,m,a){switch(this.outbound=m,s.type){case g.FrameTypes.RESUME:{if(clearTimeout(this.timeoutId),this.frameStore.lastReceivedFramePosition<s.clientPosition){var o=new f.RSocketError(g.ErrorCodes.REJECTED_RESUME,"Impossible to resume since first available client frame position is greater than last received server frame position");this.outbound.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:o.code,message:o.message}),this.close(o);return}try{this.frameStore.dropTo(s.serverPosition)}catch(p){this.outbound.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:p.code,message:p.message}),this.close(p);return}this.outbound.send({type:g.FrameTypes.RESUME_OK,streamId:0,flags:g.Flags.NONE,clientPosition:this.frameStore.lastReceivedFramePosition});break}case g.FrameTypes.RESUME_OK:{try{this.frameStore.dropTo(s.clientPosition)}catch(p){this.outbound.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:p.code,message:p.message}),this.close(p)}break}}this.frameStore.drain(this.outbound.send.bind(this.outbound)),a.onClose(this.handleConnectionClose.bind(this)),this.connectionFramesHandler.resume()},l.prototype.handleConnectionClose=function(s){return i(this,void 0,void 0,function(){var m;return _(this,function(a){switch(a.label){case 0:if(this.connectionFramesHandler.pause(),!this.reconnector)return[3,5];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.reconnector(this,this.frameStore)];case 2:return a.sent(),[3,4];case 3:return m=a.sent(),this.close(m),[3,4];case 4:return[3,6];case 5:this.timeoutId=setTimeout(this.close.bind(this),this.sessionTimeout),a.label=6;case 6:return[2]}})})},l})(I);r.ResumableClientServerInputMultiplexerDemultiplexer=w;var c=(function(){function t(l,s,m){this.outbound=l,this.closeable=s,this.delegate=m,this.resumed=!1}return t.prototype.close=function(){this.delegate.close()},t.prototype.onClose=function(l){this.delegate.onClose(l)},Object.defineProperty(t.prototype,"connectionOutbound",{get:function(){return this.delegate.connectionOutbound},enumerable:!1,configurable:!0}),t.prototype.createRequestStream=function(l){this.delegate.createRequestStream(l)},t.prototype.connectionInbound=function(l){this.delegate.connectionInbound(l)},t.prototype.handleRequestStream=function(l){this.delegate.handleRequestStream(l)},t.prototype.handle=function(l){var s=this;if(!this.resumed){if(l.type===g.FrameTypes.RESUME_OK){this.resumed=!0,this.delegate.resume(l,this.outbound,this.closeable);return}else this.outbound.send({type:g.FrameTypes.ERROR,streamId:0,code:g.ErrorCodes.CONNECTION_ERROR,message:"Incomplete RESUME handshake. Unexpected frame ".concat(l.type," received"),flags:g.Flags.NONE}),this.closeable.close(),this.closeable.onClose(function(){return s.delegate.close(new f.RSocketError(g.ErrorCodes.CONNECTION_ERROR,"Incomplete RESUME handshake. Unexpected frame ".concat(l.type," received")))});return}this.delegate.handle(l)},t})();r.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=c})(le)),le}var K={},Y={},ie={},Yt;function at(){if(Yt)return ie;Yt=1;var r=ie&&ie.__generator||function(R,f){var E={label:0,sent:function(){if(c[0]&1)throw c[1];return c[1]},trys:[],ops:[]},I,w,c,t;return t={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(t[Symbol.iterator]=function(){return this}),t;function l(m){return function(a){return s([m,a])}}function s(m){if(I)throw new TypeError("Generator is already executing.");for(;E;)try{if(I=1,w&&(c=m[0]&2?w.return:m[0]?w.throw||((c=w.return)&&c.call(w),0):w.next)&&!(c=c.call(w,m[1])).done)return c;switch(w=0,c&&(m=[m[0]&2,c.value]),m[0]){case 0:case 1:c=m;break;case 4:return E.label++,{value:m[1],done:!1};case 5:E.label++,w=m[1],m=[0];continue;case 7:m=E.ops.pop(),E.trys.pop();continue;default:if(c=E.trys,!(c=c.length>0&&c[c.length-1])&&(m[0]===6||m[0]===2)){E=0;continue}if(m[0]===3&&(!c||m[1]>c[0]&&m[1]<c[3])){E.label=m[1];break}if(m[0]===6&&E.label<c[1]){E.label=c[1],c=m;break}if(c&&E.label<c[2]){E.label=c[2],E.ops.push(m);break}c[2]&&E.ops.pop(),E.trys.pop();continue}m=f.call(R,E)}catch(a){m=[6,a],w=0}finally{I=c=0}if(m[0]&5)throw m[1];return{value:m[0]?m[1]:void 0,done:!0}}};Object.defineProperty(ie,"__esModule",{value:!0}),ie.fragmentWithRequestN=ie.fragment=ie.isFragmentable=void 0;var u=se();function i(R,f,E){return f===0?!1:R.data.byteLength+(R.metadata?R.metadata.byteLength+u.Lengths.METADATA:0)+(E==u.FrameTypes.REQUEST_STREAM||E==u.FrameTypes.REQUEST_CHANNEL?u.Lengths.REQUEST:0)>f}ie.isFragmentable=i;function _(R,f,E,I,w){var c,t,l,s,m,a,o,o,p,T,b,b,L,N;return w===void 0&&(w=!1),r(this,function(D){switch(D.label){case 0:return c=(N=(L=f.data)===null||L===void 0?void 0:L.byteLength)!==null&&N!==void 0?N:0,t=I!==u.FrameTypes.PAYLOAD,l=E,f.metadata?(m=f.metadata.byteLength,m!==0?[3,1]:(l-=u.Lengths.METADATA,s=Q.Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return a=0,t?(l-=u.Lengths.METADATA,o=Math.min(m,a+l),s=f.metadata.slice(a,o),l-=s.byteLength,a=o,l!==0?[3,3]:(t=!1,[4,{type:I,flags:u.Flags.FOLLOWS|u.Flags.METADATA,data:void 0,metadata:s,streamId:R}])):[3,3];case 2:D.sent(),s=void 0,l=E,D.label=3;case 3:return a<m?(l-=u.Lengths.METADATA,o=Math.min(m,a+l),s=f.metadata.slice(a,o),l-=s.byteLength,a=o,l===0||c===0?[4,{type:u.FrameTypes.PAYLOAD,flags:u.Flags.NEXT|u.Flags.METADATA|(a===m&&w&&c===0?u.Flags.COMPLETE:u.Flags.FOLLOWS),data:void 0,metadata:s,streamId:R}]:[3,5]):[3,6];case 4:D.sent(),s=void 0,l=E,D.label=5;case 5:return[3,3];case 6:return p=0,t?(b=Math.min(c,p+l),T=f.data.slice(p,b),l-=T.byteLength,p=b,[4,{type:I,flags:u.Flags.FOLLOWS|(s?u.Flags.METADATA:u.Flags.NONE),data:T,metadata:s,streamId:R}]):[3,8];case 7:D.sent(),s=void 0,T=void 0,l=E,D.label=8;case 8:return p<c?(b=Math.min(c,p+l),T=f.data.slice(p,b),l-=T.byteLength,p=b,[4,{type:u.FrameTypes.PAYLOAD,flags:p===c?(w?u.Flags.COMPLETE:u.Flags.NONE)|u.Flags.NEXT|(s?u.Flags.METADATA:0):u.Flags.FOLLOWS|u.Flags.NEXT|(s?u.Flags.METADATA:0),data:T,metadata:s,streamId:R}]):[3,10];case 9:return D.sent(),s=void 0,T=void 0,l=E,[3,8];case 10:return[2]}})}ie.fragment=_;function g(R,f,E,I,w,c){var t,l,s,m,a,o,p,p,T,b,L,L,N,D;return c===void 0&&(c=!1),r(this,function(U){switch(U.label){case 0:return t=(D=(N=f.data)===null||N===void 0?void 0:N.byteLength)!==null&&D!==void 0?D:0,l=!0,s=E,f.metadata?(a=f.metadata.byteLength,a!==0?[3,1]:(s-=u.Lengths.METADATA,m=Q.Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return o=0,l?(s-=u.Lengths.METADATA+u.Lengths.REQUEST,p=Math.min(a,o+s),m=f.metadata.slice(o,p),s-=m.byteLength,o=p,s!==0?[3,3]:(l=!1,[4,{type:I,flags:u.Flags.FOLLOWS|u.Flags.METADATA,data:void 0,requestN:w,metadata:m,streamId:R}])):[3,3];case 2:U.sent(),m=void 0,s=E,U.label=3;case 3:return o<a?(s-=u.Lengths.METADATA,p=Math.min(a,o+s),m=f.metadata.slice(o,p),s-=m.byteLength,o=p,s===0||t===0?[4,{type:u.FrameTypes.PAYLOAD,flags:u.Flags.NEXT|u.Flags.METADATA|(o===a&&c&&t===0?u.Flags.COMPLETE:u.Flags.FOLLOWS),data:void 0,metadata:m,streamId:R}]:[3,5]):[3,6];case 4:U.sent(),m=void 0,s=E,U.label=5;case 5:return[3,3];case 6:return T=0,l?(s-=u.Lengths.REQUEST,L=Math.min(t,T+s),b=f.data.slice(T,L),s-=b.byteLength,T=L,[4,{type:I,flags:u.Flags.FOLLOWS|(m?u.Flags.METADATA:u.Flags.NONE),data:b,requestN:w,metadata:m,streamId:R}]):[3,8];case 7:U.sent(),m=void 0,b=void 0,s=E,U.label=8;case 8:return T<t?(L=Math.min(t,T+s),b=f.data.slice(T,L),s-=b.byteLength,T=L,[4,{type:u.FrameTypes.PAYLOAD,flags:T===t?(c?u.Flags.COMPLETE:u.Flags.NONE)|u.Flags.NEXT|(m?u.Flags.METADATA:0):u.Flags.FOLLOWS|u.Flags.NEXT|(m?u.Flags.METADATA:0),data:b,metadata:m,streamId:R}]):[3,10];case 9:return U.sent(),m=void 0,b=void 0,s=E,[3,8];case 10:return[2]}})}return ie.fragmentWithRequestN=g,ie}var he={},Jt;function ot(){if(Jt)return he;Jt=1,Object.defineProperty(he,"__esModule",{value:!0}),he.cancel=he.reassemble=he.add=void 0;function r(_,g,R){return _.hasFragments?(_.data=_.data?Q.Buffer.concat([_.data,g]):g,_.metadata&&R&&(_.metadata=Q.Buffer.concat([_.metadata,R])),!0):(_.hasFragments=!0,_.data=g,R&&(_.metadata=R),!0)}he.add=r;function u(_,g,R){_.hasFragments=!1;var f=_.data?Q.Buffer.concat([_.data,g]):g;if(_.data=void 0,_.metadata){var E=R?Q.Buffer.concat([_.metadata,R]):_.metadata;return _.metadata=void 0,{data:f,metadata:E}}return{data:f}}he.reassemble=u;function i(_){_.hasFragments=!1,_.data=void 0,_.metadata=void 0}return he.cancel=i,he}var Zt;function Zn(){if(Zt)return Y;Zt=1;var r=Y&&Y.__createBinding||(Object.create?(function(c,t,l,s){s===void 0&&(s=l),Object.defineProperty(c,s,{enumerable:!0,get:function(){return t[l]}})}):(function(c,t,l,s){s===void 0&&(s=l),c[s]=t[l]})),u=Y&&Y.__setModuleDefault||(Object.create?(function(c,t){Object.defineProperty(c,"default",{enumerable:!0,value:t})}):function(c,t){c.default=t}),i=Y&&Y.__importStar||function(c){if(c&&c.__esModule)return c;var t={};if(c!=null)for(var l in c)l!=="default"&&Object.prototype.hasOwnProperty.call(c,l)&&r(t,c,l);return u(t,c),t},_=Y&&Y.__values||function(c){var t=typeof Symbol=="function"&&Symbol.iterator,l=t&&c[t],s=0;if(l)return l.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&s>=c.length&&(c=void 0),{value:c&&c[s++],done:!c}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Y,"__esModule",{value:!0}),Y.RequestChannelResponderStream=Y.RequestChannelRequesterStream=void 0;var g=ye(),R=at(),f=se(),E=i(ot()),I=(function(){function c(t,l,s,m,a,o){this.payload=t,this.isComplete=l,this.receiver=s,this.fragmentSize=m,this.initialRequestN=a,this.leaseManager=o,this.streamType=f.FrameTypes.REQUEST_CHANNEL}return c.prototype.handleReady=function(t,l){var s,m;if(this.outboundDone)return!1;this.streamId=t,this.stream=l,l.connect(this);var a=this.isComplete;if(a&&(this.outboundDone=a),(0,R.isFragmentable)(this.payload,this.fragmentSize,f.FrameTypes.REQUEST_CHANNEL))try{for(var o=_((0,R.fragmentWithRequestN)(t,this.payload,this.fragmentSize,f.FrameTypes.REQUEST_CHANNEL,this.initialRequestN,a)),p=o.next();!p.done;p=o.next()){var T=p.value;this.stream.send(T)}}catch(b){s={error:b}}finally{try{p&&!p.done&&(m=o.return)&&m.call(o)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.REQUEST_CHANNEL,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:(this.payload.metadata!==void 0?f.Flags.METADATA:f.Flags.NONE)|(a?f.Flags.COMPLETE:f.Flags.NONE),streamId:t});return this.hasExtension&&this.stream.send({type:f.FrameTypes.EXT,streamId:t,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},c.prototype.handleReject=function(t){this.inboundDone||(this.inboundDone=!0,this.outboundDone=!0,this.receiver.onError(t))},c.prototype.handle=function(t){var l,s=t.type;switch(s){case f.FrameTypes.PAYLOAD:{var m=f.Flags.hasComplete(t.flags),a=f.Flags.hasNext(t.flags);if(m||!f.Flags.hasFollows(t.flags)){if(m&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!a)){this.receiver.onComplete();return}var o=this.hasFragments?E.reassemble(this,t.data,t.metadata):{data:t.data,metadata:t.metadata};this.receiver.onNext(o,m);return}if(E.add(this,t.data,t.metadata))return;l="Unexpected frame size";break}case f.FrameTypes.CANCEL:{if(this.outboundDone)return;this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this),this.receiver.cancel();return}case f.FrameTypes.REQUEST_N:{if(this.outboundDone)return;if(this.hasFragments){l="Unexpected frame type [".concat(s,"] during reassembly");break}this.receiver.request(t.requestN);return}case f.FrameTypes.ERROR:{var p=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),E.cancel(this),p||this.receiver.cancel(),this.receiver.onError(new g.RSocketError(t.code,t.message));return}case f.FrameTypes.EXT:this.receiver.onExtension(t.extendedType,t.extendedContent,f.Flags.hasIgnore(t.flags));return;default:l="Unexpected frame type [".concat(s,"]")}this.close(new g.RSocketError(g.ErrorCodes.CANCELED,l)),this.stream.send({type:f.FrameTypes.CANCEL,streamId:this.streamId,flags:f.Flags.NONE}),this.stream.disconnect(this)},c.prototype.request=function(t){if(!this.inboundDone){if(!this.streamId){this.initialRequestN+=t;return}this.stream.send({type:f.FrameTypes.REQUEST_N,flags:f.Flags.NONE,requestN:t,streamId:this.streamId})}},c.prototype.cancel=function(){var t,l=this.inboundDone,s=this.outboundDone;if(!(l&&s)){if(this.inboundDone=!0,this.outboundDone=!0,s||this.receiver.cancel(),!this.streamId){(t=this.leaseManager)===null||t===void 0||t.cancelRequest(this);return}this.stream.send({type:l?f.FrameTypes.ERROR:f.FrameTypes.CANCEL,flags:f.Flags.NONE,streamId:this.streamId,code:g.ErrorCodes.CANCELED,message:"Cancelled"}),this.stream.disconnect(this),E.cancel(this)}},c.prototype.onNext=function(t,l){var s,m;if(!this.outboundDone)if(l&&(this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this)),(0,R.isFragmentable)(t,this.fragmentSize,f.FrameTypes.PAYLOAD))try{for(var a=_((0,R.fragment)(this.streamId,t,this.fragmentSize,f.FrameTypes.PAYLOAD,l)),o=a.next();!o.done;o=a.next()){var p=o.value;this.stream.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.PAYLOAD,streamId:this.streamId,flags:f.Flags.NEXT|(t.metadata?f.Flags.METADATA:f.Flags.NONE)|(l?f.Flags.COMPLETE:f.Flags.NONE),data:t.data,metadata:t.metadata})},c.prototype.onComplete=function(){if(!this.streamId){this.isComplete=!0;return}this.outboundDone||(this.outboundDone=!0,this.stream.send({type:f.FrameTypes.PAYLOAD,streamId:this.streamId,flags:f.Flags.COMPLETE,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},c.prototype.onError=function(t){if(!this.outboundDone){var l=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:f.FrameTypes.ERROR,streamId:this.streamId,flags:f.Flags.NONE,code:t instanceof g.RSocketError?t.code:g.ErrorCodes.APPLICATION_ERROR,message:t.message}),this.stream.disconnect(this),l||this.receiver.onError(t)}},c.prototype.onExtension=function(t,l,s){if(!this.outboundDone){if(!this.streamId){this.hasExtension=!0,this.extendedType=t,this.extendedContent=l,this.flags=s?f.Flags.IGNORE:f.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:f.FrameTypes.EXT,extendedType:t,extendedContent:l,flags:s?f.Flags.IGNORE:f.Flags.NONE})}},c.prototype.close=function(t){if(!(this.inboundDone&&this.outboundDone)){var l=this.inboundDone,s=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,E.cancel(this),s||this.receiver.cancel(),l||(t?this.receiver.onError(t):this.receiver.onComplete())}},c})();Y.RequestChannelRequesterStream=I;var w=(function(){function c(t,l,s,m,a){if(this.streamId=t,this.stream=l,this.fragmentSize=s,this.handler=m,this.streamType=f.FrameTypes.REQUEST_CHANNEL,l.connect(this),f.Flags.hasFollows(a.flags)){E.add(this,a.data,a.metadata),this.initialRequestN=a.requestN,this.isComplete=f.Flags.hasComplete(a.flags);return}var o={data:a.data,metadata:a.metadata},p=f.Flags.hasComplete(a.flags);this.inboundDone=p;try{this.receiver=m(o,a.requestN,p,this),this.outboundDone&&this.defferedError&&this.receiver.onError(this.defferedError)}catch(T){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(T)}}return c.prototype.handle=function(t){var l,s=t.type;switch(s){case f.FrameTypes.PAYLOAD:{if(f.Flags.hasFollows(t.flags)){if(E.add(this,t.data,t.metadata))return;l="Unexpected frame size";break}var m=this.hasFragments?E.reassemble(this,t.data,t.metadata):{data:t.data,metadata:t.metadata},a=f.Flags.hasComplete(t.flags);if(this.receiver){if(a&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!f.Flags.hasNext(t.flags))){this.receiver.onComplete();return}this.receiver.onNext(m,a)}else{var o=this.isComplete||a;o&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this));try{this.receiver=this.handler(m,this.initialRequestN,o,this),this.outboundDone&&this.defferedError}catch(b){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(b)}}return}case f.FrameTypes.REQUEST_N:{if(!this.receiver||this.hasFragments){l="Unexpected frame type [".concat(s,"] during reassembly");break}this.receiver.request(t.requestN);return}case f.FrameTypes.ERROR:case f.FrameTypes.CANCEL:{var o=this.inboundDone,p=this.outboundDone;if(this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),E.cancel(this),!this.receiver)return;if(p||this.receiver.cancel(),!o){var T=s===f.FrameTypes.CANCEL?new g.RSocketError(g.ErrorCodes.CANCELED,"Cancelled"):new g.RSocketError(t.code,t.message);this.receiver.onError(T)}return}case f.FrameTypes.EXT:{if(!this.receiver||this.hasFragments){l="Unexpected frame type [".concat(s,"] during reassembly");break}this.receiver.onExtension(t.extendedType,t.extendedContent,f.Flags.hasIgnore(t.flags));return}default:l="Unexpected frame type [".concat(s,"]")}this.stream.send({type:f.FrameTypes.ERROR,flags:f.Flags.NONE,code:g.ErrorCodes.CANCELED,message:l,streamId:this.streamId}),this.stream.disconnect(this),this.close(new g.RSocketError(g.ErrorCodes.CANCELED,l))},c.prototype.onError=function(t){if(this.outboundDone){console.warn("Trying to error for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}var l=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:f.FrameTypes.ERROR,flags:f.Flags.NONE,code:t instanceof g.RSocketError?t.code:g.ErrorCodes.APPLICATION_ERROR,message:t.message,streamId:this.streamId}),this.stream.disconnect(this),l||(this.receiver?this.receiver.onError(t):this.defferedError=t)},c.prototype.onNext=function(t,l){var s,m;if(!this.outboundDone){if(l&&(this.outboundDone=!0),(0,R.isFragmentable)(t,this.fragmentSize,f.FrameTypes.PAYLOAD))try{for(var a=_((0,R.fragment)(this.streamId,t,this.fragmentSize,f.FrameTypes.PAYLOAD,l)),o=a.next();!o.done;o=a.next()){var p=o.value;this.stream.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.PAYLOAD,flags:f.Flags.NEXT|(l?f.Flags.COMPLETE:f.Flags.NONE)|(t.metadata?f.Flags.METADATA:f.Flags.NONE),data:t.data,metadata:t.metadata,streamId:this.streamId});l&&this.inboundDone&&this.stream.disconnect(this)}},c.prototype.onComplete=function(){this.outboundDone||(this.outboundDone=!0,this.stream.send({type:f.FrameTypes.PAYLOAD,flags:f.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},c.prototype.onExtension=function(t,l,s){this.outboundDone&&this.inboundDone||this.stream.send({type:f.FrameTypes.EXT,streamId:this.streamId,flags:s?f.Flags.IGNORE:f.Flags.NONE,extendedType:t,extendedContent:l})},c.prototype.request=function(t){this.inboundDone||this.stream.send({type:f.FrameTypes.REQUEST_N,flags:f.Flags.NONE,streamId:this.streamId,requestN:t})},c.prototype.cancel=function(){this.inboundDone||(this.inboundDone=!0,this.stream.send({type:f.FrameTypes.CANCEL,flags:f.Flags.NONE,streamId:this.streamId}),this.outboundDone&&this.stream.disconnect(this))},c.prototype.close=function(t){if(this.inboundDone&&this.outboundDone){console.warn("Trying to close for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}var l=this.inboundDone,s=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,E.cancel(this);var m=this.receiver;m&&(s||m.cancel(),l||(t?m.onError(t):m.onComplete()))},c})();return Y.RequestChannelResponderStream=w,Y}var J={},$t;function $n(){if($t)return J;$t=1;var r=J&&J.__createBinding||(Object.create?(function(c,t,l,s){s===void 0&&(s=l),Object.defineProperty(c,s,{enumerable:!0,get:function(){return t[l]}})}):(function(c,t,l,s){s===void 0&&(s=l),c[s]=t[l]})),u=J&&J.__setModuleDefault||(Object.create?(function(c,t){Object.defineProperty(c,"default",{enumerable:!0,value:t})}):function(c,t){c.default=t}),i=J&&J.__importStar||function(c){if(c&&c.__esModule)return c;var t={};if(c!=null)for(var l in c)l!=="default"&&Object.prototype.hasOwnProperty.call(c,l)&&r(t,c,l);return u(t,c),t},_=J&&J.__values||function(c){var t=typeof Symbol=="function"&&Symbol.iterator,l=t&&c[t],s=0;if(l)return l.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&s>=c.length&&(c=void 0),{value:c&&c[s++],done:!c}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(J,"__esModule",{value:!0}),J.RequestFnfResponderStream=J.RequestFnFRequesterStream=void 0;var g=ye(),R=at(),f=se(),E=i(ot()),I=(function(){function c(t,l,s,m){this.payload=t,this.receiver=l,this.fragmentSize=s,this.leaseManager=m,this.streamType=f.FrameTypes.REQUEST_FNF}return c.prototype.handleReady=function(t,l){var s,m;if(this.done)return!1;if(this.streamId=t,(0,R.isFragmentable)(this.payload,this.fragmentSize,f.FrameTypes.REQUEST_FNF))try{for(var a=_((0,R.fragment)(t,this.payload,this.fragmentSize,f.FrameTypes.REQUEST_FNF)),o=a.next();!o.done;o=a.next()){var p=o.value;l.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else l.send({type:f.FrameTypes.REQUEST_FNF,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?f.Flags.METADATA:0,streamId:t});return this.done=!0,this.receiver.onComplete(),!0},c.prototype.handleReject=function(t){this.done||(this.done=!0,this.receiver.onError(t))},c.prototype.cancel=function(){var t;this.done||(this.done=!0,(t=this.leaseManager)===null||t===void 0||t.cancelRequest(this))},c.prototype.handle=function(t){if(t.type==f.FrameTypes.ERROR){this.close(new g.RSocketError(t.code,t.message));return}this.close(new g.RSocketError(g.ErrorCodes.CANCELED,"Received invalid frame"))},c.prototype.close=function(t){if(this.done){console.warn("Trying to close for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}t?this.receiver.onError(t):this.receiver.onComplete()},c})();J.RequestFnFRequesterStream=I;var w=(function(){function c(t,l,s,m){if(this.streamId=t,this.stream=l,this.handler=s,this.streamType=f.FrameTypes.REQUEST_FNF,f.Flags.hasFollows(m.flags)){E.add(this,m.data,m.metadata),l.connect(this);return}var a={data:m.data,metadata:m.metadata};try{this.cancellable=s(a,this)}catch{}}return c.prototype.handle=function(t){var l;if(t.type==f.FrameTypes.PAYLOAD)if(f.Flags.hasFollows(t.flags)){if(E.add(this,t.data,t.metadata))return;l="Unexpected fragment size"}else{this.stream.disconnect(this);var s=E.reassemble(this,t.data,t.metadata);try{this.cancellable=this.handler(s,this)}catch{}return}else l="Unexpected frame type [".concat(t.type,"]");this.done=!0,t.type!=f.FrameTypes.CANCEL&&t.type!=f.FrameTypes.ERROR&&this.stream.send({type:f.FrameTypes.ERROR,streamId:this.streamId,flags:f.Flags.NONE,code:g.ErrorCodes.CANCELED,message:l}),this.stream.disconnect(this),E.cancel(this)},c.prototype.close=function(t){var l;if(this.done){console.warn("Trying to close for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}this.done=!0,E.cancel(this),(l=this.cancellable)===null||l===void 0||l.cancel()},c.prototype.onError=function(t){},c.prototype.onComplete=function(){},c})();return J.RequestFnfResponderStream=w,J}var Z={},en;function er(){if(en)return Z;en=1;var r=Z&&Z.__createBinding||(Object.create?(function(c,t,l,s){s===void 0&&(s=l),Object.defineProperty(c,s,{enumerable:!0,get:function(){return t[l]}})}):(function(c,t,l,s){s===void 0&&(s=l),c[s]=t[l]})),u=Z&&Z.__setModuleDefault||(Object.create?(function(c,t){Object.defineProperty(c,"default",{enumerable:!0,value:t})}):function(c,t){c.default=t}),i=Z&&Z.__importStar||function(c){if(c&&c.__esModule)return c;var t={};if(c!=null)for(var l in c)l!=="default"&&Object.prototype.hasOwnProperty.call(c,l)&&r(t,c,l);return u(t,c),t},_=Z&&Z.__values||function(c){var t=typeof Symbol=="function"&&Symbol.iterator,l=t&&c[t],s=0;if(l)return l.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&s>=c.length&&(c=void 0),{value:c&&c[s++],done:!c}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Z,"__esModule",{value:!0}),Z.RequestResponseResponderStream=Z.RequestResponseRequesterStream=void 0;var g=ye(),R=at(),f=se(),E=i(ot()),I=(function(){function c(t,l,s,m){this.payload=t,this.receiver=l,this.fragmentSize=s,this.leaseManager=m,this.streamType=f.FrameTypes.REQUEST_RESPONSE}return c.prototype.handleReady=function(t,l){var s,m;if(this.done)return!1;if(this.streamId=t,this.stream=l,l.connect(this),(0,R.isFragmentable)(this.payload,this.fragmentSize,f.FrameTypes.REQUEST_RESPONSE))try{for(var a=_((0,R.fragment)(t,this.payload,this.fragmentSize,f.FrameTypes.REQUEST_RESPONSE)),o=a.next();!o.done;o=a.next()){var p=o.value;this.stream.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.REQUEST_RESPONSE,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?f.Flags.METADATA:0,streamId:t});return this.hasExtension&&this.stream.send({type:f.FrameTypes.EXT,streamId:t,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},c.prototype.handleReject=function(t){this.done||(this.done=!0,this.receiver.onError(t))},c.prototype.handle=function(t){var l,s=t.type;switch(s){case f.FrameTypes.PAYLOAD:{var m=f.Flags.hasComplete(t.flags),a=f.Flags.hasNext(t.flags);if(m||!f.Flags.hasFollows(t.flags)){if(this.done=!0,this.stream.disconnect(this),!a){this.receiver.onComplete();return}var o=this.hasFragments?E.reassemble(this,t.data,t.metadata):{data:t.data,metadata:t.metadata};this.receiver.onNext(o,!0);return}if(!E.add(this,t.data,t.metadata)){l="Unexpected fragment size";break}return}case f.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),E.cancel(this),this.receiver.onError(new g.RSocketError(t.code,t.message));return}case f.FrameTypes.EXT:{if(this.hasFragments){l="Unexpected frame type [".concat(s,"] during reassembly");break}this.receiver.onExtension(t.extendedType,t.extendedContent,f.Flags.hasIgnore(t.flags));return}default:l="Unexpected frame type [".concat(s,"]")}this.close(new g.RSocketError(g.ErrorCodes.CANCELED,l)),this.stream.send({type:f.FrameTypes.CANCEL,streamId:this.streamId,flags:f.Flags.NONE}),this.stream.disconnect(this)},c.prototype.cancel=function(){var t;if(!this.done){if(this.done=!0,!this.streamId){(t=this.leaseManager)===null||t===void 0||t.cancelRequest(this);return}this.stream.send({type:f.FrameTypes.CANCEL,flags:f.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),E.cancel(this)}},c.prototype.onExtension=function(t,l,s){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=t,this.extendedContent=l,this.flags=s?f.Flags.IGNORE:f.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:f.FrameTypes.EXT,extendedType:t,extendedContent:l,flags:s?f.Flags.IGNORE:f.Flags.NONE})}},c.prototype.close=function(t){this.done||(this.done=!0,E.cancel(this),t?this.receiver.onError(t):this.receiver.onComplete())},c})();Z.RequestResponseRequesterStream=I;var w=(function(){function c(t,l,s,m,a){if(this.streamId=t,this.stream=l,this.fragmentSize=s,this.handler=m,this.streamType=f.FrameTypes.REQUEST_RESPONSE,l.connect(this),f.Flags.hasFollows(a.flags)){E.add(this,a.data,a.metadata);return}var o={data:a.data,metadata:a.metadata};try{this.receiver=m(o,this)}catch(p){this.onError(p)}}return c.prototype.handle=function(t){var l,s;if(!this.receiver||this.hasFragments)if(t.type===f.FrameTypes.PAYLOAD)if(f.Flags.hasFollows(t.flags)){if(E.add(this,t.data,t.metadata))return;s="Unexpected fragment size"}else{var m=E.reassemble(this,t.data,t.metadata);try{this.receiver=this.handler(m,this)}catch(a){this.onError(a)}return}else s="Unexpected frame type [".concat(t.type,"] during reassembly");else if(t.type===f.FrameTypes.EXT){this.receiver.onExtension(t.extendedType,t.extendedContent,f.Flags.hasIgnore(t.flags));return}else s="Unexpected frame type [".concat(t.type,"]");this.done=!0,(l=this.receiver)===null||l===void 0||l.cancel(),t.type!==f.FrameTypes.CANCEL&&t.type!==f.FrameTypes.ERROR&&this.stream.send({type:f.FrameTypes.ERROR,flags:f.Flags.NONE,code:g.ErrorCodes.CANCELED,message:s,streamId:this.streamId}),this.stream.disconnect(this),E.cancel(this)},c.prototype.onError=function(t){if(this.done){console.warn("Trying to error for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}this.done=!0,this.stream.send({type:f.FrameTypes.ERROR,flags:f.Flags.NONE,code:t instanceof g.RSocketError?t.code:g.ErrorCodes.APPLICATION_ERROR,message:t.message,streamId:this.streamId}),this.stream.disconnect(this)},c.prototype.onNext=function(t,l){var s,m;if(!this.done){if(this.done=!0,(0,R.isFragmentable)(t,this.fragmentSize,f.FrameTypes.PAYLOAD))try{for(var a=_((0,R.fragment)(this.streamId,t,this.fragmentSize,f.FrameTypes.PAYLOAD,!0)),o=a.next();!o.done;o=a.next()){var p=o.value;this.stream.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.PAYLOAD,flags:f.Flags.NEXT|f.Flags.COMPLETE|(t.metadata?f.Flags.METADATA:0),data:t.data,metadata:t.metadata,streamId:this.streamId});this.stream.disconnect(this)}},c.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:f.FrameTypes.PAYLOAD,flags:f.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},c.prototype.onExtension=function(t,l,s){this.done||this.stream.send({type:f.FrameTypes.EXT,streamId:this.streamId,flags:s?f.Flags.IGNORE:f.Flags.NONE,extendedType:t,extendedContent:l})},c.prototype.close=function(t){var l;if(this.done){console.warn("Trying to close for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}E.cancel(this),(l=this.receiver)===null||l===void 0||l.cancel()},c})();return Z.RequestResponseResponderStream=w,Z}var $={},tn;function tr(){if(tn)return $;tn=1;var r=$&&$.__createBinding||(Object.create?(function(c,t,l,s){s===void 0&&(s=l),Object.defineProperty(c,s,{enumerable:!0,get:function(){return t[l]}})}):(function(c,t,l,s){s===void 0&&(s=l),c[s]=t[l]})),u=$&&$.__setModuleDefault||(Object.create?(function(c,t){Object.defineProperty(c,"default",{enumerable:!0,value:t})}):function(c,t){c.default=t}),i=$&&$.__importStar||function(c){if(c&&c.__esModule)return c;var t={};if(c!=null)for(var l in c)l!=="default"&&Object.prototype.hasOwnProperty.call(c,l)&&r(t,c,l);return u(t,c),t},_=$&&$.__values||function(c){var t=typeof Symbol=="function"&&Symbol.iterator,l=t&&c[t],s=0;if(l)return l.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&s>=c.length&&(c=void 0),{value:c&&c[s++],done:!c}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty($,"__esModule",{value:!0}),$.RequestStreamResponderStream=$.RequestStreamRequesterStream=void 0;var g=ye(),R=at(),f=se(),E=i(ot()),I=(function(){function c(t,l,s,m,a){this.payload=t,this.receiver=l,this.fragmentSize=s,this.initialRequestN=m,this.leaseManager=a,this.streamType=f.FrameTypes.REQUEST_STREAM}return c.prototype.handleReady=function(t,l){var s,m;if(this.done)return!1;if(this.streamId=t,this.stream=l,l.connect(this),(0,R.isFragmentable)(this.payload,this.fragmentSize,f.FrameTypes.REQUEST_STREAM))try{for(var a=_((0,R.fragmentWithRequestN)(t,this.payload,this.fragmentSize,f.FrameTypes.REQUEST_STREAM,this.initialRequestN)),o=a.next();!o.done;o=a.next()){var p=o.value;this.stream.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.REQUEST_STREAM,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:this.payload.metadata!==void 0?f.Flags.METADATA:0,streamId:t});return this.hasExtension&&this.stream.send({type:f.FrameTypes.EXT,streamId:t,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},c.prototype.handleReject=function(t){this.done||(this.done=!0,this.receiver.onError(t))},c.prototype.handle=function(t){var l,s=t.type;switch(s){case f.FrameTypes.PAYLOAD:{var m=f.Flags.hasComplete(t.flags),a=f.Flags.hasNext(t.flags);if(m||!f.Flags.hasFollows(t.flags)){if(m&&(this.done=!0,this.stream.disconnect(this),!a)){this.receiver.onComplete();return}var o=this.hasFragments?E.reassemble(this,t.data,t.metadata):{data:t.data,metadata:t.metadata};this.receiver.onNext(o,m);return}if(!E.add(this,t.data,t.metadata)){l="Unexpected fragment size";break}return}case f.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),E.cancel(this),this.receiver.onError(new g.RSocketError(t.code,t.message));return}case f.FrameTypes.EXT:{if(this.hasFragments){l="Unexpected frame type [".concat(s,"] during reassembly");break}this.receiver.onExtension(t.extendedType,t.extendedContent,f.Flags.hasIgnore(t.flags));return}default:l="Unexpected frame type [".concat(s,"]")}this.close(new g.RSocketError(g.ErrorCodes.CANCELED,l)),this.stream.send({type:f.FrameTypes.CANCEL,streamId:this.streamId,flags:f.Flags.NONE}),this.stream.disconnect(this)},c.prototype.request=function(t){if(!this.done){if(!this.streamId){this.initialRequestN+=t;return}this.stream.send({type:f.FrameTypes.REQUEST_N,flags:f.Flags.NONE,requestN:t,streamId:this.streamId})}},c.prototype.cancel=function(){var t;if(!this.done){if(this.done=!0,!this.streamId){(t=this.leaseManager)===null||t===void 0||t.cancelRequest(this);return}this.stream.send({type:f.FrameTypes.CANCEL,flags:f.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),E.cancel(this)}},c.prototype.onExtension=function(t,l,s){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=t,this.extendedContent=l,this.flags=s?f.Flags.IGNORE:f.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:f.FrameTypes.EXT,extendedType:t,extendedContent:l,flags:s?f.Flags.IGNORE:f.Flags.NONE})}},c.prototype.close=function(t){this.done||(this.done=!0,E.cancel(this),t?this.receiver.onError(t):this.receiver.onComplete())},c})();$.RequestStreamRequesterStream=I;var w=(function(){function c(t,l,s,m,a){if(this.streamId=t,this.stream=l,this.fragmentSize=s,this.handler=m,this.streamType=f.FrameTypes.REQUEST_STREAM,l.connect(this),f.Flags.hasFollows(a.flags)){this.initialRequestN=a.requestN,E.add(this,a.data,a.metadata);return}var o={data:a.data,metadata:a.metadata};try{this.receiver=m(o,a.requestN,this)}catch(p){this.onError(p)}}return c.prototype.handle=function(t){var l,s;if(!this.receiver||this.hasFragments)if(t.type===f.FrameTypes.PAYLOAD)if(f.Flags.hasFollows(t.flags)){if(E.add(this,t.data,t.metadata))return;s="Unexpected frame size"}else{var m=E.reassemble(this,t.data,t.metadata);try{this.receiver=this.handler(m,this.initialRequestN,this)}catch(a){this.onError(a)}return}else s="Unexpected frame type [".concat(t.type,"] during reassembly");else if(t.type===f.FrameTypes.REQUEST_N){this.receiver.request(t.requestN);return}else if(t.type===f.FrameTypes.EXT){this.receiver.onExtension(t.extendedType,t.extendedContent,f.Flags.hasIgnore(t.flags));return}else s="Unexpected frame type [".concat(t.type,"]");this.done=!0,E.cancel(this),(l=this.receiver)===null||l===void 0||l.cancel(),t.type!==f.FrameTypes.CANCEL&&t.type!==f.FrameTypes.ERROR&&this.stream.send({type:f.FrameTypes.ERROR,flags:f.Flags.NONE,code:g.ErrorCodes.CANCELED,message:s,streamId:this.streamId}),this.stream.disconnect(this)},c.prototype.onError=function(t){if(this.done){console.warn("Trying to error for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}this.done=!0,this.stream.send({type:f.FrameTypes.ERROR,flags:f.Flags.NONE,code:t instanceof g.RSocketError?t.code:g.ErrorCodes.APPLICATION_ERROR,message:t.message,streamId:this.streamId}),this.stream.disconnect(this)},c.prototype.onNext=function(t,l){var s,m;if(!this.done){if(l&&(this.done=!0),(0,R.isFragmentable)(t,this.fragmentSize,f.FrameTypes.PAYLOAD))try{for(var a=_((0,R.fragment)(this.streamId,t,this.fragmentSize,f.FrameTypes.PAYLOAD,l)),o=a.next();!o.done;o=a.next()){var p=o.value;this.stream.send(p)}}catch(T){s={error:T}}finally{try{o&&!o.done&&(m=a.return)&&m.call(a)}finally{if(s)throw s.error}}else this.stream.send({type:f.FrameTypes.PAYLOAD,flags:f.Flags.NEXT|(l?f.Flags.COMPLETE:f.Flags.NONE)|(t.metadata?f.Flags.METADATA:f.Flags.NONE),data:t.data,metadata:t.metadata,streamId:this.streamId});l&&this.stream.disconnect(this)}},c.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:f.FrameTypes.PAYLOAD,flags:f.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},c.prototype.onExtension=function(t,l,s){this.done||this.stream.send({type:f.FrameTypes.EXT,streamId:this.streamId,flags:s?f.Flags.IGNORE:f.Flags.NONE,extendedType:t,extendedContent:l})},c.prototype.close=function(t){var l;if(this.done){console.warn("Trying to close for the second time. ".concat(t?"Dropping error [".concat(t,"]."):""));return}E.cancel(this),(l=this.receiver)===null||l===void 0||l.cancel()},c})();return $.RequestStreamResponderStream=w,$}var nn;function Rn(){if(nn)return K;nn=1,Object.defineProperty(K,"__esModule",{value:!0}),K.KeepAliveSender=K.KeepAliveHandler=K.DefaultConnectionFrameHandler=K.DefaultStreamRequestHandler=K.LeaseHandler=K.RSocketRequester=void 0;var r=ye(),u=se(),i=Zn(),_=$n(),g=er(),R=tr(),f=(function(){function m(a,o,p){this.connection=a,this.fragmentSize=o,this.leaseManager=p}return m.prototype.fireAndForget=function(a,o){var p=new _.RequestFnFRequesterStream(a,o,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(p):this.connection.multiplexerDemultiplexer.createRequestStream(p),p},m.prototype.requestResponse=function(a,o){var p=new g.RequestResponseRequesterStream(a,o,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(p):this.connection.multiplexerDemultiplexer.createRequestStream(p),p},m.prototype.requestStream=function(a,o,p){var T=new R.RequestStreamRequesterStream(a,p,this.fragmentSize,o,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(T):this.connection.multiplexerDemultiplexer.createRequestStream(T),T},m.prototype.requestChannel=function(a,o,p,T){var b=new i.RequestChannelRequesterStream(a,p,T,this.fragmentSize,o,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(b):this.connection.multiplexerDemultiplexer.createRequestStream(b),b},m.prototype.metadataPush=function(a,o){throw new Error("Method not implemented.")},m.prototype.close=function(a){this.connection.close(a)},m.prototype.onClose=function(a){this.connection.onClose(a)},m})();K.RSocketRequester=f;var E=(function(){function m(a,o){this.maxPendingRequests=a,this.multiplexer=o,this.pendingRequests=[],this.expirationTime=0,this.availableLease=0}return m.prototype.handle=function(a){for(this.expirationTime=a.ttl+Date.now(),this.availableLease=a.requestCount;this.availableLease>0&&this.pendingRequests.length>0;){var o=this.pendingRequests.shift();this.availableLease--,this.multiplexer.createRequestStream(o)}},m.prototype.requestLease=function(a){var o=this.availableLease;if(o>0&&Date.now()<this.expirationTime){this.availableLease=o-1,this.multiplexer.createRequestStream(a);return}if(this.pendingRequests.length>=this.maxPendingRequests){a.handleReject(new r.RSocketError(r.ErrorCodes.REJECTED,"No available lease given"));return}this.pendingRequests.push(a)},m.prototype.cancelRequest=function(a){var o=this.pendingRequests.indexOf(a);o>-1&&this.pendingRequests.splice(o,1)},m})();K.LeaseHandler=E;var I=(function(){function m(a,o){this.rsocket=a,this.fragmentSize=o}return m.prototype.handle=function(a,o){switch(a.type){case u.FrameTypes.REQUEST_FNF:this.rsocket.fireAndForget&&new _.RequestFnfResponderStream(a.streamId,o,this.rsocket.fireAndForget.bind(this.rsocket),a);return;case u.FrameTypes.REQUEST_RESPONSE:if(this.rsocket.requestResponse){new g.RequestResponseResponderStream(a.streamId,o,this.fragmentSize,this.rsocket.requestResponse.bind(this.rsocket),a);return}this.rejectRequest(a.streamId,o);return;case u.FrameTypes.REQUEST_STREAM:if(this.rsocket.requestStream){new R.RequestStreamResponderStream(a.streamId,o,this.fragmentSize,this.rsocket.requestStream.bind(this.rsocket),a);return}this.rejectRequest(a.streamId,o);return;case u.FrameTypes.REQUEST_CHANNEL:if(this.rsocket.requestChannel){new i.RequestChannelResponderStream(a.streamId,o,this.fragmentSize,this.rsocket.requestChannel.bind(this.rsocket),a);return}this.rejectRequest(a.streamId,o);return}},m.prototype.rejectRequest=function(a,o){o.send({type:u.FrameTypes.ERROR,streamId:a,flags:u.Flags.NONE,code:r.ErrorCodes.REJECTED,message:"No available handler found"})},m.prototype.close=function(){},m})();K.DefaultStreamRequestHandler=I;var w=(function(){function m(a,o,p,T,b){this.connection=a,this.keepAliveHandler=o,this.keepAliveSender=p,this.leaseHandler=T,this.rsocket=b}return m.prototype.handle=function(a){switch(a.type){case u.FrameTypes.KEEPALIVE:this.keepAliveHandler.handle(a);return;case u.FrameTypes.LEASE:if(this.leaseHandler){this.leaseHandler.handle(a);return}return;case u.FrameTypes.ERROR:this.connection.close(new r.RSocketError(a.code,a.message));return;case u.FrameTypes.METADATA_PUSH:this.rsocket.metadataPush;return;default:this.connection.multiplexerDemultiplexer.connectionOutbound.send({type:u.FrameTypes.ERROR,streamId:0,flags:u.Flags.NONE,message:"Received unknown frame type",code:r.ErrorCodes.CONNECTION_ERROR})}},m.prototype.pause=function(){var a;this.keepAliveHandler.pause(),(a=this.keepAliveSender)===null||a===void 0||a.pause()},m.prototype.resume=function(){var a;this.keepAliveHandler.start(),(a=this.keepAliveSender)===null||a===void 0||a.start()},m.prototype.close=function(a){var o;this.keepAliveHandler.close(),(o=this.rsocket.close)===null||o===void 0||o.call(this.rsocket,a)},m})();K.DefaultConnectionFrameHandler=w;var c;(function(m){m[m.Paused=0]="Paused",m[m.Running=1]="Running",m[m.Closed=2]="Closed"})(c||(c={}));var t=(function(){function m(a,o){this.connection=a,this.keepAliveTimeoutDuration=o,this.state=c.Paused,this.outbound=a.multiplexerDemultiplexer.connectionOutbound}return m.prototype.handle=function(a){this.keepAliveLastReceivedMillis=Date.now(),u.Flags.hasRespond(a.flags)&&this.outbound.send({type:u.FrameTypes.KEEPALIVE,streamId:0,data:a.data,flags:a.flags^u.Flags.RESPOND,lastReceivedPosition:0})},m.prototype.start=function(){this.state===c.Paused&&(this.keepAliveLastReceivedMillis=Date.now(),this.state=c.Running,this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),this.keepAliveTimeoutDuration))},m.prototype.pause=function(){this.state===c.Running&&(this.state=c.Paused,clearTimeout(this.activeTimeout))},m.prototype.close=function(){this.state=c.Closed,clearTimeout(this.activeTimeout)},m.prototype.timeoutCheck=function(){var a=Date.now(),o=a-this.keepAliveLastReceivedMillis;o>=this.keepAliveTimeoutDuration?this.connection.close(new Error("No keep-alive acks for ".concat(this.keepAliveTimeoutDuration," millis"))):this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),Math.max(100,this.keepAliveTimeoutDuration-o))},m})();K.KeepAliveHandler=t;var l;(function(m){m[m.Paused=0]="Paused",m[m.Running=1]="Running",m[m.Closed=2]="Closed"})(l||(l={}));var s=(function(){function m(a,o){this.outbound=a,this.keepAlivePeriodDuration=o,this.state=l.Paused}return m.prototype.sendKeepAlive=function(){this.outbound.send({type:u.FrameTypes.KEEPALIVE,streamId:0,data:void 0,flags:u.Flags.RESPOND,lastReceivedPosition:0})},m.prototype.start=function(){this.state===l.Paused&&(this.state=l.Running,this.activeInterval=setInterval(this.sendKeepAlive.bind(this),this.keepAlivePeriodDuration))},m.prototype.pause=function(){this.state===l.Running&&(this.state=l.Paused,clearInterval(this.activeInterval))},m.prototype.close=function(){this.state=l.Closed,clearInterval(this.activeInterval)},m})();return K.KeepAliveSender=s,K}var Ae={},rn;function Tn(){if(rn)return Ae;rn=1;var r=Ae&&Ae.__values||function(g){var R=typeof Symbol=="function"&&Symbol.iterator,f=R&&g[R],E=0;if(f)return f.call(g);if(g&&typeof g.length=="number")return{next:function(){return g&&E>=g.length&&(g=void 0),{value:g&&g[E++],done:!g}}};throw new TypeError(R?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.FrameStore=void 0;var u=ut(),i=gn(),_=(function(){function g(){this.storedFrames=[],this._lastReceivedFramePosition=0,this._firstAvailableFramePosition=0,this._lastSentFramePosition=0}return Object.defineProperty(g.prototype,"lastReceivedFramePosition",{get:function(){return this._lastReceivedFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"firstAvailableFramePosition",{get:function(){return this._firstAvailableFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"lastSentFramePosition",{get:function(){return this._lastSentFramePosition},enumerable:!1,configurable:!0}),g.prototype.store=function(R){this._lastSentFramePosition+=(0,i.sizeOfFrame)(R),this.storedFrames.push(R)},g.prototype.record=function(R){this._lastReceivedFramePosition+=(0,i.sizeOfFrame)(R)},g.prototype.dropTo=function(R){for(var f=R-this._firstAvailableFramePosition;f>0&&this.storedFrames.length>0;){var E=this.storedFrames.shift();f-=(0,i.sizeOfFrame)(E)}if(f!==0)throw new u.RSocketError(u.ErrorCodes.CONNECTION_ERROR,"State inconsistency. Expected bytes to drop ".concat(R-this._firstAvailableFramePosition," but actual ").concat(f));this._firstAvailableFramePosition=R},g.prototype.drain=function(R){var f,E;try{for(var I=r(this.storedFrames),w=I.next();!w.done;w=I.next()){var c=w.value;R(c)}}catch(t){f={error:t}}finally{try{w&&!w.done&&(E=I.return)&&E.call(I)}finally{if(f)throw f.error}}},g})();return Ae.FrameStore=_,Ae}var sn;function nr(){if(sn)return ce;sn=1;var r=ce&&ce.__awaiter||function(E,I,w,c){function t(l){return l instanceof w?l:new w(function(s){s(l)})}return new(w||(w=Promise))(function(l,s){function m(p){try{o(c.next(p))}catch(T){s(T)}}function a(p){try{o(c.throw(p))}catch(T){s(T)}}function o(p){p.done?l(p.value):t(p.value).then(m,a)}o((c=c.apply(E,I||[])).next())})},u=ce&&ce.__generator||function(E,I){var w={label:0,sent:function(){if(l[0]&1)throw l[1];return l[1]},trys:[],ops:[]},c,t,l,s;return s={next:m(0),throw:m(1),return:m(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function m(o){return function(p){return a([o,p])}}function a(o){if(c)throw new TypeError("Generator is already executing.");for(;w;)try{if(c=1,t&&(l=o[0]&2?t.return:o[0]?t.throw||((l=t.return)&&l.call(t),0):t.next)&&!(l=l.call(t,o[1])).done)return l;switch(t=0,l&&(o=[o[0]&2,l.value]),o[0]){case 0:case 1:l=o;break;case 4:return w.label++,{value:o[1],done:!1};case 5:w.label++,t=o[1],o=[0];continue;case 7:o=w.ops.pop(),w.trys.pop();continue;default:if(l=w.trys,!(l=l.length>0&&l[l.length-1])&&(o[0]===6||o[0]===2)){w=0;continue}if(o[0]===3&&(!l||o[1]>l[0]&&o[1]<l[3])){w.label=o[1];break}if(o[0]===6&&w.label<l[1]){w.label=l[1],l=o;break}if(l&&w.label<l[2]){w.label=l[2],w.ops.push(o);break}l[2]&&w.ops.pop(),w.trys.pop();continue}o=I.call(E,w)}catch(p){o=[6,p],t=0}finally{c=l=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}};Object.defineProperty(ce,"__esModule",{value:!0}),ce.RSocketConnector=void 0;var i=vn(),_=se(),g=Rn(),R=Tn(),f=(function(){function E(I){this.config=I}return E.prototype.connect=function(){var I,w,c,t,l,s,m,a,o,p,T,b,L,N,D,U,H,k,M,z;return r(this,void 0,void 0,function(){var q,V,X,oe,de,ge,_e,ve,Ne,j=this;return u(this,function(W){switch(W.label){case 0:return q=this.config,V={type:_.FrameTypes.SETUP,dataMimeType:(w=(I=q.setup)===null||I===void 0?void 0:I.dataMimeType)!==null&&w!==void 0?w:"application/octet-stream",metadataMimeType:(t=(c=q.setup)===null||c===void 0?void 0:c.metadataMimeType)!==null&&t!==void 0?t:"application/octet-stream",keepAlive:(s=(l=q.setup)===null||l===void 0?void 0:l.keepAlive)!==null&&s!==void 0?s:6e4,lifetime:(a=(m=q.setup)===null||m===void 0?void 0:m.lifetime)!==null&&a!==void 0?a:3e5,metadata:(p=(o=q.setup)===null||o===void 0?void 0:o.payload)===null||p===void 0?void 0:p.metadata,data:(b=(T=q.setup)===null||T===void 0?void 0:T.payload)===null||b===void 0?void 0:b.data,resumeToken:(N=(L=q.resume)===null||L===void 0?void 0:L.tokenGenerator())!==null&&N!==void 0?N:null,streamId:0,majorVersion:1,minorVersion:0,flags:(!((U=(D=q.setup)===null||D===void 0?void 0:D.payload)===null||U===void 0)&&U.metadata?_.Flags.METADATA:_.Flags.NONE)|(q.lease?_.Flags.LEASE:_.Flags.NONE)|(q.resume?_.Flags.RESUME_ENABLE:_.Flags.NONE)},[4,q.transport.connect(function(ne){return q.resume?new i.ResumableClientServerInputMultiplexerDemultiplexer(i.StreamIdGenerator.create(-1),ne,ne,new R.FrameStore,V.resumeToken.toString(),function(Re,Te){return r(j,void 0,void 0,function(){var Se,pe,ee;return u(this,function(ue){switch(ue.label){case 0:return Se=function(Ee){return Ee.send({type:_.FrameTypes.RESUME,streamId:0,flags:_.Flags.NONE,clientPosition:Te.firstAvailableFramePosition,serverPosition:Te.lastReceivedFramePosition,majorVersion:V.minorVersion,minorVersion:V.majorVersion,resumeToken:V.resumeToken}),new i.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(Ee,Ee,Re)},pe=-1,ee=function(){return pe++,q.resume.reconnectFunction(pe).then(function(){return q.transport.connect(Se).catch(ee)})},[4,ee()];case 1:return ue.sent(),[2]}})})}):new i.ClientServerInputMultiplexerDemultiplexer(i.StreamIdGenerator.create(-1),ne,ne)})];case 1:return X=W.sent(),oe=new g.KeepAliveSender(X.multiplexerDemultiplexer.connectionOutbound,V.keepAlive),de=new g.KeepAliveHandler(X,V.lifetime),ge=q.lease?new g.LeaseHandler((H=q.lease.maxPendingRequests)!==null&&H!==void 0?H:256,X.multiplexerDemultiplexer):void 0,_e=(k=q.responder)!==null&&k!==void 0?k:{},ve=new g.DefaultConnectionFrameHandler(X,de,oe,ge,_e),Ne=new g.DefaultStreamRequestHandler(_e,0),X.onClose(function(ne){oe.close(),de.close(),ve.close(ne)}),X.multiplexerDemultiplexer.connectionInbound(ve),X.multiplexerDemultiplexer.handleRequestStream(Ne),X.multiplexerDemultiplexer.connectionOutbound.send(V),de.start(),oe.start(),[2,new g.RSocketRequester(X,(z=(M=q.fragmentation)===null||M===void 0?void 0:M.maxOutboundFragmentSize)!==null&&z!==void 0?z:0,ge)]}})})},E})();return ce.RSocketConnector=f,ce}var fe={},an;function rr(){if(an)return fe;an=1;var r=fe&&fe.__awaiter||function(I,w,c,t){function l(s){return s instanceof c?s:new c(function(m){m(s)})}return new(c||(c=Promise))(function(s,m){function a(T){try{p(t.next(T))}catch(b){m(b)}}function o(T){try{p(t.throw(T))}catch(b){m(b)}}function p(T){T.done?s(T.value):l(T.value).then(a,o)}p((t=t.apply(I,w||[])).next())})},u=fe&&fe.__generator||function(I,w){var c={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},t,l,s,m;return m={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(m[Symbol.iterator]=function(){return this}),m;function a(p){return function(T){return o([p,T])}}function o(p){if(t)throw new TypeError("Generator is already executing.");for(;c;)try{if(t=1,l&&(s=p[0]&2?l.return:p[0]?l.throw||((s=l.return)&&s.call(l),0):l.next)&&!(s=s.call(l,p[1])).done)return s;switch(l=0,s&&(p=[p[0]&2,s.value]),p[0]){case 0:case 1:s=p;break;case 4:return c.label++,{value:p[1],done:!1};case 5:c.label++,l=p[1],p=[0];continue;case 7:p=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(p[0]===6||p[0]===2)){c=0;continue}if(p[0]===3&&(!s||p[1]>s[0]&&p[1]<s[3])){c.label=p[1];break}if(p[0]===6&&c.label<s[1]){c.label=s[1],s=p;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(p);break}s[2]&&c.ops.pop(),c.trys.pop();continue}p=w.call(I,c)}catch(T){p=[6,T],l=0}finally{t=s=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}};Object.defineProperty(fe,"__esModule",{value:!0}),fe.RSocketServer=void 0;var i=vn(),_=ye(),g=se(),R=Rn(),f=Tn(),E=(function(){function I(w){var c,t;this.acceptor=w.acceptor,this.transport=w.transport,this.lease=w.lease,this.serverSideKeepAlive=w.serverSideKeepAlive,this.sessionStore=w.resume?{}:void 0,this.sessionTimeout=(t=(c=w.resume)===null||c===void 0?void 0:c.sessionTimeout)!==null&&t!==void 0?t:void 0}return I.prototype.bind=function(){return r(this,void 0,void 0,function(){var w=this;return u(this,function(c){switch(c.label){case 0:return[4,this.transport.bind(function(t,l){return r(w,void 0,void 0,function(){var s,m,m,a,o,p,T,b,L,N,D,U,H,k,M;return u(this,function(z){switch(z.label){case 0:switch(s=t.type,s){case g.FrameTypes.SETUP:return[3,1];case g.FrameTypes.RESUME:return[3,5]}return[3,6];case 1:return z.trys.push([1,3,,4]),this.lease&&!g.Flags.hasLease(t.flags)?(m=new _.RSocketError(_.ErrorCodes.REJECTED_SETUP,"Lease has to be enabled"),l.multiplexerDemultiplexer.connectionOutbound.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:m.code,message:m.message}),l.close(m),[2]):g.Flags.hasLease(t.flags)&&!this.lease?(m=new _.RSocketError(_.ErrorCodes.REJECTED_SETUP,"Lease has to be disabled"),l.multiplexerDemultiplexer.connectionOutbound.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:m.code,message:m.message}),l.close(m),[2]):(a=g.Flags.hasLease(t.flags)?new R.LeaseHandler((U=this.lease.maxPendingRequests)!==null&&U!==void 0?U:256,l.multiplexerDemultiplexer):void 0,o=new R.RSocketRequester(l,(k=(H=this.fragmentation)===null||H===void 0?void 0:H.maxOutboundFragmentSize)!==null&&k!==void 0?k:0,a),[4,this.acceptor.accept({data:t.data,dataMimeType:t.dataMimeType,metadata:t.metadata,metadataMimeType:t.metadataMimeType,flags:t.flags,keepAliveMaxLifetime:t.lifetime,keepAliveInterval:t.keepAlive,resumeToken:t.resumeToken},o)]);case 2:return p=z.sent(),T=new R.KeepAliveHandler(l,t.lifetime),b=this.serverSideKeepAlive?new R.KeepAliveSender(l.multiplexerDemultiplexer.connectionOutbound,t.keepAlive):void 0,L=new R.DefaultConnectionFrameHandler(l,T,b,a,p),N=new R.DefaultStreamRequestHandler(p,0),l.onClose(function(q){b==null||b.close(),T.close(),L.close(q)}),l.multiplexerDemultiplexer.connectionInbound(L),l.multiplexerDemultiplexer.handleRequestStream(N),T.start(),b==null||b.start(),[3,4];case 3:return D=z.sent(),l.multiplexerDemultiplexer.connectionOutbound.send({type:g.FrameTypes.ERROR,streamId:0,code:_.ErrorCodes.REJECTED_SETUP,message:(M=D.message)!==null&&M!==void 0?M:"",flags:g.Flags.NONE}),l.close(D instanceof _.RSocketError?D:new _.RSocketError(_.ErrorCodes.REJECTED_SETUP,D.message)),[3,4];case 4:return[2];case 5:return[2];case 6:l.multiplexerDemultiplexer.connectionOutbound.send({type:g.FrameTypes.ERROR,streamId:0,code:_.ErrorCodes.UNSUPPORTED_SETUP,message:"Unsupported setup",flags:g.Flags.NONE}),l.close(new _.RSocketError(_.ErrorCodes.UNSUPPORTED_SETUP)),z.label=7;case 7:return[2]}})})},function(t,l){if(t.type===g.FrameTypes.RESUME){if(w.sessionStore){var s=w.sessionStore[t.resumeToken.toString()];if(!s){l.send({type:g.FrameTypes.ERROR,streamId:0,code:_.ErrorCodes.REJECTED_RESUME,message:"No session found for the given resume token",flags:g.Flags.NONE}),l.close();return}return s.resume(t,l,l),s}l.send({type:g.FrameTypes.ERROR,streamId:0,code:_.ErrorCodes.REJECTED_RESUME,message:"Resume is not enabled",flags:g.Flags.NONE}),l.close();return}else if(t.type===g.FrameTypes.SETUP&&g.Flags.hasResume(t.flags)){if(!w.sessionStore){var m=new _.RSocketError(_.ErrorCodes.REJECTED_SETUP,"No resume support");l.send({type:g.FrameTypes.ERROR,streamId:0,flags:g.Flags.NONE,code:m.code,message:m.message}),l.close(m);return}var a=new i.ResumableClientServerInputMultiplexerDemultiplexer(i.StreamIdGenerator.create(0),l,l,new f.FrameStore,t.resumeToken.toString(),w.sessionStore,w.sessionTimeout);return w.sessionStore[t.resumeToken.toString()]=a,a}return new i.ClientServerInputMultiplexerDemultiplexer(i.StreamIdGenerator.create(0),l,l)})];case 1:return[2,c.sent()]}})})},I})();return fe.RSocketServer=E,fe}var vt={},on;function ir(){return on||(on=1,Object.defineProperty(vt,"__esModule",{value:!0})),vt}var un;function ut(){return un||(un=1,(function(r){var u=we&&we.__createBinding||(Object.create?(function(_,g,R,f){f===void 0&&(f=R),Object.defineProperty(_,f,{enumerable:!0,get:function(){return g[R]}})}):(function(_,g,R,f){f===void 0&&(f=R),_[f]=g[R]})),i=we&&we.__exportStar||function(_,g){for(var R in _)R!=="default"&&!Object.prototype.hasOwnProperty.call(g,R)&&u(g,_,R)};Object.defineProperty(r,"__esModule",{value:!0}),i(gn(),r),i(Yn(),r),i(_n(),r),i(ye(),r),i(se(),r),i(Jn(),r),i(nr(),r),i(rr(),r),i(ir(),r)})(we)),we}ut();var be={},cn;function sr(){if(cn)return be;cn=1;var r=be&&be.__extends||(function(){var _=function(g,R){return _=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(f,E){f.__proto__=E}||function(f,E){for(var I in E)Object.prototype.hasOwnProperty.call(E,I)&&(f[I]=E[I])},_(g,R)};return function(g,R){if(typeof R!="function"&&R!==null)throw new TypeError("Class extends value "+String(R)+" is not a constructor or null");_(g,R);function f(){this.constructor=g}g.prototype=R===null?Object.create(R):(f.prototype=R.prototype,new f)}})();Object.defineProperty(be,"__esModule",{value:!0}),be.WebsocketDuplexConnection=void 0;var u=ut(),i=(function(_){r(g,_);function g(R,f,E){var I=_.call(this)||this;return I.websocket=R,I.deserializer=f,I.handleClosed=function(w){I.close(new Error(w.reason||"WebsocketDuplexConnection: Socket closed unexpectedly."))},I.handleError=function(w){I.close(w.error)},I.handleMessage=function(w){try{var c=Q.Buffer.from(w.data),t=I.deserializer.deserializeFrame(c);I.multiplexerDemultiplexer.handle(t)}catch(l){I.close(l)}},R.addEventListener("close",I.handleClosed),R.addEventListener("error",I.handleError),R.addEventListener("message",I.handleMessage),I.multiplexerDemultiplexer=E(I),I}return Object.defineProperty(g.prototype,"availability",{get:function(){return this.done?0:1},enumerable:!1,configurable:!0}),g.prototype.close=function(R){if(this.done){_.prototype.close.call(this,R);return}this.websocket.removeEventListener("close",this.handleClosed),this.websocket.removeEventListener("error",this.handleError),this.websocket.removeEventListener("message",this.handleMessage),this.websocket.close(),delete this.websocket,_.prototype.close.call(this,R)},g.prototype.send=function(R){if(!this.done){var f=(0,u.serializeFrame)(R);this.websocket.send(f)}},g})(u.Deferred);return be.WebsocketDuplexConnection=i,be}sr();st.get("PowerSyncRemote");var Tt;(function(r){r.Buffered="buffered",r.Sequential="sequential"})(Tt||(Tt={}));var ln;(function(r){r.CRUD="crud",r.SYNC="sync"})(ln||(ln={}));var St;(function(r){r.HTTP="http",r.WEB_SOCKET="web-socket"})(St||(St={}));var Ft;(function(r){r.JAVASCRIPT="js",r.RUST="rust"})(Ft||(Ft={}));Ft.RUST;St.WEB_SOCKET,Tt.Buffered;var hn;(function(r){r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(hn||(hn={}));var Ge;(function(r){r.TEXT="TEXT",r.INTEGER="INTEGER",r.REAL="REAL"})(Ge||(Ge={}));Ge.TEXT;Ge.INTEGER;Ge.REAL;const Le=st;Le.TRACE,Le.DEBUG,Le.INFO,Le.TIME,Le.WARN,Le.ERROR,Le.OFF;function ar(){return st}function or(r,u={}){const i=st.get(r);return u.logLevel&&i.setLevel(u.logLevel),i}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Sn=Symbol("Comlink.proxy"),ur=Symbol("Comlink.endpoint"),cr=Symbol("Comlink.releaseProxy"),Rt=Symbol("Comlink.finalizer"),$e=Symbol("Comlink.thrown"),Fn=r=>typeof r=="object"&&r!==null||typeof r=="function",lr={canHandle:r=>Fn(r)&&r[Sn],serialize(r){const{port1:u,port2:i}=new MessageChannel;return tt(r,u),[i,[i]]},deserialize(r){return r.start(),pr(r)}},hr={canHandle:r=>Fn(r)&&$e in r,serialize({value:r}){let u;return r instanceof Error?u={isError:!0,value:{message:r.message,name:r.name,stack:r.stack}}:u={isError:!1,value:r},[u,[]]},deserialize(r){throw r.isError?Object.assign(new Error(r.value.message),r.value):r.value}},wn=new Map([["proxy",lr],["throw",hr]]);function fr(r,u){for(const i of r)if(u===i||i==="*"||i instanceof RegExp&&i.test(u))return!0;return!1}function tt(r,u=globalThis,i=["*"]){u.addEventListener("message",function _(g){if(!g||!g.data)return;if(!fr(i,g.origin)){console.warn(`Invalid origin '${g.origin}' for comlink proxy`);return}const{id:R,type:f,path:E}=Object.assign({path:[]},g.data),I=(g.data.argumentList||[]).map(Oe);let w;try{const c=E.slice(0,-1).reduce((l,s)=>l[s],r),t=E.reduce((l,s)=>l[s],r);switch(f){case"GET":w=t;break;case"SET":c[E.slice(-1)[0]]=Oe(g.data.value),w=!0;break;case"APPLY":w=t.apply(c,I);break;case"CONSTRUCT":{const l=new t(...I);w=It(l)}break;case"ENDPOINT":{const{port1:l,port2:s}=new MessageChannel;tt(r,s),w=gr(l,[l])}break;case"RELEASE":w=void 0;break;default:return}}catch(c){w={value:c,[$e]:0}}Promise.resolve(w).catch(c=>({value:c,[$e]:0})).then(c=>{const[t,l]=it(c);u.postMessage(Object.assign(Object.assign({},t),{id:R}),l),f==="RELEASE"&&(u.removeEventListener("message",_),In(u),Rt in r&&typeof r[Rt]=="function"&&r[Rt]())}).catch(c=>{const[t,l]=it({value:new TypeError("Unserializable return value"),[$e]:0});u.postMessage(Object.assign(Object.assign({},t),{id:R}),l)})}),u.start&&u.start()}function dr(r){return r.constructor.name==="MessagePort"}function In(r){dr(r)&&r.close()}function pr(r,u){const i=new Map;return r.addEventListener("message",function(g){const{data:R}=g;if(!R||!R.id)return;const f=i.get(R.id);if(f)try{f(R)}finally{i.delete(R.id)}}),wt(r,i,[],u)}function Je(r){if(r)throw new Error("Proxy has been released and is not useable")}function An(r){return qe(r,new Map,{type:"RELEASE"}).then(()=>{In(r)})}const nt=new WeakMap,rt="FinalizationRegistry"in globalThis&&new FinalizationRegistry(r=>{const u=(nt.get(r)||0)-1;nt.set(r,u),u===0&&An(r)});function Er(r,u){const i=(nt.get(u)||0)+1;nt.set(u,i),rt&&rt.register(r,u,r)}function mr(r){rt&&rt.unregister(r)}function wt(r,u,i=[],_=function(){}){let g=!1;const R=new Proxy(_,{get(f,E){if(Je(g),E===cr)return()=>{mr(R),An(r),u.clear(),g=!0};if(E==="then"){if(i.length===0)return{then:()=>R};const I=qe(r,u,{type:"GET",path:i.map(w=>w.toString())}).then(Oe);return I.then.bind(I)}return wt(r,u,[...i,E])},set(f,E,I){Je(g);const[w,c]=it(I);return qe(r,u,{type:"SET",path:[...i,E].map(t=>t.toString()),value:w},c).then(Oe)},apply(f,E,I){Je(g);const w=i[i.length-1];if(w===ur)return qe(r,u,{type:"ENDPOINT"}).then(Oe);if(w==="bind")return wt(r,u,i.slice(0,-1));const[c,t]=fn(I);return qe(r,u,{type:"APPLY",path:i.map(l=>l.toString()),argumentList:c},t).then(Oe)},construct(f,E){Je(g);const[I,w]=fn(E);return qe(r,u,{type:"CONSTRUCT",path:i.map(c=>c.toString()),argumentList:I},w).then(Oe)}});return Er(R,r),R}function yr(r){return Array.prototype.concat.apply([],r)}function fn(r){const u=r.map(it);return[u.map(i=>i[0]),yr(u.map(i=>i[1]))]}const bn=new WeakMap;function gr(r,u){return bn.set(r,u),r}function It(r){return Object.assign(r,{[Sn]:!0})}function it(r){for(const[u,i]of wn)if(i.canHandle(r)){const[_,g]=i.serialize(r);return[{type:"HANDLER",name:u,value:_},g]}return[{type:"RAW",value:r},bn.get(r)||[]]}function Oe(r){switch(r.type){case"HANDLER":return wn.get(r.name).deserialize(r.value);case"RAW":return r.value}}function qe(r,u,i,_){return new Promise(g=>{const R=_r();u.set(R,g),r.start&&r.start(),r.postMessage(Object.assign({id:R},i),_)})}function _r(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const vr=()=>{if("locks"in navigator&&navigator.locks)return navigator.locks;throw new Error("Navigator locks are not available in an insecure context. Use a secure context such as HTTPS or http://localhost.")};class Rr{constructor(u){G(this,"options");G(this,"isClosing");G(this,"activeHoldId");this.options=u,this.clientIds.add(u.clientId),this.isClosing=!1,this.activeHoldId=null}get logger(){return this.options.logger}get dbEntry(){return this.options.dbMap.get(this.options.dbFilename)}get connection(){return this.dbEntry.db}get clientIds(){return this.dbEntry.clientIds}async init(){}async markHold(){return this.activeHoldId=await this.connection.markHold(),this.activeHoldId}async releaseHold(u){try{await this.connection.releaseHold(u)}finally{this.activeHoldId=null}}async isAutoCommit(){return this.connection.isAutoCommit()}async close(){this.isClosing=!0;const{clientIds:u,logger:i}=this,{clientId:_,dbFilename:g,dbMap:R}=this.options;if(i.debug(`Close requested from client ${_} of ${[...u]}`),u.delete(_),this.activeHoldId&&this.logger.info(`Hold ${this.activeHoldId} was still active when the connection was closed. Cleanup will occur once a new hold is acquired.`),u.size==0){i.debug(`Closing connection to ${this.options}.`);const f=this.connection;R.delete(g),await f.close();return}i.debug(`Connection to ${g} not closed yet due to active clients.`)}async withClosing(u){if(this.isClosing)throw new Error("Connection is closing");return u()}async execute(u,i){return this.withClosing(()=>this.connection.execute(u,i))}async executeRaw(u,i){return this.withClosing(()=>this.connection.executeRaw(u,i))}executeBatch(u,i){return this.withClosing(()=>this.connection.executeBatch(u,i))}registerOnTableChange(u){return this.connection.registerOnTableChange(u)}getConfig(){return this.connection.getConfig()}}var We;(function(r){r.IDBBatchAtomicVFS="IDBBatchAtomicVFS",r.OPFSCoopSyncVFS="OPFSCoopSyncVFS",r.AccessHandlePoolVFS="AccessHandlePoolVFS"})(We||(We={}));const Tr=async()=>{const{default:r}=await import("./wa-sqlite-async-B2LaFWqa.js");return r()},Sr=async()=>{const{default:r}=await import("./mc-wa-sqlite-async-CXXv26nd.js");return r()},dn=async()=>{const{default:r}=await import("./wa-sqlite-8g52zAnM.js");return r()},pn=async()=>{const{default:r}=await import("./mc-wa-sqlite-DZYOhcgT.js");return r()},Fr={[We.IDBBatchAtomicVFS]:async r=>{let u;r.encryptionKey?u=await Sr():u=await Tr();const{IDBBatchAtomicVFS:i}=await import("./IDBBatchAtomicVFS-DKO0y2_v.js");return{module:u,vfs:await i.create(r.dbFileName,u,{lockPolicy:"exclusive"})}},[We.AccessHandlePoolVFS]:async r=>{let u;r.encryptionKey?u=await pn():u=await dn();const{AccessHandlePoolVFS:i}=await import("./AccessHandlePoolVFS-CKCe6db2.js");return{module:u,vfs:await i.create(r.dbFileName,u)}},[We.OPFSCoopSyncVFS]:async r=>{let u;r.encryptionKey?u=await pn():u=await dn();const{OPFSCoopSyncVFS:i}=await import("./OPFSCoopSyncVFS-kt59qS4S.js"),_=await i.create(r.dbFileName,u);return{module:u,vfs:_}}};class wr extends Gn{constructor(i){super();G(this,"options");G(this,"_sqliteAPI",null);G(this,"_dbP",null);G(this,"_moduleFactory");G(this,"updatedTables");G(this,"updateTimer");G(this,"statementMutex");G(this,"broadcastChannel");G(this,"connectionId");G(this,"_holdCounter");G(this,"_holdId");G(this,"acquireExecuteLock",i=>this.statementMutex.runExclusive(i));this.options=i,this.updatedTables=new Set,this.updateTimer=null,this.broadcastChannel=null,this.connectionId=new Date().valueOf()+Math.random(),this.statementMutex=new Mn,this._moduleFactory=Fr[this.options.vfs],this._holdCounter=0,this._holdId=null}get currentHoldId(){return this._holdId}get sqliteAPI(){if(!this._sqliteAPI)throw new Error("Initialization has not completed");return this._sqliteAPI}get dbP(){if(!this._dbP)throw new Error("Initialization has not completed");return this._dbP}async isAutoCommit(){return this.sqliteAPI.get_autocommit(this.dbP)!=0}async markHold(){const i=this._holdId;return this._holdId=`${++this._holdCounter}`,i&&await this.iterateAsyncListeners(async _=>{var g;return(g=_.holdOverwritten)==null?void 0:g.call(_,i)}),this._holdId}async releaseHold(i){if(i!=this._holdId)throw new Error(`Invalid hold state, expected ${this._holdId} but got ${i}`);this._holdId=null}async openDB(){return this._dbP=await this.sqliteAPI.open_v2(this.options.dbFilename),this._dbP}async executeEncryptionPragma(){this.options.encryptionKey&&await this.executeSingleStatement(`PRAGMA key = "${this.options.encryptionKey}"`)}async openSQLiteAPI(){const{module:i,vfs:_}=await this._moduleFactory({dbFileName:this.options.dbFilename,encryptionKey:this.options.encryptionKey}),g=Cn(i);if(g.vfs_register(_,!0),i.ccall("powersync_init_static","int",[]),this.options.encryptionKey&&i.ccall("sqlite3mc_vfs_create","int",["string","int"],[this.options.dbFilename,1])!==0)throw new Error("Failed to create multiple cipher vfs, Database encryption will not work");return g}registerBroadcastListeners(){this.broadcastChannel=new BroadcastChannel(`${this.options.dbFilename}-table-updates`),this.broadcastChannel.addEventListener("message",i=>{const _=i.data;this.connectionId!=_.connectionId&&this.queueTableUpdate(_.changedTables,!1)})}queueTableUpdate(i,_=!0){i.forEach(g=>this.updatedTables.add(g)),this.updateTimer==null&&(this.updateTimer=setTimeout(()=>this.fireUpdates(_),0))}async init(){this._sqliteAPI=await this.openSQLiteAPI(),await this.openDB(),this.registerBroadcastListeners(),await this.executeSingleStatement(`PRAGMA temp_store = ${this.options.temporaryStorage};`),await this.executeEncryptionPragma(),await this.executeSingleStatement(`PRAGMA cache_size = -${this.options.cacheSizeKb};`),this.sqliteAPI.update_hook(this.dbP,(i,_,g)=>{if(!g)return;const R=new Set([g]);this.queueTableUpdate(R)})}async getConfig(){return this.options}fireUpdates(i=!0){this.updateTimer=null;const _={tables:[...this.updatedTables],groupedUpdates:{},rawUpdates:[]};i&&this.broadcastChannel.postMessage({changedTables:this.updatedTables,connectionId:this.connectionId}),this.updatedTables.clear(),this.iterateListeners(g=>{var R;return(R=g.tablesUpdated)==null?void 0:R.call(g,_)})}async executeBatch(i,_){return this.acquireExecuteLock(async()=>{let g=0;try{await this.executeSingleStatement("BEGIN TRANSACTION");const f=_||[];for await(const E of this.sqliteAPI.statements(this.dbP,i)){if(E===null)return{rowsAffected:0,rows:{_array:[],length:0}};for(const I of f){for(let c=0;c<I.length;c++){const t=I[c];typeof t=="boolean"&&(I[c]=t?1:0)}_&&this.sqliteAPI.bind_collection(E,I),await this.sqliteAPI.step(E)===101&&(g+=this.sqliteAPI.changes(this.dbP)),this.sqliteAPI.reset(E)}}await this.executeSingleStatement("COMMIT")}catch{return await this.executeSingleStatement("ROLLBACK"),{rowsAffected:0,rows:{_array:[],length:0}}}return{rowsAffected:g,rows:{_array:[],length:0}}})}async execute(i,_){return this.acquireExecuteLock(async()=>this.executeSingleStatement(i,_))}async executeRaw(i,_){return this.acquireExecuteLock(async()=>this.executeSingleStatementRaw(i,_))}async close(){var i;(i=this.broadcastChannel)==null||i.close(),await this.acquireExecuteLock(async()=>{await this.sqliteAPI.close(this.dbP)})}async registerOnTableChange(i){return this.registerListener({tablesUpdated:_=>i(_)})}async executeSingleStatement(i,_){const g=await this._execute(i,_),R=[];for(const E of g)for(const I of E.rows){const w={};E.columns.forEach((c,t)=>{w[c]=I[t]}),R.push(w)}return{insertId:this.sqliteAPI.last_insert_id(this.dbP),rowsAffected:this.sqliteAPI.changes(this.dbP),rows:{_array:R,length:R.length}}}async executeSingleStatementRaw(i,_){return(await this._execute(i,_)).flatMap(R=>R.rows.map(f=>R.columns.map((E,I)=>f[I])))}async _execute(i,_){const g=[];for await(const R of this.sqliteAPI.statements(this.dbP,i)){let f;const E=_?[_]:[[]];for(const I of E){I.forEach((c,t,l)=>{typeof c=="boolean"&&(l[t]=c?1:0)}),this.sqliteAPI.reset(R),_&&this.sqliteAPI.bind_collection(R,I);const w=[];for(;await this.sqliteAPI.step(R)===100;){const c=this.sqliteAPI.row(R);w.push(c)}f=f??this.sqliteAPI.column_names(R),f.length&&g.push({columns:f,rows:w})}if(_)break}return g}}class Ir extends wr{async registerOnTableChange(u){return It(await super.registerOnTableChange(u))}}const Ar=ar();Ar.useDefaults();const En=or("db-worker"),et=new Map,br="open-wasqlite-db";let Lr=1;const mn=async r=>vr().request(br,async()=>{const u=Lr++,{dbFilename:i,logLevel:_}=r;if(En.setLevel(_),!et.has(i)){const R=new Set,f=new Ir(r);await f.init(),f.registerListener({holdOverwritten:async()=>{await f.execute("ROLLBACK").catch(()=>{})}}),et.set(i,{clientIds:R,db:f})}const g=new Rr({dbMap:et,dbFilename:i,clientId:u,logger:En});return It(g)});if(typeof SharedWorkerGlobalScope<"u"){const r=self;r.onconnect=function(u){const i=u.ports[0];tt(mn,i)}}else tt(mn);addEventListener("unload",()=>{Array.from(et.values()).forEach(async r=>{var i;const{db:u}=r;(i=u.close)==null||i.call(u)})});export{li as A,ci as B,xr as C,Dr as D,ui as E,oi as F,ei as G,ti as H,ni as I,Jr as J,Nr as S,zr as a,Vr as b,Br as c,Pr as d,ri as e,Cr as f,si as g,ai as h,ii as i,Kr as j,Ur as k,kr as l,qr as m,Yr as n,Mr as o,Wr as p,jr as q,Zr as r,$r as s,Xr as t,Gr as u,Hr as v,Qr as w,di as x,fi as y,hi as z};
