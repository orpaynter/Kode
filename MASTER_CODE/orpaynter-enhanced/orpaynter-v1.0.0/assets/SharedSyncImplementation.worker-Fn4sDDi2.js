var en=Object.defineProperty;var tn=(c,o,e)=>o in c?en(c,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[o]=e;var A=(c,o,e)=>tn(c,typeof o!="symbol"?o+"":o,e);const rn=new Error("request for lock canceled");var nn=function(c,o,e,n){function a(h){return h instanceof e?h:new e(function(s){s(h)})}return new(e||(e=Promise))(function(h,s){function d(l){try{R(n.next(l))}catch(r){s(r)}}function v(l){try{R(n.throw(l))}catch(r){s(r)}}function R(l){l.done?h(l.value):a(l.value).then(d,v)}R((n=n.apply(c,o||[])).next())})};class sn{constructor(o,e=rn){this._value=o,this._cancelError=e,this._queue=[],this._weightedWaiters=[]}acquire(o=1,e=0){if(o<=0)throw new Error(`invalid weight ${o}: must be positive`);return new Promise((n,a)=>{const h={resolve:n,reject:a,weight:o,priority:e},s=Nr(this._queue,d=>e<=d.priority);s===-1&&o<=this._value?this._dispatchItem(h):this._queue.splice(s+1,0,h)})}runExclusive(o){return nn(this,arguments,void 0,function*(e,n=1,a=0){const[h,s]=yield this.acquire(n,a);try{return yield e(h)}finally{s()}})}waitForUnlock(o=1,e=0){if(o<=0)throw new Error(`invalid weight ${o}: must be positive`);return this._couldLockImmediately(o,e)?Promise.resolve():new Promise(n=>{this._weightedWaiters[o-1]||(this._weightedWaiters[o-1]=[]),an(this._weightedWaiters[o-1],{resolve:n,priority:e})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(o){this._value=o,this._dispatchQueue()}release(o=1){if(o<=0)throw new Error(`invalid weight ${o}: must be positive`);this._value+=o,this._dispatchQueue()}cancel(){this._queue.forEach(o=>o.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(o){const e=this._value;this._value-=o.weight,o.resolve([e,this._newReleaser(o.weight)])}_newReleaser(o){let e=!1;return()=>{e||(e=!0,this.release(o))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let o=this._value;o>0;o--){const e=this._weightedWaiters[o-1];e&&(e.forEach(n=>n.resolve()),this._weightedWaiters[o-1]=[])}else{const o=this._queue[0].priority;for(let e=this._value;e>0;e--){const n=this._weightedWaiters[e-1];if(!n)continue;const a=n.findIndex(h=>h.priority<=o);(a===-1?n:n.splice(0,a)).forEach((h=>h.resolve()))}}}_couldLockImmediately(o,e){return(this._queue.length===0||this._queue[0].priority<e)&&o<=this._value}}function an(c,o){const e=Nr(c,n=>o.priority<=n.priority);c.splice(e+1,0,o)}function Nr(c,o){for(let e=c.length-1;e>=0;e--)if(o(c[e]))return e;return-1}var on=function(c,o,e,n){function a(h){return h instanceof e?h:new e(function(s){s(h)})}return new(e||(e=Promise))(function(h,s){function d(l){try{R(n.next(l))}catch(r){s(r)}}function v(l){try{R(n.throw(l))}catch(r){s(r)}}function R(l){l.done?h(l.value):a(l.value).then(d,v)}R((n=n.apply(c,o||[])).next())})};class cn{constructor(o){this._semaphore=new sn(1,o)}acquire(){return on(this,arguments,void 0,function*(o=0){const[,e]=yield this._semaphore.acquire(1,o);return e})}runExclusive(o,e=0){return this._semaphore.runExclusive(()=>o(),1,e)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(o=0){return this._semaphore.waitForUnlock(1,o)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}function un(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var qe={},Xe={},Vt;function ln(){if(Vt)return Xe;Vt=1,Object.defineProperty(Xe,"__esModule",{value:!0});class c{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(n){if(this.isStopped)return;const a={value:n,done:!1};if(this.pullQueue.length){const h=this.pullQueue.shift();h&&h.resolve(a)}else this.pushQueue.push(Promise.resolve(a)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const n of this.pullQueue)n.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(n){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const a of this.pullQueue)a.reject(n);this.pullQueue.length=0}else{const a=Promise.reject(n);a.catch(()=>{}),this.pushQueue.push(a)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:n=>{const a=this.pushQueue.shift();return a?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),a):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((h,s)=>{this.pullQueue.push({resolve:h,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class o{constructor(n,{highWaterMark:a=100,lowWaterMark:h=1}={}){const s=new c;s.highWaterMark=a,s.lowWaterMark=h,s.removeCallback=n({push:d=>s.push(d),stop:()=>s.stop(),fail:d=>s.fail(d),on:(d,v)=>{s.eventHandlers[d]=v}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}}return Xe.EventIterator=o,Xe.default=o,Xe}var Gt;function dn(){if(Gt)return qe;Gt=1,Object.defineProperty(qe,"__esModule",{value:!0});const c=ln();qe.EventIterator=c.EventIterator;function o(e,n,a){return new c.EventIterator(({push:h})=>(this.addEventListener(e,h,n),()=>this.removeEventListener(e,h,n)),a)}return qe.subscribe=o,qe.default=c.EventIterator,qe}dn();var ct={exports:{}};/*!
 * js-logger - http://github.com/jonnyreeves/js-logger
 * Jonny Reeves, http://jonnyreeves.co.uk/
 * js-logger may be freely distributed under the MIT license.
 */var hn=ct.exports,Xt;function fn(){return Xt||(Xt=1,(function(c){(function(o){var e={};e.VERSION="1.6.1";var n,a={},h=function(l,r){return function(){return r.apply(l,arguments)}},s=function(){var l=arguments,r=l[0],f,u;for(u=1;u<l.length;u++)for(f in l[u])!(f in r)&&l[u].hasOwnProperty(f)&&(r[f]=l[u][f]);return r},d=function(l,r){return{value:l,name:r}};e.TRACE=d(1,"TRACE"),e.DEBUG=d(2,"DEBUG"),e.INFO=d(3,"INFO"),e.TIME=d(4,"TIME"),e.WARN=d(5,"WARN"),e.ERROR=d(8,"ERROR"),e.OFF=d(99,"OFF");var v=function(l){this.context=l,this.setLevel(l.filterLevel),this.log=this.info};v.prototype={setLevel:function(l){l&&"value"in l&&(this.context.filterLevel=l)},getLevel:function(){return this.context.filterLevel},enabledFor:function(l){var r=this.context.filterLevel;return l.value>=r.value},trace:function(){this.invoke(e.TRACE,arguments)},debug:function(){this.invoke(e.DEBUG,arguments)},info:function(){this.invoke(e.INFO,arguments)},warn:function(){this.invoke(e.WARN,arguments)},error:function(){this.invoke(e.ERROR,arguments)},time:function(l){typeof l=="string"&&l.length>0&&this.invoke(e.TIME,[l,"start"])},timeEnd:function(l){typeof l=="string"&&l.length>0&&this.invoke(e.TIME,[l,"end"])},invoke:function(l,r){n&&this.enabledFor(l)&&n(r,s({level:l},this.context))}};var R=new v({filterLevel:e.OFF});(function(){var l=e;l.enabledFor=h(R,R.enabledFor),l.trace=h(R,R.trace),l.debug=h(R,R.debug),l.time=h(R,R.time),l.timeEnd=h(R,R.timeEnd),l.info=h(R,R.info),l.warn=h(R,R.warn),l.error=h(R,R.error),l.log=l.info})(),e.setHandler=function(l){n=l},e.setLevel=function(l){R.setLevel(l);for(var r in a)a.hasOwnProperty(r)&&a[r].setLevel(l)},e.getLevel=function(){return R.getLevel()},e.get=function(l){return a[l]||(a[l]=new v(s({name:l},R.context)))},e.createDefaultHandler=function(l){l=l||{},l.formatter=l.formatter||function(y,g){g.name&&y.unshift("["+g.name+"]")};var r={},f=function(u,y){Function.prototype.apply.call(u,console,y)};return typeof console>"u"?function(){}:function(u,y){u=Array.prototype.slice.call(u);var g=console.log,E;y.level===e.TIME?(E=(y.name?"["+y.name+"] ":"")+u[0],u[1]==="start"?console.time?console.time(E):r[E]=new Date().getTime():console.timeEnd?console.timeEnd(E):f(g,[E+": "+(new Date().getTime()-r[E])+"ms"])):(y.level===e.WARN&&console.warn?g=console.warn:y.level===e.ERROR&&console.error?g=console.error:y.level===e.INFO&&console.info?g=console.info:y.level===e.DEBUG&&console.debug?g=console.debug:y.level===e.TRACE&&console.trace&&(g=console.trace),l.formatter(u,y),f(g,u))}},e.useDefaults=function(l){e.setLevel(l&&l.defaultLevel||e.DEBUG),e.setHandler(e.createDefaultHandler(l))},e.setDefaults=e.useDefaults,c.exports?c.exports=e:(e._prevLogger=o.Logger,e.noConflict=function(){return o.Logger=e._prevLogger,e},o.Logger=e)})(hn)})(ct)),ct.exports}var pn=fn(),Ne=un(pn),Kt;(function(c){c[c.SQLITE_INSERT=18]="SQLITE_INSERT",c[c.SQLITE_DELETE=9]="SQLITE_DELETE",c[c.SQLITE_UPDATE=23]="SQLITE_UPDATE"})(Kt||(Kt={}));function mn(c){return"tables"in c}function yn(c){return mn(c)?c.tables:[c.table]}const Dr=2147483647;class gn{constructor(o){A(this,"internal");A(this,"totalOperations");A(this,"downloadedOperations");A(this,"downloadedFraction");this.internal=o;const e=this.untilPriority(Dr);this.totalOperations=e.totalOperations,this.downloadedOperations=e.downloadedOperations,this.downloadedFraction=e.downloadedFraction}untilPriority(o){let e=0,n=0;for(const h of Object.values(this.internal))h.priority<=o&&(n+=h.since_last,e+=h.target_count-h.at_last);let a=e==0?0:n/e;return{totalOperations:e,downloadedOperations:n,downloadedFraction:a}}}class Qe{constructor(o){A(this,"options");this.options=o}get clientImplementation(){return this.options.clientImplementation}get connected(){return this.options.connected??!1}get connecting(){return this.options.connecting??!1}get lastSyncedAt(){return this.options.lastSyncedAt}get hasSynced(){return this.options.hasSynced}get dataFlowStatus(){return this.options.dataFlow??{downloading:!1,uploading:!1}}get syncStreams(){var o,e;return(e=(o=this.options.dataFlow)==null?void 0:o.internalStreamSubscriptions)==null?void 0:e.map(n=>new Yt(this,n))}forStream(o){var a,h;const e=JSON.stringify(o.parameters),n=(h=(a=this.options.dataFlow)==null?void 0:a.internalStreamSubscriptions)==null?void 0:h.find(s=>s.name==o.name&&e==JSON.stringify(s.parameters));return n&&new Yt(this,n)}get priorityStatusEntries(){return(this.options.priorityStatusEntries??[]).slice().sort(Qe.comparePriorities)}get downloadProgress(){var e;const o=(e=this.options.dataFlow)==null?void 0:e.downloadProgress;return o==null?null:new gn(o)}statusForPriority(o){for(const e of this.priorityStatusEntries)if(e.priority>=o)return e;return{priority:o,lastSyncedAt:this.lastSyncedAt,hasSynced:this.hasSynced}}isEqual(o){const e=(n,a)=>a instanceof Error?{name:a.name,message:a.message,stack:a.stack}:a;return JSON.stringify(this.options,e)==JSON.stringify(o.options,e)}getMessage(){const o=this.dataFlowStatus;return`SyncStatus<connected: ${this.connected} connecting: ${this.connecting} lastSyncedAt: ${this.lastSyncedAt} hasSynced: ${this.hasSynced}. Downloading: ${o.downloading}. Uploading: ${o.uploading}. UploadError: ${o.uploadError}, DownloadError?: ${o.downloadError}>`}toJSON(){return{connected:this.connected,connecting:this.connecting,dataFlow:{...this.dataFlowStatus,uploadError:this.serializeError(this.dataFlowStatus.uploadError),downloadError:this.serializeError(this.dataFlowStatus.downloadError)},lastSyncedAt:this.lastSyncedAt,hasSynced:this.hasSynced,priorityStatusEntries:this.priorityStatusEntries}}serializeError(o){if(!(typeof o>"u"))return{name:o.name,message:o.message,stack:o.stack}}static comparePriorities(o,e){return e.priority-o.priority}}class Yt{constructor(o,e){A(this,"status");A(this,"core");A(this,"subscription");this.status=o,this.core=e,this.subscription={name:e.name,parameters:e.parameters,active:e.active,isDefault:e.is_default,hasExplicitSubscription:e.has_explicit_subscription,expiresAt:e.expires_at!=null?new Date(e.expires_at*1e3):null,hasSynced:e.last_synced_at!=null,lastSyncedAt:e.last_synced_at!=null?new Date(e.last_synced_at*1e3):null}}get progress(){if(this.status.dataFlowStatus.downloadProgress==null)return null;const{total:o,downloaded:e}=this.core.progress,n=o==0?0:e/o;return{totalOperations:o,downloadedOperations:e,downloadedFraction:n}}get priority(){return this.core.priority}}class De{constructor(){A(this,"listeners",new Set)}dispose(){this.listeners.clear()}registerListener(o){return this.listeners.add(o),()=>{this.listeners.delete(o)}}iterateListeners(o){for(const e of this.listeners)o(e)}async iterateAsyncListeners(o){for(let e of Array.from(this.listeners.values()))await o(e)}}function En(c,o){let e=null,n=0;const a=()=>{c(),n=Date.now(),e=null};return function(){const h=Date.now(),s=o-(h-n);s<=0?a():e||(e=setTimeout(a,s))}}class wn extends De{constructor(e){super();A(this,"options");A(this,"connectingPromise");A(this,"syncStreamInitPromise");A(this,"disconnectingPromise");A(this,"pendingConnectionOptions");A(this,"syncStreamImplementation");A(this,"syncDisposer");A(this,"locallyActiveSubscriptions",new Map);this.options=e,this.connectingPromise=null,this.syncStreamInitPromise=null,this.disconnectingPromise=null,this.pendingConnectionOptions=null,this.syncStreamImplementation=null,this.syncDisposer=null}get connector(){var e;return((e=this.pendingConnectionOptions)==null?void 0:e.connector)??null}get connectionOptions(){var e;return((e=this.pendingConnectionOptions)==null?void 0:e.options)??null}get logger(){return this.options.logger}async close(){var e,n;await((e=this.syncStreamImplementation)==null?void 0:e.dispose()),await((n=this.syncDisposer)==null?void 0:n.call(this))}async connect(e,n){const a=!!this.pendingConnectionOptions;this.pendingConnectionOptions={connector:e,options:n},(!a||this.syncStreamImplementation)&&await this.disconnectInternal();const h=async()=>{if(this.pendingConnectionOptions)return this.connectingPromise=this.connectInternal().catch(()=>{}).finally(h),this.connectingPromise;this.connectingPromise=null};return this.connectingPromise??(this.connectingPromise=this.connectInternal().catch(()=>{}).finally(h)),this.connectingPromise}async connectInternal(){var n;let e=null;await this.disconnectInternal(),this.syncStreamInitPromise=new Promise(async(a,h)=>{try{if(!this.pendingConnectionOptions){this.logger.debug("No pending connection options found, not creating sync stream implementation"),a();return}if(this.disconnectingPromise){a();return}const{connector:s,options:d}=this.pendingConnectionOptions;e=d,this.pendingConnectionOptions=null;const{sync:v,onDispose:R}=await this.options.createSyncImplementation(s,{subscriptions:this.activeStreams,...d});this.iterateListeners(l=>{var r;return(r=l.syncStreamCreated)==null?void 0:r.call(l,v)}),this.syncStreamImplementation=v,this.syncDisposer=R,await this.syncStreamImplementation.waitForReady(),a()}catch(s){h(s)}}),await this.syncStreamInitPromise,this.syncStreamInitPromise=null,e&&(await this.disconnectingPromise,this.logger.debug("Attempting to connect to PowerSync instance"),await((n=this.syncStreamImplementation)==null?void 0:n.connect(e)))}async disconnect(){this.pendingConnectionOptions=null,await this.disconnectInternal()}async disconnectInternal(){if(this.disconnectingPromise)return this.disconnectingPromise;this.disconnectingPromise=this.performDisconnect(),await this.disconnectingPromise,this.disconnectingPromise=null}async performDisconnect(){await this.syncStreamInitPromise;const e=this.syncStreamImplementation;this.syncStreamImplementation=null;const n=this.syncDisposer;this.syncDisposer=null,await(e==null?void 0:e.disconnect()),await(e==null?void 0:e.dispose()),await(n==null?void 0:n())}stream(e,n,a){const h={name:n,parameters:a},s=d=>e.firstStatusMatching(v=>{var R;return(R=v.forStream(h))==null?void 0:R.subscription.hasSynced},d);return{...h,subscribe:async d=>{await e.rustSubscriptionsCommand({subscribe:{stream:{name:n,params:a},ttl:d==null?void 0:d.ttl,priority:d==null?void 0:d.priority}}),this.syncStreamImplementation||await e.resolveOfflineSyncStatus();const v=`${n}|${JSON.stringify(a)}`;let R=this.locallyActiveSubscriptions.get(v);if(R==null){const l=()=>{this.locallyActiveSubscriptions.delete(v),this.subscriptionsMayHaveChanged()};R=new Sn(n,a,this.logger,s,l),this.locallyActiveSubscriptions.set(v,R),this.subscriptionsMayHaveChanged()}return new vn(R)},unsubscribeAll:async()=>{await e.rustSubscriptionsCommand({unsubscribe:{name:n,params:a}}),this.subscriptionsMayHaveChanged()}}}get activeStreams(){return[...this.locallyActiveSubscriptions.values()].map(e=>({name:e.name,params:e.parameters}))}subscriptionsMayHaveChanged(){var e;(e=this.syncStreamImplementation)==null||e.updateSubscriptions(this.activeStreams)}}class Sn{constructor(o,e,n,a,h){A(this,"name");A(this,"parameters");A(this,"logger");A(this,"waitForFirstSync");A(this,"clearSubscription");A(this,"refcount",0);this.name=o,this.parameters=e,this.logger=n,this.waitForFirstSync=a,this.clearSubscription=h}decrementRefCount(){this.refcount--,this.refcount==0&&this.clearSubscription()}}class vn{constructor(o){A(this,"subscription");A(this,"active",!0);this.subscription=o,o.refcount++,ze==null||ze.register(this,o)}get name(){return this.subscription.name}get parameters(){return this.subscription.parameters}waitForFirstSync(o){return this.subscription.waitForFirstSync(o)}unsubscribe(){this.active&&(this.active=!1,ze==null||ze.unregister(this),this.subscription.decrementRefCount())}}const ze="FinalizationRegistry"in globalThis?new FinalizationRegistry(c=>{c.logger.warn(`A subscription to ${c.name} with params ${JSON.stringify(c.parameters)} leaked! Please ensure calling unsubscribe() when you don't need a subscription anymore. For global subscriptions, consider storing them in global fields to avoid this warning.`)}):null;var Jt;(function(c){c.ON_DATA="onData",c.ON_ERROR="onError",c.ON_STATE_CHANGE="onStateChange",c.SETTINGS_WILL_UPDATE="settingsWillUpdate",c.CLOSED="closed"})(Jt||(Jt={}));var Nt;(function(c){c.DATA="ps_data",c.CRUD="ps_crud",c.BUCKETS="ps_buckets",c.OPLOG="ps_oplog",c.UNTYPED="ps_untyped"})(Nt||(Nt={}));var fe;(function(c){c.PROCESS_TEXT_LINE="line_text",c.PROCESS_BSON_LINE="line_binary",c.STOP="stop",c.START="start",c.NOTIFY_TOKEN_REFRESHED="refreshed_token",c.NOTIFY_CRUD_UPLOAD_COMPLETED="completed_upload",c.UPDATE_SUBSCRIPTIONS="update_subscriptions"})(fe||(fe={}));var $t;(function(c){c.PUT="PUT",c.PATCH="PATCH",c.DELETE="DELETE"})($t||($t={}));class lt{constructor(o,e,n,a,h,s,d,v){A(this,"clientId");A(this,"id");A(this,"op");A(this,"opData");A(this,"previousValues");A(this,"table");A(this,"transactionId");A(this,"metadata");this.clientId=o,this.id=a,this.op=e,this.opData=s,this.table=n,this.transactionId=h,this.previousValues=d,this.metadata=v}static fromRow(o){const e=JSON.parse(o.data);return new lt(parseInt(o.id),e.op,e.type,e.id,o.tx_id,e.data,e.old,e.metadata)}toJSON(){return{op_id:this.clientId,op:this.op,type:this.table,id:this.id,tx_id:this.transactionId,data:this.opData,old:this.previousValues,metadata:this.metadata}}equals(o){return JSON.stringify(this.toComparisonArray())==JSON.stringify(o.toComparisonArray())}hashCode(){return JSON.stringify(this.toComparisonArray())}toComparisonArray(){return[this.transactionId,this.clientId,this.op,this.table,this.id,this.opData,this.previousValues,this.metadata]}}class Z extends Error{constructor(e){super(e);A(this,"reason");this.reason=e,Object.setPrototypeOf(this,Z.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Z)}}var dt;(function(c){c[c.CLEAR=1]="CLEAR",c[c.MOVE=2]="MOVE",c[c.PUT=3]="PUT",c[c.REMOVE=4]="REMOVE"})(dt||(dt={}));class Mt{constructor(o){A(this,"value");this.value=o}static fromJSON(o){return new Mt(dt[o])}toJSON(){return Object.entries(dt).find(([,o])=>o===this.value)[0]}}class Ut{constructor(o,e,n,a,h,s,d){A(this,"op_id");A(this,"op");A(this,"checksum");A(this,"subkey");A(this,"object_type");A(this,"object_id");A(this,"data");this.op_id=o,this.op=e,this.checksum=n,this.subkey=a,this.object_type=h,this.object_id=s,this.data=d}static fromRow(o){return new Ut(o.op_id,Mt.fromJSON(o.op),o.checksum,o.subkey,o.object_type,o.object_id,o.data)}toJSON(o=!1){return{op_id:this.op_id,op:this.op.toJSON(),object_type:this.object_type,object_id:this.object_id,checksum:this.checksum,data:this.data,subkey:o?this.subkey:JSON.stringify(this.subkey)}}}class Bt{constructor(o,e,n,a,h){A(this,"bucket");A(this,"data");A(this,"has_more");A(this,"after");A(this,"next_after");this.bucket=o,this.data=e,this.has_more=n,this.after=a,this.next_after=h}static fromRow(o){return new Bt(o.bucket,o.data.map(e=>Ut.fromRow(e)),o.has_more??!1,o.after,o.next_after)}toJSON(o=!1){return{bucket:this.bucket,has_more:this.has_more,after:this.after,next_after:this.next_after,data:this.data.map(e=>e.toJSON(o))}}}var _t={},Ke={},Zt;function Rn(){if(Zt)return Ke;Zt=1,Ke.byteLength=d,Ke.toByteArray=R,Ke.fromByteArray=f;for(var c=[],o=[],e=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,h=n.length;a<h;++a)c[a]=n[a],o[n.charCodeAt(a)]=a;o[45]=62,o[95]=63;function s(u){var y=u.length;if(y%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var g=u.indexOf("=");g===-1&&(g=y);var E=g===y?0:4-g%4;return[g,E]}function d(u){var y=s(u),g=y[0],E=y[1];return(g+E)*3/4-E}function v(u,y,g){return(y+g)*3/4-g}function R(u){var y,g=s(u),E=g[0],b=g[1],C=new e(v(u,E,b)),I=0,L=b>0?E-4:E,D;for(D=0;D<L;D+=4)y=o[u.charCodeAt(D)]<<18|o[u.charCodeAt(D+1)]<<12|o[u.charCodeAt(D+2)]<<6|o[u.charCodeAt(D+3)],C[I++]=y>>16&255,C[I++]=y>>8&255,C[I++]=y&255;return b===2&&(y=o[u.charCodeAt(D)]<<2|o[u.charCodeAt(D+1)]>>4,C[I++]=y&255),b===1&&(y=o[u.charCodeAt(D)]<<10|o[u.charCodeAt(D+1)]<<4|o[u.charCodeAt(D+2)]>>2,C[I++]=y>>8&255,C[I++]=y&255),C}function l(u){return c[u>>18&63]+c[u>>12&63]+c[u>>6&63]+c[u&63]}function r(u,y,g){for(var E,b=[],C=y;C<g;C+=3)E=(u[C]<<16&16711680)+(u[C+1]<<8&65280)+(u[C+2]&255),b.push(l(E));return b.join("")}function f(u){for(var y,g=u.length,E=g%3,b=[],C=16383,I=0,L=g-E;I<L;I+=C)b.push(r(u,I,I+C>L?L:I+C));return E===1?(y=u[g-1],b.push(c[y>>2]+c[y<<4&63]+"==")):E===2&&(y=(u[g-2]<<8)+u[g-1],b.push(c[y>>10]+c[y>>4&63]+c[y<<2&63]+"=")),b.join("")}return Ke}var at={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */var er;function bn(){return er||(er=1,at.read=function(c,o,e,n,a){var h,s,d=a*8-n-1,v=(1<<d)-1,R=v>>1,l=-7,r=e?a-1:0,f=e?-1:1,u=c[o+r];for(r+=f,h=u&(1<<-l)-1,u>>=-l,l+=d;l>0;h=h*256+c[o+r],r+=f,l-=8);for(s=h&(1<<-l)-1,h>>=-l,l+=n;l>0;s=s*256+c[o+r],r+=f,l-=8);if(h===0)h=1-R;else{if(h===v)return s?NaN:(u?-1:1)*(1/0);s=s+Math.pow(2,n),h=h-R}return(u?-1:1)*s*Math.pow(2,h-n)},at.write=function(c,o,e,n,a,h){var s,d,v,R=h*8-a-1,l=(1<<R)-1,r=l>>1,f=a===23?Math.pow(2,-24)-Math.pow(2,-77):0,u=n?0:h-1,y=n?1:-1,g=o<0||o===0&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(d=isNaN(o)?1:0,s=l):(s=Math.floor(Math.log(o)/Math.LN2),o*(v=Math.pow(2,-s))<1&&(s--,v*=2),s+r>=1?o+=f/v:o+=f*Math.pow(2,1-r),o*v>=2&&(s++,v/=2),s+r>=l?(d=0,s=l):s+r>=1?(d=(o*v-1)*Math.pow(2,a),s=s+r):(d=o*Math.pow(2,r-1)*Math.pow(2,a),s=0));a>=8;c[e+u]=d&255,u+=y,d/=256,a-=8);for(s=s<<a|d,R+=a;R>0;c[e+u]=s&255,u+=y,s/=256,R-=8);c[e+u-y]|=g*128}),at}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var tr;function Tn(){return tr||(tr=1,(function(c){const o=Rn(),e=bn(),n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;c.Buffer=d,c.SlowBuffer=C,c.INSPECT_MAX_BYTES=50;const a=2147483647;c.kMaxLength=a,d.TYPED_ARRAY_SUPPORT=h(),!d.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function h(){try{const m=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(m,t),m.foo()===42}catch{return!1}}Object.defineProperty(d.prototype,"parent",{enumerable:!0,get:function(){if(d.isBuffer(this))return this.buffer}}),Object.defineProperty(d.prototype,"offset",{enumerable:!0,get:function(){if(d.isBuffer(this))return this.byteOffset}});function s(m){if(m>a)throw new RangeError('The value "'+m+'" is invalid for option "size"');const t=new Uint8Array(m);return Object.setPrototypeOf(t,d.prototype),t}function d(m,t,i){if(typeof m=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return r(m)}return v(m,t,i)}d.poolSize=8192;function v(m,t,i){if(typeof m=="string")return f(m,t);if(ArrayBuffer.isView(m))return y(m);if(m==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof m);if(re(m,ArrayBuffer)||m&&re(m.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(re(m,SharedArrayBuffer)||m&&re(m.buffer,SharedArrayBuffer)))return g(m,t,i);if(typeof m=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const w=m.valueOf&&m.valueOf();if(w!=null&&w!==m)return d.from(w,t,i);const F=E(m);if(F)return F;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof m[Symbol.toPrimitive]=="function")return d.from(m[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof m)}d.from=function(m,t,i){return v(m,t,i)},Object.setPrototypeOf(d.prototype,Uint8Array.prototype),Object.setPrototypeOf(d,Uint8Array);function R(m){if(typeof m!="number")throw new TypeError('"size" argument must be of type number');if(m<0)throw new RangeError('The value "'+m+'" is invalid for option "size"')}function l(m,t,i){return R(m),m<=0?s(m):t!==void 0?typeof i=="string"?s(m).fill(t,i):s(m).fill(t):s(m)}d.alloc=function(m,t,i){return l(m,t,i)};function r(m){return R(m),s(m<0?0:b(m)|0)}d.allocUnsafe=function(m){return r(m)},d.allocUnsafeSlow=function(m){return r(m)};function f(m,t){if((typeof t!="string"||t==="")&&(t="utf8"),!d.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const i=I(m,t)|0;let w=s(i);const F=w.write(m,t);return F!==i&&(w=w.slice(0,F)),w}function u(m){const t=m.length<0?0:b(m.length)|0,i=s(t);for(let w=0;w<t;w+=1)i[w]=m[w]&255;return i}function y(m){if(re(m,Uint8Array)){const t=new Uint8Array(m);return g(t.buffer,t.byteOffset,t.byteLength)}return u(m)}function g(m,t,i){if(t<0||m.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(m.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');let w;return t===void 0&&i===void 0?w=new Uint8Array(m):i===void 0?w=new Uint8Array(m,t):w=new Uint8Array(m,t,i),Object.setPrototypeOf(w,d.prototype),w}function E(m){if(d.isBuffer(m)){const t=b(m.length)|0,i=s(t);return i.length===0||m.copy(i,0,0,t),i}if(m.length!==void 0)return typeof m.length!="number"||Me(m.length)?s(0):u(m);if(m.type==="Buffer"&&Array.isArray(m.data))return u(m.data)}function b(m){if(m>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return m|0}function C(m){return+m!=m&&(m=0),d.alloc(+m)}d.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==d.prototype},d.compare=function(t,i){if(re(t,Uint8Array)&&(t=d.from(t,t.offset,t.byteLength)),re(i,Uint8Array)&&(i=d.from(i,i.offset,i.byteLength)),!d.isBuffer(t)||!d.isBuffer(i))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===i)return 0;let w=t.length,F=i.length;for(let p=0,S=Math.min(w,F);p<S;++p)if(t[p]!==i[p]){w=t[p],F=i[p];break}return w<F?-1:F<w?1:0},d.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},d.concat=function(t,i){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return d.alloc(0);let w;if(i===void 0)for(i=0,w=0;w<t.length;++w)i+=t[w].length;const F=d.allocUnsafe(i);let p=0;for(w=0;w<t.length;++w){let S=t[w];if(re(S,Uint8Array))p+S.length>F.length?(d.isBuffer(S)||(S=d.from(S)),S.copy(F,p)):Uint8Array.prototype.set.call(F,S,p);else if(d.isBuffer(S))S.copy(F,p);else throw new TypeError('"list" argument must be an Array of Buffers');p+=S.length}return F};function I(m,t){if(d.isBuffer(m))return m.length;if(ArrayBuffer.isView(m)||re(m,ArrayBuffer))return m.byteLength;if(typeof m!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof m);const i=m.length,w=arguments.length>2&&arguments[2]===!0;if(!w&&i===0)return 0;let F=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return Ge(m).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return i*2;case"hex":return i>>>1;case"base64":return st(m).length;default:if(F)return w?-1:Ge(m).length;t=(""+t).toLowerCase(),F=!0}}d.byteLength=I;function L(m,t,i){let w=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((i===void 0||i>this.length)&&(i=this.length),i<=0)||(i>>>=0,t>>>=0,i<=t))return"";for(m||(m="utf8");;)switch(m){case"hex":return Re(this,t,i);case"utf8":case"utf-8":return z(this,t,i);case"ascii":return Se(this,t,i);case"latin1":case"binary":return ve(this,t,i);case"base64":return G(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Pe(this,t,i);default:if(w)throw new TypeError("Unknown encoding: "+m);m=(m+"").toLowerCase(),w=!0}}d.prototype._isBuffer=!0;function D(m,t,i){const w=m[t];m[t]=m[i],m[i]=w}d.prototype.swap16=function(){const t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let i=0;i<t;i+=2)D(this,i,i+1);return this},d.prototype.swap32=function(){const t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let i=0;i<t;i+=4)D(this,i,i+3),D(this,i+1,i+2);return this},d.prototype.swap64=function(){const t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let i=0;i<t;i+=8)D(this,i,i+7),D(this,i+1,i+6),D(this,i+2,i+5),D(this,i+3,i+4);return this},d.prototype.toString=function(){const t=this.length;return t===0?"":arguments.length===0?z(this,0,t):L.apply(this,arguments)},d.prototype.toLocaleString=d.prototype.toString,d.prototype.equals=function(t){if(!d.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:d.compare(this,t)===0},d.prototype.inspect=function(){let t="";const i=c.INSPECT_MAX_BYTES;return t=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(t+=" ... "),"<Buffer "+t+">"},n&&(d.prototype[n]=d.prototype.inspect),d.prototype.compare=function(t,i,w,F,p){if(re(t,Uint8Array)&&(t=d.from(t,t.offset,t.byteLength)),!d.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(i===void 0&&(i=0),w===void 0&&(w=t?t.length:0),F===void 0&&(F=0),p===void 0&&(p=this.length),i<0||w>t.length||F<0||p>this.length)throw new RangeError("out of range index");if(F>=p&&i>=w)return 0;if(F>=p)return-1;if(i>=w)return 1;if(i>>>=0,w>>>=0,F>>>=0,p>>>=0,this===t)return 0;let S=p-F,T=w-i;const _=Math.min(S,T),N=this.slice(F,p),O=t.slice(i,w);for(let x=0;x<_;++x)if(N[x]!==O[x]){S=N[x],T=O[x];break}return S<T?-1:T<S?1:0};function P(m,t,i,w,F){if(m.length===0)return-1;if(typeof i=="string"?(w=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,Me(i)&&(i=F?0:m.length-1),i<0&&(i=m.length+i),i>=m.length){if(F)return-1;i=m.length-1}else if(i<0)if(F)i=0;else return-1;if(typeof t=="string"&&(t=d.from(t,w)),d.isBuffer(t))return t.length===0?-1:B(m,t,i,w,F);if(typeof t=="number")return t=t&255,typeof Uint8Array.prototype.indexOf=="function"?F?Uint8Array.prototype.indexOf.call(m,t,i):Uint8Array.prototype.lastIndexOf.call(m,t,i):B(m,[t],i,w,F);throw new TypeError("val must be string, number or Buffer")}function B(m,t,i,w,F){let p=1,S=m.length,T=t.length;if(w!==void 0&&(w=String(w).toLowerCase(),w==="ucs2"||w==="ucs-2"||w==="utf16le"||w==="utf-16le")){if(m.length<2||t.length<2)return-1;p=2,S/=2,T/=2,i/=2}function _(O,x){return p===1?O[x]:O.readUInt16BE(x*p)}let N;if(F){let O=-1;for(N=i;N<S;N++)if(_(m,N)===_(t,O===-1?0:N-O)){if(O===-1&&(O=N),N-O+1===T)return O*p}else O!==-1&&(N-=N-O),O=-1}else for(i+T>S&&(i=S-T),N=i;N>=0;N--){let O=!0;for(let x=0;x<T;x++)if(_(m,N+x)!==_(t,x)){O=!1;break}if(O)return N}return-1}d.prototype.includes=function(t,i,w){return this.indexOf(t,i,w)!==-1},d.prototype.indexOf=function(t,i,w){return P(this,t,i,w,!0)},d.prototype.lastIndexOf=function(t,i,w){return P(this,t,i,w,!1)};function Q(m,t,i,w){i=Number(i)||0;const F=m.length-i;w?(w=Number(w),w>F&&(w=F)):w=F;const p=t.length;w>p/2&&(w=p/2);let S;for(S=0;S<w;++S){const T=parseInt(t.substr(S*2,2),16);if(Me(T))return S;m[i+S]=T}return S}function j(m,t,i,w){return ke(Ge(t,m.length-i),m,i,w)}function q(m,t,i,w){return ke(bt(t),m,i,w)}function H(m,t,i,w){return ke(st(t),m,i,w)}function M(m,t,i,w){return ke(it(t,m.length-i),m,i,w)}d.prototype.write=function(t,i,w,F){if(i===void 0)F="utf8",w=this.length,i=0;else if(w===void 0&&typeof i=="string")F=i,w=this.length,i=0;else if(isFinite(i))i=i>>>0,isFinite(w)?(w=w>>>0,F===void 0&&(F="utf8")):(F=w,w=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const p=this.length-i;if((w===void 0||w>p)&&(w=p),t.length>0&&(w<0||i<0)||i>this.length)throw new RangeError("Attempt to write outside buffer bounds");F||(F="utf8");let S=!1;for(;;)switch(F){case"hex":return Q(this,t,i,w);case"utf8":case"utf-8":return j(this,t,i,w);case"ascii":case"latin1":case"binary":return q(this,t,i,w);case"base64":return H(this,t,i,w);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,t,i,w);default:if(S)throw new TypeError("Unknown encoding: "+F);F=(""+F).toLowerCase(),S=!0}},d.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function G(m,t,i){return t===0&&i===m.length?o.fromByteArray(m):o.fromByteArray(m.slice(t,i))}function z(m,t,i){i=Math.min(m.length,i);const w=[];let F=t;for(;F<i;){const p=m[F];let S=null,T=p>239?4:p>223?3:p>191?2:1;if(F+T<=i){let _,N,O,x;switch(T){case 1:p<128&&(S=p);break;case 2:_=m[F+1],(_&192)===128&&(x=(p&31)<<6|_&63,x>127&&(S=x));break;case 3:_=m[F+1],N=m[F+2],(_&192)===128&&(N&192)===128&&(x=(p&15)<<12|(_&63)<<6|N&63,x>2047&&(x<55296||x>57343)&&(S=x));break;case 4:_=m[F+1],N=m[F+2],O=m[F+3],(_&192)===128&&(N&192)===128&&(O&192)===128&&(x=(p&15)<<18|(_&63)<<12|(N&63)<<6|O&63,x>65535&&x<1114112&&(S=x))}}S===null?(S=65533,T=1):S>65535&&(S-=65536,w.push(S>>>10&1023|55296),S=56320|S&1023),w.push(S),F+=T}return pe(w)}const ee=4096;function pe(m){const t=m.length;if(t<=ee)return String.fromCharCode.apply(String,m);let i="",w=0;for(;w<t;)i+=String.fromCharCode.apply(String,m.slice(w,w+=ee));return i}function Se(m,t,i){let w="";i=Math.min(m.length,i);for(let F=t;F<i;++F)w+=String.fromCharCode(m[F]&127);return w}function ve(m,t,i){let w="";i=Math.min(m.length,i);for(let F=t;F<i;++F)w+=String.fromCharCode(m[F]);return w}function Re(m,t,i){const w=m.length;(!t||t<0)&&(t=0),(!i||i<0||i>w)&&(i=w);let F="";for(let p=t;p<i;++p)F+=Tt[m[p]];return F}function Pe(m,t,i){const w=m.slice(t,i);let F="";for(let p=0;p<w.length-1;p+=2)F+=String.fromCharCode(w[p]+w[p+1]*256);return F}d.prototype.slice=function(t,i){const w=this.length;t=~~t,i=i===void 0?w:~~i,t<0?(t+=w,t<0&&(t=0)):t>w&&(t=w),i<0?(i+=w,i<0&&(i=0)):i>w&&(i=w),i<t&&(i=t);const F=this.subarray(t,i);return Object.setPrototypeOf(F,d.prototype),F};function W(m,t,i){if(m%1!==0||m<0)throw new RangeError("offset is not uint");if(m+t>i)throw new RangeError("Trying to access beyond buffer length")}d.prototype.readUintLE=d.prototype.readUIntLE=function(t,i,w){t=t>>>0,i=i>>>0,w||W(t,i,this.length);let F=this[t],p=1,S=0;for(;++S<i&&(p*=256);)F+=this[t+S]*p;return F},d.prototype.readUintBE=d.prototype.readUIntBE=function(t,i,w){t=t>>>0,i=i>>>0,w||W(t,i,this.length);let F=this[t+--i],p=1;for(;i>0&&(p*=256);)F+=this[t+--i]*p;return F},d.prototype.readUint8=d.prototype.readUInt8=function(t,i){return t=t>>>0,i||W(t,1,this.length),this[t]},d.prototype.readUint16LE=d.prototype.readUInt16LE=function(t,i){return t=t>>>0,i||W(t,2,this.length),this[t]|this[t+1]<<8},d.prototype.readUint16BE=d.prototype.readUInt16BE=function(t,i){return t=t>>>0,i||W(t,2,this.length),this[t]<<8|this[t+1]},d.prototype.readUint32LE=d.prototype.readUInt32LE=function(t,i){return t=t>>>0,i||W(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216},d.prototype.readUint32BE=d.prototype.readUInt32BE=function(t,i){return t=t>>>0,i||W(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])},d.prototype.readBigUInt64LE=oe(function(t){t=t>>>0,ge(t,"offset");const i=this[t],w=this[t+7];(i===void 0||w===void 0)&&_e(t,this.length-8);const F=i+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,p=this[++t]+this[++t]*2**8+this[++t]*2**16+w*2**24;return BigInt(F)+(BigInt(p)<<BigInt(32))}),d.prototype.readBigUInt64BE=oe(function(t){t=t>>>0,ge(t,"offset");const i=this[t],w=this[t+7];(i===void 0||w===void 0)&&_e(t,this.length-8);const F=i*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],p=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+w;return(BigInt(F)<<BigInt(32))+BigInt(p)}),d.prototype.readIntLE=function(t,i,w){t=t>>>0,i=i>>>0,w||W(t,i,this.length);let F=this[t],p=1,S=0;for(;++S<i&&(p*=256);)F+=this[t+S]*p;return p*=128,F>=p&&(F-=Math.pow(2,8*i)),F},d.prototype.readIntBE=function(t,i,w){t=t>>>0,i=i>>>0,w||W(t,i,this.length);let F=i,p=1,S=this[t+--F];for(;F>0&&(p*=256);)S+=this[t+--F]*p;return p*=128,S>=p&&(S-=Math.pow(2,8*i)),S},d.prototype.readInt8=function(t,i){return t=t>>>0,i||W(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]},d.prototype.readInt16LE=function(t,i){t=t>>>0,i||W(t,2,this.length);const w=this[t]|this[t+1]<<8;return w&32768?w|4294901760:w},d.prototype.readInt16BE=function(t,i){t=t>>>0,i||W(t,2,this.length);const w=this[t+1]|this[t]<<8;return w&32768?w|4294901760:w},d.prototype.readInt32LE=function(t,i){return t=t>>>0,i||W(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},d.prototype.readInt32BE=function(t,i){return t=t>>>0,i||W(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},d.prototype.readBigInt64LE=oe(function(t){t=t>>>0,ge(t,"offset");const i=this[t],w=this[t+7];(i===void 0||w===void 0)&&_e(t,this.length-8);const F=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(w<<24);return(BigInt(F)<<BigInt(32))+BigInt(i+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)}),d.prototype.readBigInt64BE=oe(function(t){t=t>>>0,ge(t,"offset");const i=this[t],w=this[t+7];(i===void 0||w===void 0)&&_e(t,this.length-8);const F=(i<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(F)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+w)}),d.prototype.readFloatLE=function(t,i){return t=t>>>0,i||W(t,4,this.length),e.read(this,t,!0,23,4)},d.prototype.readFloatBE=function(t,i){return t=t>>>0,i||W(t,4,this.length),e.read(this,t,!1,23,4)},d.prototype.readDoubleLE=function(t,i){return t=t>>>0,i||W(t,8,this.length),e.read(this,t,!0,52,8)},d.prototype.readDoubleBE=function(t,i){return t=t>>>0,i||W(t,8,this.length),e.read(this,t,!1,52,8)};function V(m,t,i,w,F,p){if(!d.isBuffer(m))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>F||t<p)throw new RangeError('"value" argument is out of bounds');if(i+w>m.length)throw new RangeError("Index out of range")}d.prototype.writeUintLE=d.prototype.writeUIntLE=function(t,i,w,F){if(t=+t,i=i>>>0,w=w>>>0,!F){const T=Math.pow(2,8*w)-1;V(this,t,i,w,T,0)}let p=1,S=0;for(this[i]=t&255;++S<w&&(p*=256);)this[i+S]=t/p&255;return i+w},d.prototype.writeUintBE=d.prototype.writeUIntBE=function(t,i,w,F){if(t=+t,i=i>>>0,w=w>>>0,!F){const T=Math.pow(2,8*w)-1;V(this,t,i,w,T,0)}let p=w-1,S=1;for(this[i+p]=t&255;--p>=0&&(S*=256);)this[i+p]=t/S&255;return i+w},d.prototype.writeUint8=d.prototype.writeUInt8=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,1,255,0),this[i]=t&255,i+1},d.prototype.writeUint16LE=d.prototype.writeUInt16LE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,2,65535,0),this[i]=t&255,this[i+1]=t>>>8,i+2},d.prototype.writeUint16BE=d.prototype.writeUInt16BE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,2,65535,0),this[i]=t>>>8,this[i+1]=t&255,i+2},d.prototype.writeUint32LE=d.prototype.writeUInt32LE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,4,4294967295,0),this[i+3]=t>>>24,this[i+2]=t>>>16,this[i+1]=t>>>8,this[i]=t&255,i+4},d.prototype.writeUint32BE=d.prototype.writeUInt32BE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,4,4294967295,0),this[i]=t>>>24,this[i+1]=t>>>16,this[i+2]=t>>>8,this[i+3]=t&255,i+4};function ne(m,t,i,w,F){nt(t,w,F,m,i,7);let p=Number(t&BigInt(4294967295));m[i++]=p,p=p>>8,m[i++]=p,p=p>>8,m[i++]=p,p=p>>8,m[i++]=p;let S=Number(t>>BigInt(32)&BigInt(4294967295));return m[i++]=S,S=S>>8,m[i++]=S,S=S>>8,m[i++]=S,S=S>>8,m[i++]=S,i}function be(m,t,i,w,F){nt(t,w,F,m,i,7);let p=Number(t&BigInt(4294967295));m[i+7]=p,p=p>>8,m[i+6]=p,p=p>>8,m[i+5]=p,p=p>>8,m[i+4]=p;let S=Number(t>>BigInt(32)&BigInt(4294967295));return m[i+3]=S,S=S>>8,m[i+2]=S,S=S>>8,m[i+1]=S,S=S>>8,m[i]=S,i+8}d.prototype.writeBigUInt64LE=oe(function(t,i=0){return ne(this,t,i,BigInt(0),BigInt("0xffffffffffffffff"))}),d.prototype.writeBigUInt64BE=oe(function(t,i=0){return be(this,t,i,BigInt(0),BigInt("0xffffffffffffffff"))}),d.prototype.writeIntLE=function(t,i,w,F){if(t=+t,i=i>>>0,!F){const _=Math.pow(2,8*w-1);V(this,t,i,w,_-1,-_)}let p=0,S=1,T=0;for(this[i]=t&255;++p<w&&(S*=256);)t<0&&T===0&&this[i+p-1]!==0&&(T=1),this[i+p]=(t/S>>0)-T&255;return i+w},d.prototype.writeIntBE=function(t,i,w,F){if(t=+t,i=i>>>0,!F){const _=Math.pow(2,8*w-1);V(this,t,i,w,_-1,-_)}let p=w-1,S=1,T=0;for(this[i+p]=t&255;--p>=0&&(S*=256);)t<0&&T===0&&this[i+p+1]!==0&&(T=1),this[i+p]=(t/S>>0)-T&255;return i+w},d.prototype.writeInt8=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,1,127,-128),t<0&&(t=255+t+1),this[i]=t&255,i+1},d.prototype.writeInt16LE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,2,32767,-32768),this[i]=t&255,this[i+1]=t>>>8,i+2},d.prototype.writeInt16BE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,2,32767,-32768),this[i]=t>>>8,this[i+1]=t&255,i+2},d.prototype.writeInt32LE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,4,2147483647,-2147483648),this[i]=t&255,this[i+1]=t>>>8,this[i+2]=t>>>16,this[i+3]=t>>>24,i+4},d.prototype.writeInt32BE=function(t,i,w){return t=+t,i=i>>>0,w||V(this,t,i,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[i]=t>>>24,this[i+1]=t>>>16,this[i+2]=t>>>8,this[i+3]=t&255,i+4},d.prototype.writeBigInt64LE=oe(function(t,i=0){return ne(this,t,i,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),d.prototype.writeBigInt64BE=oe(function(t,i=0){return be(this,t,i,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Te(m,t,i,w,F,p){if(i+w>m.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function Fe(m,t,i,w,F){return t=+t,i=i>>>0,F||Te(m,t,i,4),e.write(m,t,i,w,23,4),i+4}d.prototype.writeFloatLE=function(t,i,w){return Fe(this,t,i,!0,w)},d.prototype.writeFloatBE=function(t,i,w){return Fe(this,t,i,!1,w)};function me(m,t,i,w,F){return t=+t,i=i>>>0,F||Te(m,t,i,8),e.write(m,t,i,w,52,8),i+8}d.prototype.writeDoubleLE=function(t,i,w){return me(this,t,i,!0,w)},d.prototype.writeDoubleBE=function(t,i,w){return me(this,t,i,!1,w)},d.prototype.copy=function(t,i,w,F){if(!d.isBuffer(t))throw new TypeError("argument should be a Buffer");if(w||(w=0),!F&&F!==0&&(F=this.length),i>=t.length&&(i=t.length),i||(i=0),F>0&&F<w&&(F=w),F===w||t.length===0||this.length===0)return 0;if(i<0)throw new RangeError("targetStart out of bounds");if(w<0||w>=this.length)throw new RangeError("Index out of range");if(F<0)throw new RangeError("sourceEnd out of bounds");F>this.length&&(F=this.length),t.length-i<F-w&&(F=t.length-i+w);const p=F-w;return this===t&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(i,w,F):Uint8Array.prototype.set.call(t,this.subarray(w,F),i),p},d.prototype.fill=function(t,i,w,F){if(typeof t=="string"){if(typeof i=="string"?(F=i,i=0,w=this.length):typeof w=="string"&&(F=w,w=this.length),F!==void 0&&typeof F!="string")throw new TypeError("encoding must be a string");if(typeof F=="string"&&!d.isEncoding(F))throw new TypeError("Unknown encoding: "+F);if(t.length===1){const S=t.charCodeAt(0);(F==="utf8"&&S<128||F==="latin1")&&(t=S)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(i<0||this.length<i||this.length<w)throw new RangeError("Out of range index");if(w<=i)return this;i=i>>>0,w=w===void 0?this.length:w>>>0,t||(t=0);let p;if(typeof t=="number")for(p=i;p<w;++p)this[p]=t;else{const S=d.isBuffer(t)?t:d.from(t,F),T=S.length;if(T===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(p=0;p<w-i;++p)this[p+i]=S[p%T]}return this};const te={};function ce(m,t,i){te[m]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${m}]`,this.stack,delete this.name}get code(){return m}set code(F){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:F,writable:!0})}toString(){return`${this.name} [${m}]: ${this.message}`}}}ce("ERR_BUFFER_OUT_OF_BOUNDS",function(m){return m?`${m} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ce("ERR_INVALID_ARG_TYPE",function(m,t){return`The "${m}" argument must be of type number. Received type ${typeof t}`},TypeError),ce("ERR_OUT_OF_RANGE",function(m,t,i){let w=`The value of "${m}" is out of range.`,F=i;return Number.isInteger(i)&&Math.abs(i)>2**32?F=ye(String(i)):typeof i=="bigint"&&(F=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(F=ye(F)),F+="n"),w+=` It must be ${t}. Received ${F}`,w},RangeError);function ye(m){let t="",i=m.length;const w=m[0]==="-"?1:0;for(;i>=w+4;i-=3)t=`_${m.slice(i-3,i)}${t}`;return`${m.slice(0,i)}${t}`}function St(m,t,i){ge(t,"offset"),(m[t]===void 0||m[t+i]===void 0)&&_e(t,m.length-(i+1))}function nt(m,t,i,w,F,p){if(m>i||m<t){const S=typeof t=="bigint"?"n":"";let T;throw t===0||t===BigInt(0)?T=`>= 0${S} and < 2${S} ** ${(p+1)*8}${S}`:T=`>= -(2${S} ** ${(p+1)*8-1}${S}) and < 2 ** ${(p+1)*8-1}${S}`,new te.ERR_OUT_OF_RANGE("value",T,m)}St(w,F,p)}function ge(m,t){if(typeof m!="number")throw new te.ERR_INVALID_ARG_TYPE(t,"number",m)}function _e(m,t,i){throw Math.floor(m)!==m?(ge(m,i),new te.ERR_OUT_OF_RANGE("offset","an integer",m)):t<0?new te.ERR_BUFFER_OUT_OF_BOUNDS:new te.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${t}`,m)}const vt=/[^+/0-9A-Za-z-_]/g;function Rt(m){if(m=m.split("=")[0],m=m.trim().replace(vt,""),m.length<2)return"";for(;m.length%4!==0;)m=m+"=";return m}function Ge(m,t){t=t||1/0;let i;const w=m.length;let F=null;const p=[];for(let S=0;S<w;++S){if(i=m.charCodeAt(S),i>55295&&i<57344){if(!F){if(i>56319){(t-=3)>-1&&p.push(239,191,189);continue}else if(S+1===w){(t-=3)>-1&&p.push(239,191,189);continue}F=i;continue}if(i<56320){(t-=3)>-1&&p.push(239,191,189),F=i;continue}i=(F-55296<<10|i-56320)+65536}else F&&(t-=3)>-1&&p.push(239,191,189);if(F=null,i<128){if((t-=1)<0)break;p.push(i)}else if(i<2048){if((t-=2)<0)break;p.push(i>>6|192,i&63|128)}else if(i<65536){if((t-=3)<0)break;p.push(i>>12|224,i>>6&63|128,i&63|128)}else if(i<1114112){if((t-=4)<0)break;p.push(i>>18|240,i>>12&63|128,i>>6&63|128,i&63|128)}else throw new Error("Invalid code point")}return p}function bt(m){const t=[];for(let i=0;i<m.length;++i)t.push(m.charCodeAt(i)&255);return t}function it(m,t){let i,w,F;const p=[];for(let S=0;S<m.length&&!((t-=2)<0);++S)i=m.charCodeAt(S),w=i>>8,F=i%256,p.push(F),p.push(w);return p}function st(m){return o.toByteArray(Rt(m))}function ke(m,t,i,w){let F;for(F=0;F<w&&!(F+i>=t.length||F>=m.length);++F)t[F+i]=m[F];return F}function re(m,t){return m instanceof t||m!=null&&m.constructor!=null&&m.constructor.name!=null&&m.constructor.name===t.name}function Me(m){return m!==m}const Tt=(function(){const m="0123456789abcdef",t=new Array(256);for(let i=0;i<16;++i){const w=i*16;for(let F=0;F<16;++F)t[w+F]=m[i]+m[F]}return t})();function oe(m){return typeof BigInt>"u"?Ft:m}function Ft(){throw new Error("BigInt not supported")}})(_t)),_t}var U=Tn(),Ce={},Ye={},Ct={},rr;function ae(){return rr||(rr=1,(function(c){Object.defineProperty(c,"__esModule",{value:!0}),c.Frame=c.Lengths=c.Flags=c.FrameTypes=void 0;var o;(function(e){e[e.RESERVED=0]="RESERVED",e[e.SETUP=1]="SETUP",e[e.LEASE=2]="LEASE",e[e.KEEPALIVE=3]="KEEPALIVE",e[e.REQUEST_RESPONSE=4]="REQUEST_RESPONSE",e[e.REQUEST_FNF=5]="REQUEST_FNF",e[e.REQUEST_STREAM=6]="REQUEST_STREAM",e[e.REQUEST_CHANNEL=7]="REQUEST_CHANNEL",e[e.REQUEST_N=8]="REQUEST_N",e[e.CANCEL=9]="CANCEL",e[e.PAYLOAD=10]="PAYLOAD",e[e.ERROR=11]="ERROR",e[e.METADATA_PUSH=12]="METADATA_PUSH",e[e.RESUME=13]="RESUME",e[e.RESUME_OK=14]="RESUME_OK",e[e.EXT=63]="EXT"})(o=c.FrameTypes||(c.FrameTypes={})),(function(e){e[e.NONE=0]="NONE",e[e.COMPLETE=64]="COMPLETE",e[e.FOLLOWS=128]="FOLLOWS",e[e.IGNORE=512]="IGNORE",e[e.LEASE=64]="LEASE",e[e.METADATA=256]="METADATA",e[e.NEXT=32]="NEXT",e[e.RESPOND=128]="RESPOND",e[e.RESUME_ENABLE=128]="RESUME_ENABLE"})(c.Flags||(c.Flags={})),(function(e){function n(r){return(r&e.METADATA)===e.METADATA}e.hasMetadata=n;function a(r){return(r&e.COMPLETE)===e.COMPLETE}e.hasComplete=a;function h(r){return(r&e.NEXT)===e.NEXT}e.hasNext=h;function s(r){return(r&e.FOLLOWS)===e.FOLLOWS}e.hasFollows=s;function d(r){return(r&e.IGNORE)===e.IGNORE}e.hasIgnore=d;function v(r){return(r&e.RESPOND)===e.RESPOND}e.hasRespond=v;function R(r){return(r&e.LEASE)===e.LEASE}e.hasLease=R;function l(r){return(r&e.RESUME_ENABLE)===e.RESUME_ENABLE}e.hasResume=l})(c.Flags||(c.Flags={})),(function(e){e[e.FRAME=3]="FRAME",e[e.HEADER=6]="HEADER",e[e.METADATA=3]="METADATA",e[e.REQUEST=3]="REQUEST"})(c.Lengths||(c.Lengths={})),(function(e){function n(h){return h.streamId===0}e.isConnection=n;function a(h){return o.REQUEST_RESPONSE<=h.type&&h.type<=o.REQUEST_CHANNEL}e.isRequest=a})(c.Frame||(c.Frame={}))})(Ct)),Ct}var nr;function Pr(){return nr||(nr=1,(function(c){var o=Ye&&Ye.__generator||function(p,S){var T={label:0,sent:function(){if(O[0]&1)throw O[1];return O[1]},trys:[],ops:[]},_,N,O,x;return x={next:ie(0),throw:ie(1),return:ie(2)},typeof Symbol=="function"&&(x[Symbol.iterator]=function(){return this}),x;function ie(k){return function(Be){return Ue([k,Be])}}function Ue(k){if(_)throw new TypeError("Generator is already executing.");for(;T;)try{if(_=1,N&&(O=k[0]&2?N.return:k[0]?N.throw||((O=N.return)&&O.call(N),0):N.next)&&!(O=O.call(N,k[1])).done)return O;switch(N=0,O&&(k=[k[0]&2,O.value]),k[0]){case 0:case 1:O=k;break;case 4:return T.label++,{value:k[1],done:!1};case 5:T.label++,N=k[1],k=[0];continue;case 7:k=T.ops.pop(),T.trys.pop();continue;default:if(O=T.trys,!(O=O.length>0&&O[O.length-1])&&(k[0]===6||k[0]===2)){T=0;continue}if(k[0]===3&&(!O||k[1]>O[0]&&k[1]<O[3])){T.label=k[1];break}if(k[0]===6&&T.label<O[1]){T.label=O[1],O=k;break}if(O&&T.label<O[2]){T.label=O[2],T.ops.push(k);break}O[2]&&T.ops.pop(),T.trys.pop();continue}k=S.call(p,T)}catch(Be){k=[6,Be],N=0}finally{_=O=0}if(k[0]&5)throw k[1];return{value:k[0]?k[1]:void 0,done:!0}}};Object.defineProperty(c,"__esModule",{value:!0}),c.Deserializer=c.sizeOfFrame=c.serializeFrame=c.deserializeFrame=c.serializeFrameWithLength=c.deserializeFrames=c.deserializeFrameWithLength=c.writeUInt64BE=c.readUInt64BE=c.writeUInt24BE=c.readUInt24BE=c.MAX_VERSION=c.MAX_TTL=c.MAX_STREAM_ID=c.MAX_RESUME_LENGTH=c.MAX_REQUEST_N=c.MAX_REQUEST_COUNT=c.MAX_MIME_LENGTH=c.MAX_METADATA_LENGTH=c.MAX_LIFETIME=c.MAX_KEEPALIVE=c.MAX_CODE=c.FRAME_TYPE_OFFFSET=c.FLAGS_MASK=void 0;var e=ae();c.FLAGS_MASK=1023,c.FRAME_TYPE_OFFFSET=10,c.MAX_CODE=2147483647,c.MAX_KEEPALIVE=2147483647,c.MAX_LIFETIME=2147483647,c.MAX_METADATA_LENGTH=16777215,c.MAX_MIME_LENGTH=255,c.MAX_REQUEST_COUNT=2147483647,c.MAX_REQUEST_N=2147483647,c.MAX_RESUME_LENGTH=65535,c.MAX_STREAM_ID=2147483647,c.MAX_TTL=2147483647,c.MAX_VERSION=65535;var n=4294967296;function a(p,S){var T=p.readUInt8(S)<<16,_=p.readUInt8(S+1)<<8,N=p.readUInt8(S+2);return T|_|N}c.readUInt24BE=a;function h(p,S,T){return T=p.writeUInt8(S>>>16,T),T=p.writeUInt8(S>>>8&255,T),p.writeUInt8(S&255,T)}c.writeUInt24BE=h;function s(p,S){var T=p.readUInt32BE(S),_=p.readUInt32BE(S+4);return T*n+_}c.readUInt64BE=s;function d(p,S,T){var _=S/n|0,N=S%n;return T=p.writeUInt32BE(_,T),p.writeUInt32BE(N,T)}c.writeUInt64BE=d;var v=6,R=3;function l(p){var S=a(p,0);return u(p.slice(R,R+S))}c.deserializeFrameWithLength=l;function r(p){var S,T,_,N,O,x;return o(this,function(ie){switch(ie.label){case 0:S=0,ie.label=1;case 1:return S+R<p.length?(T=a(p,S),_=S+R,N=_+T,N>p.length?[3,3]:(O=p.slice(_,N),x=u(O),S=N,[4,[x,S]])):[3,3];case 2:return ie.sent(),[3,1];case 3:return[2]}})}c.deserializeFrames=r;function f(p){var S=y(p),T=U.Buffer.allocUnsafe(S.length+R);return h(T,S.length,0),S.copy(T,R),T}c.serializeFrameWithLength=f;function u(p){var S=0,T=p.readInt32BE(S);S+=4;var _=p.readUInt16BE(S);S+=2;var N=_>>>c.FRAME_TYPE_OFFFSET,O=_&c.FLAGS_MASK;switch(N){case e.FrameTypes.SETUP:return L(p,T,O);case e.FrameTypes.PAYLOAD:return bt(p,T,O);case e.FrameTypes.ERROR:return Q(p,T,O);case e.FrameTypes.KEEPALIVE:return M(p,T,O);case e.FrameTypes.REQUEST_FNF:return W(p,T,O);case e.FrameTypes.REQUEST_RESPONSE:return V(p,T,O);case e.FrameTypes.REQUEST_STREAM:return me(p,T,O);case e.FrameTypes.REQUEST_CHANNEL:return te(p,T,O);case e.FrameTypes.METADATA_PUSH:return ne(p,T,O);case e.FrameTypes.REQUEST_N:return nt(p,T,O);case e.FrameTypes.RESUME:return re(p,T,O);case e.FrameTypes.RESUME_OK:return Ft(p,T,O);case e.FrameTypes.CANCEL:return vt(p,T,O);case e.FrameTypes.LEASE:return pe(p,T,O)}}c.deserializeFrame=u;function y(p){switch(p.type){case e.FrameTypes.SETUP:return C(p);case e.FrameTypes.PAYLOAD:return Rt(p);case e.FrameTypes.ERROR:return P(p);case e.FrameTypes.KEEPALIVE:return q(p);case e.FrameTypes.REQUEST_FNF:case e.FrameTypes.REQUEST_RESPONSE:return Se(p);case e.FrameTypes.REQUEST_STREAM:case e.FrameTypes.REQUEST_CHANNEL:return Te(p);case e.FrameTypes.METADATA_PUSH:return Re(p);case e.FrameTypes.REQUEST_N:return ye(p);case e.FrameTypes.RESUME:return st(p);case e.FrameTypes.RESUME_OK:return Tt(p);case e.FrameTypes.CANCEL:return ge(p);case e.FrameTypes.LEASE:return z(p)}}c.serializeFrame=y;function g(p){switch(p.type){case e.FrameTypes.SETUP:return I(p);case e.FrameTypes.PAYLOAD:return Ge(p);case e.FrameTypes.ERROR:return B(p);case e.FrameTypes.KEEPALIVE:return H(p);case e.FrameTypes.REQUEST_FNF:case e.FrameTypes.REQUEST_RESPONSE:return ve(p);case e.FrameTypes.REQUEST_STREAM:case e.FrameTypes.REQUEST_CHANNEL:return Fe(p);case e.FrameTypes.METADATA_PUSH:return Pe(p);case e.FrameTypes.REQUEST_N:return St();case e.FrameTypes.RESUME:return ke(p);case e.FrameTypes.RESUME_OK:return oe();case e.FrameTypes.CANCEL:return _e();case e.FrameTypes.LEASE:return ee(p)}}c.sizeOfFrame=g;var E=14,b=2;function C(p){var S=p.resumeToken!=null?p.resumeToken.byteLength:0,T=p.metadataMimeType!=null?U.Buffer.byteLength(p.metadataMimeType,"ascii"):0,_=p.dataMimeType!=null?U.Buffer.byteLength(p.dataMimeType,"ascii"):0,N=t(p),O=U.Buffer.allocUnsafe(v+E+(S?b+S:0)+T+_+N),x=m(p,O);return x=O.writeUInt16BE(p.majorVersion,x),x=O.writeUInt16BE(p.minorVersion,x),x=O.writeUInt32BE(p.keepAlive,x),x=O.writeUInt32BE(p.lifetime,x),p.flags&e.Flags.RESUME_ENABLE&&(x=O.writeUInt16BE(S,x),p.resumeToken!=null&&(x+=p.resumeToken.copy(O,x))),x=O.writeUInt8(T,x),p.metadataMimeType!=null&&(x+=O.write(p.metadataMimeType,x,x+T,"ascii")),x=O.writeUInt8(_,x),p.dataMimeType!=null&&(x+=O.write(p.dataMimeType,x,x+_,"ascii")),i(p,O,x),O}function I(p){var S=p.resumeToken!=null?p.resumeToken.byteLength:0,T=p.metadataMimeType!=null?U.Buffer.byteLength(p.metadataMimeType,"ascii"):0,_=p.dataMimeType!=null?U.Buffer.byteLength(p.dataMimeType,"ascii"):0,N=t(p);return v+E+(S?b+S:0)+T+_+N}function L(p,S,T){p.length;var _=v,N=p.readUInt16BE(_);_+=2;var O=p.readUInt16BE(_);_+=2;var x=p.readInt32BE(_);_+=4;var ie=p.readInt32BE(_);_+=4;var Ue=null;if(T&e.Flags.RESUME_ENABLE){var k=p.readInt16BE(_);_+=2,Ue=p.slice(_,_+k),_+=k}var Be=p.readUInt8(_);_+=1;var $r=p.toString("ascii",_,_+Be);_+=Be;var jt=p.readUInt8(_);_+=1;var Zr=p.toString("ascii",_,_+jt);_+=jt;var Qt={data:null,dataMimeType:Zr,flags:T,keepAlive:x,lifetime:ie,majorVersion:N,metadata:null,metadataMimeType:$r,minorVersion:O,resumeToken:Ue,streamId:0,type:e.FrameTypes.SETUP};return w(p,Qt,_),Qt}var D=4;function P(p){var S=p.message!=null?U.Buffer.byteLength(p.message,"utf8"):0,T=U.Buffer.allocUnsafe(v+D+S),_=m(p,T);return _=T.writeUInt32BE(p.code,_),p.message!=null&&T.write(p.message,_,_+S,"utf8"),T}function B(p){var S=p.message!=null?U.Buffer.byteLength(p.message,"utf8"):0;return v+D+S}function Q(p,S,T){p.length;var _=v,N=p.readInt32BE(_);_+=4;var O=p.length-_,x="";return O>0&&(x=p.toString("utf8",_,_+O),_+=O),{code:N,flags:T,message:x,streamId:S,type:e.FrameTypes.ERROR}}var j=8;function q(p){var S=p.data!=null?p.data.byteLength:0,T=U.Buffer.allocUnsafe(v+j+S),_=m(p,T);return _=d(T,p.lastReceivedPosition,_),p.data!=null&&p.data.copy(T,_),T}function H(p){var S=p.data!=null?p.data.byteLength:0;return v+j+S}function M(p,S,T){p.length;var _=v,N=s(p,_);_+=8;var O=null;return _<p.length&&(O=p.slice(_,p.length)),{data:O,flags:T,lastReceivedPosition:N,streamId:0,type:e.FrameTypes.KEEPALIVE}}var G=8;function z(p){var S=p.metadata!=null?p.metadata.byteLength:0,T=U.Buffer.allocUnsafe(v+G+S),_=m(p,T);return _=T.writeUInt32BE(p.ttl,_),_=T.writeUInt32BE(p.requestCount,_),p.metadata!=null&&p.metadata.copy(T,_),T}function ee(p){var S=p.metadata!=null?p.metadata.byteLength:0;return v+G+S}function pe(p,S,T){var _=v,N=p.readUInt32BE(_);_+=4;var O=p.readUInt32BE(_);_+=4;var x=null;return _<p.length&&(x=p.slice(_,p.length)),{flags:T,metadata:x,requestCount:O,streamId:0,ttl:N,type:e.FrameTypes.LEASE}}function Se(p){var S=t(p),T=U.Buffer.allocUnsafe(v+S),_=m(p,T);return i(p,T,_),T}function ve(p){var S=t(p);return v+S}function Re(p){var S=p.metadata;if(S!=null){var T=U.Buffer.allocUnsafe(v+S.byteLength),_=m(p,T);return S.copy(T,_),T}else{var T=U.Buffer.allocUnsafe(v);return m(p,T),T}}function Pe(p){return v+(p.metadata!=null?p.metadata.byteLength:0)}function W(p,S,T){p.length;var _={data:null,flags:T,metadata:null,streamId:S,type:e.FrameTypes.REQUEST_FNF};return w(p,_,v),_}function V(p,S,T){var _={data:null,flags:T,metadata:null,streamId:S,type:e.FrameTypes.REQUEST_RESPONSE};return w(p,_,v),_}function ne(p,S,T){return{flags:T,metadata:length===v?null:p.slice(v,length),streamId:0,type:e.FrameTypes.METADATA_PUSH}}var be=4;function Te(p){var S=t(p),T=U.Buffer.allocUnsafe(v+be+S),_=m(p,T);return _=T.writeUInt32BE(p.requestN,_),i(p,T,_),T}function Fe(p){var S=t(p);return v+be+S}function me(p,S,T){p.length;var _=v,N=p.readInt32BE(_);_+=4;var O={data:null,flags:T,metadata:null,requestN:N,streamId:S,type:e.FrameTypes.REQUEST_STREAM};return w(p,O,_),O}function te(p,S,T){p.length;var _=v,N=p.readInt32BE(_);_+=4;var O={data:null,flags:T,metadata:null,requestN:N,streamId:S,type:e.FrameTypes.REQUEST_CHANNEL};return w(p,O,_),O}var ce=4;function ye(p){var S=U.Buffer.allocUnsafe(v+ce),T=m(p,S);return S.writeUInt32BE(p.requestN,T),S}function St(p){return v+ce}function nt(p,S,T){p.length;var _=p.readInt32BE(v);return{flags:T,requestN:_,streamId:S,type:e.FrameTypes.REQUEST_N}}function ge(p){var S=U.Buffer.allocUnsafe(v);return m(p,S),S}function _e(p){return v}function vt(p,S,T){return p.length,{flags:T,streamId:S,type:e.FrameTypes.CANCEL}}function Rt(p){var S=t(p),T=U.Buffer.allocUnsafe(v+S),_=m(p,T);return i(p,T,_),T}function Ge(p){var S=t(p);return v+S}function bt(p,S,T){p.length;var _={data:null,flags:T,metadata:null,streamId:S,type:e.FrameTypes.PAYLOAD};return w(p,_,v),_}var it=22;function st(p){var S=p.resumeToken.byteLength,T=U.Buffer.allocUnsafe(v+it+S),_=m(p,T);return _=T.writeUInt16BE(p.majorVersion,_),_=T.writeUInt16BE(p.minorVersion,_),_=T.writeUInt16BE(S,_),_+=p.resumeToken.copy(T,_),_=d(T,p.serverPosition,_),d(T,p.clientPosition,_),T}function ke(p){var S=p.resumeToken.byteLength;return v+it+S}function re(p,S,T){p.length;var _=v,N=p.readUInt16BE(_);_+=2;var O=p.readUInt16BE(_);_+=2;var x=p.readInt16BE(_);_+=2;var ie=p.slice(_,_+x);_+=x;var Ue=s(p,_);_+=8;var k=s(p,_);return _+=8,{clientPosition:k,flags:T,majorVersion:N,minorVersion:O,resumeToken:ie,serverPosition:Ue,streamId:0,type:e.FrameTypes.RESUME}}var Me=8;function Tt(p){var S=U.Buffer.allocUnsafe(v+Me),T=m(p,S);return d(S,p.clientPosition,T),S}function oe(p){return v+Me}function Ft(p,S,T){p.length;var _=s(p,v);return{clientPosition:_,flags:T,streamId:0,type:e.FrameTypes.RESUME_OK}}function m(p,S){var T=S.writeInt32BE(p.streamId,0);return S.writeUInt16BE(p.type<<c.FRAME_TYPE_OFFFSET|p.flags&c.FLAGS_MASK,T)}function t(p){var S=0;return p.data!=null&&(S+=p.data.byteLength),e.Flags.hasMetadata(p.flags)&&(S+=R,p.metadata!=null&&(S+=p.metadata.byteLength)),S}function i(p,S,T){if(e.Flags.hasMetadata(p.flags))if(p.metadata!=null){var _=p.metadata.byteLength;T=h(S,_,T),T+=p.metadata.copy(S,T)}else T=h(S,0,T);p.data!=null&&p.data.copy(S,T)}function w(p,S,T){if(e.Flags.hasMetadata(S.flags)){var _=a(p,T);T+=R,_>0&&(S.metadata=p.slice(T,T+_),T+=_)}T<p.length&&(S.data=p.slice(T,p.length))}var F=(function(){function p(){}return p.prototype.deserializeFrame=function(S){return u(S)},p.prototype.deserializeFrameWithLength=function(S){return l(S)},p.prototype.deserializeFrames=function(S){return r(S)},p})();c.Deserializer=F})(Ye)),Ye}var At={},ir;function Fn(){return ir||(ir=1,Object.defineProperty(At,"__esModule",{value:!0})),At}var Ae={},sr;function kr(){if(sr)return Ae;sr=1;var c=Ae&&Ae.__values||function(e){var n=typeof Symbol=="function"&&Symbol.iterator,a=n&&e[n],h=0;if(a)return a.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&h>=e.length&&(e=void 0),{value:e&&e[h++],done:!e}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.Deferred=void 0;var o=(function(){function e(){this._done=!1,this.onCloseCallbacks=[]}return Object.defineProperty(e.prototype,"done",{get:function(){return this._done},enumerable:!1,configurable:!0}),e.prototype.close=function(n){var a,h,s,d;if(this.done){console.warn("Trying to close for the second time. ".concat(n?"Dropping error [".concat(n,"]."):""));return}if(this._done=!0,this._error=n,n){try{for(var v=c(this.onCloseCallbacks),R=v.next();!R.done;R=v.next()){var l=R.value;l(n)}}catch(u){a={error:u}}finally{try{R&&!R.done&&(h=v.return)&&h.call(v)}finally{if(a)throw a.error}}return}try{for(var r=c(this.onCloseCallbacks),f=r.next();!f.done;f=r.next()){var l=f.value;l()}}catch(u){s={error:u}}finally{try{f&&!f.done&&(d=r.return)&&d.call(r)}finally{if(s)throw s.error}}},e.prototype.onClose=function(n){if(this._done){n(this._error);return}this.onCloseCallbacks.push(n)},e})();return Ae.Deferred=o,Ae}var Je={},ar;function we(){return ar||(ar=1,(function(c){var o=Je&&Je.__extends||(function(){var n=function(a,h){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,d){s.__proto__=d}||function(s,d){for(var v in d)Object.prototype.hasOwnProperty.call(d,v)&&(s[v]=d[v])},n(a,h)};return function(a,h){if(typeof h!="function"&&h!==null)throw new TypeError("Class extends value "+String(h)+" is not a constructor or null");n(a,h);function s(){this.constructor=a}a.prototype=h===null?Object.create(h):(s.prototype=h.prototype,new s)}})();Object.defineProperty(c,"__esModule",{value:!0}),c.ErrorCodes=c.RSocketError=void 0;var e=(function(n){o(a,n);function a(h,s){var d=n.call(this,s)||this;return d.code=h,d}return a})(Error);c.RSocketError=e,(function(n){n[n.RESERVED=0]="RESERVED",n[n.INVALID_SETUP=1]="INVALID_SETUP",n[n.UNSUPPORTED_SETUP=2]="UNSUPPORTED_SETUP",n[n.REJECTED_SETUP=3]="REJECTED_SETUP",n[n.REJECTED_RESUME=4]="REJECTED_RESUME",n[n.CONNECTION_CLOSE=258]="CONNECTION_CLOSE",n[n.CONNECTION_ERROR=257]="CONNECTION_ERROR",n[n.APPLICATION_ERROR=513]="APPLICATION_ERROR",n[n.REJECTED=514]="REJECTED",n[n.CANCELED=515]="CANCELED",n[n.INVALID=516]="INVALID",n[n.RESERVED_EXTENSION=4294967295]="RESERVED_EXTENSION"})(c.ErrorCodes||(c.ErrorCodes={}))})(Je)),Je}var It={},or;function _n(){return or||(or=1,Object.defineProperty(It,"__esModule",{value:!0})),It}var ue={},le={},cr;function Mr(){return cr||(cr=1,(function(c){var o=le&&le.__extends||(function(){var r=function(f,u){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(y,g){y.__proto__=g}||function(y,g){for(var E in g)Object.prototype.hasOwnProperty.call(g,E)&&(y[E]=g[E])},r(f,u)};return function(f,u){if(typeof u!="function"&&u!==null)throw new TypeError("Class extends value "+String(u)+" is not a constructor or null");r(f,u);function y(){this.constructor=f}f.prototype=u===null?Object.create(u):(y.prototype=u.prototype,new y)}})(),e=le&&le.__awaiter||function(r,f,u,y){function g(E){return E instanceof u?E:new u(function(b){b(E)})}return new(u||(u=Promise))(function(E,b){function C(D){try{L(y.next(D))}catch(P){b(P)}}function I(D){try{L(y.throw(D))}catch(P){b(P)}}function L(D){D.done?E(D.value):g(D.value).then(C,I)}L((y=y.apply(r,f||[])).next())})},n=le&&le.__generator||function(r,f){var u={label:0,sent:function(){if(E[0]&1)throw E[1];return E[1]},trys:[],ops:[]},y,g,E,b;return b={next:C(0),throw:C(1),return:C(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function C(L){return function(D){return I([L,D])}}function I(L){if(y)throw new TypeError("Generator is already executing.");for(;u;)try{if(y=1,g&&(E=L[0]&2?g.return:L[0]?g.throw||((E=g.return)&&E.call(g),0):g.next)&&!(E=E.call(g,L[1])).done)return E;switch(g=0,E&&(L=[L[0]&2,E.value]),L[0]){case 0:case 1:E=L;break;case 4:return u.label++,{value:L[1],done:!1};case 5:u.label++,g=L[1],L=[0];continue;case 7:L=u.ops.pop(),u.trys.pop();continue;default:if(E=u.trys,!(E=E.length>0&&E[E.length-1])&&(L[0]===6||L[0]===2)){u=0;continue}if(L[0]===3&&(!E||L[1]>E[0]&&L[1]<E[3])){u.label=L[1];break}if(L[0]===6&&u.label<E[1]){u.label=E[1],E=L;break}if(E&&u.label<E[2]){u.label=E[2],u.ops.push(L);break}E[2]&&u.ops.pop(),u.trys.pop();continue}L=f.call(r,u)}catch(D){L=[6,D],g=0}finally{y=E=0}if(L[0]&5)throw L[1];return{value:L[0]?L[1]:void 0,done:!0}}};Object.defineProperty(c,"__esModule",{value:!0}),c.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=c.ResumableClientServerInputMultiplexerDemultiplexer=c.ClientServerInputMultiplexerDemultiplexer=c.StreamIdGenerator=void 0;var a=wt(),h=kr(),s=we(),d=ae();(function(r){function f(y){return new u(y)}r.create=f;var u=(function(){function y(g){this.currentId=g}return y.prototype.next=function(g){var E=this.currentId+2;g(E)&&(this.currentId=E)},y})()})(c.StreamIdGenerator||(c.StreamIdGenerator={}));var v=(function(r){o(f,r);function f(u,y,g){var E=r.call(this)||this;return E.streamIdSupplier=u,E.outbound=y,E.closeable=g,E.registry={},g.onClose(E.close.bind(E)),E}return f.prototype.handle=function(u){if(d.Frame.isConnection(u)){if(u.type===a.FrameTypes.RESERVED)return;this.connectionFramesHandler.handle(u)}else if(d.Frame.isRequest(u)){if(this.registry[u.streamId])return;this.requestFramesHandler.handle(u,this)}else{var y=this.registry[u.streamId];if(!y)return;y.handle(u)}},f.prototype.connectionInbound=function(u){if(this.connectionFramesHandler)throw new Error("Connection frame handler has already been installed");this.connectionFramesHandler=u},f.prototype.handleRequestStream=function(u){if(this.requestFramesHandler)throw new Error("Stream handler has already been installed");this.requestFramesHandler=u},f.prototype.send=function(u){this.outbound.send(u)},Object.defineProperty(f.prototype,"connectionOutbound",{get:function(){return this},enumerable:!1,configurable:!0}),f.prototype.createRequestStream=function(u){var y=this;if(this.done){u.handleReject(new Error("Already closed"));return}var g=this.registry;this.streamIdSupplier.next(function(E){return u.handleReady(E,y)},Object.keys(g))},f.prototype.connect=function(u){this.registry[u.streamId]=u},f.prototype.disconnect=function(u){delete this.registry[u.streamId]},f.prototype.close=function(u){if(this.done){r.prototype.close.call(this,u);return}for(var y in this.registry){var g=this.registry[y];g.close(new Error("Closed. ".concat(u?"Original cause [".concat(u,"]."):"")))}r.prototype.close.call(this,u)},f})(h.Deferred);c.ClientServerInputMultiplexerDemultiplexer=v;var R=(function(r){o(f,r);function f(u,y,g,E,b,C,I){var L=r.call(this,u,y,new h.Deferred)||this;return L.frameStore=E,L.token=b,L.sessionTimeout=I,C instanceof Function?L.reconnector=C:L.sessionStore=C,g.onClose(L.handleConnectionClose.bind(L)),L}return f.prototype.send=function(u){if(d.Frame.isConnection(u)){if(u.type===a.FrameTypes.KEEPALIVE)u.lastReceivedPosition=this.frameStore.lastReceivedFramePosition;else if(u.type===a.FrameTypes.ERROR){this.outbound.send(u),this.sessionStore&&delete this.sessionStore[this.token],r.prototype.close.call(this,new s.RSocketError(u.code,u.message));return}}else this.frameStore.store(u);this.outbound.send(u)},f.prototype.handle=function(u){if(d.Frame.isConnection(u)){if(u.type===a.FrameTypes.KEEPALIVE)try{this.frameStore.dropTo(u.lastReceivedPosition)}catch(y){this.outbound.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:y.code,message:y.message}),this.close(y)}else if(u.type===a.FrameTypes.ERROR){r.prototype.handle.call(this,u),this.sessionStore&&delete this.sessionStore[this.token],r.prototype.close.call(this,new s.RSocketError(u.code,u.message));return}}else this.frameStore.record(u);r.prototype.handle.call(this,u)},f.prototype.resume=function(u,y,g){switch(this.outbound=y,u.type){case a.FrameTypes.RESUME:{if(clearTimeout(this.timeoutId),this.frameStore.lastReceivedFramePosition<u.clientPosition){var E=new s.RSocketError(a.ErrorCodes.REJECTED_RESUME,"Impossible to resume since first available client frame position is greater than last received server frame position");this.outbound.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:E.code,message:E.message}),this.close(E);return}try{this.frameStore.dropTo(u.serverPosition)}catch(b){this.outbound.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:b.code,message:b.message}),this.close(b);return}this.outbound.send({type:a.FrameTypes.RESUME_OK,streamId:0,flags:a.Flags.NONE,clientPosition:this.frameStore.lastReceivedFramePosition});break}case a.FrameTypes.RESUME_OK:{try{this.frameStore.dropTo(u.clientPosition)}catch(b){this.outbound.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:b.code,message:b.message}),this.close(b)}break}}this.frameStore.drain(this.outbound.send.bind(this.outbound)),g.onClose(this.handleConnectionClose.bind(this)),this.connectionFramesHandler.resume()},f.prototype.handleConnectionClose=function(u){return e(this,void 0,void 0,function(){var y;return n(this,function(g){switch(g.label){case 0:if(this.connectionFramesHandler.pause(),!this.reconnector)return[3,5];g.label=1;case 1:return g.trys.push([1,3,,4]),[4,this.reconnector(this,this.frameStore)];case 2:return g.sent(),[3,4];case 3:return y=g.sent(),this.close(y),[3,4];case 4:return[3,6];case 5:this.timeoutId=setTimeout(this.close.bind(this),this.sessionTimeout),g.label=6;case 6:return[2]}})})},f})(v);c.ResumableClientServerInputMultiplexerDemultiplexer=R;var l=(function(){function r(f,u,y){this.outbound=f,this.closeable=u,this.delegate=y,this.resumed=!1}return r.prototype.close=function(){this.delegate.close()},r.prototype.onClose=function(f){this.delegate.onClose(f)},Object.defineProperty(r.prototype,"connectionOutbound",{get:function(){return this.delegate.connectionOutbound},enumerable:!1,configurable:!0}),r.prototype.createRequestStream=function(f){this.delegate.createRequestStream(f)},r.prototype.connectionInbound=function(f){this.delegate.connectionInbound(f)},r.prototype.handleRequestStream=function(f){this.delegate.handleRequestStream(f)},r.prototype.handle=function(f){var u=this;if(!this.resumed){if(f.type===a.FrameTypes.RESUME_OK){this.resumed=!0,this.delegate.resume(f,this.outbound,this.closeable);return}else this.outbound.send({type:a.FrameTypes.ERROR,streamId:0,code:a.ErrorCodes.CONNECTION_ERROR,message:"Incomplete RESUME handshake. Unexpected frame ".concat(f.type," received"),flags:a.Flags.NONE}),this.closeable.close(),this.closeable.onClose(function(){return u.delegate.close(new s.RSocketError(a.ErrorCodes.CONNECTION_ERROR,"Incomplete RESUME handshake. Unexpected frame ".concat(f.type," received")))});return}this.delegate.handle(f)},r})();c.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=l})(le)),le}var X={},K={},se={},ur;function gt(){if(ur)return se;ur=1;var c=se&&se.__generator||function(h,s){var d={label:0,sent:function(){if(l[0]&1)throw l[1];return l[1]},trys:[],ops:[]},v,R,l,r;return r={next:f(0),throw:f(1),return:f(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function f(y){return function(g){return u([y,g])}}function u(y){if(v)throw new TypeError("Generator is already executing.");for(;d;)try{if(v=1,R&&(l=y[0]&2?R.return:y[0]?R.throw||((l=R.return)&&l.call(R),0):R.next)&&!(l=l.call(R,y[1])).done)return l;switch(R=0,l&&(y=[y[0]&2,l.value]),y[0]){case 0:case 1:l=y;break;case 4:return d.label++,{value:y[1],done:!1};case 5:d.label++,R=y[1],y=[0];continue;case 7:y=d.ops.pop(),d.trys.pop();continue;default:if(l=d.trys,!(l=l.length>0&&l[l.length-1])&&(y[0]===6||y[0]===2)){d=0;continue}if(y[0]===3&&(!l||y[1]>l[0]&&y[1]<l[3])){d.label=y[1];break}if(y[0]===6&&d.label<l[1]){d.label=l[1],l=y;break}if(l&&d.label<l[2]){d.label=l[2],d.ops.push(y);break}l[2]&&d.ops.pop(),d.trys.pop();continue}y=s.call(h,d)}catch(g){y=[6,g],R=0}finally{v=l=0}if(y[0]&5)throw y[1];return{value:y[0]?y[1]:void 0,done:!0}}};Object.defineProperty(se,"__esModule",{value:!0}),se.fragmentWithRequestN=se.fragment=se.isFragmentable=void 0;var o=ae();function e(h,s,d){return s===0?!1:h.data.byteLength+(h.metadata?h.metadata.byteLength+o.Lengths.METADATA:0)+(d==o.FrameTypes.REQUEST_STREAM||d==o.FrameTypes.REQUEST_CHANNEL?o.Lengths.REQUEST:0)>s}se.isFragmentable=e;function n(h,s,d,v,R){var l,r,f,u,y,g,E,E,b,C,I,I,L,D;return R===void 0&&(R=!1),c(this,function(P){switch(P.label){case 0:return l=(D=(L=s.data)===null||L===void 0?void 0:L.byteLength)!==null&&D!==void 0?D:0,r=v!==o.FrameTypes.PAYLOAD,f=d,s.metadata?(y=s.metadata.byteLength,y!==0?[3,1]:(f-=o.Lengths.METADATA,u=U.Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return g=0,r?(f-=o.Lengths.METADATA,E=Math.min(y,g+f),u=s.metadata.slice(g,E),f-=u.byteLength,g=E,f!==0?[3,3]:(r=!1,[4,{type:v,flags:o.Flags.FOLLOWS|o.Flags.METADATA,data:void 0,metadata:u,streamId:h}])):[3,3];case 2:P.sent(),u=void 0,f=d,P.label=3;case 3:return g<y?(f-=o.Lengths.METADATA,E=Math.min(y,g+f),u=s.metadata.slice(g,E),f-=u.byteLength,g=E,f===0||l===0?[4,{type:o.FrameTypes.PAYLOAD,flags:o.Flags.NEXT|o.Flags.METADATA|(g===y&&R&&l===0?o.Flags.COMPLETE:o.Flags.FOLLOWS),data:void 0,metadata:u,streamId:h}]:[3,5]):[3,6];case 4:P.sent(),u=void 0,f=d,P.label=5;case 5:return[3,3];case 6:return b=0,r?(I=Math.min(l,b+f),C=s.data.slice(b,I),f-=C.byteLength,b=I,[4,{type:v,flags:o.Flags.FOLLOWS|(u?o.Flags.METADATA:o.Flags.NONE),data:C,metadata:u,streamId:h}]):[3,8];case 7:P.sent(),u=void 0,C=void 0,f=d,P.label=8;case 8:return b<l?(I=Math.min(l,b+f),C=s.data.slice(b,I),f-=C.byteLength,b=I,[4,{type:o.FrameTypes.PAYLOAD,flags:b===l?(R?o.Flags.COMPLETE:o.Flags.NONE)|o.Flags.NEXT|(u?o.Flags.METADATA:0):o.Flags.FOLLOWS|o.Flags.NEXT|(u?o.Flags.METADATA:0),data:C,metadata:u,streamId:h}]):[3,10];case 9:return P.sent(),u=void 0,C=void 0,f=d,[3,8];case 10:return[2]}})}se.fragment=n;function a(h,s,d,v,R,l){var r,f,u,y,g,E,b,b,C,I,L,L,D,P;return l===void 0&&(l=!1),c(this,function(B){switch(B.label){case 0:return r=(P=(D=s.data)===null||D===void 0?void 0:D.byteLength)!==null&&P!==void 0?P:0,f=!0,u=d,s.metadata?(g=s.metadata.byteLength,g!==0?[3,1]:(u-=o.Lengths.METADATA,y=U.Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return E=0,f?(u-=o.Lengths.METADATA+o.Lengths.REQUEST,b=Math.min(g,E+u),y=s.metadata.slice(E,b),u-=y.byteLength,E=b,u!==0?[3,3]:(f=!1,[4,{type:v,flags:o.Flags.FOLLOWS|o.Flags.METADATA,data:void 0,requestN:R,metadata:y,streamId:h}])):[3,3];case 2:B.sent(),y=void 0,u=d,B.label=3;case 3:return E<g?(u-=o.Lengths.METADATA,b=Math.min(g,E+u),y=s.metadata.slice(E,b),u-=y.byteLength,E=b,u===0||r===0?[4,{type:o.FrameTypes.PAYLOAD,flags:o.Flags.NEXT|o.Flags.METADATA|(E===g&&l&&r===0?o.Flags.COMPLETE:o.Flags.FOLLOWS),data:void 0,metadata:y,streamId:h}]:[3,5]):[3,6];case 4:B.sent(),y=void 0,u=d,B.label=5;case 5:return[3,3];case 6:return C=0,f?(u-=o.Lengths.REQUEST,L=Math.min(r,C+u),I=s.data.slice(C,L),u-=I.byteLength,C=L,[4,{type:v,flags:o.Flags.FOLLOWS|(y?o.Flags.METADATA:o.Flags.NONE),data:I,requestN:R,metadata:y,streamId:h}]):[3,8];case 7:B.sent(),y=void 0,I=void 0,u=d,B.label=8;case 8:return C<r?(L=Math.min(r,C+u),I=s.data.slice(C,L),u-=I.byteLength,C=L,[4,{type:o.FrameTypes.PAYLOAD,flags:C===r?(l?o.Flags.COMPLETE:o.Flags.NONE)|o.Flags.NEXT|(y?o.Flags.METADATA:0):o.Flags.FOLLOWS|o.Flags.NEXT|(y?o.Flags.METADATA:0),data:I,metadata:y,streamId:h}]):[3,10];case 9:return B.sent(),y=void 0,I=void 0,u=d,[3,8];case 10:return[2]}})}return se.fragmentWithRequestN=a,se}var de={},lr;function Et(){if(lr)return de;lr=1,Object.defineProperty(de,"__esModule",{value:!0}),de.cancel=de.reassemble=de.add=void 0;function c(n,a,h){return n.hasFragments?(n.data=n.data?U.Buffer.concat([n.data,a]):a,n.metadata&&h&&(n.metadata=U.Buffer.concat([n.metadata,h])),!0):(n.hasFragments=!0,n.data=a,h&&(n.metadata=h),!0)}de.add=c;function o(n,a,h){n.hasFragments=!1;var s=n.data?U.Buffer.concat([n.data,a]):a;if(n.data=void 0,n.metadata){var d=h?U.Buffer.concat([n.metadata,h]):n.metadata;return n.metadata=void 0,{data:s,metadata:d}}return{data:s}}de.reassemble=o;function e(n){n.hasFragments=!1,n.data=void 0,n.metadata=void 0}return de.cancel=e,de}var dr;function Cn(){if(dr)return K;dr=1;var c=K&&K.__createBinding||(Object.create?(function(l,r,f,u){u===void 0&&(u=f),Object.defineProperty(l,u,{enumerable:!0,get:function(){return r[f]}})}):(function(l,r,f,u){u===void 0&&(u=f),l[u]=r[f]})),o=K&&K.__setModuleDefault||(Object.create?(function(l,r){Object.defineProperty(l,"default",{enumerable:!0,value:r})}):function(l,r){l.default=r}),e=K&&K.__importStar||function(l){if(l&&l.__esModule)return l;var r={};if(l!=null)for(var f in l)f!=="default"&&Object.prototype.hasOwnProperty.call(l,f)&&c(r,l,f);return o(r,l),r},n=K&&K.__values||function(l){var r=typeof Symbol=="function"&&Symbol.iterator,f=r&&l[r],u=0;if(f)return f.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&u>=l.length&&(l=void 0),{value:l&&l[u++],done:!l}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(K,"__esModule",{value:!0}),K.RequestChannelResponderStream=K.RequestChannelRequesterStream=void 0;var a=we(),h=gt(),s=ae(),d=e(Et()),v=(function(){function l(r,f,u,y,g,E){this.payload=r,this.isComplete=f,this.receiver=u,this.fragmentSize=y,this.initialRequestN=g,this.leaseManager=E,this.streamType=s.FrameTypes.REQUEST_CHANNEL}return l.prototype.handleReady=function(r,f){var u,y;if(this.outboundDone)return!1;this.streamId=r,this.stream=f,f.connect(this);var g=this.isComplete;if(g&&(this.outboundDone=g),(0,h.isFragmentable)(this.payload,this.fragmentSize,s.FrameTypes.REQUEST_CHANNEL))try{for(var E=n((0,h.fragmentWithRequestN)(r,this.payload,this.fragmentSize,s.FrameTypes.REQUEST_CHANNEL,this.initialRequestN,g)),b=E.next();!b.done;b=E.next()){var C=b.value;this.stream.send(C)}}catch(I){u={error:I}}finally{try{b&&!b.done&&(y=E.return)&&y.call(E)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.REQUEST_CHANNEL,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:(this.payload.metadata!==void 0?s.Flags.METADATA:s.Flags.NONE)|(g?s.Flags.COMPLETE:s.Flags.NONE),streamId:r});return this.hasExtension&&this.stream.send({type:s.FrameTypes.EXT,streamId:r,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},l.prototype.handleReject=function(r){this.inboundDone||(this.inboundDone=!0,this.outboundDone=!0,this.receiver.onError(r))},l.prototype.handle=function(r){var f,u=r.type;switch(u){case s.FrameTypes.PAYLOAD:{var y=s.Flags.hasComplete(r.flags),g=s.Flags.hasNext(r.flags);if(y||!s.Flags.hasFollows(r.flags)){if(y&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!g)){this.receiver.onComplete();return}var E=this.hasFragments?d.reassemble(this,r.data,r.metadata):{data:r.data,metadata:r.metadata};this.receiver.onNext(E,y);return}if(d.add(this,r.data,r.metadata))return;f="Unexpected frame size";break}case s.FrameTypes.CANCEL:{if(this.outboundDone)return;this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this),this.receiver.cancel();return}case s.FrameTypes.REQUEST_N:{if(this.outboundDone)return;if(this.hasFragments){f="Unexpected frame type [".concat(u,"] during reassembly");break}this.receiver.request(r.requestN);return}case s.FrameTypes.ERROR:{var b=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),d.cancel(this),b||this.receiver.cancel(),this.receiver.onError(new a.RSocketError(r.code,r.message));return}case s.FrameTypes.EXT:this.receiver.onExtension(r.extendedType,r.extendedContent,s.Flags.hasIgnore(r.flags));return;default:f="Unexpected frame type [".concat(u,"]")}this.close(new a.RSocketError(a.ErrorCodes.CANCELED,f)),this.stream.send({type:s.FrameTypes.CANCEL,streamId:this.streamId,flags:s.Flags.NONE}),this.stream.disconnect(this)},l.prototype.request=function(r){if(!this.inboundDone){if(!this.streamId){this.initialRequestN+=r;return}this.stream.send({type:s.FrameTypes.REQUEST_N,flags:s.Flags.NONE,requestN:r,streamId:this.streamId})}},l.prototype.cancel=function(){var r,f=this.inboundDone,u=this.outboundDone;if(!(f&&u)){if(this.inboundDone=!0,this.outboundDone=!0,u||this.receiver.cancel(),!this.streamId){(r=this.leaseManager)===null||r===void 0||r.cancelRequest(this);return}this.stream.send({type:f?s.FrameTypes.ERROR:s.FrameTypes.CANCEL,flags:s.Flags.NONE,streamId:this.streamId,code:a.ErrorCodes.CANCELED,message:"Cancelled"}),this.stream.disconnect(this),d.cancel(this)}},l.prototype.onNext=function(r,f){var u,y;if(!this.outboundDone)if(f&&(this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this)),(0,h.isFragmentable)(r,this.fragmentSize,s.FrameTypes.PAYLOAD))try{for(var g=n((0,h.fragment)(this.streamId,r,this.fragmentSize,s.FrameTypes.PAYLOAD,f)),E=g.next();!E.done;E=g.next()){var b=E.value;this.stream.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.PAYLOAD,streamId:this.streamId,flags:s.Flags.NEXT|(r.metadata?s.Flags.METADATA:s.Flags.NONE)|(f?s.Flags.COMPLETE:s.Flags.NONE),data:r.data,metadata:r.metadata})},l.prototype.onComplete=function(){if(!this.streamId){this.isComplete=!0;return}this.outboundDone||(this.outboundDone=!0,this.stream.send({type:s.FrameTypes.PAYLOAD,streamId:this.streamId,flags:s.Flags.COMPLETE,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},l.prototype.onError=function(r){if(!this.outboundDone){var f=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:s.FrameTypes.ERROR,streamId:this.streamId,flags:s.Flags.NONE,code:r instanceof a.RSocketError?r.code:a.ErrorCodes.APPLICATION_ERROR,message:r.message}),this.stream.disconnect(this),f||this.receiver.onError(r)}},l.prototype.onExtension=function(r,f,u){if(!this.outboundDone){if(!this.streamId){this.hasExtension=!0,this.extendedType=r,this.extendedContent=f,this.flags=u?s.Flags.IGNORE:s.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:s.FrameTypes.EXT,extendedType:r,extendedContent:f,flags:u?s.Flags.IGNORE:s.Flags.NONE})}},l.prototype.close=function(r){if(!(this.inboundDone&&this.outboundDone)){var f=this.inboundDone,u=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,d.cancel(this),u||this.receiver.cancel(),f||(r?this.receiver.onError(r):this.receiver.onComplete())}},l})();K.RequestChannelRequesterStream=v;var R=(function(){function l(r,f,u,y,g){if(this.streamId=r,this.stream=f,this.fragmentSize=u,this.handler=y,this.streamType=s.FrameTypes.REQUEST_CHANNEL,f.connect(this),s.Flags.hasFollows(g.flags)){d.add(this,g.data,g.metadata),this.initialRequestN=g.requestN,this.isComplete=s.Flags.hasComplete(g.flags);return}var E={data:g.data,metadata:g.metadata},b=s.Flags.hasComplete(g.flags);this.inboundDone=b;try{this.receiver=y(E,g.requestN,b,this),this.outboundDone&&this.defferedError&&this.receiver.onError(this.defferedError)}catch(C){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(C)}}return l.prototype.handle=function(r){var f,u=r.type;switch(u){case s.FrameTypes.PAYLOAD:{if(s.Flags.hasFollows(r.flags)){if(d.add(this,r.data,r.metadata))return;f="Unexpected frame size";break}var y=this.hasFragments?d.reassemble(this,r.data,r.metadata):{data:r.data,metadata:r.metadata},g=s.Flags.hasComplete(r.flags);if(this.receiver){if(g&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!s.Flags.hasNext(r.flags))){this.receiver.onComplete();return}this.receiver.onNext(y,g)}else{var E=this.isComplete||g;E&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this));try{this.receiver=this.handler(y,this.initialRequestN,E,this),this.outboundDone&&this.defferedError}catch(I){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(I)}}return}case s.FrameTypes.REQUEST_N:{if(!this.receiver||this.hasFragments){f="Unexpected frame type [".concat(u,"] during reassembly");break}this.receiver.request(r.requestN);return}case s.FrameTypes.ERROR:case s.FrameTypes.CANCEL:{var E=this.inboundDone,b=this.outboundDone;if(this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),d.cancel(this),!this.receiver)return;if(b||this.receiver.cancel(),!E){var C=u===s.FrameTypes.CANCEL?new a.RSocketError(a.ErrorCodes.CANCELED,"Cancelled"):new a.RSocketError(r.code,r.message);this.receiver.onError(C)}return}case s.FrameTypes.EXT:{if(!this.receiver||this.hasFragments){f="Unexpected frame type [".concat(u,"] during reassembly");break}this.receiver.onExtension(r.extendedType,r.extendedContent,s.Flags.hasIgnore(r.flags));return}default:f="Unexpected frame type [".concat(u,"]")}this.stream.send({type:s.FrameTypes.ERROR,flags:s.Flags.NONE,code:a.ErrorCodes.CANCELED,message:f,streamId:this.streamId}),this.stream.disconnect(this),this.close(new a.RSocketError(a.ErrorCodes.CANCELED,f))},l.prototype.onError=function(r){if(this.outboundDone){console.warn("Trying to error for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}var f=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:s.FrameTypes.ERROR,flags:s.Flags.NONE,code:r instanceof a.RSocketError?r.code:a.ErrorCodes.APPLICATION_ERROR,message:r.message,streamId:this.streamId}),this.stream.disconnect(this),f||(this.receiver?this.receiver.onError(r):this.defferedError=r)},l.prototype.onNext=function(r,f){var u,y;if(!this.outboundDone){if(f&&(this.outboundDone=!0),(0,h.isFragmentable)(r,this.fragmentSize,s.FrameTypes.PAYLOAD))try{for(var g=n((0,h.fragment)(this.streamId,r,this.fragmentSize,s.FrameTypes.PAYLOAD,f)),E=g.next();!E.done;E=g.next()){var b=E.value;this.stream.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.PAYLOAD,flags:s.Flags.NEXT|(f?s.Flags.COMPLETE:s.Flags.NONE)|(r.metadata?s.Flags.METADATA:s.Flags.NONE),data:r.data,metadata:r.metadata,streamId:this.streamId});f&&this.inboundDone&&this.stream.disconnect(this)}},l.prototype.onComplete=function(){this.outboundDone||(this.outboundDone=!0,this.stream.send({type:s.FrameTypes.PAYLOAD,flags:s.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},l.prototype.onExtension=function(r,f,u){this.outboundDone&&this.inboundDone||this.stream.send({type:s.FrameTypes.EXT,streamId:this.streamId,flags:u?s.Flags.IGNORE:s.Flags.NONE,extendedType:r,extendedContent:f})},l.prototype.request=function(r){this.inboundDone||this.stream.send({type:s.FrameTypes.REQUEST_N,flags:s.Flags.NONE,streamId:this.streamId,requestN:r})},l.prototype.cancel=function(){this.inboundDone||(this.inboundDone=!0,this.stream.send({type:s.FrameTypes.CANCEL,flags:s.Flags.NONE,streamId:this.streamId}),this.outboundDone&&this.stream.disconnect(this))},l.prototype.close=function(r){if(this.inboundDone&&this.outboundDone){console.warn("Trying to close for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}var f=this.inboundDone,u=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,d.cancel(this);var y=this.receiver;y&&(u||y.cancel(),f||(r?y.onError(r):y.onComplete()))},l})();return K.RequestChannelResponderStream=R,K}var Y={},hr;function An(){if(hr)return Y;hr=1;var c=Y&&Y.__createBinding||(Object.create?(function(l,r,f,u){u===void 0&&(u=f),Object.defineProperty(l,u,{enumerable:!0,get:function(){return r[f]}})}):(function(l,r,f,u){u===void 0&&(u=f),l[u]=r[f]})),o=Y&&Y.__setModuleDefault||(Object.create?(function(l,r){Object.defineProperty(l,"default",{enumerable:!0,value:r})}):function(l,r){l.default=r}),e=Y&&Y.__importStar||function(l){if(l&&l.__esModule)return l;var r={};if(l!=null)for(var f in l)f!=="default"&&Object.prototype.hasOwnProperty.call(l,f)&&c(r,l,f);return o(r,l),r},n=Y&&Y.__values||function(l){var r=typeof Symbol=="function"&&Symbol.iterator,f=r&&l[r],u=0;if(f)return f.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&u>=l.length&&(l=void 0),{value:l&&l[u++],done:!l}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Y,"__esModule",{value:!0}),Y.RequestFnfResponderStream=Y.RequestFnFRequesterStream=void 0;var a=we(),h=gt(),s=ae(),d=e(Et()),v=(function(){function l(r,f,u,y){this.payload=r,this.receiver=f,this.fragmentSize=u,this.leaseManager=y,this.streamType=s.FrameTypes.REQUEST_FNF}return l.prototype.handleReady=function(r,f){var u,y;if(this.done)return!1;if(this.streamId=r,(0,h.isFragmentable)(this.payload,this.fragmentSize,s.FrameTypes.REQUEST_FNF))try{for(var g=n((0,h.fragment)(r,this.payload,this.fragmentSize,s.FrameTypes.REQUEST_FNF)),E=g.next();!E.done;E=g.next()){var b=E.value;f.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else f.send({type:s.FrameTypes.REQUEST_FNF,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?s.Flags.METADATA:0,streamId:r});return this.done=!0,this.receiver.onComplete(),!0},l.prototype.handleReject=function(r){this.done||(this.done=!0,this.receiver.onError(r))},l.prototype.cancel=function(){var r;this.done||(this.done=!0,(r=this.leaseManager)===null||r===void 0||r.cancelRequest(this))},l.prototype.handle=function(r){if(r.type==s.FrameTypes.ERROR){this.close(new a.RSocketError(r.code,r.message));return}this.close(new a.RSocketError(a.ErrorCodes.CANCELED,"Received invalid frame"))},l.prototype.close=function(r){if(this.done){console.warn("Trying to close for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}r?this.receiver.onError(r):this.receiver.onComplete()},l})();Y.RequestFnFRequesterStream=v;var R=(function(){function l(r,f,u,y){if(this.streamId=r,this.stream=f,this.handler=u,this.streamType=s.FrameTypes.REQUEST_FNF,s.Flags.hasFollows(y.flags)){d.add(this,y.data,y.metadata),f.connect(this);return}var g={data:y.data,metadata:y.metadata};try{this.cancellable=u(g,this)}catch{}}return l.prototype.handle=function(r){var f;if(r.type==s.FrameTypes.PAYLOAD)if(s.Flags.hasFollows(r.flags)){if(d.add(this,r.data,r.metadata))return;f="Unexpected fragment size"}else{this.stream.disconnect(this);var u=d.reassemble(this,r.data,r.metadata);try{this.cancellable=this.handler(u,this)}catch{}return}else f="Unexpected frame type [".concat(r.type,"]");this.done=!0,r.type!=s.FrameTypes.CANCEL&&r.type!=s.FrameTypes.ERROR&&this.stream.send({type:s.FrameTypes.ERROR,streamId:this.streamId,flags:s.Flags.NONE,code:a.ErrorCodes.CANCELED,message:f}),this.stream.disconnect(this),d.cancel(this)},l.prototype.close=function(r){var f;if(this.done){console.warn("Trying to close for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}this.done=!0,d.cancel(this),(f=this.cancellable)===null||f===void 0||f.cancel()},l.prototype.onError=function(r){},l.prototype.onComplete=function(){},l})();return Y.RequestFnfResponderStream=R,Y}var J={},fr;function In(){if(fr)return J;fr=1;var c=J&&J.__createBinding||(Object.create?(function(l,r,f,u){u===void 0&&(u=f),Object.defineProperty(l,u,{enumerable:!0,get:function(){return r[f]}})}):(function(l,r,f,u){u===void 0&&(u=f),l[u]=r[f]})),o=J&&J.__setModuleDefault||(Object.create?(function(l,r){Object.defineProperty(l,"default",{enumerable:!0,value:r})}):function(l,r){l.default=r}),e=J&&J.__importStar||function(l){if(l&&l.__esModule)return l;var r={};if(l!=null)for(var f in l)f!=="default"&&Object.prototype.hasOwnProperty.call(l,f)&&c(r,l,f);return o(r,l),r},n=J&&J.__values||function(l){var r=typeof Symbol=="function"&&Symbol.iterator,f=r&&l[r],u=0;if(f)return f.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&u>=l.length&&(l=void 0),{value:l&&l[u++],done:!l}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(J,"__esModule",{value:!0}),J.RequestResponseResponderStream=J.RequestResponseRequesterStream=void 0;var a=we(),h=gt(),s=ae(),d=e(Et()),v=(function(){function l(r,f,u,y){this.payload=r,this.receiver=f,this.fragmentSize=u,this.leaseManager=y,this.streamType=s.FrameTypes.REQUEST_RESPONSE}return l.prototype.handleReady=function(r,f){var u,y;if(this.done)return!1;if(this.streamId=r,this.stream=f,f.connect(this),(0,h.isFragmentable)(this.payload,this.fragmentSize,s.FrameTypes.REQUEST_RESPONSE))try{for(var g=n((0,h.fragment)(r,this.payload,this.fragmentSize,s.FrameTypes.REQUEST_RESPONSE)),E=g.next();!E.done;E=g.next()){var b=E.value;this.stream.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.REQUEST_RESPONSE,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?s.Flags.METADATA:0,streamId:r});return this.hasExtension&&this.stream.send({type:s.FrameTypes.EXT,streamId:r,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},l.prototype.handleReject=function(r){this.done||(this.done=!0,this.receiver.onError(r))},l.prototype.handle=function(r){var f,u=r.type;switch(u){case s.FrameTypes.PAYLOAD:{var y=s.Flags.hasComplete(r.flags),g=s.Flags.hasNext(r.flags);if(y||!s.Flags.hasFollows(r.flags)){if(this.done=!0,this.stream.disconnect(this),!g){this.receiver.onComplete();return}var E=this.hasFragments?d.reassemble(this,r.data,r.metadata):{data:r.data,metadata:r.metadata};this.receiver.onNext(E,!0);return}if(!d.add(this,r.data,r.metadata)){f="Unexpected fragment size";break}return}case s.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),d.cancel(this),this.receiver.onError(new a.RSocketError(r.code,r.message));return}case s.FrameTypes.EXT:{if(this.hasFragments){f="Unexpected frame type [".concat(u,"] during reassembly");break}this.receiver.onExtension(r.extendedType,r.extendedContent,s.Flags.hasIgnore(r.flags));return}default:f="Unexpected frame type [".concat(u,"]")}this.close(new a.RSocketError(a.ErrorCodes.CANCELED,f)),this.stream.send({type:s.FrameTypes.CANCEL,streamId:this.streamId,flags:s.Flags.NONE}),this.stream.disconnect(this)},l.prototype.cancel=function(){var r;if(!this.done){if(this.done=!0,!this.streamId){(r=this.leaseManager)===null||r===void 0||r.cancelRequest(this);return}this.stream.send({type:s.FrameTypes.CANCEL,flags:s.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),d.cancel(this)}},l.prototype.onExtension=function(r,f,u){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=r,this.extendedContent=f,this.flags=u?s.Flags.IGNORE:s.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:s.FrameTypes.EXT,extendedType:r,extendedContent:f,flags:u?s.Flags.IGNORE:s.Flags.NONE})}},l.prototype.close=function(r){this.done||(this.done=!0,d.cancel(this),r?this.receiver.onError(r):this.receiver.onComplete())},l})();J.RequestResponseRequesterStream=v;var R=(function(){function l(r,f,u,y,g){if(this.streamId=r,this.stream=f,this.fragmentSize=u,this.handler=y,this.streamType=s.FrameTypes.REQUEST_RESPONSE,f.connect(this),s.Flags.hasFollows(g.flags)){d.add(this,g.data,g.metadata);return}var E={data:g.data,metadata:g.metadata};try{this.receiver=y(E,this)}catch(b){this.onError(b)}}return l.prototype.handle=function(r){var f,u;if(!this.receiver||this.hasFragments)if(r.type===s.FrameTypes.PAYLOAD)if(s.Flags.hasFollows(r.flags)){if(d.add(this,r.data,r.metadata))return;u="Unexpected fragment size"}else{var y=d.reassemble(this,r.data,r.metadata);try{this.receiver=this.handler(y,this)}catch(g){this.onError(g)}return}else u="Unexpected frame type [".concat(r.type,"] during reassembly");else if(r.type===s.FrameTypes.EXT){this.receiver.onExtension(r.extendedType,r.extendedContent,s.Flags.hasIgnore(r.flags));return}else u="Unexpected frame type [".concat(r.type,"]");this.done=!0,(f=this.receiver)===null||f===void 0||f.cancel(),r.type!==s.FrameTypes.CANCEL&&r.type!==s.FrameTypes.ERROR&&this.stream.send({type:s.FrameTypes.ERROR,flags:s.Flags.NONE,code:a.ErrorCodes.CANCELED,message:u,streamId:this.streamId}),this.stream.disconnect(this),d.cancel(this)},l.prototype.onError=function(r){if(this.done){console.warn("Trying to error for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}this.done=!0,this.stream.send({type:s.FrameTypes.ERROR,flags:s.Flags.NONE,code:r instanceof a.RSocketError?r.code:a.ErrorCodes.APPLICATION_ERROR,message:r.message,streamId:this.streamId}),this.stream.disconnect(this)},l.prototype.onNext=function(r,f){var u,y;if(!this.done){if(this.done=!0,(0,h.isFragmentable)(r,this.fragmentSize,s.FrameTypes.PAYLOAD))try{for(var g=n((0,h.fragment)(this.streamId,r,this.fragmentSize,s.FrameTypes.PAYLOAD,!0)),E=g.next();!E.done;E=g.next()){var b=E.value;this.stream.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.PAYLOAD,flags:s.Flags.NEXT|s.Flags.COMPLETE|(r.metadata?s.Flags.METADATA:0),data:r.data,metadata:r.metadata,streamId:this.streamId});this.stream.disconnect(this)}},l.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:s.FrameTypes.PAYLOAD,flags:s.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},l.prototype.onExtension=function(r,f,u){this.done||this.stream.send({type:s.FrameTypes.EXT,streamId:this.streamId,flags:u?s.Flags.IGNORE:s.Flags.NONE,extendedType:r,extendedContent:f})},l.prototype.close=function(r){var f;if(this.done){console.warn("Trying to close for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}d.cancel(this),(f=this.receiver)===null||f===void 0||f.cancel()},l})();return J.RequestResponseResponderStream=R,J}var $={},pr;function On(){if(pr)return $;pr=1;var c=$&&$.__createBinding||(Object.create?(function(l,r,f,u){u===void 0&&(u=f),Object.defineProperty(l,u,{enumerable:!0,get:function(){return r[f]}})}):(function(l,r,f,u){u===void 0&&(u=f),l[u]=r[f]})),o=$&&$.__setModuleDefault||(Object.create?(function(l,r){Object.defineProperty(l,"default",{enumerable:!0,value:r})}):function(l,r){l.default=r}),e=$&&$.__importStar||function(l){if(l&&l.__esModule)return l;var r={};if(l!=null)for(var f in l)f!=="default"&&Object.prototype.hasOwnProperty.call(l,f)&&c(r,l,f);return o(r,l),r},n=$&&$.__values||function(l){var r=typeof Symbol=="function"&&Symbol.iterator,f=r&&l[r],u=0;if(f)return f.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&u>=l.length&&(l=void 0),{value:l&&l[u++],done:!l}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty($,"__esModule",{value:!0}),$.RequestStreamResponderStream=$.RequestStreamRequesterStream=void 0;var a=we(),h=gt(),s=ae(),d=e(Et()),v=(function(){function l(r,f,u,y,g){this.payload=r,this.receiver=f,this.fragmentSize=u,this.initialRequestN=y,this.leaseManager=g,this.streamType=s.FrameTypes.REQUEST_STREAM}return l.prototype.handleReady=function(r,f){var u,y;if(this.done)return!1;if(this.streamId=r,this.stream=f,f.connect(this),(0,h.isFragmentable)(this.payload,this.fragmentSize,s.FrameTypes.REQUEST_STREAM))try{for(var g=n((0,h.fragmentWithRequestN)(r,this.payload,this.fragmentSize,s.FrameTypes.REQUEST_STREAM,this.initialRequestN)),E=g.next();!E.done;E=g.next()){var b=E.value;this.stream.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.REQUEST_STREAM,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:this.payload.metadata!==void 0?s.Flags.METADATA:0,streamId:r});return this.hasExtension&&this.stream.send({type:s.FrameTypes.EXT,streamId:r,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},l.prototype.handleReject=function(r){this.done||(this.done=!0,this.receiver.onError(r))},l.prototype.handle=function(r){var f,u=r.type;switch(u){case s.FrameTypes.PAYLOAD:{var y=s.Flags.hasComplete(r.flags),g=s.Flags.hasNext(r.flags);if(y||!s.Flags.hasFollows(r.flags)){if(y&&(this.done=!0,this.stream.disconnect(this),!g)){this.receiver.onComplete();return}var E=this.hasFragments?d.reassemble(this,r.data,r.metadata):{data:r.data,metadata:r.metadata};this.receiver.onNext(E,y);return}if(!d.add(this,r.data,r.metadata)){f="Unexpected fragment size";break}return}case s.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),d.cancel(this),this.receiver.onError(new a.RSocketError(r.code,r.message));return}case s.FrameTypes.EXT:{if(this.hasFragments){f="Unexpected frame type [".concat(u,"] during reassembly");break}this.receiver.onExtension(r.extendedType,r.extendedContent,s.Flags.hasIgnore(r.flags));return}default:f="Unexpected frame type [".concat(u,"]")}this.close(new a.RSocketError(a.ErrorCodes.CANCELED,f)),this.stream.send({type:s.FrameTypes.CANCEL,streamId:this.streamId,flags:s.Flags.NONE}),this.stream.disconnect(this)},l.prototype.request=function(r){if(!this.done){if(!this.streamId){this.initialRequestN+=r;return}this.stream.send({type:s.FrameTypes.REQUEST_N,flags:s.Flags.NONE,requestN:r,streamId:this.streamId})}},l.prototype.cancel=function(){var r;if(!this.done){if(this.done=!0,!this.streamId){(r=this.leaseManager)===null||r===void 0||r.cancelRequest(this);return}this.stream.send({type:s.FrameTypes.CANCEL,flags:s.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),d.cancel(this)}},l.prototype.onExtension=function(r,f,u){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=r,this.extendedContent=f,this.flags=u?s.Flags.IGNORE:s.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:s.FrameTypes.EXT,extendedType:r,extendedContent:f,flags:u?s.Flags.IGNORE:s.Flags.NONE})}},l.prototype.close=function(r){this.done||(this.done=!0,d.cancel(this),r?this.receiver.onError(r):this.receiver.onComplete())},l})();$.RequestStreamRequesterStream=v;var R=(function(){function l(r,f,u,y,g){if(this.streamId=r,this.stream=f,this.fragmentSize=u,this.handler=y,this.streamType=s.FrameTypes.REQUEST_STREAM,f.connect(this),s.Flags.hasFollows(g.flags)){this.initialRequestN=g.requestN,d.add(this,g.data,g.metadata);return}var E={data:g.data,metadata:g.metadata};try{this.receiver=y(E,g.requestN,this)}catch(b){this.onError(b)}}return l.prototype.handle=function(r){var f,u;if(!this.receiver||this.hasFragments)if(r.type===s.FrameTypes.PAYLOAD)if(s.Flags.hasFollows(r.flags)){if(d.add(this,r.data,r.metadata))return;u="Unexpected frame size"}else{var y=d.reassemble(this,r.data,r.metadata);try{this.receiver=this.handler(y,this.initialRequestN,this)}catch(g){this.onError(g)}return}else u="Unexpected frame type [".concat(r.type,"] during reassembly");else if(r.type===s.FrameTypes.REQUEST_N){this.receiver.request(r.requestN);return}else if(r.type===s.FrameTypes.EXT){this.receiver.onExtension(r.extendedType,r.extendedContent,s.Flags.hasIgnore(r.flags));return}else u="Unexpected frame type [".concat(r.type,"]");this.done=!0,d.cancel(this),(f=this.receiver)===null||f===void 0||f.cancel(),r.type!==s.FrameTypes.CANCEL&&r.type!==s.FrameTypes.ERROR&&this.stream.send({type:s.FrameTypes.ERROR,flags:s.Flags.NONE,code:a.ErrorCodes.CANCELED,message:u,streamId:this.streamId}),this.stream.disconnect(this)},l.prototype.onError=function(r){if(this.done){console.warn("Trying to error for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}this.done=!0,this.stream.send({type:s.FrameTypes.ERROR,flags:s.Flags.NONE,code:r instanceof a.RSocketError?r.code:a.ErrorCodes.APPLICATION_ERROR,message:r.message,streamId:this.streamId}),this.stream.disconnect(this)},l.prototype.onNext=function(r,f){var u,y;if(!this.done){if(f&&(this.done=!0),(0,h.isFragmentable)(r,this.fragmentSize,s.FrameTypes.PAYLOAD))try{for(var g=n((0,h.fragment)(this.streamId,r,this.fragmentSize,s.FrameTypes.PAYLOAD,f)),E=g.next();!E.done;E=g.next()){var b=E.value;this.stream.send(b)}}catch(C){u={error:C}}finally{try{E&&!E.done&&(y=g.return)&&y.call(g)}finally{if(u)throw u.error}}else this.stream.send({type:s.FrameTypes.PAYLOAD,flags:s.Flags.NEXT|(f?s.Flags.COMPLETE:s.Flags.NONE)|(r.metadata?s.Flags.METADATA:s.Flags.NONE),data:r.data,metadata:r.metadata,streamId:this.streamId});f&&this.stream.disconnect(this)}},l.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:s.FrameTypes.PAYLOAD,flags:s.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},l.prototype.onExtension=function(r,f,u){this.done||this.stream.send({type:s.FrameTypes.EXT,streamId:this.streamId,flags:u?s.Flags.IGNORE:s.Flags.NONE,extendedType:r,extendedContent:f})},l.prototype.close=function(r){var f;if(this.done){console.warn("Trying to close for the second time. ".concat(r?"Dropping error [".concat(r,"]."):""));return}d.cancel(this),(f=this.receiver)===null||f===void 0||f.cancel()},l})();return $.RequestStreamResponderStream=R,$}var mr;function Ur(){if(mr)return X;mr=1,Object.defineProperty(X,"__esModule",{value:!0}),X.KeepAliveSender=X.KeepAliveHandler=X.DefaultConnectionFrameHandler=X.DefaultStreamRequestHandler=X.LeaseHandler=X.RSocketRequester=void 0;var c=we(),o=ae(),e=Cn(),n=An(),a=In(),h=On(),s=(function(){function y(g,E,b){this.connection=g,this.fragmentSize=E,this.leaseManager=b}return y.prototype.fireAndForget=function(g,E){var b=new n.RequestFnFRequesterStream(g,E,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(b):this.connection.multiplexerDemultiplexer.createRequestStream(b),b},y.prototype.requestResponse=function(g,E){var b=new a.RequestResponseRequesterStream(g,E,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(b):this.connection.multiplexerDemultiplexer.createRequestStream(b),b},y.prototype.requestStream=function(g,E,b){var C=new h.RequestStreamRequesterStream(g,b,this.fragmentSize,E,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(C):this.connection.multiplexerDemultiplexer.createRequestStream(C),C},y.prototype.requestChannel=function(g,E,b,C){var I=new e.RequestChannelRequesterStream(g,b,C,this.fragmentSize,E,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(I):this.connection.multiplexerDemultiplexer.createRequestStream(I),I},y.prototype.metadataPush=function(g,E){throw new Error("Method not implemented.")},y.prototype.close=function(g){this.connection.close(g)},y.prototype.onClose=function(g){this.connection.onClose(g)},y})();X.RSocketRequester=s;var d=(function(){function y(g,E){this.maxPendingRequests=g,this.multiplexer=E,this.pendingRequests=[],this.expirationTime=0,this.availableLease=0}return y.prototype.handle=function(g){for(this.expirationTime=g.ttl+Date.now(),this.availableLease=g.requestCount;this.availableLease>0&&this.pendingRequests.length>0;){var E=this.pendingRequests.shift();this.availableLease--,this.multiplexer.createRequestStream(E)}},y.prototype.requestLease=function(g){var E=this.availableLease;if(E>0&&Date.now()<this.expirationTime){this.availableLease=E-1,this.multiplexer.createRequestStream(g);return}if(this.pendingRequests.length>=this.maxPendingRequests){g.handleReject(new c.RSocketError(c.ErrorCodes.REJECTED,"No available lease given"));return}this.pendingRequests.push(g)},y.prototype.cancelRequest=function(g){var E=this.pendingRequests.indexOf(g);E>-1&&this.pendingRequests.splice(E,1)},y})();X.LeaseHandler=d;var v=(function(){function y(g,E){this.rsocket=g,this.fragmentSize=E}return y.prototype.handle=function(g,E){switch(g.type){case o.FrameTypes.REQUEST_FNF:this.rsocket.fireAndForget&&new n.RequestFnfResponderStream(g.streamId,E,this.rsocket.fireAndForget.bind(this.rsocket),g);return;case o.FrameTypes.REQUEST_RESPONSE:if(this.rsocket.requestResponse){new a.RequestResponseResponderStream(g.streamId,E,this.fragmentSize,this.rsocket.requestResponse.bind(this.rsocket),g);return}this.rejectRequest(g.streamId,E);return;case o.FrameTypes.REQUEST_STREAM:if(this.rsocket.requestStream){new h.RequestStreamResponderStream(g.streamId,E,this.fragmentSize,this.rsocket.requestStream.bind(this.rsocket),g);return}this.rejectRequest(g.streamId,E);return;case o.FrameTypes.REQUEST_CHANNEL:if(this.rsocket.requestChannel){new e.RequestChannelResponderStream(g.streamId,E,this.fragmentSize,this.rsocket.requestChannel.bind(this.rsocket),g);return}this.rejectRequest(g.streamId,E);return}},y.prototype.rejectRequest=function(g,E){E.send({type:o.FrameTypes.ERROR,streamId:g,flags:o.Flags.NONE,code:c.ErrorCodes.REJECTED,message:"No available handler found"})},y.prototype.close=function(){},y})();X.DefaultStreamRequestHandler=v;var R=(function(){function y(g,E,b,C,I){this.connection=g,this.keepAliveHandler=E,this.keepAliveSender=b,this.leaseHandler=C,this.rsocket=I}return y.prototype.handle=function(g){switch(g.type){case o.FrameTypes.KEEPALIVE:this.keepAliveHandler.handle(g);return;case o.FrameTypes.LEASE:if(this.leaseHandler){this.leaseHandler.handle(g);return}return;case o.FrameTypes.ERROR:this.connection.close(new c.RSocketError(g.code,g.message));return;case o.FrameTypes.METADATA_PUSH:this.rsocket.metadataPush;return;default:this.connection.multiplexerDemultiplexer.connectionOutbound.send({type:o.FrameTypes.ERROR,streamId:0,flags:o.Flags.NONE,message:"Received unknown frame type",code:c.ErrorCodes.CONNECTION_ERROR})}},y.prototype.pause=function(){var g;this.keepAliveHandler.pause(),(g=this.keepAliveSender)===null||g===void 0||g.pause()},y.prototype.resume=function(){var g;this.keepAliveHandler.start(),(g=this.keepAliveSender)===null||g===void 0||g.start()},y.prototype.close=function(g){var E;this.keepAliveHandler.close(),(E=this.rsocket.close)===null||E===void 0||E.call(this.rsocket,g)},y})();X.DefaultConnectionFrameHandler=R;var l;(function(y){y[y.Paused=0]="Paused",y[y.Running=1]="Running",y[y.Closed=2]="Closed"})(l||(l={}));var r=(function(){function y(g,E){this.connection=g,this.keepAliveTimeoutDuration=E,this.state=l.Paused,this.outbound=g.multiplexerDemultiplexer.connectionOutbound}return y.prototype.handle=function(g){this.keepAliveLastReceivedMillis=Date.now(),o.Flags.hasRespond(g.flags)&&this.outbound.send({type:o.FrameTypes.KEEPALIVE,streamId:0,data:g.data,flags:g.flags^o.Flags.RESPOND,lastReceivedPosition:0})},y.prototype.start=function(){this.state===l.Paused&&(this.keepAliveLastReceivedMillis=Date.now(),this.state=l.Running,this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),this.keepAliveTimeoutDuration))},y.prototype.pause=function(){this.state===l.Running&&(this.state=l.Paused,clearTimeout(this.activeTimeout))},y.prototype.close=function(){this.state=l.Closed,clearTimeout(this.activeTimeout)},y.prototype.timeoutCheck=function(){var g=Date.now(),E=g-this.keepAliveLastReceivedMillis;E>=this.keepAliveTimeoutDuration?this.connection.close(new Error("No keep-alive acks for ".concat(this.keepAliveTimeoutDuration," millis"))):this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),Math.max(100,this.keepAliveTimeoutDuration-E))},y})();X.KeepAliveHandler=r;var f;(function(y){y[y.Paused=0]="Paused",y[y.Running=1]="Running",y[y.Closed=2]="Closed"})(f||(f={}));var u=(function(){function y(g,E){this.outbound=g,this.keepAlivePeriodDuration=E,this.state=f.Paused}return y.prototype.sendKeepAlive=function(){this.outbound.send({type:o.FrameTypes.KEEPALIVE,streamId:0,data:void 0,flags:o.Flags.RESPOND,lastReceivedPosition:0})},y.prototype.start=function(){this.state===f.Paused&&(this.state=f.Running,this.activeInterval=setInterval(this.sendKeepAlive.bind(this),this.keepAlivePeriodDuration))},y.prototype.pause=function(){this.state===f.Running&&(this.state=f.Paused,clearInterval(this.activeInterval))},y.prototype.close=function(){this.state=f.Closed,clearInterval(this.activeInterval)},y})();return X.KeepAliveSender=u,X}var Ie={},yr;function Br(){if(yr)return Ie;yr=1;var c=Ie&&Ie.__values||function(a){var h=typeof Symbol=="function"&&Symbol.iterator,s=h&&a[h],d=0;if(s)return s.call(a);if(a&&typeof a.length=="number")return{next:function(){return a&&d>=a.length&&(a=void 0),{value:a&&a[d++],done:!a}}};throw new TypeError(h?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.FrameStore=void 0;var o=wt(),e=Pr(),n=(function(){function a(){this.storedFrames=[],this._lastReceivedFramePosition=0,this._firstAvailableFramePosition=0,this._lastSentFramePosition=0}return Object.defineProperty(a.prototype,"lastReceivedFramePosition",{get:function(){return this._lastReceivedFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"firstAvailableFramePosition",{get:function(){return this._firstAvailableFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"lastSentFramePosition",{get:function(){return this._lastSentFramePosition},enumerable:!1,configurable:!0}),a.prototype.store=function(h){this._lastSentFramePosition+=(0,e.sizeOfFrame)(h),this.storedFrames.push(h)},a.prototype.record=function(h){this._lastReceivedFramePosition+=(0,e.sizeOfFrame)(h)},a.prototype.dropTo=function(h){for(var s=h-this._firstAvailableFramePosition;s>0&&this.storedFrames.length>0;){var d=this.storedFrames.shift();s-=(0,e.sizeOfFrame)(d)}if(s!==0)throw new o.RSocketError(o.ErrorCodes.CONNECTION_ERROR,"State inconsistency. Expected bytes to drop ".concat(h-this._firstAvailableFramePosition," but actual ").concat(s));this._firstAvailableFramePosition=h},a.prototype.drain=function(h){var s,d;try{for(var v=c(this.storedFrames),R=v.next();!R.done;R=v.next()){var l=R.value;h(l)}}catch(r){s={error:r}}finally{try{R&&!R.done&&(d=v.return)&&d.call(v)}finally{if(s)throw s.error}}},a})();return Ie.FrameStore=n,Ie}var gr;function Ln(){if(gr)return ue;gr=1;var c=ue&&ue.__awaiter||function(d,v,R,l){function r(f){return f instanceof R?f:new R(function(u){u(f)})}return new(R||(R=Promise))(function(f,u){function y(b){try{E(l.next(b))}catch(C){u(C)}}function g(b){try{E(l.throw(b))}catch(C){u(C)}}function E(b){b.done?f(b.value):r(b.value).then(y,g)}E((l=l.apply(d,v||[])).next())})},o=ue&&ue.__generator||function(d,v){var R={label:0,sent:function(){if(f[0]&1)throw f[1];return f[1]},trys:[],ops:[]},l,r,f,u;return u={next:y(0),throw:y(1),return:y(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function y(E){return function(b){return g([E,b])}}function g(E){if(l)throw new TypeError("Generator is already executing.");for(;R;)try{if(l=1,r&&(f=E[0]&2?r.return:E[0]?r.throw||((f=r.return)&&f.call(r),0):r.next)&&!(f=f.call(r,E[1])).done)return f;switch(r=0,f&&(E=[E[0]&2,f.value]),E[0]){case 0:case 1:f=E;break;case 4:return R.label++,{value:E[1],done:!1};case 5:R.label++,r=E[1],E=[0];continue;case 7:E=R.ops.pop(),R.trys.pop();continue;default:if(f=R.trys,!(f=f.length>0&&f[f.length-1])&&(E[0]===6||E[0]===2)){R=0;continue}if(E[0]===3&&(!f||E[1]>f[0]&&E[1]<f[3])){R.label=E[1];break}if(E[0]===6&&R.label<f[1]){R.label=f[1],f=E;break}if(f&&R.label<f[2]){R.label=f[2],R.ops.push(E);break}f[2]&&R.ops.pop(),R.trys.pop();continue}E=v.call(d,R)}catch(b){E=[6,b],r=0}finally{l=f=0}if(E[0]&5)throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}};Object.defineProperty(ue,"__esModule",{value:!0}),ue.RSocketConnector=void 0;var e=Mr(),n=ae(),a=Ur(),h=Br(),s=(function(){function d(v){this.config=v}return d.prototype.connect=function(){var v,R,l,r,f,u,y,g,E,b,C,I,L,D,P,B,Q,j,q,H;return c(this,void 0,void 0,function(){var M,G,z,ee,pe,Se,ve,Re,Pe,W=this;return o(this,function(V){switch(V.label){case 0:return M=this.config,G={type:n.FrameTypes.SETUP,dataMimeType:(R=(v=M.setup)===null||v===void 0?void 0:v.dataMimeType)!==null&&R!==void 0?R:"application/octet-stream",metadataMimeType:(r=(l=M.setup)===null||l===void 0?void 0:l.metadataMimeType)!==null&&r!==void 0?r:"application/octet-stream",keepAlive:(u=(f=M.setup)===null||f===void 0?void 0:f.keepAlive)!==null&&u!==void 0?u:6e4,lifetime:(g=(y=M.setup)===null||y===void 0?void 0:y.lifetime)!==null&&g!==void 0?g:3e5,metadata:(b=(E=M.setup)===null||E===void 0?void 0:E.payload)===null||b===void 0?void 0:b.metadata,data:(I=(C=M.setup)===null||C===void 0?void 0:C.payload)===null||I===void 0?void 0:I.data,resumeToken:(D=(L=M.resume)===null||L===void 0?void 0:L.tokenGenerator())!==null&&D!==void 0?D:null,streamId:0,majorVersion:1,minorVersion:0,flags:(!((B=(P=M.setup)===null||P===void 0?void 0:P.payload)===null||B===void 0)&&B.metadata?n.Flags.METADATA:n.Flags.NONE)|(M.lease?n.Flags.LEASE:n.Flags.NONE)|(M.resume?n.Flags.RESUME_ENABLE:n.Flags.NONE)},[4,M.transport.connect(function(ne){return M.resume?new e.ResumableClientServerInputMultiplexerDemultiplexer(e.StreamIdGenerator.create(-1),ne,ne,new h.FrameStore,G.resumeToken.toString(),function(be,Te){return c(W,void 0,void 0,function(){var Fe,me,te;return o(this,function(ce){switch(ce.label){case 0:return Fe=function(ye){return ye.send({type:n.FrameTypes.RESUME,streamId:0,flags:n.Flags.NONE,clientPosition:Te.firstAvailableFramePosition,serverPosition:Te.lastReceivedFramePosition,majorVersion:G.minorVersion,minorVersion:G.majorVersion,resumeToken:G.resumeToken}),new e.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(ye,ye,be)},me=-1,te=function(){return me++,M.resume.reconnectFunction(me).then(function(){return M.transport.connect(Fe).catch(te)})},[4,te()];case 1:return ce.sent(),[2]}})})}):new e.ClientServerInputMultiplexerDemultiplexer(e.StreamIdGenerator.create(-1),ne,ne)})];case 1:return z=V.sent(),ee=new a.KeepAliveSender(z.multiplexerDemultiplexer.connectionOutbound,G.keepAlive),pe=new a.KeepAliveHandler(z,G.lifetime),Se=M.lease?new a.LeaseHandler((Q=M.lease.maxPendingRequests)!==null&&Q!==void 0?Q:256,z.multiplexerDemultiplexer):void 0,ve=(j=M.responder)!==null&&j!==void 0?j:{},Re=new a.DefaultConnectionFrameHandler(z,pe,ee,Se,ve),Pe=new a.DefaultStreamRequestHandler(ve,0),z.onClose(function(ne){ee.close(),pe.close(),Re.close(ne)}),z.multiplexerDemultiplexer.connectionInbound(Re),z.multiplexerDemultiplexer.handleRequestStream(Pe),z.multiplexerDemultiplexer.connectionOutbound.send(G),pe.start(),ee.start(),[2,new a.RSocketRequester(z,(H=(q=M.fragmentation)===null||q===void 0?void 0:q.maxOutboundFragmentSize)!==null&&H!==void 0?H:0,Se)]}})})},d})();return ue.RSocketConnector=s,ue}var he={},Er;function xn(){if(Er)return he;Er=1;var c=he&&he.__awaiter||function(v,R,l,r){function f(u){return u instanceof l?u:new l(function(y){y(u)})}return new(l||(l=Promise))(function(u,y){function g(C){try{b(r.next(C))}catch(I){y(I)}}function E(C){try{b(r.throw(C))}catch(I){y(I)}}function b(C){C.done?u(C.value):f(C.value).then(g,E)}b((r=r.apply(v,R||[])).next())})},o=he&&he.__generator||function(v,R){var l={label:0,sent:function(){if(u[0]&1)throw u[1];return u[1]},trys:[],ops:[]},r,f,u,y;return y={next:g(0),throw:g(1),return:g(2)},typeof Symbol=="function"&&(y[Symbol.iterator]=function(){return this}),y;function g(b){return function(C){return E([b,C])}}function E(b){if(r)throw new TypeError("Generator is already executing.");for(;l;)try{if(r=1,f&&(u=b[0]&2?f.return:b[0]?f.throw||((u=f.return)&&u.call(f),0):f.next)&&!(u=u.call(f,b[1])).done)return u;switch(f=0,u&&(b=[b[0]&2,u.value]),b[0]){case 0:case 1:u=b;break;case 4:return l.label++,{value:b[1],done:!1};case 5:l.label++,f=b[1],b=[0];continue;case 7:b=l.ops.pop(),l.trys.pop();continue;default:if(u=l.trys,!(u=u.length>0&&u[u.length-1])&&(b[0]===6||b[0]===2)){l=0;continue}if(b[0]===3&&(!u||b[1]>u[0]&&b[1]<u[3])){l.label=b[1];break}if(b[0]===6&&l.label<u[1]){l.label=u[1],u=b;break}if(u&&l.label<u[2]){l.label=u[2],l.ops.push(b);break}u[2]&&l.ops.pop(),l.trys.pop();continue}b=R.call(v,l)}catch(C){b=[6,C],f=0}finally{r=u=0}if(b[0]&5)throw b[1];return{value:b[0]?b[1]:void 0,done:!0}}};Object.defineProperty(he,"__esModule",{value:!0}),he.RSocketServer=void 0;var e=Mr(),n=we(),a=ae(),h=Ur(),s=Br(),d=(function(){function v(R){var l,r;this.acceptor=R.acceptor,this.transport=R.transport,this.lease=R.lease,this.serverSideKeepAlive=R.serverSideKeepAlive,this.sessionStore=R.resume?{}:void 0,this.sessionTimeout=(r=(l=R.resume)===null||l===void 0?void 0:l.sessionTimeout)!==null&&r!==void 0?r:void 0}return v.prototype.bind=function(){return c(this,void 0,void 0,function(){var R=this;return o(this,function(l){switch(l.label){case 0:return[4,this.transport.bind(function(r,f){return c(R,void 0,void 0,function(){var u,y,y,g,E,b,C,I,L,D,P,B,Q,j,q;return o(this,function(H){switch(H.label){case 0:switch(u=r.type,u){case a.FrameTypes.SETUP:return[3,1];case a.FrameTypes.RESUME:return[3,5]}return[3,6];case 1:return H.trys.push([1,3,,4]),this.lease&&!a.Flags.hasLease(r.flags)?(y=new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,"Lease has to be enabled"),f.multiplexerDemultiplexer.connectionOutbound.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:y.code,message:y.message}),f.close(y),[2]):a.Flags.hasLease(r.flags)&&!this.lease?(y=new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,"Lease has to be disabled"),f.multiplexerDemultiplexer.connectionOutbound.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:y.code,message:y.message}),f.close(y),[2]):(g=a.Flags.hasLease(r.flags)?new h.LeaseHandler((B=this.lease.maxPendingRequests)!==null&&B!==void 0?B:256,f.multiplexerDemultiplexer):void 0,E=new h.RSocketRequester(f,(j=(Q=this.fragmentation)===null||Q===void 0?void 0:Q.maxOutboundFragmentSize)!==null&&j!==void 0?j:0,g),[4,this.acceptor.accept({data:r.data,dataMimeType:r.dataMimeType,metadata:r.metadata,metadataMimeType:r.metadataMimeType,flags:r.flags,keepAliveMaxLifetime:r.lifetime,keepAliveInterval:r.keepAlive,resumeToken:r.resumeToken},E)]);case 2:return b=H.sent(),C=new h.KeepAliveHandler(f,r.lifetime),I=this.serverSideKeepAlive?new h.KeepAliveSender(f.multiplexerDemultiplexer.connectionOutbound,r.keepAlive):void 0,L=new h.DefaultConnectionFrameHandler(f,C,I,g,b),D=new h.DefaultStreamRequestHandler(b,0),f.onClose(function(M){I==null||I.close(),C.close(),L.close(M)}),f.multiplexerDemultiplexer.connectionInbound(L),f.multiplexerDemultiplexer.handleRequestStream(D),C.start(),I==null||I.start(),[3,4];case 3:return P=H.sent(),f.multiplexerDemultiplexer.connectionOutbound.send({type:a.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.REJECTED_SETUP,message:(q=P.message)!==null&&q!==void 0?q:"",flags:a.Flags.NONE}),f.close(P instanceof n.RSocketError?P:new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,P.message)),[3,4];case 4:return[2];case 5:return[2];case 6:f.multiplexerDemultiplexer.connectionOutbound.send({type:a.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.UNSUPPORTED_SETUP,message:"Unsupported setup",flags:a.Flags.NONE}),f.close(new n.RSocketError(n.ErrorCodes.UNSUPPORTED_SETUP)),H.label=7;case 7:return[2]}})})},function(r,f){if(r.type===a.FrameTypes.RESUME){if(R.sessionStore){var u=R.sessionStore[r.resumeToken.toString()];if(!u){f.send({type:a.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.REJECTED_RESUME,message:"No session found for the given resume token",flags:a.Flags.NONE}),f.close();return}return u.resume(r,f,f),u}f.send({type:a.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.REJECTED_RESUME,message:"Resume is not enabled",flags:a.Flags.NONE}),f.close();return}else if(r.type===a.FrameTypes.SETUP&&a.Flags.hasResume(r.flags)){if(!R.sessionStore){var y=new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,"No resume support");f.send({type:a.FrameTypes.ERROR,streamId:0,flags:a.Flags.NONE,code:y.code,message:y.message}),f.close(y);return}var g=new e.ResumableClientServerInputMultiplexerDemultiplexer(e.StreamIdGenerator.create(0),f,f,new s.FrameStore,r.resumeToken.toString(),R.sessionStore,R.sessionTimeout);return R.sessionStore[r.resumeToken.toString()]=g,g}return new e.ClientServerInputMultiplexerDemultiplexer(e.StreamIdGenerator.create(0),f,f)})];case 1:return[2,l.sent()]}})})},v})();return he.RSocketServer=d,he}var Ot={},wr;function Nn(){return wr||(wr=1,Object.defineProperty(Ot,"__esModule",{value:!0})),Ot}var Sr;function wt(){return Sr||(Sr=1,(function(c){var o=Ce&&Ce.__createBinding||(Object.create?(function(n,a,h,s){s===void 0&&(s=h),Object.defineProperty(n,s,{enumerable:!0,get:function(){return a[h]}})}):(function(n,a,h,s){s===void 0&&(s=h),n[s]=a[h]})),e=Ce&&Ce.__exportStar||function(n,a){for(var h in n)h!=="default"&&!Object.prototype.hasOwnProperty.call(a,h)&&o(a,n,h)};Object.defineProperty(c,"__esModule",{value:!0}),e(Pr(),c),e(Fn(),c),e(kr(),c),e(we(),c),e(ae(),c),e(_n(),c),e(Ln(),c),e(xn(),c),e(Nn(),c)})(Ce)),Ce}var qr=wt(),Dn="1.46.0",Pn={version:Dn};const vr={highWater:10,lowWater:0};class Rr extends De{constructor(e){super();A(this,"options");A(this,"dataQueue");A(this,"isClosed");A(this,"processingPromise");A(this,"notifyDataAdded");A(this,"logger");A(this,"mapLine");if(this.options=e,this.processingPromise=null,this.isClosed=!1,this.dataQueue=[],this.mapLine=(e==null?void 0:e.mapLine)??(n=>n),this.logger=(e==null?void 0:e.logger)??Ne.get("DataStream"),e!=null&&e.closeOnError){const n=this.registerListener({error:a=>{n==null||n(),this.close()}})}}get highWatermark(){var e,n;return((n=(e=this.options)==null?void 0:e.pressure)==null?void 0:n.highWaterMark)??vr.highWater}get lowWatermark(){var e,n;return((n=(e=this.options)==null?void 0:e.pressure)==null?void 0:n.lowWaterMark)??vr.lowWater}get closed(){return this.isClosed}async close(){this.isClosed=!0,await this.processingPromise,this.iterateListeners(e=>{var n;return(n=e.closed)==null?void 0:n.call(e)}),this.dataQueue=[],this.listeners.clear()}enqueueData(e){var n;if(this.isClosed)throw new Error("Cannot enqueue data into closed stream.");this.dataQueue.push(e),(n=this.notifyDataAdded)==null||n.call(this),this.processQueue()}async read(){return this.closed||(this.processingPromise&&await this.processingPromise,this.closed)?null:new Promise((e,n)=>{const a=this.registerListener({data:async h=>{e(h),a==null||a()},closed:()=>{e(null),a==null||a()},error:h=>{n(h),a==null||a()}});this.processQueue()})}forEach(e){return this.dataQueue.length<=this.lowWatermark&&this.iterateAsyncErrored(async n=>{var a;return(a=n.lowWater)==null?void 0:a.call(n)}),this.registerListener({data:e})}processQueue(){if(this.processingPromise)return;const e=this.processingPromise=this._processQueue();return e.finally(()=>{this.processingPromise=null}),e}hasDataReader(){return Array.from(this.listeners.values()).some(e=>!!e.data)}async _processQueue(){if(this.dataQueue.length>=this.highWatermark&&await this.iterateAsyncErrored(async e=>{var n;return(n=e.highWater)==null?void 0:n.call(e)}),!(this.isClosed||!this.hasDataReader())){if(this.dataQueue.length){const e=this.dataQueue.shift(),n=this.mapLine(e);await this.iterateAsyncErrored(async a=>{var h;return(h=a.data)==null?void 0:h.call(a,n)})}if(this.dataQueue.length<=this.lowWatermark){const e=new Promise(n=>{this.notifyDataAdded=n});await Promise.race([this.iterateAsyncErrored(async n=>{var a;return(a=n.lowWater)==null?void 0:a.call(n)}),e]),this.notifyDataAdded=null}this.dataQueue.length>0&&setTimeout(()=>this.processQueue())}}async iterateAsyncErrored(e){const n=Array.from(this.listeners.values());for(let a of n)try{await e(a)}catch(h){this.logger.error(h),this.iterateListeners(s=>{var d;return(d=s.error)==null?void 0:d.call(s,h)})}}}var Oe={},br;function kn(){if(br)return Oe;br=1;var c=Oe&&Oe.__extends||(function(){var n=function(a,h){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,d){s.__proto__=d}||function(s,d){for(var v in d)Object.prototype.hasOwnProperty.call(d,v)&&(s[v]=d[v])},n(a,h)};return function(a,h){if(typeof h!="function"&&h!==null)throw new TypeError("Class extends value "+String(h)+" is not a constructor or null");n(a,h);function s(){this.constructor=a}a.prototype=h===null?Object.create(h):(s.prototype=h.prototype,new s)}})();Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.WebsocketDuplexConnection=void 0;var o=wt(),e=(function(n){c(a,n);function a(h,s,d){var v=n.call(this)||this;return v.websocket=h,v.deserializer=s,v.handleClosed=function(R){v.close(new Error(R.reason||"WebsocketDuplexConnection: Socket closed unexpectedly."))},v.handleError=function(R){v.close(R.error)},v.handleMessage=function(R){try{var l=U.Buffer.from(R.data),r=v.deserializer.deserializeFrame(l);v.multiplexerDemultiplexer.handle(r)}catch(f){v.close(f)}},h.addEventListener("close",v.handleClosed),h.addEventListener("error",v.handleError),h.addEventListener("message",v.handleMessage),v.multiplexerDemultiplexer=d(v),v}return Object.defineProperty(a.prototype,"availability",{get:function(){return this.done?0:1},enumerable:!1,configurable:!0}),a.prototype.close=function(h){if(this.done){n.prototype.close.call(this,h);return}this.websocket.removeEventListener("close",this.handleClosed),this.websocket.removeEventListener("error",this.handleError),this.websocket.removeEventListener("message",this.handleMessage),this.websocket.close(),delete this.websocket,n.prototype.close.call(this,h)},a.prototype.send=function(h){if(!this.done){var s=(0,o.serializeFrame)(h);this.websocket.send(s)}},a})(o.Deferred);return Oe.WebsocketDuplexConnection=e,Oe}var Mn=kn();class Un{constructor(o){A(this,"url");A(this,"factory");this.url=o.url,this.factory=o.wsCreator??(e=>new WebSocket(e))}connect(o){return new Promise((e,n)=>{const a=this.factory(this.url);a.binaryType="arraybuffer";let h;const s=()=>{h(),e(new Mn.WebsocketDuplexConnection(a,new qr.Deserializer,o))},d=R=>{h(),R.error!=null?n(R.error):R.message!=null?n(new Error(`Failed to create websocket connection: ${R.message}`)):n(new Error(`Failed to create websocket connection to ${this.url}`))},v=()=>{h(),n(new Error("WebSocket connection closed while opening"))};h=()=>{a.removeEventListener("open",s),a.removeEventListener("error",d),a.removeEventListener("close",v)},a.addEventListener("open",s),a.addEventListener("error",d),a.addEventListener("close",v)})}}const Bn=/\/+$/,qn=Pn.version,zn=5,Hn=2e4,Tr=3e4,Wn=9e4,zr=Ne.get("PowerSyncRemote");var Ze;(function(c){c.Buffered="buffered",c.Sequential="sequential"})(Ze||(Ze={}));class qt{getFetch(){throw new Error("Unspecified fetch implementation")}}const jn={socketUrlTransformer:c=>c.replace(/^https?:\/\//,function(o){return o==="https://"?"wss://":"ws://"}),fetchImplementation:new qt,fetchOptions:{}};class Qn{constructor(o,e=zr,n){A(this,"connector");A(this,"logger");A(this,"credentials",null);A(this,"options");this.connector=o,this.logger=e,this.options={...jn,...n??{}}}get fetch(){const{fetchImplementation:o}=this.options;return o instanceof qt?o.getFetch():o}async getCredentials(){return this.credentials?this.credentials:this.prefetchCredentials()}async prefetchCredentials(){return this.credentials=await this.fetchCredentials(),this.credentials}async fetchCredentials(){const o=await this.connector.fetchCredentials();if(o!=null&&o.endpoint.match(Bn))throw new Error(`A trailing forward slash "/" was found in the fetchCredentials endpoint: "${o.endpoint}". Remove the trailing forward slash "/" to fix this error.`);return o}invalidateCredentials(){var o,e;this.credentials=null,(e=(o=this.connector).invalidateCredentials)==null||e.call(o)}getUserAgent(){return`powersync-js/${qn}`}async buildRequest(o){const e=await this.getCredentials();if(e!=null&&(e.endpoint==null||e.endpoint==""))throw new Error("PowerSync endpoint not configured");if((e==null?void 0:e.token)==null||(e==null?void 0:e.token)==""){const a=new Error("Not signed in");throw a.status=401,a}const n=this.getUserAgent();return{url:e.endpoint+o,headers:{"content-type":"application/json",Authorization:`Token ${e.token}`,"x-user-agent":n}}}async post(o,e,n={}){const a=await this.buildRequest(o),h=await this.fetch(a.url,{method:"POST",headers:{...n,...a.headers},body:JSON.stringify(e)});if(h.status===401&&this.invalidateCredentials(),!h.ok)throw new Error(`Received ${h.status} - ${h.statusText} when posting to ${o}: ${await h.text()}}`);return h.json()}async get(o,e){const n=await this.buildRequest(o),a=await this.fetch(n.url,{method:"GET",headers:{...e,...n.headers}});if(a.status===401&&this.invalidateCredentials(),!a.ok)throw new Error(`Received ${a.status} - ${a.statusText} when getting from ${o}: ${await a.text()}}`);return a.json()}createTextDecoder(){return new TextDecoder}createSocket(o){return new WebSocket(o)}async socketStreamRaw(o,e,n){var Q,j;const{path:a,fetchStrategy:h=Ze.Buffered}=o,s=n==null?"application/json":"application/bson";function d(q){let H;return n!=null?H=n.serialize(q):H=JSON.stringify(q),U.Buffer.from(H)}const v=h==Ze.Buffered?10:1,R=await this.buildRequest(a),l=this.getUserAgent(),r=new Rr({logger:this.logger,pressure:{lowWaterMark:zn},mapLine:e});if((Q=o.abortSignal)!=null&&Q.aborted)throw new Z("Connection request aborted");(j=o.abortSignal)==null||j.addEventListener("abort",()=>{r.close()},{once:!0});let f;const u=()=>{clearTimeout(f),f=setTimeout(()=>{this.logger.error(`No data received on WebSocket in ${Tr}ms, closing connection.`),r.close()},Tr)};u();let y=()=>{};const g=this.options.socketUrlTransformer(R.url),E=new qr.RSocketConnector({transport:new Un({url:g,wsCreator:q=>{const H=this.createSocket(q);return y=r.registerListener({closed:()=>{H.close()}}),H.addEventListener("message",M=>{u()}),H}}),setup:{keepAlive:Hn,lifetime:Wn,dataMimeType:s,metadataMimeType:s,payload:{data:null,metadata:d({token:R.headers.Authorization,user_agent:l})}}});let b;try{b=await E.connect(),y()}catch(q){throw this.logger.error("Failed to connect WebSocket",q),clearTimeout(f),r.closed||await r.close(),q}u();let C=!1;const I=()=>{clearTimeout(f),!C&&(C=!0,b.close())};b.onClose(()=>C=!0);let L=v;const D=r.registerListener({closed:()=>{I(),D()}}),P=await new Promise((q,H)=>{let M=!1;const G=b.requestStream({data:d(o.data),metadata:d({path:a})},v,{onError:z=>{z.message.includes("PSYNC_")?z.message.includes("PSYNC_S21")&&this.invalidateCredentials():z.message!=="Closed. "&&this.invalidateCredentials(),z.message!=="Closed. "&&this.logger.error(z),r.close(),M||H(z)},onNext:z=>{M||(M=!0,q(G));const{data:ee}=z;L--,ee&&r.enqueueData(ee)},onComplete:()=>{r.close()},onExtension:()=>{}})}),B=r.registerListener({lowWater:async()=>{v-L>0&&(P.request(v-L),L=v)},closed:()=>{B()}});return r}async postStreamRaw(o,e){const{data:n,path:a,headers:h,abortSignal:s}=o,d=await this.buildRequest(a);if(s!=null&&s.aborted)throw new Z("Abort request received before making postStreamRaw request");const v=new AbortController;let R=!1;s==null||s.addEventListener("abort",()=>{R||v.abort(s.reason??new Z("Cancelling network request before it resolves. Abort signal has been received."))});const l=await this.fetch(d.url,{method:"POST",headers:{...h,...d.headers},body:JSON.stringify(n),signal:v.signal,cache:"no-store",...this.options.fetchOptions??{},...o.fetchOptions}).catch(I=>{throw I.name=="AbortError"?new Z(`Pending fetch request to ${d.url} has been aborted.`):I});if(!l)throw new Error("Fetch request was aborted");if(R=!0,!l.ok||!l.body){const I=await l.text();this.logger.error(`Could not POST streaming to ${a} - ${l.status} - ${l.statusText}: ${I}`);const L=new Error(`HTTP ${l.statusText}: ${I}`);throw L.status=l.status,L}const r=l.body.getReader();let f=!1;const u=async()=>{try{f=!0,await r.cancel()}catch{}r.releaseLock()},y=new Rr({logger:this.logger,mapLine:e,pressure:{highWaterMark:20,lowWaterMark:10}});s==null||s.addEventListener("abort",()=>{u(),y.close()});const g=this.createTextDecoder();let E="";(async()=>{for(;!y.closed&&!(s!=null&&s.aborted)&&!f;){const{done:D,value:P}=await r.read();if(D){const j=E.trim();j.length!=0&&y.enqueueData(j),y.close(),await u();return}const B=g.decode(P,{stream:!0});E+=B;const Q=E.split(`
`);for(var I=0;I<Q.length-1;I++){var L=Q[I].trim();L.length>0&&y.enqueueData(L)}E=Q[Q.length-1],y.dataQueue.length>y.highWatermark&&await new Promise(j=>{const q=y.registerListener({lowWater:async()=>{j(),q()},closed:()=>{j(),q()}})})}})().catch(I=>this.logger.error("Error consuming stream",I));const C=y.registerListener({closed:()=>{u(),C==null||C()}});return y}}function Fr(c){return{priority:c.priority,hasSynced:c.has_synced??void 0,lastSyncedAt:c.last_synced_at!=null?new Date(c.last_synced_at*1e3):void 0}}function Vn(c){var n;const o=c.priority_status.find(a=>a.priority==Dr),e=o!=null?Fr(o):null;return{connected:c.connected,connecting:c.connecting,dataFlow:{downloading:c.downloading!=null,downloadProgress:(n=c.downloading)==null?void 0:n.buckets,internalStreamSubscriptions:c.streams},lastSyncedAt:e==null?void 0:e.lastSyncedAt,hasSynced:e==null?void 0:e.hasSynced,priorityStatusEntries:c.priority_status.map(Fr)}}function Gn(c){return c.data!=null}function Xn(c){return c.token_expires_in!=null}function Kn(c){return c.checkpoint!=null}function Yn(c){return c.checkpoint_complete!=null}function Jn(c){return c.partial_checkpoint_complete!=null}function $n(c){return c.checkpoint_diff!=null}var et;(function(c){c.CRUD="crud",c.SYNC="sync"})(et||(et={}));var tt;(function(c){c.HTTP="http",c.WEB_SOCKET="web-socket"})(tt||(tt={}));var ht;(function(c){c.JAVASCRIPT="js",c.RUST="rust"})(ht||(ht={}));const Zn=ht.RUST,ei={appMetadata:{},connectionMethod:tt.WEB_SOCKET,clientImplementation:Zn,fetchStrategy:Ze.Buffered,params:{},serializedSchema:void 0,includeDefaultStreams:!0},_r=3;class ti extends De{constructor(e){super();A(this,"_lastSyncedAt");A(this,"options");A(this,"abortController");A(this,"uploadAbortController");A(this,"crudUpdateListener");A(this,"streamingSyncPromise");A(this,"logger");A(this,"activeStreams");A(this,"isUploadingCrud",!1);A(this,"notifyCompletedUploads");A(this,"handleActiveStreamsChange");A(this,"syncStatus");A(this,"triggerCrudUpload");this.options=e,this.activeStreams=e.subscriptions,this.logger=e.logger??Ne.get("PowerSyncStream"),this.syncStatus=new Qe({connected:!1,connecting:!1,lastSyncedAt:void 0,dataFlow:{uploading:!1,downloading:!1}}),this.abortController=null,this.triggerCrudUpload=En(()=>{!this.syncStatus.connected||this.isUploadingCrud||(this.isUploadingCrud=!0,this._uploadAllCrud().finally(()=>{var n;(n=this.notifyCompletedUploads)==null||n.call(this),this.isUploadingCrud=!1}))},this.options.crudUploadThrottleMs)}async waitForReady(){}waitForStatus(e){return this.waitUntilStatusMatches(n=>{const a=(h,s)=>Object.entries(h).every(([d,v])=>{const R=s[d];return typeof v=="object"&&typeof R=="object"?a(v,R):v==R});return a(e,n)})}waitUntilStatusMatches(e){return new Promise(n=>{if(e(this.syncStatus)){n();return}const a=this.registerListener({statusChanged:h=>{e(h)&&(n(),a==null||a())}})})}get lastSyncedAt(){const e=this.syncStatus.lastSyncedAt;return e&&new Date(e)}get isConnected(){return this.syncStatus.connected}async dispose(){var e,n;super.dispose(),(e=this.crudUpdateListener)==null||e.call(this),this.crudUpdateListener=void 0,(n=this.uploadAbortController)==null||n.abort()}async hasCompletedSync(){return this.options.adapter.hasCompletedSync()}async getWriteCheckpoint(){let n=`/write-checkpoint2.json?client_id=${await this.options.adapter.getClientId()}`;const h=(await this.options.remote.get(n)).data.write_checkpoint;return this.logger.debug(`Created write checkpoint: ${h}`),h}async _uploadAllCrud(){return this.obtainLock({type:et.CRUD,callback:async()=>{var a;let e;const n=new AbortController;for(this.uploadAbortController=n,(a=this.abortController)==null||a.signal.addEventListener("abort",()=>{n.abort()},{once:!0});!n.signal.aborted;)try{const h=await this.options.adapter.nextCrudItem();if(h){if(this.updateSyncStatus({dataFlow:{uploading:!0}}),h.clientId==(e==null?void 0:e.clientId))throw this.logger.warn(`Potentially previously uploaded CRUD entries are still present in the upload queue.
Make sure to handle uploads and complete CRUD transactions or batches by calling and awaiting their [.complete()] method.
The next upload iteration will be delayed.`),new Error("Delaying due to previously encountered CRUD item.");e=h,await this.options.uploadCrud(),this.updateSyncStatus({dataFlow:{uploadError:void 0}})}else{await this.options.adapter.updateLocalTarget(()=>this.getWriteCheckpoint())==!1&&e!=null&&this.logger.debug("Upload complete, no write checkpoint needed.");break}}catch(h){if(e=void 0,this.updateSyncStatus({dataFlow:{uploading:!1,uploadError:h}}),await this.delayRetry(n.signal),!this.isConnected)break;this.logger.debug(`Caught exception when uploading. Upload will retry after a delay. Exception: ${h.message}`)}finally{this.updateSyncStatus({dataFlow:{uploading:!1}})}this.uploadAbortController=null}})}async connect(e){this.abortController&&await this.disconnect();const n=new AbortController;return this.abortController=n,this.streamingSyncPromise=this.streamingSync(this.abortController.signal,e),new Promise(a=>{const h=this.registerListener({statusChanged:s=>{if(s.dataFlowStatus.downloadError!=null)this.logger.warn("Initial connect attempt did not successfully connect to server");else if(s.connecting)return;h(),a()}})})}async disconnect(){if(this.abortController){this.abortController.signal.aborted||this.abortController.abort(new Z("Disconnect has been requested"));try{await this.streamingSyncPromise}catch(e){this.logger.warn(e)}this.streamingSyncPromise=void 0,this.abortController=null,this.updateSyncStatus({connected:!1,connecting:!1})}}async streamingSync(e,n){e||(this.abortController=new AbortController,e=this.abortController.signal),this.crudUpdateListener=this.options.adapter.registerListener({crudUpdate:()=>this.triggerCrudUpload()});let a=new AbortController;for(e.addEventListener("abort",()=>{var h;a.abort((e==null?void 0:e.reason)??new Z("Received command to disconnect from upstream")),(h=this.crudUpdateListener)==null||h.call(this),this.crudUpdateListener=void 0,this.updateSyncStatus({connected:!1,connecting:!1,dataFlow:{downloading:!1,downloadProgress:null}})});;){this.updateSyncStatus({connecting:!0});let h=!0,s=null;try{if(e!=null&&e.aborted)break;s=await this.streamingSyncIteration(a.signal,n)}catch(d){d instanceof Z?(this.logger.warn(d),h=!1):this.logger.error(d),this.updateSyncStatus({dataFlow:{downloadError:d}})}finally{this.notifyCompletedUploads=void 0,e.aborted||(a.abort(new Z("Closing sync stream network requests before retry.")),a=new AbortController),(s==null?void 0:s.immediateRestart)!=!0&&(this.updateSyncStatus({connected:!1,connecting:!0}),h&&await this.delayRetry(a.signal))}}this.updateSyncStatus({connected:!1,connecting:!1})}async collectLocalBucketState(){const e=await this.options.adapter.getBucketStates(),n=e.map(h=>({name:h.bucket,after:h.op_id})),a=new Map;for(const h of e)a.set(h.bucket,null);return[n,a]}async requireKeyFormat(e){const n=await this.options.adapter.hasMigratedSubkeys();return e&&!n?(await this.options.adapter.migrateToFixedSubkeys(),!0):n}streamingSyncIteration(e,n){return this.obtainLock({type:et.SYNC,signal:e,callback:async()=>{const a={...ei,...n??{}},h=Object.entries(a.appMetadata).filter(([d,v])=>typeof v!="string");if(h.length>0)throw new Error(`Invalid appMetadata provided. Only string values are allowed. Invalid values: ${h.map(([d,v])=>`${d}: ${v}`).join(", ")}`);const s=a.clientImplementation;return this.updateSyncStatus({clientImplementation:s}),s==ht.JAVASCRIPT?(await this.legacyStreamingSyncIteration(e,a),null):(await this.requireKeyFormat(!0),await this.rustSyncIteration(e,a))}})}async legacyStreamingSyncIteration(e,n){var u;const a=(u=n.serializedSchema)==null?void 0:u.raw_tables;a!=null&&a.length&&this.logger.warn("Raw tables require the Rust-based sync client. The JS client will ignore them."),this.activeStreams.length&&this.logger.error("Sync streams require `clientImplementation: SyncClientImplementation.RUST` when connecting."),this.logger.debug("Streaming sync iteration started"),this.options.adapter.startSession();let[h,s]=await this.collectLocalBucketState(),d=null,v=null;const R=await this.options.adapter.getClientId(),l=await this.requireKeyFormat(!1);this.logger.debug("Requesting stream from server");const r={path:"/sync/stream",abortSignal:e,data:{buckets:h,include_checksum:!0,raw_data:!0,parameters:n.params,app_metadata:n.appMetadata,client_id:R}};let f;if((n==null?void 0:n.connectionMethod)==tt.HTTP)f=await this.options.remote.postStreamRaw(r,y=>typeof y=="string"?JSON.parse(y):y);else{const y=await this.options.remote.getBSON();f=await this.options.remote.socketStreamRaw({...r,fetchStrategy:n.fetchStrategy},g=>g instanceof Uint8Array?y.deserialize(g):g,y)}for(this.logger.debug("Stream established. Processing events"),this.notifyCompletedUploads=()=>{f.closed||f.enqueueData({crud_upload_completed:null})};!f.closed;){const y=await f.read();if(!y)return;if("crud_upload_completed"in y){if(v!=null){const{applied:g,endIteration:E}=await this.applyCheckpoint(v);if(g)v=null;else if(E)break}continue}if(this.syncStatus.connected||(Promise.resolve().then(()=>this.triggerCrudUpload()),this.updateSyncStatus({connected:!0})),Kn(y)){d=y.checkpoint,v=null;const g=new Set(s.keys()),E=new Map;for(const b of y.checkpoint.buckets)E.set(b.bucket,{name:b.bucket,priority:b.priority??_r}),g.delete(b.bucket);g.size>0&&this.logger.debug("Removing buckets",[...g]),s=E,await this.options.adapter.removeBuckets([...g]),await this.options.adapter.setTargetCheckpoint(d),await this.updateSyncStatusForStartingCheckpoint(d)}else if(Yn(y)){const g=await this.applyCheckpoint(d);if(g.endIteration)return;g.applied?v=null:v=d}else if(Jn(y)){const g=y.partial_checkpoint_complete.priority;this.logger.debug("Partial checkpoint complete",g);const E=await this.options.adapter.syncLocalDatabase(d,g);if(E.checkpointValid){if(E.ready){this.logger.debug("partial checkpoint validation succeeded");const b=this.syncStatus.priorityStatusEntries.filter(C=>C.priority<=g);b.push({priority:g,lastSyncedAt:new Date,hasSynced:!0}),this.updateSyncStatus({connected:!0,priorityStatusEntries:b})}}else{await new Promise(b=>setTimeout(b,50));return}}else if($n(y)){if(d==null)throw new Error("Checkpoint diff without previous checkpoint");v=null;const g=y.checkpoint_diff,E=new Map;for(const I of d.buckets)E.set(I.bucket,I);for(const I of g.updated_buckets)E.set(I.bucket,I);for(const I of g.removed_buckets)E.delete(I);d={last_op_id:g.last_op_id,buckets:[...E.values()],write_checkpoint:g.write_checkpoint},await this.updateSyncStatusForStartingCheckpoint(d),s=new Map,E.forEach((I,L)=>s.set(L,{name:I.bucket,priority:I.priority??_r}));const C=g.removed_buckets;C.length>0&&this.logger.debug("Remove buckets",C),await this.options.adapter.removeBuckets(C),await this.options.adapter.setTargetCheckpoint(d)}else if(Gn(y)){const{data:g}=y,E=this.syncStatus.dataFlowStatus.downloadProgress;let b=null;if(E){b={...E};const C=b[g.bucket];C&&(b[g.bucket]={...C,since_last:C.since_last+g.data.length})}this.updateSyncStatus({dataFlow:{downloading:!0,downloadProgress:b}}),await this.options.adapter.saveSyncData({buckets:[Bt.fromRow(g)]},l)}else if(Xn(y)){const g=y.token_expires_in;if(g==0){this.logger.debug("Token expiring; reconnect"),await this.delayRetry();return}else if(g<30){this.logger.debug("Token will expire soon; reconnect"),this.options.remote.invalidateCredentials();return}this.triggerCrudUpload()}else this.logger.debug("Received unknown sync line",y)}this.logger.debug("Stream input empty")}async rustSyncIteration(e,n){const a=this,h=this.options.adapter,s=this.options.remote;let d=null,v=!1,R=!1;if(e.aborted)throw new Z("Connection request has been aborted");const l=new AbortController;e.addEventListener("abort",()=>l.abort());let r=null;async function f(b){const C={path:"/sync/stream",abortSignal:l.signal,data:b.request};n.connectionMethod==tt.HTTP?r=await s.postStreamRaw(C,I=>typeof I=="string"?{command:fe.PROCESS_TEXT_LINE,payload:I}:I):r=await s.socketStreamRaw({...C,fetchStrategy:n.fetchStrategy},I=>I instanceof Uint8Array?{command:fe.PROCESS_BSON_LINE,payload:I}:I),a.updateSyncStatus({connected:!0});try{for(;!r.closed;){const I=await r.read();if(I==null)return;await y(I.command,I.payload),v||(a.triggerCrudUpload(),v=!0)}}finally{const I=r;r=null,await I.close()}}async function u(){await y(fe.STOP)}async function y(b,C){const I=await h.control(b,C??null);a.logger.trace("powersync_control",b,C==null||typeof C=="string"?C:"<bytes>",I),await E(JSON.parse(I))}async function g(b){if("LogLine"in b)switch(b.LogLine.severity){case"DEBUG":a.logger.debug(b.LogLine.line);break;case"INFO":a.logger.info(b.LogLine.line);break;case"WARNING":a.logger.warn(b.LogLine.line);break}else if("UpdateSyncStatus"in b)a.updateSyncStatus(Vn(b.UpdateSyncStatus.status));else if("EstablishSyncStream"in b){if(d!=null)throw"Unexpected request to establish sync stream, already connected";d=f(b.EstablishSyncStream)}else"FetchCredentials"in b?b.FetchCredentials.did_expire?s.invalidateCredentials():(s.invalidateCredentials(),s.fetchCredentials().then(C=>{r==null||r.enqueueData({command:fe.NOTIFY_TOKEN_REFRESHED})},C=>{a.logger.warn("Could not prefetch credentials",C)})):"CloseSyncStream"in b?(l.abort(),R=b.CloseSyncStream.hide_disconnect):"FlushFileSystem"in b||"DidCompleteSync"in b&&a.updateSyncStatus({dataFlow:{downloadError:void 0}})}async function E(b){for(const C of b)await g(C)}try{const b={parameters:n.params,app_metadata:n.appMetadata,active_streams:this.activeStreams,include_defaults:n.includeDefaultStreams};n.serializedSchema&&(b.schema=n.serializedSchema),await y(fe.START,JSON.stringify(b)),this.notifyCompletedUploads=()=>{r&&!(r!=null&&r.closed)&&r.enqueueData({command:fe.NOTIFY_CRUD_UPLOAD_COMPLETED})},this.handleActiveStreamsChange=()=>{r&&!(r!=null&&r.closed)&&r.enqueueData({command:fe.UPDATE_SUBSCRIPTIONS,payload:JSON.stringify(this.activeStreams)})},await d}finally{this.notifyCompletedUploads=this.handleActiveStreamsChange=void 0,await u()}return{immediateRestart:R}}async updateSyncStatusForStartingCheckpoint(e){const n=await this.options.adapter.getBucketOperationProgress(),a={};let h=!1;for(const s of e.buckets){const d=n[s.bucket],v=(d==null?void 0:d.atLast)??0,R=(d==null?void 0:d.sinceLast)??0;a[s.bucket]={priority:s.priority??3,at_last:v,since_last:R,target_count:s.count??0},s.count!=null&&s.count<v+R&&(h=!0)}if(h)for(const s in a){const d=a[s];d.at_last=0,d.since_last=0}this.updateSyncStatus({dataFlow:{downloading:!0,downloadProgress:a}})}async applyCheckpoint(e){let n=await this.options.adapter.syncLocalDatabase(e);if(n.checkpointValid){if(!n.ready)return this.logger.debug(`Could not apply checkpoint ${e.last_op_id} due to local data. We will retry applying the checkpoint after that upload is completed.`),{applied:!1,endIteration:!1}}else return this.logger.debug(`Checksum mismatch in checkpoint ${e.last_op_id}, will reconnect`),await new Promise(a=>setTimeout(a,50)),{applied:!1,endIteration:!0};return this.logger.debug(`Applied checkpoint ${e.last_op_id}`,e),this.updateSyncStatus({connected:!0,lastSyncedAt:new Date,dataFlow:{downloading:!1,downloadProgress:null,downloadError:void 0}}),{applied:!0,endIteration:!1}}updateSyncStatus(e){const n=new Qe({connected:e.connected??this.syncStatus.connected,connecting:!e.connected&&(e.connecting??this.syncStatus.connecting),lastSyncedAt:e.lastSyncedAt??this.syncStatus.lastSyncedAt,dataFlow:{...this.syncStatus.dataFlowStatus,...e.dataFlow},priorityStatusEntries:e.priorityStatusEntries??this.syncStatus.priorityStatusEntries,clientImplementation:e.clientImplementation??this.syncStatus.clientImplementation});this.syncStatus.isEqual(n)||(this.syncStatus=n,this.iterateListeners(a=>{var h;return(h=a.statusChanged)==null?void 0:h.call(a,n)})),this.iterateListeners(a=>{var h;return(h=a.statusUpdated)==null?void 0:h.call(a,e)})}async delayRetry(e){return new Promise(n=>{if(e!=null&&e.aborted){n();return}const{retryDelayMs:a}=this.options;let h;const s=()=>{n(),h&&(clearTimeout(h),h=void 0),e==null||e.removeEventListener("abort",s)};e==null||e.addEventListener("abort",s,{once:!0}),h=setTimeout(s,a)})}updateSubscriptions(e){var n;this.activeStreams=e,(n=this.handleActiveStreamsChange)==null||n.call(this)}}var Cr;(function(c){c.INSERT="INSERT",c.UPDATE="UPDATE",c.DELETE="DELETE"})(Cr||(Cr={}));const Ar="9223372036854775807",$e=class $e extends De{constructor(e,n=Ne.get("SqliteBucketStorage")){super();A(this,"db");A(this,"logger");A(this,"tableNames");A(this,"_hasCompletedSync");A(this,"updateListener");A(this,"_clientId");this.db=e,this.logger=n,this._hasCompletedSync=!1,this.tableNames=new Set,this.updateListener=e.registerListener({tablesUpdated:a=>{yn(a).includes(Nt.CRUD)&&this.iterateListeners(s=>{var d;return(d=s.crudUpdate)==null?void 0:d.call(s)})}})}async init(){this._hasCompletedSync=!1;const e=await this.db.getAll("SELECT name FROM sqlite_master WHERE type='table' AND name GLOB 'ps_data_*'");for(const n of e??[])this.tableNames.add(n.name)}async dispose(){var e;(e=this.updateListener)==null||e.call(this)}async _getClientId(){return(await this.db.get("SELECT powersync_client_id() as client_id")).client_id}getClientId(){return this._clientId==null&&(this._clientId=this._getClientId()),this._clientId}getMaxOpId(){return Ar}startSession(){}async getBucketStates(){return await this.db.getAll("SELECT name as bucket, cast(last_op as TEXT) as op_id FROM ps_buckets WHERE pending_delete = 0 AND name != '$local'")}async getBucketOperationProgress(){const e=await this.db.getAll("SELECT name, count_at_last, count_since_last FROM ps_buckets");return Object.fromEntries(e.map(n=>[n.name,{atLast:n.count_at_last,sinceLast:n.count_since_last}]))}async saveSyncData(e,n=!1){await this.writeTransaction(async a=>{for(const h of e.buckets)await a.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["save",JSON.stringify({buckets:[h.toJSON(n)]})]),this.logger.debug(`Saved batch of data for  bucket: ${h.bucket}, operations: ${h.data.length}`)})}async removeBuckets(e){for(const n of e)await this.deleteBucket(n)}async deleteBucket(e){await this.writeTransaction(async n=>{await n.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["delete_bucket",e])}),this.logger.debug(`Done deleting bucket ${e}`)}async hasCompletedSync(){if(this._hasCompletedSync)return!0;const n=(await this.db.get("SELECT powersync_last_synced_at() as synced_at")).synced_at!=null;return n&&(this._hasCompletedSync=!0),n}async syncLocalDatabase(e,n){const a=await this.validateChecksums(e,n);if(!a.checkpointValid){this.logger.error("Checksums failed for",a.checkpointFailures);for(const v of a.checkpointFailures??[])await this.deleteBucket(v);return{ready:!1,checkpointValid:!1,checkpointFailures:a.checkpointFailures}}n==null?this.logger.debug(`Validated checksums checkpoint ${e.last_op_id}`):this.logger.debug(`Validated checksums for partial checkpoint ${e.last_op_id}, priority ${n}`);let h=e.buckets;n!==void 0&&(h=h.filter(v=>Lt(n,v)));const s=h.map(v=>v.bucket);return await this.writeTransaction(async v=>{await v.execute("UPDATE ps_buckets SET last_op = ? WHERE name IN (SELECT json_each.value FROM json_each(?))",[e.last_op_id,JSON.stringify(s)]),n==null&&e.write_checkpoint&&await v.execute("UPDATE ps_buckets SET last_op = ? WHERE name = '$local'",[e.write_checkpoint])}),await this.updateObjectsFromBuckets(e,n)?{ready:!0,checkpointValid:!0}:{ready:!1,checkpointValid:!0}}async updateObjectsFromBuckets(e,n){let a="";if(n!==void 0){const h=[];for(const s of e.buckets)Lt(n,s)&&h.push(s.bucket);a=JSON.stringify({priority:n,buckets:h})}return this.writeTransaction(async h=>{const{insertId:s}=await h.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["sync_local",a]);if(s==1){if(n==null){const d=Object.fromEntries(e.buckets.map(R=>[R.bucket,R.count])),v=JSON.stringify(d);await h.execute("UPDATE ps_buckets SET count_since_last = 0, count_at_last = ?->name WHERE name != '$local' AND ?->name IS NOT NULL",[v,v])}return!0}else return!1})}async validateChecksums(e,n){var d;if(n!==void 0){const v=e.buckets.filter(R=>Lt(n,R));e={...e,buckets:v}}const h=(d=(await this.db.execute("SELECT powersync_validate_checkpoint(?) as result",[JSON.stringify({...e})])).rows)==null?void 0:d.item(0);if(!h)return{checkpointValid:!1,ready:!1,checkpointFailures:[]};const s=JSON.parse(h.result);return s.valid?{ready:!0,checkpointValid:!0}:{checkpointValid:!1,ready:!1,checkpointFailures:s.failed_buckets}}async updateLocalTarget(e){if(!(await this.db.getAll("SELECT target_op FROM ps_buckets WHERE name = '$local' AND target_op = CAST(? as INTEGER)",[Ar])).length)return!1;const a=await this.db.getAll("SELECT seq FROM main.sqlite_sequence WHERE name = 'ps_crud'");if(!a.length)return!1;const h=a[0].seq,s=await e();return this.writeTransaction(async d=>{var r,f,u;if((r=(await d.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows)!=null&&r.length)return this.logger.debug(`New data uploaded since write checkpoint ${s} - need new write checkpoint`),!1;const R=await d.execute("SELECT seq FROM main.sqlite_sequence WHERE name = 'ps_crud'");if(!((f=R.rows)!=null&&f.length))throw new Error("SQLite Sequence should not be empty");return((u=R.rows)==null?void 0:u.item(0).seq)!=h?(this.logger.debug(`New data uploaded since write checpoint ${s} - need new write checkpoint (sequence updated)`),!1):(this.logger.debug(`Updating target write checkpoint to ${s}`),await d.execute("UPDATE ps_buckets SET target_op = CAST(? as INTEGER) WHERE name='$local'",[s]),!0)})}async nextCrudItem(){const e=await this.db.getOptional("SELECT * FROM ps_crud ORDER BY id ASC LIMIT 1");if(e)return lt.fromRow(e)}async hasCrud(){return!!await this.db.getOptional("SELECT 1 FROM ps_crud LIMIT 1")}async getCrudBatch(e=100){if(!await this.hasCrud())return null;const n=await this.db.getAll("SELECT * FROM ps_crud ORDER BY id ASC LIMIT ?",[e]),a=[];for(const s of n)a.push(lt.fromRow(s));if(a.length===0)return null;const h=a[a.length-1];return{crud:a,haveMore:!0,complete:async s=>this.writeTransaction(async d=>{var v;await d.execute("DELETE FROM ps_crud WHERE id <= ?",[h.clientId]),s?(v=(await d.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows)!=null&&v.length&&await d.execute("UPDATE ps_buckets SET target_op = CAST(? as INTEGER) WHERE name='$local'",[s]):await d.execute("UPDATE ps_buckets SET target_op = CAST(? as INTEGER) WHERE name='$local'",[this.getMaxOpId()])})}}async writeTransaction(e,n){return this.db.writeTransaction(e,n)}async setTargetCheckpoint(e){}async control(e,n){return await this.writeTransaction(async a=>{const[[h]]=await a.executeRaw("SELECT powersync_control(?, ?)",[e,n]);return h})}async hasMigratedSubkeys(){const{r:e}=await this.db.get("SELECT EXISTS(SELECT * FROM ps_kv WHERE key = ?) as r",[$e._subkeyMigrationKey]);return e!=0}async migrateToFixedSubkeys(){await this.writeTransaction(async e=>{await e.execute("UPDATE ps_oplog SET key = powersync_remove_duplicate_key_encoding(key);"),await e.execute("INSERT OR REPLACE INTO ps_kv (key, value) VALUES (?, ?);",[$e._subkeyMigrationKey,"1"])})}};A($e,"_subkeyMigrationKey","powersync_js_migrated_subkeys");let Dt=$e;function Lt(c,o){return o.priority!=null&&o.priority<=c}const We=class We extends Error{static MATCHES(o){return o instanceof We||o instanceof Error&&o.name==We.NAME}constructor(o){super(o),this.name=We.NAME}};A(We,"NAME","ConnectionClosedError");let Ve=We;var rt;(function(c){c.TEXT="TEXT",c.INTEGER="INTEGER",c.REAL="REAL"})(rt||(rt={}));rt.TEXT;rt.INTEGER;rt.REAL;const Le=Ne,Ee={TRACE:Le.TRACE,DEBUG:Le.DEBUG,INFO:Le.INFO,TIME:Le.TIME,WARN:Le.WARN,ERROR:Le.ERROR,OFF:Le.OFF};function ri(){return Ne}function Hr(c,o={}){const e=Ne.get(c);return o.logLevel&&e.setLevel(o.logLevel),e}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Wr=Symbol("Comlink.proxy"),jr=Symbol("Comlink.endpoint"),zt=Symbol("Comlink.releaseProxy"),xt=Symbol("Comlink.finalizer"),ut=Symbol("Comlink.thrown"),Qr=c=>typeof c=="object"&&c!==null||typeof c=="function",ni={canHandle:c=>Qr(c)&&c[Wr],serialize(c){const{port1:o,port2:e}=new MessageChannel;return Ht(c,o),[e,[e]]},deserialize(c){return c.start(),Pt(c)}},ii={canHandle:c=>Qr(c)&&ut in c,serialize({value:c}){let o;return c instanceof Error?o={isError:!0,value:{message:c.message,name:c.name,stack:c.stack}}:o={isError:!1,value:c},[o,[]]},deserialize(c){throw c.isError?Object.assign(new Error(c.value.message),c.value):c.value}},Vr=new Map([["proxy",ni],["throw",ii]]);function si(c,o){for(const e of c)if(o===e||e==="*"||e instanceof RegExp&&e.test(o))return!0;return!1}function Ht(c,o=globalThis,e=["*"]){o.addEventListener("message",function n(a){if(!a||!a.data)return;if(!si(e,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:h,type:s,path:d}=Object.assign({path:[]},a.data),v=(a.data.argumentList||[]).map(xe);let R;try{const l=d.slice(0,-1).reduce((f,u)=>f[u],c),r=d.reduce((f,u)=>f[u],c);switch(s){case"GET":R=r;break;case"SET":l[d.slice(-1)[0]]=xe(a.data.value),R=!0;break;case"APPLY":R=r.apply(l,v);break;case"CONSTRUCT":{const f=new r(...v);R=Yr(f)}break;case"ENDPOINT":{const{port1:f,port2:u}=new MessageChannel;Ht(c,u),R=li(f,[f])}break;case"RELEASE":R=void 0;break;default:return}}catch(l){R={value:l,[ut]:0}}Promise.resolve(R).catch(l=>({value:l,[ut]:0})).then(l=>{const[r,f]=mt(l);o.postMessage(Object.assign(Object.assign({},r),{id:h}),f),s==="RELEASE"&&(o.removeEventListener("message",n),Gr(o),xt in c&&typeof c[xt]=="function"&&c[xt]())}).catch(l=>{const[r,f]=mt({value:new TypeError("Unserializable return value"),[ut]:0});o.postMessage(Object.assign(Object.assign({},r),{id:h}),f)})}),o.start&&o.start()}function ai(c){return c.constructor.name==="MessagePort"}function Gr(c){ai(c)&&c.close()}function Pt(c,o){const e=new Map;return c.addEventListener("message",function(a){const{data:h}=a;if(!h||!h.id)return;const s=e.get(h.id);if(s)try{s(h)}finally{e.delete(h.id)}}),kt(c,e,[],o)}function ot(c){if(c)throw new Error("Proxy has been released and is not useable")}function Xr(c){return He(c,new Map,{type:"RELEASE"}).then(()=>{Gr(c)})}const ft=new WeakMap,pt="FinalizationRegistry"in globalThis&&new FinalizationRegistry(c=>{const o=(ft.get(c)||0)-1;ft.set(c,o),o===0&&Xr(c)});function oi(c,o){const e=(ft.get(o)||0)+1;ft.set(o,e),pt&&pt.register(c,o,c)}function ci(c){pt&&pt.unregister(c)}function kt(c,o,e=[],n=function(){}){let a=!1;const h=new Proxy(n,{get(s,d){if(ot(a),d===zt)return()=>{ci(h),Xr(c),o.clear(),a=!0};if(d==="then"){if(e.length===0)return{then:()=>h};const v=He(c,o,{type:"GET",path:e.map(R=>R.toString())}).then(xe);return v.then.bind(v)}return kt(c,o,[...e,d])},set(s,d,v){ot(a);const[R,l]=mt(v);return He(c,o,{type:"SET",path:[...e,d].map(r=>r.toString()),value:R},l).then(xe)},apply(s,d,v){ot(a);const R=e[e.length-1];if(R===jr)return He(c,o,{type:"ENDPOINT"}).then(xe);if(R==="bind")return kt(c,o,e.slice(0,-1));const[l,r]=Ir(v);return He(c,o,{type:"APPLY",path:e.map(f=>f.toString()),argumentList:l},r).then(xe)},construct(s,d){ot(a);const[v,R]=Ir(d);return He(c,o,{type:"CONSTRUCT",path:e.map(l=>l.toString()),argumentList:v},R).then(xe)}});return oi(h,c),h}function ui(c){return Array.prototype.concat.apply([],c)}function Ir(c){const o=c.map(mt);return[o.map(e=>e[0]),ui(o.map(e=>e[1]))]}const Kr=new WeakMap;function li(c,o){return Kr.set(c,o),c}function Yr(c){return Object.assign(c,{[Wr]:!0})}function mt(c){for(const[o,e]of Vr)if(e.canHandle(c)){const[n,a]=e.serialize(c);return[{type:"HANDLER",name:o,value:n},a]}return[{type:"RAW",value:c},Kr.get(c)||[]]}function xe(c){switch(c.type){case"HANDLER":return Vr.get(c.name).deserialize(c.value);case"RAW":return c.value}}function He(c,o,e,n){return new Promise(a=>{const h=di();o.set(h,a),c.start&&c.start(),c.postMessage(Object.assign({id:h},e),n)})}function di(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function hi(c){c??(c=navigator);const o=fi(c),e=pi(c);return[o,e].filter(n=>n!=null)}function fi(c){var a;const o=(a=c.userAgentData)==null?void 0:a.brands;if(o!=null){const h=[{name:"Google Chrome",value:"Chrome"},{name:"Opera",value:"Opera"},{name:"Edge",value:"Edge"},{name:"Chromium",value:"Chromium"}];for(let{name:s,value:d}of h){const v=o.find(R=>R.brand==s);if(v!=null)return`${d}/${v.version}`}}const e=c.userAgent,n=[{re:/(?:firefox|fxios)\/(\d+)/i,value:"Firefox"},{re:/(?:edg|edge|edga|edgios)\/(\d+)/i,value:"Edge"},{re:/opr\/(\d+)/i,value:"Opera"},{re:/(?:chrome|chromium|crios)\/(\d+)/i,value:"Chrome"},{re:/version\/(\d+).*safari/i,value:"Safari"}];for(let{re:h,value:s}of n){const d=h.exec(e);if(d!=null)return`${s}/${d[1]}`}return null}function pi(c){var n;if(((n=c.userAgentData)==null?void 0:n.platform)!=null)return c.userAgentData.platform.toLowerCase();const o=c.userAgent,e=[{re:/windows/i,value:"windows"},{re:/android/i,value:"android"},{re:/linux/i,value:"linux"},{re:/iphone|ipad|ipod/i,value:"ios"},{re:/macintosh|mac os x/i,value:"macos"}];for(let{re:a,value:h}of e)if(a.test(o))return h;return null}class mi extends qt{getFetch(){return fetch.bind(globalThis)}}class yi extends Qn{constructor(e,n=zr,a){super(e,n,{...a??{},fetchImplementation:(a==null?void 0:a.fetchImplementation)??new mi});A(this,"connector");A(this,"logger");A(this,"_bson");this.connector=e,this.logger=n}getUserAgent(){let e=[super.getUserAgent(),"powersync-web"];try{e.push(...hi())}catch(n){this.logger.warn("Failed to get user agent info",n)}return e.join(" ")}async getBSON(){if(this._bson)return this._bson;const{BSON:e}=await import("./bson-CuyQlZSR.js");return this._bson=e,this._bson}}const Wt=()=>{if("locks"in navigator&&navigator.locks)return navigator.locks;throw new Error("Navigator locks are not available in an insecure context. Use a secure context such as HTTPS or http://localhost.")};class gi extends ti{constructor(o){super(o)}get webOptions(){return this.options}async obtainLock(o){const e=`streaming-sync-${o.type}-${this.webOptions.identifier}`;return o.type==et.SYNC&&this.logger.debug("requesting lock for ",e),Wt().request(e,{signal:o.signal},o.callback)}}class Jr extends De{constructor(e){super();A(this,"options");A(this,"lockAbortController",new AbortController);A(this,"notifyRemoteClosed");this.options=e,e.remoteCanCloseUnexpectedly&&(this.notifyRemoteClosed=new AbortController)}get baseConnection(){return this.options.baseConnection}init(){return this.baseConnection.init()}markRemoteClosed(){this.notifyRemoteClosed.abort()}markHold(){return this.withRemote(()=>this.baseConnection.markHold())}releaseHold(e){return this.withRemote(()=>this.baseConnection.releaseHold(e))}isAutoCommit(){return this.withRemote(()=>this.baseConnection.isAutoCommit())}withRemote(e,n=!1){const a=this.notifyRemoteClosed;return a?new Promise((h,s)=>{if(a.signal.aborted&&(s(new Ve("Called operation on closed remote")),!n))return;function d(){s(new Ve("Remote peer closed with request in flight"))}function v(R){a.signal.removeEventListener("abort",d),R()}a.signal.addEventListener("abort",d),e().then(R=>v(()=>h(R))).catch(R=>v(()=>s(R)))}):e()}async shareConnection(){const{identifier:e,remote:n}=this.options;return await new Promise((h,s)=>navigator.locks.request(`shared-connection-${this.options.identifier}-${Date.now()}-${Math.round(Math.random()*1e4)}`,{signal:this.lockAbortController.signal},async()=>{h(),!this.lockAbortController.signal.aborted&&await new Promise(d=>{this.lockAbortController.signal.addEventListener("abort",()=>{d()})})}).catch(d=>{d.name=="AbortError"?h():s(d)})),{port:await n[jr](),identifier:e}}async registerOnTableChange(e){return this.baseConnection.registerOnTableChange(Yr(e))}async close(){var e,n;this.lockAbortController.abort();try{await this.withRemote(()=>this.baseConnection.close(),!0)}finally{this.options.remote[zt](),(n=(e=this.options).onClose)==null||n.call(e),this.iterateListeners(a=>{var h;return(h=a.closing)==null?void 0:h.call(a)})}}execute(e,n){return this.withRemote(()=>this.baseConnection.execute(e,n))}executeRaw(e,n){return this.withRemote(()=>this.baseConnection.executeRaw(e,n))}executeBatch(e,n){return this.withRemote(()=>this.baseConnection.executeBatch(e,n))}getConfig(){return this.withRemote(()=>this.baseConnection.getConfig())}}typeof BigInt.prototype.toJSON>"u"&&(BigInt.prototype.toJSON=function(){return this.toString()});Object.getPrototypeOf(async function(){}).constructor;var je;(function(c){c.IDBBatchAtomicVFS="IDBBatchAtomicVFS",c.OPFSCoopSyncVFS="OPFSCoopSyncVFS",c.AccessHandlePoolVFS="AccessHandlePoolVFS"})(je||(je={}));const Ei=async()=>{const{default:c}=await import("./wa-sqlite-async-B2LaFWqa.js");return c()},wi=async()=>{const{default:c}=await import("./mc-wa-sqlite-async-CXXv26nd.js");return c()},Or=async()=>{const{default:c}=await import("./wa-sqlite-8g52zAnM.js");return c()},Lr=async()=>{const{default:c}=await import("./mc-wa-sqlite-DZYOhcgT.js");return c()};je.IDBBatchAtomicVFS+"",je.AccessHandlePoolVFS+"",je.OPFSCoopSyncVFS+"";class Si extends De{constructor(e){super();A(this,"options");A(this,"logger");A(this,"dbGetHelpers");A(this,"debugMode");A(this,"_dbIdentifier");A(this,"initPromise");A(this,"_db",null);A(this,"_disposeTableChangeListener",null);A(this,"_config",null);A(this,"pendingAbortControllers");A(this,"requiresHolds");A(this,"databaseOpenPromise",null);A(this,"closing");A(this,"closed");A(this,"_execute",async(e,n)=>{await this.waitForInitialized();const a=await this.baseDB.execute(e,n);return{...a,rows:{...a.rows,item:h=>a.rows._array[h]}}});A(this,"_executeRaw",async(e,n)=>(await this.waitForInitialized(),await this.baseDB.executeRaw(e,n)));A(this,"_executeBatch",async(e,n)=>(await this.waitForInitialized(),{...await this.baseDB.executeBatch(e,n),rows:void 0}));if(this.options=e,this._dbIdentifier=e.name,this.logger=e.logger??Hr(`LockedAsyncDatabaseAdapter - ${this._dbIdentifier}`),this.pendingAbortControllers=new Set,this.closed=!1,this.closing=!1,this.requiresHolds=null,this.debugMode=e.debugMode??!1,this.debugMode){const n=this._execute.bind(this);this._execute=async(a,h)=>{const s=performance.now();try{const d=await n(a,h);return performance.measure(`[SQL] ${a}`,{start:s}),d}catch(d){throw performance.measure(`[SQL] [ERROR: ${d.message}] ${a}`,{start:s}),d}}}this.dbGetHelpers=this.generateDBHelpers({execute:(n,a)=>this.acquireLock(()=>this._execute(n,a)),executeRaw:(n,a)=>this.acquireLock(()=>this._executeRaw(n,a))}),this.initPromise=this._init()}get baseDB(){if(!this._db)throw new Error("Initialization has not completed yet. Cannot access base db");return this._db}get name(){return this._dbIdentifier}async init(){return this.initPromise}async openInternalDB(){return this._acquireLock(async()=>{var n,a;(n=this._disposeTableChangeListener)==null||n.call(this),this._disposeTableChangeListener=null,(a=this._db)==null||a.close().catch(h=>this.logger.warn("Error closing database before opening new instance",h));const e=!!this._db;this._db=null,this._db=await this.options.openConnection(),await this._db.init(),this._config=await this._db.getConfig(),await this.registerOnChangeListener(this._db),e&&this.iterateListeners(h=>{var s;return(s=h.databaseReOpened)==null?void 0:s.call(h)}),this.requiresHolds=this._config.vfs==je.IDBBatchAtomicVFS})}_reOpen(){return this.databaseOpenPromise=this.openInternalDB().finally(()=>{this.databaseOpenPromise=null}),this.databaseOpenPromise}async reOpenInternalDB(){if(!this.options.reOpenOnConnectionClosed)throw new Error("Cannot re-open underlying database, reOpenOnConnectionClosed is not enabled");return this.databaseOpenPromise?this.databaseOpenPromise:this._reOpen()}async _init(){for(let n=0;n<3;n++)try{await this.openInternalDB();break}catch(a){if(n==2)throw a;this.logger.warn(`Attempt ${n+1} of 3 to open database failed, retrying in 1 second...`,a),await new Promise(h=>setTimeout(h,1e3))}this.iterateListeners(n=>{var a;return(a=n.initialized)==null?void 0:a.call(n)})}getConfiguration(){if(!this._config)throw new Error("Cannot get config before initialization is completed");return{...this._config,requiresPersistentTriggers:!1}}async waitForInitialized(){await this.initPromise}async shareConnection(){if(!(this._db instanceof Jr))throw new Error("Only worker connections can be shared");return this._db.shareConnection()}async registerOnChangeListener(e){this._disposeTableChangeListener=await e.registerOnTableChange(n=>{this.iterateListeners(a=>{var h;return(h=a.tablesUpdated)==null?void 0:h.call(a,n)})})}async refreshSchema(){}async execute(e,n){return this.writeLock(a=>a.execute(e,n))}async executeRaw(e,n){return this.writeLock(a=>a.executeRaw(e,n))}async executeBatch(e,n){return this.writeLock(a=>this._executeBatch(e,n))}async close(){var n,a;this.closing=!0;const e=this._disposeTableChangeListener;e&&e(),this.pendingAbortControllers.forEach(h=>h.abort("Closed")),await((a=(n=this.baseDB)==null?void 0:n.close)==null?void 0:a.call(n)),this.closed=!0}async getAll(e,n){return await this.waitForInitialized(),this.dbGetHelpers.getAll(e,n)}async getOptional(e,n){return await this.waitForInitialized(),this.dbGetHelpers.getOptional(e,n)}async get(e,n){return await this.waitForInitialized(),this.dbGetHelpers.get(e,n)}async readLock(e,n){return await this.waitForInitialized(),this.acquireLock(async()=>e(this.generateDBHelpers({execute:this._execute,executeRaw:this._executeRaw})),{timeoutMs:(n==null?void 0:n.timeoutMs)??this.options.defaultLockTimeoutMs})}async writeLock(e,n){return await this.waitForInitialized(),this.acquireLock(async()=>e(this.generateDBHelpers({execute:this._execute,executeRaw:this._executeRaw})),{timeoutMs:(n==null?void 0:n.timeoutMs)??this.options.defaultLockTimeoutMs})}async _acquireLock(e,n){if(this.closing)throw new Error("Cannot acquire lock, the database is closing");const a=new AbortController;this.pendingAbortControllers.add(a);const{timeoutMs:h}=n??{},s=h?setTimeout(()=>{a.abort(`Timeout after ${h}ms`),this.pendingAbortControllers.delete(a)},h):null;return Wt().request(`db-lock-${this._dbIdentifier}`,{signal:a.signal},async()=>(this.pendingAbortControllers.delete(a),s&&clearTimeout(s),await e()))}async acquireLock(e,n){return await this.waitForInitialized(),this.databaseOpenPromise&&await this.databaseOpenPromise,this._acquireLock(async()=>{let a=null;try{if(this.databaseOpenPromise||!this._db)throw new Ve("Connection is busy re-opening");return a=this.requiresHolds?await this.baseDB.markHold():null,await e()}catch(h){throw Ve.MATCHES(h)&&this.options.reOpenOnConnectionClosed&&!this.databaseOpenPromise&&!this.closing&&this.reOpenInternalDB(),h}finally{a&&await this.baseDB.releaseHold(a)}},n)}async readTransaction(e,n){return this.readLock(this.wrapTransaction(e))}writeTransaction(e,n){return this.writeLock(this.wrapTransaction(e,!0))}generateDBHelpers(e){return{...e,async getAll(n,a){var s;return((s=(await e.execute(n,a)).rows)==null?void 0:s._array)??[]},async getOptional(n,a){var s;return((s=(await e.execute(n,a)).rows)==null?void 0:s.item(0))??null},async get(n,a){var d;const s=(d=(await e.execute(n,a)).rows)==null?void 0:d.item(0);if(!s)throw new Error("Result set is empty");return s}}}wrapTransaction(e,n=!1){return async a=>{await this._execute(n?"BEGIN EXCLUSIVE":"BEGIN");let h=!1;const s=async()=>h?{rowsAffected:0}:(h=!0,this._execute("COMMIT")),d=()=>(h=!0,this._execute("ROLLBACK"));try{const v=await e({...a,commit:s,rollback:d});return h||await s(),v}catch(v){this.logger.debug("Caught ex in transaction",v);try{await d()}catch{}throw v}}}}class vi{constructor(o){A(this,"clients");A(this,"TRACE");A(this,"DEBUG");A(this,"INFO");A(this,"TIME");A(this,"WARN");A(this,"ERROR");A(this,"OFF");A(this,"currentLevel",Ee.INFO);this.clients=o,this.TRACE=Ee.TRACE,this.DEBUG=Ee.DEBUG,this.INFO=Ee.INFO,this.TIME=Ee.TIME,this.WARN=Ee.WARN,this.ERROR=Ee.ERROR,this.OFF=Ee.OFF}trace(...o){if(!this.enabledFor(this.TRACE))return;console.trace(...o);const e=this.sanitizeArgs(o);this.iterateClients(n=>n.clientProvider.trace(...e))}debug(...o){if(!this.enabledFor(this.DEBUG))return;console.debug(...o);const e=this.sanitizeArgs(o);this.iterateClients(n=>n.clientProvider.debug(...e))}info(...o){if(!this.enabledFor(this.INFO))return;console.info(...o);const e=this.sanitizeArgs(o);this.iterateClients(n=>n.clientProvider.info(...e))}log(...o){if(!this.enabledFor(this.INFO))return;console.log(...o);const e=this.sanitizeArgs(o);this.iterateClients(n=>n.clientProvider.log(...e))}warn(...o){if(!this.enabledFor(this.WARN))return;console.warn(...o);const e=this.sanitizeArgs(o);this.iterateClients(n=>n.clientProvider.warn(...e))}error(...o){if(!this.enabledFor(this.ERROR))return;console.error(...o);const e=this.sanitizeArgs(o);this.iterateClients(n=>n.clientProvider.error(...e))}time(o){this.enabledFor(this.TIME)&&(console.time(o),this.iterateClients(e=>e.clientProvider.time(o)))}timeEnd(o){this.enabledFor(this.TIME)&&(console.timeEnd(o),this.iterateClients(e=>e.clientProvider.timeEnd(o)))}setLevel(o){this.currentLevel=o}getLevel(){return this.currentLevel}enabledFor(o){return o.value>=this.currentLevel.value}async iterateClients(o){for(const e of this.clients)try{await o(e)}catch(n){console.error("Caught exception when iterating client",n)}}sanitizeArgs(o){return o.map(n=>{try{return structuredClone(n)}catch(a){return console.error(a),"Could not serialize log params. Check shared worker logs for more details."}})}}var yt;(function(c){c.CLOSE_CLIENT="close-client",c.CLOSE_ACK="close-ack"})(yt||(yt={}));const Ri={};class bi extends De{constructor(){super();A(this,"ports");A(this,"isInitialized");A(this,"statusListener");A(this,"fetchCredentialsController");A(this,"uploadDataController");A(this,"syncParams");A(this,"logger");A(this,"lastConnectOptions");A(this,"portMutex");A(this,"subscriptions",[]);A(this,"connectionManager");A(this,"syncStatus");A(this,"broadCastLogger");A(this,"distributedDB");this.ports=[],this.syncParams=null,this.logger=Hr("shared-sync"),this.lastConnectOptions=void 0,this.portMutex=new cn,this.isInitialized=new Promise(e=>{const n=this.registerListener({initialized:()=>{e(),n==null||n()}})}),this.distributedDB=null,this.syncStatus=new Qe({}),this.broadCastLogger=new vi(this.ports),this.connectionManager=new wn({createSyncImplementation:async()=>{await this.waitForReady();const e=this.generateStreamingImplementation(),n=e.registerListener({statusChanged:a=>{this.updateAllStatuses(a.toJSON())}});return{sync:e,onDispose:n}},logger:this.logger})}get lastSyncedAt(){var e;return(e=this.connectionManager.syncStreamImplementation)==null?void 0:e.lastSyncedAt}get isConnected(){var e;return((e=this.connectionManager.syncStreamImplementation)==null?void 0:e.isConnected)??!1}async getLastWrappedPort(){return await this.portMutex.runExclusive(()=>{for(let e=this.ports.length-1;e>=0;e--)if(!this.ports[e].isClosing)return this.ports[e]})}async getRandomWrappedPort(){return await this.portMutex.runExclusive(()=>{const e=this.ports.filter(n=>!n.isClosing);return e[Math.floor(Math.random()*e.length)]})}async waitForStatus(e){return this.withSyncImplementation(async n=>n.waitForStatus(e))}async waitUntilStatusMatches(e){return this.withSyncImplementation(async n=>n.waitUntilStatusMatches(e))}async waitForReady(){return this.isInitialized}collectActiveSubscriptions(){var n;this.logger.debug("Collecting active stream subscriptions across tabs");const e=new Map;for(const a of this.ports)for(const h of a.currentSubscriptions){const s=JSON.stringify(h);e.set(s,h)}this.subscriptions=[...e.values()],this.logger.debug("Collected stream subscriptions",this.subscriptions),(n=this.connectionManager.syncStreamImplementation)==null||n.updateSubscriptions(this.subscriptions)}updateSubscriptions(e,n){e.currentSubscriptions=n,this.collectActiveSubscriptions()}setLogLevel(e){this.logger.setLevel(e),this.broadCastLogger.setLevel(e)}async setParams(e){var a,h;if(await this.portMutex.runExclusive(async()=>{this.collectActiveSubscriptions()}),this.syncParams)return;this.syncParams=e,(h=(a=e.streamOptions)==null?void 0:a.flags)!=null&&h.broadcastLogs&&(this.logger=this.broadCastLogger);const n=new Si({name:e.dbParams.dbFilename,openConnection:async()=>{const s=await this.openInternalDB();return s.registerListener({closing:()=>{n.reOpenInternalDB()}}),s},logger:this.logger,reOpenOnConnectionClosed:!0});this.distributedDB=n,await n.init(),n.registerListener({databaseReOpened:()=>{var s;(s=this.connectionManager.syncStreamImplementation)==null||s.triggerCrudUpload()}}),self.onerror=s=>{this.logger.error("Uncaught exception in PowerSync shared sync worker",s)},this.iterateListeners(s=>{var d;return(d=s.initialized)==null?void 0:d.call(s)})}async dispose(){var e;return await this.waitForReady(),(e=this.statusListener)==null||e.call(this),this.connectionManager.close()}async connect(e){return this.lastConnectOptions=e,this.connectionManager.connect(Ri,e??{})}async disconnect(){return this.connectionManager.disconnect()}async addPort(e){return await this.portMutex.runExclusive(()=>{var h;const n={port:e,clientProvider:Pt(e),currentSubscriptions:[],closeListeners:[],isClosing:!1};this.ports.push(n);const a=(h=this.connectionManager.syncStreamImplementation)==null?void 0:h.syncStatus;return a&&n.clientProvider.statusChanged(a.toJSON()),n})}async removePort(e){return e.isClosing=!0,await this.portMutex.runExclusive(async()=>{const n=this.ports.findIndex(h=>h==e);if(n<0)return this.logger.warn(`Could not remove port ${e} since it is not present in active ports.`),()=>{};const a=this.ports[n];this.ports.splice(n,1),[this.fetchCredentialsController,this.uploadDataController].forEach(h=>{(h==null?void 0:h.activePort)==e&&h.controller.abort(new Z("Closing pending requests after client port is removed"))});for(const h of a.closeListeners)await h();return this.collectActiveSubscriptions(),()=>a.clientProvider[zt]()})}triggerCrudUpload(){this.withSyncImplementation(async e=>{e.triggerCrudUpload()})}async hasCompletedSync(){return this.withSyncImplementation(async e=>e.hasCompletedSync())}async getWriteCheckpoint(){return this.withSyncImplementation(async e=>e.getWriteCheckpoint())}async withSyncImplementation(e){if(await this.waitForReady(),this.connectionManager.syncStreamImplementation)return e(this.connectionManager.syncStreamImplementation);const n=await new Promise(a=>{const h=this.connectionManager.registerListener({syncStreamCreated:s=>{a(s),h==null||h()}})});return e(n)}generateStreamingImplementation(){const e=this.syncParams;return new gi({adapter:new Dt(this.distributedDB,this.logger),remote:new yi({invalidateCredentials:async()=>{const n=await this.getLastWrappedPort();if(!n)throw new Error("No client port found to invalidate credentials");try{this.logger.log("calling the last port client provider to invalidate credentials"),n.clientProvider.invalidateCredentials()}catch(a){this.logger.error("error invalidating credentials",a)}},fetchCredentials:async()=>{const n=await this.getLastWrappedPort();if(!n)throw new Error("No client port found to fetch credentials");return new Promise(async(a,h)=>{const s=new AbortController;this.fetchCredentialsController={controller:s,activePort:n},s.signal.onabort=h;try{this.logger.log("calling the last port client provider for credentials"),a(await n.clientProvider.fetchCredentials())}catch(d){h(d)}finally{this.fetchCredentialsController=void 0}})}},this.logger),uploadCrud:async()=>{const n=await this.getLastWrappedPort();if(!n)throw new Error("No client port found to upload crud");return new Promise(async(a,h)=>{const s=new AbortController;this.uploadDataController={controller:s,activePort:n},s.signal.onabort=()=>a();try{a(await n.clientProvider.uploadCrud())}catch(d){h(d)}finally{this.uploadDataController=void 0}})},...e.streamOptions,subscriptions:this.subscriptions,logger:this.logger})}async openInternalDB(){const e=await this.getRandomWrappedPort();if(!e)throw new Error("Could not open DB connection since no client is connected.");const n=setTimeout(()=>{a.abort()},1e4),a=new AbortController,h=()=>{a.abort()},s=()=>{const f=e.closeListeners.indexOf(h);f>=0&&e.closeListeners.splice(f,1)};e.closeListeners.push(h);const d=await xr({action:()=>e.clientProvider.getDBWorkerPort(),signal:a.signal,cleanupOnAbort:f=>{f.close()}}).catch(f=>{throw s(),f}),v=Pt(d),R=this.syncParams.dbParams.dbFilename,l=await xr({action:()=>v(this.syncParams.dbParams),signal:a.signal,cleanupOnAbort:f=>{f.close()}}).finally(()=>{s()});clearTimeout(n);const r=new Jr({remote:v,baseConnection:l,identifier:R,remoteCanCloseUnexpectedly:!0});return e.closeListeners.push(async()=>{this.logger.info("Aborting open connection because associated tab closed."),r.markRemoteClosed(),r.close().catch(f=>this.logger.warn("error closing database connection",f))}),r}updateAllStatuses(e){this.syncStatus=new Qe(e),this.ports.forEach(n=>n.clientProvider.statusChanged(e))}}function xr(c){const{action:o,signal:e,cleanupOnAbort:n}=c;return new Promise((a,h)=>{if(e.aborted){h(new Z("Operation aborted by abort controller"));return}function s(){e.removeEventListener("abort",s),h(new Z("Operation aborted by abort controller"))}e.addEventListener("abort",s,{once:!0});function d(v){e.removeEventListener("abort",s),v()}o().then(v=>{if(e.aborted)return d(()=>n==null?void 0:n(v));d(()=>a(v))}).catch(v=>d(()=>h(v)))})}class Ti{constructor(o,e){A(this,"sync");A(this,"port");A(this,"resolvedPort",null);A(this,"resolvedPortPromise",null);this.sync=o,this.port=e,Ht(this,this.port),this.port.addEventListener("message",async n=>{const a=n.data;(a==null?void 0:a.event)==yt.CLOSE_CLIENT&&await this.removePort()})}async removePort(){if(this.resolvedPort){const o=this.resolvedPort;this.resolvedPort=null;const e=await this.sync.removePort(o);this.resolvedPort=null,this.port.postMessage({event:yt.CLOSE_ACK,data:{}}),e==null||e()}}async addLockBasedCloseSignal(o){this.resolvedPort=await this.sync.addPort(this.port),Wt().request(o,async()=>{await this.removePort()})}setLogLevel(o){this.sync.setLogLevel(o)}triggerCrudUpload(){return this.sync.triggerCrudUpload()}setParams(o,e){return this.resolvedPort.currentSubscriptions=e,this.sync.setParams(o)}getWriteCheckpoint(){return this.sync.getWriteCheckpoint()}hasCompletedSync(){return this.sync.hasCompletedSync()}connect(o){return this.sync.connect(o)}updateSubscriptions(o){this.resolvedPort&&this.sync.updateSubscriptions(this.resolvedPort,o)}disconnect(){return this.sync.disconnect()}}const Fi=self,_i=ri();_i.useDefaults();const Ci=new bi;Fi.onconnect=async function(c){const o=c.ports[0];new Ti(Ci,o)};
